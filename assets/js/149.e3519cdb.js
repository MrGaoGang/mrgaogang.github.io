(window.webpackJsonp=window.webpackJsonp||[]).push([[149],{816:function(t,a,s){"use strict";s.r(a);var e=s(18),o=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"再聊-cookie-和-csrf-攻击-xss-攻击"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#再聊-cookie-和-csrf-攻击-xss-攻击"}},[t._v("#")]),t._v(" 再聊 Cookie 和 CSRF 攻击 XSS 攻击")]),t._v(" "),s("p",[t._v("HTTP 协议是无状态的，主要是为了让 HTTP 协议尽可能简单，使得它能够处理大量事务。HTTP/1.1 引入 Cookie 来保存状态信息。")]),t._v(" "),s("p",[s("strong",[t._v("Cookie 是服务器发送到用户浏览器并保存在本地的一小块数据")]),t._v("，它会在浏览器之后向同一服务器再次发起请求时被携带上，用于告知服务端两个请求是否来自同一浏览器。由于之后每次请求都会需要携带 Cookie 数据，因此会带来额外的性能开销（尤其是在移动环境下）。")]),t._v(" "),s("h2",{attrs:{id:"cookie-简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cookie-简介"}},[t._v("#")]),t._v(" Cookie 简介")]),t._v(" "),s("h3",{attrs:{id:"_1-1-用途"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-用途"}},[t._v("#")]),t._v(" 1.1. 用途")]),t._v(" "),s("ul",[s("li",[t._v("会话状态管理（如用户登录状态、购物车、游戏分数或其它需要记录的信息）")]),t._v(" "),s("li",[t._v("个性化设置（如用户自定义设置、主题等）")]),t._v(" "),s("li",[t._v("浏览器行为跟踪（如跟踪分析用户行为等）")])]),t._v(" "),s("h3",{attrs:{id:"_1-2-创建过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-创建过程"}},[t._v("#")]),t._v(" 1.2. 创建过程")]),t._v(" "),s("p",[t._v("服务器发送的响应报文包含 Set-Cookie 首部字段，客户端得到响应报文后把 Cookie 内容保存到浏览器中。")]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[t._v("HTTP/1.0 200 OK Content-type: text/html Set-Cookie: yummy_cookie=mrgaogang\nSet-Cookie: tasty_cookie=strawberry\n")])])]),s("p",[t._v("客户端之后对同一个服务器发送请求时，会从浏览器中取出 Cookie 信息并通过 Cookie 请求首部字段发送给服务器。")]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[t._v("GET /sample_page.html HTTP/1.1 Host: mrgaogang.github.io Cookie:\nyummy_cookie=mrgaogang; tasty_cookie=strawberry\n")])])]),s("h3",{attrs:{id:"_1-3-分类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-分类"}},[t._v("#")]),t._v(" 1.3. 分类")]),t._v(" "),s("ul",[s("li",[t._v("会话期 Cookie：浏览器关闭之后它会被自动删除，也就是说它仅在会话期内有效。")]),t._v(" "),s("li",[t._v("持久性 Cookie：指定过期时间（Expires）或有效期（max-age）之后就成为了持久性的 Cookie。")])]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[t._v("Set-Cookie: id=a3fWa; Expires=Wed, 21 Oct 2021 07:28:00 GMT;\n")])])]),s("h3",{attrs:{id:"_1-4-cookie-属性-name-和-value"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-cookie-属性-name-和-value"}},[t._v("#")]),t._v(" 1.4 Cookie 属性 - Name 和 Value")]),t._v(" "),s("p",[t._v("Cookie 本质上就是一个键值对，其中 Name 表示 Cookie 的键，Value 表示 Cookie 的值。一个简单的例子")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" http "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" url "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"url"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" routes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"/"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hello mrgaogang"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"/get"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookie"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"/set"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setHeader")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Set-Cookie"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name=mrgaogang"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"age=30"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"done"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 响应网络请求")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onRequest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" pathname "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" route "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" routes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("pathname"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 根据路径选择不同的路由来处理")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("route"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("route")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("statusCode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("404")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Not Found"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果未匹配到路由则返回404")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建 HTTP 服务")]),t._v("\nhttp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createServer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("onRequest"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"_1-5-cookie-属性-domin-important"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-cookie-属性-domin-important"}},[t._v("#")]),t._v(" 1.5 Cookie 属性 - Domin (important)")]),t._v(" "),s("p",[s("code",[t._v("Domain")]),t._v(" 标识指定了哪些主机可以接受 Cookie。如果不指定，"),s("strong",[t._v("默认为当前文档的主机（不包含子域名）")]),t._v("。")]),t._v(" "),s("p",[s("strong",[t._v('某个域下的 · 如果希望能够被他的子域具有可见性（即可以读取），必须要注意的一点是，应该保证这个 cookie 在被 Set 的时候，应该以"."开头')]),t._v(".")]),t._v(" "),s("blockquote",[s("p",[t._v("举个例子,如果当前域为"),s("code",[t._v("now.qq.com")]),t._v("，如果不设置 "),s("code",[t._v("cookie，则")]),t._v(" domin 默认为 "),s("code",[t._v("now.qq.com")]),t._v("; "),s("code",[t._v("now")]),t._v(" 是无法获取到 "),s("code",[t._v("qq.com")]),t._v(" 的 "),s("code",[t._v("cookie")]),t._v(" 信息的，如果想要获取则需要将 domin 设置为"),s("code",[t._v(".qq.com")]),t._v(";")])]),t._v(" "),s("p",[t._v("注意点:")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("不能在 "),s("code",[t._v("test.com")]),t._v(" 设置 Cookie 的域为 "),s("code",[t._v("a.test.com")]),t._v("，不过反过来是可以的，即在 "),s("code",[t._v("a.test.com")]),t._v(" 中设置 Cookie 域为 "),s("code",[t._v("test.com")]),t._v("。同样， "),s("code",[t._v("a.test.com")]),t._v(" 中不能设置 Cookie 域为 "),s("code",[t._v("b.test.com")]),t._v("，更不能设置成其他网站，例如 "),s("code",[t._v("baidu.com")]),t._v("，这样最大程度保证了安全性.")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("Cookie 的作用域与端口号无关")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("Cookie 的作用域与协议(http/https)无关")])])])]),t._v(" "),s("blockquote",[s("p",[t._v("所以这里千万不要跟跨域的同源策略搞混，Cookie 只区分域，不区分端口和协议，只要域相同，即使端口号或协议不同，cookie 也能共享。")])]),t._v(" "),s("h3",{attrs:{id:"_1-6-cookie-属性-path"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-cookie-属性-path"}},[t._v("#")]),t._v(" 1.6 Cookie 属性 - Path")]),t._v(" "),s("p",[t._v("这个属性可以指定可以共享 Cookie 的子目录，在开发中其实很少用到，基本上都不设置，默认就是 "),s("code",[t._v("/")]),t._v(" 根目录，"),s("strong",[t._v("因为设置为根目录，所有子目录可以共享")]),t._v("，如果指定子目录的话，其上级目录则无法访问该 Cookie，例如：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setHeader")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Set-Cookie"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name=mrgaogang; Domain=mrgaogang.github.com; Path=/javascript;"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"age=10"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("那么这个 Cookie 只能在目录 "),s("code",[t._v("/javascript")]),t._v(" 以及子目录 "),s("code",[t._v("/javascript/xx/xx")]),t._v(" 中共享。如果访问其他目录，例如根目录 "),s("code",[t._v("/")]),t._v(" 和 "),s("code",[t._v("/ios")]),t._v(" 目录中是看不到的.")]),t._v(" "),s("h3",{attrs:{id:"_1-7-cookie-属性-expires-max-age"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-7-cookie-属性-expires-max-age"}},[t._v("#")]),t._v(" 1.7 Cookie 属性 - Expires/Max-Age")]),t._v(" "),s("p",[t._v("这个属性是用得最多的，用于设置 Cookie 的有效期，如果没有设置，默认是 Session，即会话期间有效。所谓的「会话期间」是指当客户端被关闭时，cookie 就会被移除。但是一定要注意，这个不是严格意义上的浏览器关了，Cookie 就没了，因为：")]),t._v(" "),s("blockquote",[s("p",[s("strong",[t._v("很多 Web 浏览器支持会话恢复功能，用户重新打开浏览器的时候 cookie 也会恢复")]),t._v("。")])]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("Expires 用于指定具体的过期时间")]),t._v("：")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setHeader")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Set-Cookie"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("name=mrgaogang; expires=")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toGMTString")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("blockquote",[s("p",[s("strong",[t._v("注意这里一定要是 "),s("code",[t._v("toGMTString")]),t._v("，写成 "),s("code",[t._v("toISOString")]),t._v(" 的话被认为是会话级别的 Cookie。")])])]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("而 Max-Age 则以秒为单位设置多少秒之后过期，例如 10 秒后过期")]),t._v("：")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setHeader")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Set-Cookie"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name=mrgaogang; max-age=10;"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("不过需要注意：")]),t._v(" "),s("blockquote",[s("p",[s("strong",[t._v("如果 Max-Age 和 Expires 同时存在，那么 Max-Age 优先级更高。")])])]),t._v(" "),s("h3",{attrs:{id:"_1-8-cookie-属性-httponly"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-8-cookie-属性-httponly"}},[t._v("#")]),t._v(" 1.8 Cookie 属性 - HttpOnly")]),t._v(" "),s("p",[t._v("为避免跨域脚本 (XSS) 攻击，通过 "),s("code",[t._v("javascript")]),t._v(" 的 "),s("code",[t._v("document.cookie")]),t._v(" API 无法访问带有 "),s("code",[t._v("HttpOnly")]),t._v(" 标记的 Cookie，它们只应该发送给服务端。如果包含服务端 Session 信息的 Cookie 不想被客户端 JavaScript 脚本调用，那么就应该为其设置 "),s("code",[t._v("HttpOnly")]),t._v(" 标记。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("res.setHeader('Set-Cookie', ['name=mrgaogang; httpOnly=true;', 'age=30'])\n\n")])])]),s("p",[t._v("这个时候通过 "),s("code",[t._v("document.cookie")]),t._v(" 是获取不到 name 值的，只能得到 age。")]),t._v(" "),s("h3",{attrs:{id:"_1-9-cookie-属性-secure"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-9-cookie-属性-secure"}},[t._v("#")]),t._v(" 1.9 Cookie 属性 - Secure")]),t._v(" "),s("p",[t._v("标记为 "),s("code",[t._v("Secure")]),t._v(" 的 "),s("code",[t._v("Cookie")]),t._v(" 只应通过被 "),s("code",[t._v("HTTPS")]),t._v(" 协议加密过的请求发送给服务端。\n。如果服务器是 "),s("code",[t._v("HTTP")]),t._v(" 的，但是设置了 "),s("code",[t._v("Secure")]),t._v(",那么客户端是收不到这个 "),s("code",[t._v("Cookie")]),t._v(" 的;")]),t._v(" "),s("h3",{attrs:{id:"_1-10-cookie-属性-samesite"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-10-cookie-属性-samesite"}},[t._v("#")]),t._v(" 1.10 Cookie 属性 - SameSite")]),t._v(" "),s("p",[s("code",[t._v("SameSite")]),t._v(" : Cookie 允许服务器要求某个 Cookie 在跨站请求时不会被发送，从而可以阻止跨站请求伪造攻击（CSRF）。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Set-Cookie: key=value; SameSite=Strict\n\n")])])]),s("ul",[s("li",[s("code",[t._v("Strict")]),t._v(" 浏览器将只发送相同站点请求的 Cookie(即当前网页 URL 与请求目标 URL 完全一致)。如果请求来自与当前 location 的 URL 不同的 URL，则不包括标记为 Strict 属性的 Cookie；")]),t._v(" "),s("li",[s("code",[t._v("Lax")]),t._v(" 在新版本浏览器中，为"),s("strong",[t._v("默认")]),t._v("选项，Same-site Cookies 将会为一些跨站子请求保留，如"),s("strong",[t._v("图片加载")]),t._v("或者 "),s("strong",[t._v("iframe")]),t._v(" 不会发送，而点击 "),s("code",[t._v("<a>")]),t._v(" 标签会发送；")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("请求类型")]),t._v(" "),s("th",[t._v("示例")]),t._v(" "),s("th",[t._v("正常情况")]),t._v(" "),s("th",[t._v("Lax")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("链接")]),t._v(" "),s("td",[s("code",[t._v('<a href="..."></a>')])]),t._v(" "),s("td",[t._v("发送 Cookie")]),t._v(" "),s("td",[t._v("发送 Cookie")])]),t._v(" "),s("tr",[s("td",[t._v("预加载")]),t._v(" "),s("td",[s("code",[t._v('<link rel="prerender" href="..."/>')])]),t._v(" "),s("td",[t._v("发送 Cookie")]),t._v(" "),s("td",[t._v("发送 Cookie")])]),t._v(" "),s("tr",[s("td",[t._v("GET 表单")]),t._v(" "),s("td",[s("code",[t._v('<form method="GET" action="...">')])]),t._v(" "),s("td",[t._v("发送 Cookie")]),t._v(" "),s("td",[t._v("发送 Cookie")])]),t._v(" "),s("tr",[s("td",[t._v("POST 表单")]),t._v(" "),s("td",[s("code",[t._v('<form method="POST" action="...">')])]),t._v(" "),s("td",[t._v("发送 Cookie")]),t._v(" "),s("td",[t._v("不发送")])]),t._v(" "),s("tr",[s("td",[t._v("iframe")]),t._v(" "),s("td",[s("code",[t._v('<iframe src="..."></iframe>')])]),t._v(" "),s("td",[t._v("发送 Cookie")]),t._v(" "),s("td",[t._v("不发送")])]),t._v(" "),s("tr",[s("td",[t._v("AJAX")]),t._v(" "),s("td",[s("code",[t._v('$.get("...")')])]),t._v(" "),s("td",[t._v("发送 Cookie")]),t._v(" "),s("td",[t._v("不发送")])]),t._v(" "),s("tr",[s("td",[t._v("Image")]),t._v(" "),s("td",[s("code",[t._v('<img src="...">')])]),t._v(" "),s("td",[t._v("发送 Cookie")]),t._v(" "),s("td",[t._v("不发送")])])])]),t._v(" "),s("ul",[s("li",[s("code",[t._v("None")]),t._v(" 浏览器会在同站请求、跨站请求下继续发送 Cookies，不区分大小写；")])]),t._v(" "),s("p",[t._v("需要注意的是，如果设置为 "),s("code",[t._v("None")]),t._v(" 的话，必须开启 "),s("code",[t._v("Secure")]),t._v(" 属性，否则会提示这个警告 ⚠️")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('This Set-Cookie was blocked because it had the "SameSite=None" attribute but did not have the "Secure" attribute, which is required in order to use "SameSite=None"\n\n')])])]),s("p",[s("img",{attrs:{src:"http://img.zlib.cn/blog/cookie-samesite-none.png",alt:""}})]),t._v(" "),s("h2",{attrs:{id:"cookie-和-csrf-攻击"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cookie-和-csrf-攻击"}},[t._v("#")]),t._v(" Cookie 和 CSRF 攻击")]),t._v(" "),s("h3",{attrs:{id:"csrf-的理解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#csrf-的理解"}},[t._v("#")]),t._v(" CSRF 的理解")]),t._v(" "),s("p",[s("code",[t._v("CSRF")]),t._v("，中文名叫跨站请求伪造，发生的场景就是，用户登陆了 a 网站，然后跳转到 b 网站，b 网站直接发送一个 a 网站的请求，进行一些危险操作，就发生了 "),s("code",[t._v("CSRF")]),t._v(" 攻击！\n这时候，懂得这个 "),s("code",[t._v("CSRF")]),t._v(" 了吗？我认为一部分同学依然不懂，因为我看过太多这样的描述了！")]),t._v(" "),s("p",[t._v("因为有这么一些疑惑，"),s("strong",[t._v("为什么在 b 网站可以仿造 a 网站的请求？Cookie 不是跨域的吗？什么条件下，什么场景下，会发生这样的事情？")])]),t._v(" "),s("p",[t._v("这时候，我们要注意上面对 cookie 的定义，"),s("strong",[t._v("在发送一个 http 请求的时候，携带的 cookie 是这个 http 请求域的地址的 cookie")]),t._v("。")]),t._v(" "),s("p",[t._v("也就是我在 b 网站，发送 a 网站的一个请求，携带的是 a 网站域名下的 cookie！很多同学的误解，就是觉得 cookie 是跨域的，b 网站发送任何一个请求，我只能携带 b 网站域名下的 cookie。")]),t._v(" "),s("p",[t._v("当然，我们在 b 网站下，读取 cookie 的时候，只能读取 b 网站域名下的 cookie，这是 cookie 的跨域限制。所以要记住，"),s("strong",[t._v("不要把 http 请求携带的 cookie，和当前域名的访问权限的 cookie 混淆在一起")]),t._v("。")]),t._v(" "),s("p",[t._v("还要理解一个点："),s("strong",[t._v("CSRF 攻击，仅仅是利用了 http 携带 cookie 的特性进行攻击的，但是攻击站点还是无法得到被攻击站点的 cookie。这个和 XSS 不同，XSS 是直接通过拿到 Cookie 等信息进行攻击的")]),t._v("。")]),t._v(" "),s("h3",{attrs:{id:"cookie-相关特性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cookie-相关特性"}},[t._v("#")]),t._v(" Cookie 相关特性？")]),t._v(" "),s("p",[t._v("在 CSRF 攻击中，就 Cookie 相关的特性：")]),t._v(" "),s("p",[t._v("1、http 请求，会自动携带 Cookie。")]),t._v(" "),s("p",[t._v("2、携带的 cookie，还是 http 请求所在域名的 cookie。")]),t._v(" "),s("h3",{attrs:{id:"cookie-如何应对的-csrf-攻击"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cookie-如何应对的-csrf-攻击"}},[t._v("#")]),t._v(" Cookie 如何应对的 CSRF 攻击？")]),t._v(" "),s("p",[t._v("明白了 CSRF 的本质，就能理解如何防御 CSRF 的攻击。")]),t._v(" "),s("p",[s("strong",[t._v("方案一：放弃 Cookie、使用 Token")])]),t._v(" "),s("p",[t._v("由于 CSRF 是通过 Cookie 伪造请求的方式，欺骗服务器，来达到自己的目的。那么我们采取的策略就是，不使用 Cookie 的方式来验证用户身份，我们使用 Token！")]),t._v(" "),s("p",[t._v("Token 的策略，一般就是登陆的时候，服务端在 response 中，返回一个 token 字段，然后以后所有的通信，前端就把这个 "),s("code",[t._v("token")]),t._v(" 添加到 "),s("code",[t._v("http")]),t._v(" 请求的头部。")]),t._v(" "),s("p",[t._v("这是当前，最常用的防御 CSRF 攻击的策略。")]),t._v(" "),s("p",[s("strong",[t._v("方案二：SameSite Cookies")])]),t._v(" "),s("p",[t._v("前面已经介绍了，只能当前域名的网站发出的 http 请求，携带这个 Cookie。")]),t._v(" "),s("p",[t._v("当然，由于这是新的 cookie 属性，在兼容性上肯定会有问题。")]),t._v(" "),s("p",[s("strong",[t._v("方案三：服务端 Referer 验证")])]),t._v(" "),s("p",[t._v("我们发送的 http 请求中，header 中会带有 Referer 字段，这个字段代表的是当前域的域名，服务端可以通过这个字段来判断，是不是“真正”的用户请求。")]),t._v(" "),s("p",[t._v("也就是说，如果 b 网站伪造 a 网站的请求，Referer 字段还是表明，这个请求是 b 网站的。也就能辨认这个请求的真伪了。")]),t._v(" "),s("p",[t._v("不过，目前这种方案，使用的人比较少。可能存在的问题就是，如果连 Referer 字段都能伪造，怎么办？")]),t._v(" "),s("h2",{attrs:{id:"cookie-和-xss-攻击"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cookie-和-xss-攻击"}},[t._v("#")]),t._v(" Cookie 和 XSS 攻击")]),t._v(" "),s("p",[t._v("我们知道攻击者可以通过一系列的手动获取到当前用户的 cookie;那么我们应该如何应对 XSS 攻击呢？")]),t._v(" "),s("h3",{attrs:{id:"_1-使用-cookie-的-httponly"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-使用-cookie-的-httponly"}},[t._v("#")]),t._v(" 1. 使用 Cookie 的 HttpOnly")]),t._v(" "),s("p",[t._v("Cookie 有一个 "),s("code",[t._v("http-only")]),t._v(" 属性，表示只能被 "),s("code",[t._v("http")]),t._v(" 请求携带。")]),t._v(" "),s("p",[t._v("假如你的网站遭受到 "),s("code",[t._v("XSS")]),t._v(" 攻击，攻击者就无法通过 "),s("code",[t._v("document.cookie")]),t._v("得到你的 cookie 信息; 上面已经讲过我们可以设置指定的 cookie 为"),s("code",[t._v("HttpOnly")]),t._v(",这样就可以避免一些隐私数据被获取到。")]),t._v(" "),s("h3",{attrs:{id:"_2-数据转义"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-数据转义"}},[t._v("#")]),t._v(" 2. 数据转义")]),t._v(" "),s("p",[t._v("将特殊自出进行编码")]),t._v(" "),s("p",[t._v("以下表格详细列出了防御 XSS 所需的关键编码方法。")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("编码类型")]),t._v(" "),s("th",[t._v("编码机制")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("HTML 实体编码")]),t._v(" "),s("td",[t._v("把 & 转化为 "),s("code",[t._v("&amp;")]),t._v(" "),s("br"),t._v(" 把 < 转化为 "),s("code",[t._v("&lt;")]),t._v(" "),s("br"),t._v(" 把 > 转化为 "),s("code",[t._v("&gt")]),t._v("; "),s("br"),t._v(' 把 " 转化为 '),s("code",[t._v("&quot;")]),t._v(" "),s("br"),t._v(" 把 ' 转化为 "),s("code",[t._v("&#x27;")]),t._v(" "),s("br"),t._v(" 把 / 转化为 "),s("code",[t._v("&#x2F;")]),t._v(" "),s("br")])]),t._v(" "),s("tr",[s("td",[t._v("HTML 属性编码")]),t._v(" "),s("td",[t._v("除字母数字字符外，请使用 HTML 实体&#xHH;的格式编码所有字符，包括空格。（HH=十六进制值）")])]),t._v(" "),s("tr",[s("td",[t._v("URL 编码")]),t._v(" "),s("td",[t._v("标准编码，请参阅：http://www.w3schools.com/tags/ref_urlencode.asp。"),s("br"),t._v("网址编码只能用于编码参数值，而不能用于 URL 的整个 URL 或路径片段。")])]),t._v(" "),s("tr",[s("td",[t._v("JavaScript 编码")]),t._v(" "),s("td",[t._v("除字母数字字符外，请使用\\uXXXX unicode 转义格式（X=整数）转义所有字符。")])]),t._v(" "),s("tr",[s("td",[t._v("CSS 16 进制编码")]),t._v(" "),s("td",[t._v("除了字母数字字符以外，使用\\HH 格式来转义 ASCII 值小于 256 的所有字符。CSS 转义支持\\XX 和\\XXXXXX。但是这种转义方式可能导致吃字符的问题(例如转义!1111,\\XX1111 可能导致 1111 被吃掉)。有两种解决方案："),s("br"),t._v("（a）在 CSS 转义之后添加一个空格（将被 CSS 解析器忽略，例如\\XX 1111）"),s("br"),t._v("（b）通过零填充使 CSS 转义位数饱和(例如 \\000000XX)。")])])])]),t._v(" "),s("h3",{attrs:{id:"_3-经验总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-经验总结"}},[t._v("#")]),t._v(" 3. 经验总结")]),t._v(" "),s("blockquote",[s("p",[t._v("以下经验总结摘自"),s("a",{attrs:{href:"https://tech.meituan.com/2018/09/27/fe-security.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("《【基本功】 前端安全系列之一：如何防止 XSS 攻击？ | 美团技术团队》"),s("OutboundLink")],1)])]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("利用模板引擎")]),t._v("\n开启模板引擎自带的 HTML 转义功能。例如：在 ejs 中，尽量使用 "),s("code",[t._v("<%= data %>")]),t._v(" 而不是"),s("code",[t._v("<%- data %>")]),t._v("；在 doT.js 中，尽量使用 "),s("code",[t._v("{{! data }")]),t._v(" 而不是 "),s("code",[t._v("{{= data }")]),t._v("。")]),t._v(" "),s("li",[s("strong",[t._v("避免内联事件")]),t._v("\n尽量不要使用 "),s("code",[t._v("onLoad=\"onload('"+t._s(t.data)+"')\"")]),t._v("、"),s("code",[t._v("onClick=\"go('"+t._s(t.action)+"')\"")]),t._v("这种拼接内联事件的写法。在 JavaScript 中通过 "),s("code",[t._v(".addEventlistener()")]),t._v("事件绑定会更安全。")]),t._v(" "),s("li",[s("strong",[t._v("避免拼接 HTML")]),t._v("\n前端采用拼接 HTML 的方法比较危险，如果框架允许，使用 createElement、setAttribute 之类的方法实现。或者采用比较成熟的渲染框架，如 Vue/React 等。")]),t._v(" "),s("li",[s("strong",[t._v("时刻保持警惕")]),t._v("\n在插入位置为 DOM 属性、链接等位置时，要打起精神，严加防范。")]),t._v(" "),s("li",[s("strong",[t._v("增加攻击难度，降低攻击后果")]),t._v("\n通过 CSP、输入长度配置、接口安全措施等方法，增加攻击的难度，降低攻击的后果。")]),t._v(" "),s("li",[s("strong",[t._v("主动检测和发现")]),t._v("\n可使用 XSS 攻击字符串和自动扫描工具寻找潜在的 XSS 漏洞。")])]),t._v(" "),s("h2",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://juejin.cn/post/6863377752939036679",target:"_blank",rel:"noopener noreferrer"}},[t._v("Cookie 属性详解"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://juejin.cn/post/6844904102544031757",target:"_blank",rel:"noopener noreferrer"}},[t._v("彻底理解 Cookie 以及 Cookie 安全"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/lushijie/xss-defense/blob/master/README.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("XSS 防御手册"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=o.exports}}]);