<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>高先生的博客</title>
    <meta name="description" content="旨在分享对技术的了解">
    <link rel="icon" href="/icons/icon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9cfd884fe46fc31072811d47a486a552";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    
    <link rel="preload" href="/assets/css/0.styles.8164cbfa.css" as="style"><link rel="preload" href="/assets/js/app.2111dc5c.js" as="script"><link rel="preload" href="/assets/js/5.74299f27.js" as="script"><link rel="preload" href="/assets/js/3.c83a9e42.js" as="script"><link rel="preload" href="/assets/js/99.f58c3413.js" as="script"><link rel="prefetch" href="/assets/js/1.02e40fdf.js"><link rel="prefetch" href="/assets/js/10.1f2fbf61.js"><link rel="prefetch" href="/assets/js/100.2ede149f.js"><link rel="prefetch" href="/assets/js/101.d7dc53a4.js"><link rel="prefetch" href="/assets/js/102.34b17e29.js"><link rel="prefetch" href="/assets/js/103.552bcd46.js"><link rel="prefetch" href="/assets/js/104.058cbde0.js"><link rel="prefetch" href="/assets/js/105.adb89ae1.js"><link rel="prefetch" href="/assets/js/106.d347866a.js"><link rel="prefetch" href="/assets/js/107.a5e8dc3b.js"><link rel="prefetch" href="/assets/js/108.26237349.js"><link rel="prefetch" href="/assets/js/109.5f106efa.js"><link rel="prefetch" href="/assets/js/11.2854b1bd.js"><link rel="prefetch" href="/assets/js/110.170cee3a.js"><link rel="prefetch" href="/assets/js/111.0bc41f1a.js"><link rel="prefetch" href="/assets/js/112.9ebc696e.js"><link rel="prefetch" href="/assets/js/113.949349a2.js"><link rel="prefetch" href="/assets/js/114.ef9279da.js"><link rel="prefetch" href="/assets/js/115.1ac471ac.js"><link rel="prefetch" href="/assets/js/116.14cd21d2.js"><link rel="prefetch" href="/assets/js/117.aba1a1a9.js"><link rel="prefetch" href="/assets/js/118.e6dd3b5b.js"><link rel="prefetch" href="/assets/js/119.4a132eb8.js"><link rel="prefetch" href="/assets/js/12.c27e0fa6.js"><link rel="prefetch" href="/assets/js/120.f3d300f6.js"><link rel="prefetch" href="/assets/js/121.a1333ee6.js"><link rel="prefetch" href="/assets/js/122.c587305c.js"><link rel="prefetch" href="/assets/js/123.24113716.js"><link rel="prefetch" href="/assets/js/124.c1c51970.js"><link rel="prefetch" href="/assets/js/125.a9f2dee1.js"><link rel="prefetch" href="/assets/js/126.ce922c71.js"><link rel="prefetch" href="/assets/js/127.d5317fcc.js"><link rel="prefetch" href="/assets/js/128.beeb2895.js"><link rel="prefetch" href="/assets/js/129.d2cbad04.js"><link rel="prefetch" href="/assets/js/13.34db5579.js"><link rel="prefetch" href="/assets/js/130.c9b1b54c.js"><link rel="prefetch" href="/assets/js/131.1f24b71c.js"><link rel="prefetch" href="/assets/js/132.829936f5.js"><link rel="prefetch" href="/assets/js/133.24d42a9f.js"><link rel="prefetch" href="/assets/js/134.2d290686.js"><link rel="prefetch" href="/assets/js/135.37016b45.js"><link rel="prefetch" href="/assets/js/136.4d389481.js"><link rel="prefetch" href="/assets/js/137.a100b095.js"><link rel="prefetch" href="/assets/js/138.e5934947.js"><link rel="prefetch" href="/assets/js/139.95ff2d28.js"><link rel="prefetch" href="/assets/js/14.7e002de4.js"><link rel="prefetch" href="/assets/js/140.d8fe155d.js"><link rel="prefetch" href="/assets/js/141.38d51c47.js"><link rel="prefetch" href="/assets/js/142.f9e52cc3.js"><link rel="prefetch" href="/assets/js/143.7a8fdfa0.js"><link rel="prefetch" href="/assets/js/144.d8893ab3.js"><link rel="prefetch" href="/assets/js/145.72261b26.js"><link rel="prefetch" href="/assets/js/146.7611fe52.js"><link rel="prefetch" href="/assets/js/147.9025610e.js"><link rel="prefetch" href="/assets/js/148.38d51659.js"><link rel="prefetch" href="/assets/js/149.eab442cd.js"><link rel="prefetch" href="/assets/js/15.db58275d.js"><link rel="prefetch" href="/assets/js/150.e9ae61db.js"><link rel="prefetch" href="/assets/js/151.5a2267b2.js"><link rel="prefetch" href="/assets/js/152.30624e80.js"><link rel="prefetch" href="/assets/js/153.9296f245.js"><link rel="prefetch" href="/assets/js/154.2ab308ec.js"><link rel="prefetch" href="/assets/js/155.a9e04304.js"><link rel="prefetch" href="/assets/js/156.a0662dfe.js"><link rel="prefetch" href="/assets/js/157.f22bc220.js"><link rel="prefetch" href="/assets/js/158.74cf5977.js"><link rel="prefetch" href="/assets/js/159.55904729.js"><link rel="prefetch" href="/assets/js/16.6232bd7f.js"><link rel="prefetch" href="/assets/js/160.ca3f27af.js"><link rel="prefetch" href="/assets/js/161.7b829601.js"><link rel="prefetch" href="/assets/js/162.44cc734f.js"><link rel="prefetch" href="/assets/js/163.ec35e95f.js"><link rel="prefetch" href="/assets/js/164.fd119e3a.js"><link rel="prefetch" href="/assets/js/165.f757712c.js"><link rel="prefetch" href="/assets/js/166.d5154f02.js"><link rel="prefetch" href="/assets/js/167.108ba85c.js"><link rel="prefetch" href="/assets/js/168.eb2c7ebc.js"><link rel="prefetch" href="/assets/js/169.1a018883.js"><link rel="prefetch" href="/assets/js/17.6b39c822.js"><link rel="prefetch" href="/assets/js/170.781fa1bc.js"><link rel="prefetch" href="/assets/js/171.13951ef0.js"><link rel="prefetch" href="/assets/js/18.e1b9e178.js"><link rel="prefetch" href="/assets/js/19.9439205e.js"><link rel="prefetch" href="/assets/js/2.bc0ed7f5.js"><link rel="prefetch" href="/assets/js/20.ac3bba0f.js"><link rel="prefetch" href="/assets/js/21.a71cae09.js"><link rel="prefetch" href="/assets/js/22.cbc2eba9.js"><link rel="prefetch" href="/assets/js/23.ab3c3e88.js"><link rel="prefetch" href="/assets/js/24.aa112f4c.js"><link rel="prefetch" href="/assets/js/25.21711087.js"><link rel="prefetch" href="/assets/js/26.c5e4d8ef.js"><link rel="prefetch" href="/assets/js/27.9769236b.js"><link rel="prefetch" href="/assets/js/28.19743b59.js"><link rel="prefetch" href="/assets/js/29.2dcb4105.js"><link rel="prefetch" href="/assets/js/30.2edca9d3.js"><link rel="prefetch" href="/assets/js/31.00607cc6.js"><link rel="prefetch" href="/assets/js/32.099f466b.js"><link rel="prefetch" href="/assets/js/33.3226a996.js"><link rel="prefetch" href="/assets/js/34.29ae37dc.js"><link rel="prefetch" href="/assets/js/35.64d31cb7.js"><link rel="prefetch" href="/assets/js/36.70574e97.js"><link rel="prefetch" href="/assets/js/37.dac3cb1a.js"><link rel="prefetch" href="/assets/js/38.2a0f7412.js"><link rel="prefetch" href="/assets/js/39.2ab98348.js"><link rel="prefetch" href="/assets/js/40.c87981e7.js"><link rel="prefetch" href="/assets/js/41.7fa2516c.js"><link rel="prefetch" href="/assets/js/42.4f0bd79b.js"><link rel="prefetch" href="/assets/js/43.3a1f4af7.js"><link rel="prefetch" href="/assets/js/44.200554b7.js"><link rel="prefetch" href="/assets/js/45.781f8292.js"><link rel="prefetch" href="/assets/js/46.64b9f22c.js"><link rel="prefetch" href="/assets/js/47.dd0814fc.js"><link rel="prefetch" href="/assets/js/48.84d01050.js"><link rel="prefetch" href="/assets/js/49.4479fe1a.js"><link rel="prefetch" href="/assets/js/50.417d9420.js"><link rel="prefetch" href="/assets/js/51.82f4a301.js"><link rel="prefetch" href="/assets/js/52.bafd22d3.js"><link rel="prefetch" href="/assets/js/53.a4822b46.js"><link rel="prefetch" href="/assets/js/54.9948abe1.js"><link rel="prefetch" href="/assets/js/55.f9225a40.js"><link rel="prefetch" href="/assets/js/56.1ea15a90.js"><link rel="prefetch" href="/assets/js/57.276890bc.js"><link rel="prefetch" href="/assets/js/58.03df9950.js"><link rel="prefetch" href="/assets/js/59.c6577d89.js"><link rel="prefetch" href="/assets/js/6.ec5c238c.js"><link rel="prefetch" href="/assets/js/60.b25632a0.js"><link rel="prefetch" href="/assets/js/61.8be0f707.js"><link rel="prefetch" href="/assets/js/62.d85f515e.js"><link rel="prefetch" href="/assets/js/63.20c9c14b.js"><link rel="prefetch" href="/assets/js/64.8650787b.js"><link rel="prefetch" href="/assets/js/65.c8f86cb9.js"><link rel="prefetch" href="/assets/js/66.4138964d.js"><link rel="prefetch" href="/assets/js/67.c95541cc.js"><link rel="prefetch" href="/assets/js/68.a8fc656b.js"><link rel="prefetch" href="/assets/js/69.6126ccd9.js"><link rel="prefetch" href="/assets/js/7.00f74c2f.js"><link rel="prefetch" href="/assets/js/70.6711f34b.js"><link rel="prefetch" href="/assets/js/71.1a1592d5.js"><link rel="prefetch" href="/assets/js/72.a80ffb1c.js"><link rel="prefetch" href="/assets/js/73.9033d8cd.js"><link rel="prefetch" href="/assets/js/74.4598e097.js"><link rel="prefetch" href="/assets/js/75.a209a387.js"><link rel="prefetch" href="/assets/js/76.ef675a79.js"><link rel="prefetch" href="/assets/js/77.a573cb36.js"><link rel="prefetch" href="/assets/js/78.f5c8e796.js"><link rel="prefetch" href="/assets/js/79.3416e399.js"><link rel="prefetch" href="/assets/js/8.5953d28c.js"><link rel="prefetch" href="/assets/js/80.d235209d.js"><link rel="prefetch" href="/assets/js/81.7dadd364.js"><link rel="prefetch" href="/assets/js/82.408a8a21.js"><link rel="prefetch" href="/assets/js/83.031528b7.js"><link rel="prefetch" href="/assets/js/84.ca156917.js"><link rel="prefetch" href="/assets/js/85.5186070c.js"><link rel="prefetch" href="/assets/js/86.2515da65.js"><link rel="prefetch" href="/assets/js/87.c9a59c9c.js"><link rel="prefetch" href="/assets/js/88.942a6eaf.js"><link rel="prefetch" href="/assets/js/89.3a245487.js"><link rel="prefetch" href="/assets/js/9.8b63f902.js"><link rel="prefetch" href="/assets/js/90.edda40e6.js"><link rel="prefetch" href="/assets/js/91.e93a6b42.js"><link rel="prefetch" href="/assets/js/92.d2d5707d.js"><link rel="prefetch" href="/assets/js/93.5012022a.js"><link rel="prefetch" href="/assets/js/94.9dd32817.js"><link rel="prefetch" href="/assets/js/95.5acffb37.js"><link rel="prefetch" href="/assets/js/96.8324aa48.js"><link rel="prefetch" href="/assets/js/97.64786b3d.js"><link rel="prefetch" href="/assets/js/98.56db9e4e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8164cbfa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/header.png" alt="高先生的博客" class="logo"> <span class="site-name can-hide">高先生的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="http://gaogangsever.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  页面构建器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/javascript/index.html" class="nav-link">前端</a></div><div class="nav-item"><a href="/vue/index.html" class="nav-link">Vue</a></div><div class="nav-item"><a href="/react/index.html" class="nav-link">React/RN</a></div><div class="nav-item"><a href="/ai/index.html" class="nav-link">AI</a></div><div class="nav-item"><a href="/android/index.html" class="nav-link">Android</a></div><div class="nav-item"><a href="/ios/index.html" class="nav-link">iOS</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">低代码Mendix</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mendix/index.html" class="nav-link">1. Mendix介绍</a></li><li class="dropdown-item"><!----> <a href="/mendix/widgets/index.html" class="nav-link">2. 组件开发</a></li><li class="dropdown-item"><!----> <a href="/mendix/study.html" class="nav-link">3. Mendix学习</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/other/git.html" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/other/vscode.html" class="nav-link">vscode</a></li><li class="dropdown-item"><!----> <a href="https://yeasy.gitbook.io/docker_practice/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  docker
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开源</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/article/oview/index.html" class="nav-link">图表库oView</a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_recyclerview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_recyclerview
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_popup_window" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_popup_window
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/lucky_tools/blob/master/packages/mendix-cli/README.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue开发Mendix组件脚手架
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/cocos-webpack-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cocos web端开发
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/ui-designer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ui 构建器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/KotlinGank" target="_blank" rel="noopener noreferrer" class="nav-link external">
  kotlin App
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/tensorflow_object_detection" target="_blank" rel="noopener noreferrer" class="nav-link external">
  tensorflow object detection
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="http://gaogangsever.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  页面构建器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/javascript/index.html" class="nav-link">前端</a></div><div class="nav-item"><a href="/vue/index.html" class="nav-link">Vue</a></div><div class="nav-item"><a href="/react/index.html" class="nav-link">React/RN</a></div><div class="nav-item"><a href="/ai/index.html" class="nav-link">AI</a></div><div class="nav-item"><a href="/android/index.html" class="nav-link">Android</a></div><div class="nav-item"><a href="/ios/index.html" class="nav-link">iOS</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">低代码Mendix</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mendix/index.html" class="nav-link">1. Mendix介绍</a></li><li class="dropdown-item"><!----> <a href="/mendix/widgets/index.html" class="nav-link">2. 组件开发</a></li><li class="dropdown-item"><!----> <a href="/mendix/study.html" class="nav-link">3. Mendix学习</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/other/git.html" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/other/vscode.html" class="nav-link">vscode</a></li><li class="dropdown-item"><!----> <a href="https://yeasy.gitbook.io/docker_practice/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  docker
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开源</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/article/oview/index.html" class="nav-link">图表库oView</a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_recyclerview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_recyclerview
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_popup_window" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_popup_window
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/lucky_tools/blob/master/packages/mendix-cli/README.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue开发Mendix组件脚手架
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/cocos-webpack-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cocos web端开发
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/ui-designer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ui 构建器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/KotlinGank" target="_blank" rel="noopener noreferrer" class="nav-link external">
  kotlin App
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/tensorflow_object_detection" target="_blank" rel="noopener noreferrer" class="nav-link external">
  tensorflow object detection
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第一部分-作用域和闭包" class="sidebar-link">第一部分 作用域和闭包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第1章-作用域是什么" class="sidebar-link">第1章 作用域是什么</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第2章-词法作用域" class="sidebar-link">第2章 词法作用域</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第3章-函数作用域和块作用域" class="sidebar-link">第3章 函数作用域和块作用域</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第4章-变量和函数提升" class="sidebar-link">第4章 变量和函数提升</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第5章-作用域闭包" class="sidebar-link">第5章 作用域闭包</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#附录a-动态作用域" class="sidebar-link">附录A 动态作用域</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#附录b-块作用域的替代方案" class="sidebar-link">附录B 块作用域的替代方案</a></li></ul></li><li><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第二部分-this和对象原型" class="sidebar-link">第二部分 this和对象原型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第1章-关于this" class="sidebar-link">第1章 关于this</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第2章-this全面解析" class="sidebar-link">第2章 this全面解析</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第3章-对象" class="sidebar-link">第3章 对象</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第4章-混合对象“类”" class="sidebar-link">第4章 混合对象“类”</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第5章-原型" class="sidebar-link">第5章 原型</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#第6章-行为委托" class="sidebar-link">第6章 行为委托</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#附录-a" class="sidebar-link">附录 A</a></li><li class="sidebar-sub-header"><a href="/javascript/base/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Javascript%E4%B8%8A.html#es6-class语法糖" class="sidebar-link">ES6 class语法糖</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>你不知道的JavaScript 上卷</p> <h2 id="第一部分-作用域和闭包"><a href="#第一部分-作用域和闭包" aria-hidden="true" class="header-anchor">#</a> 第一部分 作用域和闭包</h2> <h3 id="第1章-作用域是什么"><a href="#第1章-作用域是什么" aria-hidden="true" class="header-anchor">#</a> 第1章 作用域是什么</h3> <ul><li>问题1：变量储存在哪里？</li> <li>问题2：程序需要时如何找到它们？</li></ul> <h4 id="_1-1-编译原理"><a href="#_1-1-编译原理" aria-hidden="true" class="header-anchor">#</a> 1.1 编译原理</h4> <p>JavaScript语言是“动态”或“解释执行”语言，但事实上是一门编译语言。但它不是提前编译的，编译结果也不能在分布式系统中移植。</p> <p>传统编译语言流程中，程序在执行之前会经历三个步骤，统称为“编译”。</p> <ul><li><p>分词/词法分析（Tokenizing/Lexing）</p> <p>将由字符组成的字符串分解成（对编程语言来说）有意义的代码块。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre></div><p>上面这段程序会被分解成以下词法单元：var、a、=、2、;。</p> <p>空格是否会被当做词法单元，取决于空格在这门语言中是否有意义。</p></li> <li><p>解析/语法分析（Parsing）</p> <p>将词法单元流（数组）转换成一个由元素逐级嵌套所组成的代表了程序语法结构的数。这个数被称作<code>抽象语法树</code>（Abstract Syntax Tree, AST）。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre></div><p>以上代码的抽象语法树如下所示：</p> <ul><li>VariableDeclaration 顶级节点
<ul><li>Identifier 子节点，值为a</li> <li>AssignmentExpression 子节点
<ul><li>NumericLiteral 子节点，字为2</li></ul></li></ul></li></ul></li> <li><p>代码生成</p> <p>将<code>AST</code>转换成可执行代码的过程。过程与语言、目标平台等相关。</p> <p>简单来说就是可以通过某种方法将<code>var a = 2;</code>的AST转化为一组机器指令。用来创建一个叫做a的变量（包括分配内存等），并将一个值存储在a中。</p></li></ul> <h4 id="_1-2-理解作用域"><a href="#_1-2-理解作用域" aria-hidden="true" class="header-anchor">#</a> 1.2 理解作用域</h4> <h5 id="_1-2-1-演员表"><a href="#_1-2-1-演员表" aria-hidden="true" class="header-anchor">#</a> 1.2.1 演员表</h5> <ul><li>引擎：从头到尾负责整个JavaScript程序的编译和执行。</li> <li>编译器：负责语法分析和代码生成等</li> <li>作用域：负责收集并维护由所有声明的标识符（变量、函数）组成的一系列查询，并实施一套非常严格的规则，确定当前执行的代码对这些标识符的访问权限。</li></ul> <h5 id="_1-2-2-对话"><a href="#_1-2-2-对话" aria-hidden="true" class="header-anchor">#</a> 1.2.2 对话</h5> <p><code>var a = 2;</code>存在2个不同的声明。</p> <ul><li><p>1、编译器在编译时处理（<code>var a</code>）：在当前作用域中声明一个变量（如果之前没有声明过）。</p> <div class="language-Flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token punctuation">:</span> Start
e<span class="token operator">=&gt;</span>end<span class="token punctuation">:</span> End
op1<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 分解成词法单元
op2<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 解析成树结构<span class="token constant">AST</span>
cond<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> 当前作用域存在变量a<span class="token operator">?</span>
op3<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 忽略此声明，继续编译
op4<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 在当前作用域集合中声明新变量a
op5<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 生成代码
st<span class="token operator">-</span><span class="token operator">&gt;</span>op1<span class="token operator">-</span><span class="token operator">&gt;</span>op2<span class="token operator">-</span><span class="token operator">&gt;</span>cond
<span class="token function">cond</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op3<span class="token operator">-</span><span class="token operator">&gt;</span>op5<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">cond</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op4<span class="token operator">-</span><span class="token operator">&gt;</span>op5<span class="token operator">-</span><span class="token operator">&gt;</span>e
</code></pre></div></li> <li><p>2、引擎在运行时处理（<code>a = 2</code>）：在作用域中查找该变量，如果找到就对变量赋值。</p></li></ul> <div class="language-Flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token punctuation">:</span> Start
e<span class="token operator">=&gt;</span>end<span class="token punctuation">:</span> End
cond<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> 当前作用域存在变量a<span class="token operator">?</span>
cond2<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> 全局作用域<span class="token operator">?</span>
op1<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 引擎使用这个变量a
op2<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 引擎向上一级作用域查找变量a
op3<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 引擎把<span class="token number">2</span>赋值给变量a
op4<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 举手示意，抛出异常
st<span class="token operator">-</span><span class="token operator">&gt;</span>cond
<span class="token function">cond</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op1<span class="token operator">-</span><span class="token operator">&gt;</span>op3<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">cond</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">cond2</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">op2</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>cond
<span class="token function">cond2</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op4<span class="token operator">-</span><span class="token operator">&gt;</span>e
</code></pre></div><h5 id="_1-2-3-lhs和rhs查询"><a href="#_1-2-3-lhs和rhs查询" aria-hidden="true" class="header-anchor">#</a> 1.2.3 LHS和RHS查询</h5> <p><code>L</code>和<code>R</code>分别代表一个赋值操作的左侧和右侧，当变量出现在赋值操作的左侧时进行<code>LHS</code>查询，出现在赋值操作的**<code>非左侧</code>**时进行<code>RHS</code>查询。</p> <ul><li><p>LHS查询（左侧）：找到变量的容器本身，然后对其赋值</p></li> <li><p>RHS查询（非左侧）：查找某个变量的值，可以理解为 <code>retrieve his source value</code>，即取到它的源值</p></li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上述代码共有1处LHS查询，3处RHS查询。</p> <ul><li><p>LHS查询有：</p> <ul><li>隐式的<code>a = 2</code>中，在<code>2</code>被当做参数传递给<code>foo(…)</code>函数时，需要对参数<code>a</code>进行LHS查询</li></ul></li> <li><p>RHS查询有：</p> <ul><li><p>最后一行<code>foo(...)</code>函数的调用需要对foo进行RHS查询</p></li> <li><p><code>console.log( a );</code>中对<code>a</code>进行RHS查询</p></li> <li><p><code>console.log(...)</code>本身对<code>console</code>对象进行RHS查询</p></li></ul></li></ul> <h4 id="_1-3-作用域嵌套"><a href="#_1-3-作用域嵌套" aria-hidden="true" class="header-anchor">#</a> 1.3 作用域嵌套</h4> <p>遍历嵌套作用域链的规则：引擎从当前的执行作用域开始查找变量，如果找不到就向上一级继续查找。当抵达最外层的全局作用域时，无论找到还是没有找到，查找过程都会停止。</p> <h4 id="_1-4-异常"><a href="#_1-4-异常" aria-hidden="true" class="header-anchor">#</a> 1.4 异常</h4> <p><code>ReferenceError</code>和作用域判别失败相关，<code>TypeError</code>表示作用域判别成功了，但是对结果的操作是非法或不合理的。</p> <ul><li>RHS查询在作用域链中搜索不到所需的变量，引擎会抛出<code>ReferenceError</code>异常。</li> <li>非严格模式下，LHS查询在作用域链中搜索不到所需的变量，全局作用域中会创建一个具有该名称的变量并返还给引擎。</li> <li>严格模式下（ES5开始，禁止自动或隐式地创建全局变量），LHS查询失败会抛出<code>ReferenceError</code>异常</li> <li>在RHS查询成功情况下，对变量进行不合理的操作，引擎会抛出<code>TypeError</code>异常。（比如对非函数类型的值进行函数调用，或者引用null或undefined类型的值中的属性）</li></ul> <h4 id="_1-5-小结"><a href="#_1-5-小结" aria-hidden="true" class="header-anchor">#</a> 1.5 小结</h4> <p><code>var a = 2</code>被分解成2个独立的步骤。</p> <ul><li>1、<code>var a</code>在其作用域中声明新变量</li> <li>2、<code>a = 2</code>会LHS查询a，然后对其进行赋值</li></ul> <h5 id=""><a href="#" aria-hidden="true" class="header-anchor">#</a></h5> <h3 id="第2章-词法作用域"><a href="#第2章-词法作用域" aria-hidden="true" class="header-anchor">#</a> 第2章 词法作用域</h3> <h4 id="_2-1-词法阶段"><a href="#_2-1-词法阶段" aria-hidden="true" class="header-anchor">#</a> 2.1 词法阶段</h4> <p>词法作用域是定义在词法阶段的作用域，是由写代码时将变量和块作用域写在哪里来决定的，所以在词法分析器处理代码时会保持作用域不变。（不考虑欺骗词法作用域情况下）</p> <h5 id="_2-1-1-查找"><a href="#_2-1-1-查找" aria-hidden="true" class="header-anchor">#</a> 2.1.1 查找</h5> <ul><li><p>作用域查找会在找到第一个匹配的标识符时停止。</p></li> <li><p>遮蔽效应：在多层嵌套作用域中可以定义同名的标识符，内部的标识符会“遮蔽”外部的标识符。</p></li> <li><p>全局变量会自动变成全局对象的属性，可以间接的通过对全局对象属性的引用来访问。通过这种技术可以访问那些被同名变量所遮蔽的全局变量，但是非全局的变量如果被遮蔽了，无论如何都无法被访问到。</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span>a
</code></pre></div></li> <li><p>词法作用域只由函数被声明时所处的位置决定。</p></li> <li><p>词法作用域查找只会查找一级标识符，比如a、b、c。对于<code>foo.bar.baz</code>，词法作用域只会查找<code>foo</code>标识符,找到之后，<strong>对象属性访问规则</strong>会分别接管对<code>bar</code>和<code>baz</code>属性的访问。</p></li></ul> <h4 id="_2-2-欺骗词法"><a href="#_2-2-欺骗词法" aria-hidden="true" class="header-anchor">#</a> 2.2 欺骗词法</h4> <p>欺骗词法作用域会导致性能下降。以下两种方法<strong>不推荐使用</strong></p> <h5 id="_2-2-1-eval"><a href="#_2-2-1-eval" aria-hidden="true" class="header-anchor">#</a> 2.2.1 eval</h5> <p><code>eval(..)</code>函数可以接受一个字符串为参数，并将其中的内容视为好像在书写时就存在于程序中这个位置的代码。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span> <span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">,</span> a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">eval</span><span class="token punctuation">(</span> str <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 欺骗！</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a<span class="token punctuation">,</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span> <span class="token string">&quot;var b = 3;&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1, 3</span>
</code></pre></div><p><code>eval('var b = 3')</code>会被当做本来就在那里一样来处理。</p> <ul><li>非严格模式下，如果<code>eval(..)</code>中所执行的代码包含一个或多个声明，会在运行期修改书写期的词法作用域。上述代码中在<code>foo(..)</code>内部创建了一个变量b，并遮蔽了外部作用域中的同名变量。</li> <li>严格模式下，<code>eval(..)</code>在运行时有自己的词法作用域，其中的声明无法修改作用域。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span> 
    <span class="token function">eval</span><span class="token punctuation">(</span> str <span class="token punctuation">)</span><span class="token punctuation">;</span> 
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError: a is not defined</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span> <span class="token string">&quot;var a = 2;&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><ul><li><code>setTimeout(..)</code>和<code>setInterval(..)</code>的第一个参数可以是字符串，会被解释为一段动态生成的函数代码。<strong>已过时，不要使用</strong></li> <li><code>new Function(..)</code>的最后一个参数可以接受代码字符串（前面的参数是新生成的函数的形参）。<strong>避免使用</strong></li></ul> <h5 id="_2-2-2-with"><a href="#_2-2-2-with" aria-hidden="true" class="header-anchor">#</a> 2.2.2 with</h5> <p><code>with</code>通常被当做重复引用同一个对象中的多个属性的快捷方式，可以<strong>不需要重复引用对象本身</strong>。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    c<span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 单调乏味的重复“obj”</span>
obj<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
obj<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
obj<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

<span class="token comment">// 简单的快捷方式</span>
<span class="token keyword">with</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    b <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    c <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>with可以将一个没有或有多个属性的对象处理为一个完全隔离的词法作用域，这个对象的属性会被处理为定义在这个作用域中的词法标识符。</p> <p>这个块内部正常的var声明并不会被限制在这个块的作用域中，而是被添加到with所处的函数作用域中。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">with</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> o1 <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> o2 <span class="token operator">=</span> <span class="token punctuation">{</span>
    b <span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span> o1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> o1<span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

<span class="token function">foo</span><span class="token punctuation">(</span> o2 <span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> o2<span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2 -- 不好，a被泄露到全局作用域上了！</span>
</code></pre></div><p>上面例子中，创建了<code>o1</code>和<code>o2</code>两个对象。其中一个有<code>a</code>属性，另一个没有。在<code>with(obj){..}</code>内部是一个LHS引用，并将2赋值给它。</p> <ul><li><code>o1</code>传递进去后，with声明的作用域是<code>o1</code>,<code>a = 2</code>赋值操作找到<code>o1.a</code>并将2赋值给它。</li> <li><code>o2</code>传递进去后，作用域<code>o2</code>中并没有<code>a</code>属性，因此进行正常的LHS标识符查找，o2的作用域、<code>foo(..)</code>的作用域和全局作用域都没有找到标识符a，因此当<code>a = 2</code>执行时，自动创建了一个全局变量（非严格模式），所以<code>o2.a</code>保持undefined。</li></ul> <h5 id="_2-2-3-性能"><a href="#_2-2-3-性能" aria-hidden="true" class="header-anchor">#</a> 2.2.3 性能</h5> <ul><li>JavaScript引擎会在编译阶段进行数项的性能优化，其中有些优化依赖于能够根据代码的词法进行静态分析，并预先确定所有变量和函数的定义位置，才能在执行过程中快速找到标识符。</li> <li>引擎在代码中发现<code>eval(..)</code>或<code>with</code>，它只能简单的<strong>假设</strong>关于标识符位置的判断都是无效的。因为无法在词法分析阶段明确知道<code>eval(..)</code>会接收到什么代码，这些代码会如何对作用域进行修改，也无法知道传递给<code>with</code>用来创建词法作用域的对象的内容到底是什么。</li> <li>悲观情况下如果出现了<code>eval(..)</code>或with，所有的优化<strong>可能</strong>都是无意义的，最简单的做法就是<strong>完全不做</strong>任何优化。代码运行起来一定会变得非常慢。</li></ul> <h4 id="_2-3-小结"><a href="#_2-3-小结" aria-hidden="true" class="header-anchor">#</a> 2.3 小结</h4> <p>词法作用域意味着作用域是由书写代码时函数声明的位置来决定的。</p> <p>编译的词法分析阶段基本能够知道全部标识符在哪里以及是如何声明的，从而能够预测在执行过程中如何对它们进行查找。</p> <p>有以下两个机制可以“欺骗”词法作用域：</p> <ul><li><code>eval(..)</code>：对一段包含一个或多个声明的”代码“字符串进行演算，借此来修改已经存在的词法作用域（<strong>运行时</strong>）。</li> <li><code>with</code>：将一个对象的引用<strong>当做</strong>作用域来处理，将对象的属性当做作用域中的标识符来处理，创建一个新的词法作用域（<strong>运行时</strong>）。</li></ul> <p>副作用是引擎无法在编译时对作用域查找进行优化。因为引擎只能谨慎地认为这样的优化是无效的，使用任何一个都将导致代码运行变慢。<strong>不要使用它们</strong></p> <h3 id="第3章-函数作用域和块作用域"><a href="#第3章-函数作用域和块作用域" aria-hidden="true" class="header-anchor">#</a> 第3章 函数作用域和块作用域</h3> <h4 id="_3-1-函数中的作用域"><a href="#_3-1-函数中的作用域" aria-hidden="true" class="header-anchor">#</a> 3.1 函数中的作用域</h4> <p>属于这个函数的全部变量都可以在整个函数的范围内使用及复用（事实上在嵌套的作用域中也可以使用）。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 一些代码</span>
    
    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 更多的代码</span>
    
    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>foo(..)</code>作用域中包含了标识符（变量、函数）a、b、c和bar。无论标识符声明出现在作用域中的何处，这个标识符所代表的变量或函数都将附属于所处的作用域。</p> <p>全局作用域只包含一个标识符：<code>foo</code>。</p> <h4 id="_3-2-隐藏内部实现"><a href="#_3-2-隐藏内部实现" aria-hidden="true" class="header-anchor">#</a> 3.2 隐藏内部实现</h4> <p>最小特权原则（最小授权或最小暴露原则）：在软件设计中，应该最小限度地暴露必要内容，而将其他内容都”隐藏“起来，比如某个模块或对象的API设计。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">var</span> b<span class="token punctuation">;</span>
    
    b <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token function">doSomethingElse</span><span class="token punctuation">(</span> a <span class="token operator">*</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> b <span class="token operator">*</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">doSomething</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 15</span>
</code></pre></div><p><code>b</code>和<code>doSomethingElse(..)</code>都无法从外部被访问，而只能被<code>doSomething(..)</code>所控制，设计上将具体内容私有化了。</p> <h5 id="_3-2-1-规避冲突"><a href="#_3-2-1-规避冲突" aria-hidden="true" class="header-anchor">#</a> 3.2.1 规避冲突</h5> <p>”隐藏“作用域中的变量和函数带来的另一个好处是可以避免同名标识符之间的冲突。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 修改for循环所属作用域中的i</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token operator">+</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">bar</span><span class="token punctuation">(</span> i <span class="token operator">*</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 糟糕，无限循环了！</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>bar(..)</code>内部的赋值表达式<code>i = 3</code>意外的覆盖了声明在<code>foo(..)</code>内部for循环中的i。</p> <blockquote><p>解决方案：</p></blockquote> <ul><li>声明一个本地变量，任何名字都可以，例如<code>var i = 3</code>。</li> <li>采用一个完全不同的标识符名称，例如<code>var j = 3</code>。</li></ul> <p>规避变量冲突的典型例子：</p> <ul><li><p>全局命名空间</p> <p>第三方库会在全局作用域中声明一个名字足够独特的变量，通常是一个对象，这个对象被用作库的命名空间，所有需要暴露给外界的功能都会成为这个对象（命名空间）的属性，而不是将自己的标识符暴露在顶级的词法作用域中。</p></li> <li><p>模块管理</p> <p>任何库无需将标识符加入到全局作用域中，而是通过依赖管理器的机制将库的标识符显示的导入到另外一个特定的作用域中。</p></li></ul> <h4 id="_3-3-函数作用域"><a href="#_3-3-函数作用域" aria-hidden="true" class="header-anchor">#</a> 3.3 函数作用域</h4> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// &lt;-- 添加这一行</span>
    
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
    
<span class="token punctuation">}</span> <span class="token comment">// &lt;-- 以及这一行</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- 以及这一行</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><p>上述函数作用域虽然可以将内部的变量和函数定义”隐藏“起来，但是会导致以下2个额外问题。</p> <ul><li>必须声明一个具名函数<code>foo()</code>，意味着<code>foo</code>这个名称本身”污染“了所在的作用域。</li> <li>必须显示地通过函数名<code>foo()</code>调用这个函数才能运行其中的代码。</li></ul> <blockquote><p>解决方案：</p></blockquote> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// &lt;-- 添加这一行</span>
    
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
    
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- 以及这一行</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><p>上述代码包装函数的声明以<code>(function...</code>开始，函数会被当做函数表达式而不是一个标准的函数声明来处理。</p> <ul><li>区分<strong>函数声明</strong>和<strong>函数表达式</strong>最简单的方法是看function关键字出现在声明中的位置（不仅仅是一行代码，而是整个声明中的位置）。
<ul><li>函数声明：<code>function</code>是声明中的第一个词</li> <li>函数表达式：<strong>不是</strong>声明中的第一个词</li></ul></li> <li><strong>函数声明</strong>和<strong>函数表达式</strong>之间最重要的区别是它们的名称标识符将会绑定在何处。
<ul><li>第一个片段中，<code>foo</code>被绑定在所在作用域中，可以直接通过<code>foo()</code>来调用它。</li> <li>第二个片段中，<code>foo</code>被绑定在函数表达式自身的函数中，而不是所在的作用域。<code>(function foo(){ .. }</code>中<code>foo</code>只能在<code>..</code>所代表的位置中被访问，外部作用域不行。<code>foo</code>变量名被隐藏在自身中意味着不会非必要地污染外部作用域。</li></ul></li></ul> <h5 id="_3-3-1-匿名和具名"><a href="#_3-3-1-匿名和具名" aria-hidden="true" class="header-anchor">#</a> 3.3.1 匿名和具名</h5> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;I wait 1 second!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上述是<strong>匿名函数表达式</strong>，因为<code>function()..</code>没有名称标识符。</p> <p>函数表达式可以匿名，但函数声明不可以省略函数名。</p> <p>匿名函数表达式有以下缺点：</p> <ul><li>在栈追踪中不会显示出有意义的函数名，会使得调试困难。</li> <li>没有函数名，当函数需要引用自身时只能使用已经<strong>过期</strong>的<code>arguments.callee</code>引用
<ul><li>递归</li> <li>事件触发后事件监听器需要解绑自身</li></ul></li> <li>匿名函数省略了对于代码可读性/可理解性很重要的函数名。</li></ul> <blockquote><p>解决方案：</p></blockquote> <p><strong>行内函数表达式</strong>可以解决上述问题，始终给函数表达式命名是一个最佳实践。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timeoutHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// &lt;-- 快看，我有名字了！</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;I waited 1 second!&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_3-3-2-立即执行函数表达式"><a href="#_3-3-2-立即执行函数表达式" aria-hidden="true" class="header-anchor">#</a> 3.3.2 立即执行函数表达式</h5> <p>立即执行函数表达式（IIFE，Immediately Invoked Function Expression）</p> <ul><li><p>匿名/具名函数表达式</p> <p>第一个（ ）将函数变成表达式，第二个（ ）执行了这个函数</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token constant">IIFE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
    
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div></li> <li><p>改进型<code>(function(){ .. }())</code></p></li></ul> <p>用来调用的（ ）被移进了用来包装的（ ）中。</p> <ul><li><p>当做函数调用并传递参数进去</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token constant">IIFE</span><span class="token punctuation">(</span> <span class="token parameter">global</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> global<span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span> window <span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div></li> <li><p>解决<code>undefined</code>标识符的默认值被错误覆盖导致的异常</p> <p>将一个参数命名为<code>undefined</code>，但是在对应的位置不传入任何值，这样就可以保证在代码块中<code>undefined</code>标识符的值真的是<code>undefined</code>。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token constant">IIFE</span><span class="token punctuation">(</span> <span class="token parameter"><span class="token keyword">undefined</span></span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">var</span> a<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Undefined is safe here!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>倒置代码的运行顺序，将需要运行的函数放在第二位，在IIFE执行<strong>之后</strong>当做参数传递进去</p> <p>函数表达式<code>def</code>定义在片段的第二部分，然后当做参数（这个参数也叫做def）被传递进IIFE函数定义的第一部分中。最后，参数def（也就是传递进去的函数）被调用，并将window传入当做global参数的值。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token constant">IIFE</span><span class="token punctuation">(</span> <span class="token parameter">def</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">def</span><span class="token punctuation">(</span> window <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">def</span><span class="token punctuation">(</span> <span class="token parameter">global</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
   
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> global<span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h4 id="_3-4-块作用域"><a href="#_3-4-块作用域" aria-hidden="true" class="header-anchor">#</a> 3.4 块作用域</h4> <p>表面上看JavaScript并没有块作用域的相关功能，除非更加深入了解（with、try/catch 、let、const）。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上述代码中<code>i</code>会被绑定在外部作用域（函数或全局）中。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>foo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> bar <span class="token operator">=</span> foo <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
    bar <span class="token operator">=</span> <span class="token function">something</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上述代码中，当使用var声明变量时，它写在哪里都是一样的，因为它们最终都会属于外部作用域。</p> <h5 id="_3-4-1-with"><a href="#_3-4-1-with" aria-hidden="true" class="header-anchor">#</a> 3.4.1 with</h5> <p>块作用域的一种形式，用<code>with</code>从对象中创建出的作用域仅在**<code>with</code>声明中**而非外部作用域中有效。</p> <h5 id="_3-4-2-try-catch"><a href="#_3-4-2-try-catch" aria-hidden="true" class="header-anchor">#</a> 3.4.2 try/catch</h5> <p>ES3规范中规定try/catch的catch分句会创建一个块作用域，其中声明的变量仅在catch中有效。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">undefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行一个非法操作来强制制造一个异常</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 能够正常执行！</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span>； <span class="token comment">// ReferenceError: err not found</span>
</code></pre></div><p>当同一个作用域中的两个或多个catch分句用同样的标识符名称声明错误变量时，很多静态检查工具还是会发出警告，<strong>实际上这并不是重复定义</strong>，因为所有变量都会安全地限制在块作用域内部。</p> <h5 id="_3-4-3-let"><a href="#_3-4-3-let" aria-hidden="true" class="header-anchor">#</a> 3.4.3 let</h5> <p>ES6引入了<code>let</code>关键字，可以将变量绑定到所在的任意作用域中（通常是<code>{ .. }</code>内部），即<code>let</code>为其声明的变量隐式地<strong>劫持</strong>了所在的块作用域。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>foo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> bar <span class="token operator">=</span> foo <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
    bar <span class="token operator">=</span> <span class="token function">something</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
</code></pre></div><blockquote><p>存在的问题</p></blockquote> <p>用<code>let</code>将变量附加在一个已经存在的的块作用域上的行为是隐式的，如果习惯性的移动这些块或者将其包含在其他的块中，可能会导致代码混乱。</p> <blockquote><p>解决方案:
为块作用域显示地创建块。显式的代码优于隐式或一些精巧但不清晰的代码。</p></blockquote> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>foo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span> <span class="token comment">// &lt;-- 显式的块</span>
        <span class="token keyword">let</span> bar <span class="token operator">=</span> foo <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        bar <span class="token operator">=</span> <span class="token function">something</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
</code></pre></div><p>在if声明内部显式地创建了一个块，如果需要对其进行重构，整个块都可以被方便地移动而不会对外部if声明的位置和语义产生任何影响。</p> <p><strong>在let进行的声明不会在块作用域中进行提升</strong></p> <div class="language-Js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
<span class="token keyword">let</span> bar <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>1、垃圾收集</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在这里做点有趣的事情</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> someReallyBigData <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">process</span><span class="token punctuation">(</span> someReallyBigData <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span> <span class="token string">&quot;my_button&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">click</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;button clicked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">/*capturingPhase*/</span><span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>click</code>函数的点击回调并<strong>不需要</strong><code>someReallyBigData</code>。理论上当<code>process(..)</code>执行后，在内存中占用大量空间的数据结构就可以被垃圾回收了。但是，由于<code>click</code>函数形成了一个覆盖整个作用域的闭包，JS引擎极有可能依然保存着这个结构（取决于具体实现）。</p></li> <li><p>2、let循环</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
</code></pre></div><p><code>for循环头部的let不仅将i绑定到了for循环的块中，事实上它将其重新绑定到了循环的每一个迭代中，确保使用上一个循环迭代结束时的值重新进行赋值</code>。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token keyword">let</span> j<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> i <span class="token operator">=</span> j<span class="token punctuation">;</span> <span class="token comment">// 每个迭代重新绑定!</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span> 
   	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h5 id="_3-4-4-const"><a href="#_3-4-4-const" aria-hidden="true" class="header-anchor">#</a> 3.4.4 const</h5> <p>ES6引用了<code>const</code>，可以创建块作用域变量，但其值是固定的（常量）</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 包含在if中的块作用域常量</span>
    
    a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 正常!</span>
    b <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// 错误!</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError!</span>
</code></pre></div><h3 id="第4章-变量和函数提升"><a href="#第4章-变量和函数提升" aria-hidden="true" class="header-anchor">#</a> 第4章 变量和函数提升</h3> <ul><li>任何声明在某个作用域内的变量，都将附属于这个作用域。</li> <li>包括变量和函数在内的所有声明都会在任何代码被执行前首先被处理。</li> <li><code>var a = 2;</code>会被看成两个声明，<code>var a;</code>和<code>a = 2;</code>，第一个声明在<strong>编译阶段</strong>进行，第二个赋值声明会被留在原地等待<strong>执行阶段</strong>。</li> <li>所有的声明（变量和函数）都会被 <strong>“移动”</strong> 到各自作用域的最顶端，这个过程叫做 <strong>提升</strong></li> <li><strong>只有声明本身会被提升，而包括函数表达式在内的赋值或其他运行逻辑并不会提升</strong>。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> a<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">// 实际按如下形式进行处理</span>
<span class="token keyword">var</span> a<span class="token punctuation">;</span> <span class="token comment">// 编译阶段</span>

a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 执行阶段</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><div class="language-Js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefinde</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">// 实际按如下形式进行处理</span>
<span class="token keyword">var</span> a<span class="token punctuation">;</span> <span class="token comment">// 编译</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefinde</span>

a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 执行</span>
</code></pre></div><ul><li>每个作用域都会进行变量提升</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a<span class="token punctuation">;</span>
    
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefinde</span>
    
    a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>函数声明会被提升，但是<strong>函数表达式不会被提升</strong>。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不是ReferenceError，而是TypeError!</span>

<span class="token keyword">var</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>上面这段程序中，变量标识符<code>foo()</code>被提升并分配给所在作用域，因此<code>foo()</code>不会导致ReferenceError。此时<code>foo</code>并没有赋值（<strong>如果它是一个函数声明而不是函数表达式，那么就会赋值</strong>），<code>foo()</code>由于对<code>undefined</code>值进行函数调用而导致非法操作，因此抛出<code>TypeError</code>异常。</p> <ul><li><code>即使是具名的函数表达式，名称标识符在赋值之前也无法在所在作用域中使用</code>。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TypeError</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>

<span class="token keyword">var</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">// 实际按如下形式进行处理</span>
<span class="token keyword">var</span> foo<span class="token punctuation">;</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TypeError</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>

<span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token operator">...</span>self<span class="token operator">...</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_4-1-函数优先"><a href="#_4-1-函数优先" aria-hidden="true" class="header-anchor">#</a> 4.1 函数优先</h4> <ul><li>函数声明和变量声明都会被提升，但是，<strong>函数首先被提升，然后才是变量</strong></li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

<span class="token keyword">var</span> foo<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">// 实际按如下形式进行处理</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 函数提升是整体提升，声明 + 赋值</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

<span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><code>var foo</code>尽管出现在<code>function foo()...</code>的声明之前，但它是重复的声明，且函数声明会被提升到普通变量之前，因此被忽略</li> <li><strong>后面出现的函数声明可以覆盖前面的</strong>。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>一个普通块内部的函数声明通常会被提升到所在作用域的顶部，不会被条件判断所控制。<strong>尽量避免在普通块内部声明函数</strong>。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;b&quot;</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;a&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;b&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="第5章-作用域闭包"><a href="#第5章-作用域闭包" aria-hidden="true" class="header-anchor">#</a> 第5章 作用域闭包</h3> <h4 id="_5-1-闭包"><a href="#_5-1-闭包" aria-hidden="true" class="header-anchor">#</a> 5.1 闭包</h4> <ul><li>当函数可以记住并访问所在的词法作用域，即使函数名是在当前词法作用域之外执行，这时就产生了闭包。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    
    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> bar<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> baz <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2 ---- 这就是闭包的效果</span>
</code></pre></div><p><code>bar()</code>在自己定义的词法作用域以外的地方执行。</p> <p><code>bar()</code>拥有覆盖<code>foo()</code>内部作用域的闭包，使得该作用域能够一直存活，以供<code>bar()</code>在之后任何时间进行引用，不会被垃圾回收器回收</p> <ul><li><code>bar()</code>持有对<code>foo()</code>内部作用域的引用，这个引用就叫做闭包。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// 对函数类型的值进行传递</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    
    <span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">bar</span><span class="token punctuation">(</span> baz <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这就是闭包</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>把内部函数<code>baz</code>传递给<code>bar</code>，当调用这个内部函数时（现在叫做<code>fn</code>），它覆盖的<code>foo()</code>内部作用域的闭包就形成了，因为它能够访问a。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// 间接的传递函数</span>
<span class="token keyword">var</span> fn<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    
    <span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    
    fn <span class="token operator">=</span> baz<span class="token punctuation">;</span> <span class="token comment">// 将baz分配给全局变量</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这就是闭包</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><ul><li>将内部函数传递到所在的词法作用域以外，它都会持有对原始定义作用域的引用，无论在何处执行这个函数都会使用闭包。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> message <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">wait</span><span class="token punctuation">(</span> <span class="token string">&quot;Hello, closure!&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>在引擎内部，内置的工具函数<code>setTimeout(..)</code>持有对一个参数的引用，这里参数叫做timer，引擎会调用这个函数，而词法作用域在这个过程中保持完整。<strong>这就是闭包</strong></li> <li>定时器、事件监听器、Ajax请求、跨窗口通信、Web Workers或者任何其他的异步（或者同步）任务中，只要使用了<strong>回调函数</strong>，实际上就是在使用<strong>闭包</strong>！</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// 典型的闭包例子：IIFE</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token constant">IIFE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_5-2-循环和闭包"><a href="#_5-2-循环和闭包" aria-hidden="true" class="header-anchor">#</a> 5.2 循环和闭包</h4> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> i <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//输入五次6</span>
</code></pre></div><ul><li>延迟函数的回调会在循环结束时才执行，输出显示的是循环结束时<code>i</code>的最终值。</li> <li>尽管循环中的五个函数是在各个迭代中分别定义的，但是它们都被<strong>封闭在一个共享的全局作用域中，因此实际上只有一个<code>i</code></strong>，<strong>若使用let 定义i ，则每次调用都会产生一个单独的块级作用域，就会输出1-5</strong></li></ul> <p>尝试方案1：使用IIFE增加更多的闭包作用域</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span><span class="token punctuation">,</span> i <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//失败，因为IIFE作用域是空的，需要包含一点实质内容才可以使用</span>
</code></pre></div><p>尝试方案2：IIFE增加变量</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> j <span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span><span class="token punctuation">,</span> j <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 正常工作</span>
</code></pre></div><p>尝试方案3：改进型，将<code>i</code>作为参数传递给IIFE函数</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">j</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> j <span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span><span class="token punctuation">,</span> j <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 正常工作</span>
</code></pre></div><h5 id="_5-2-1-块作用域和闭包"><a href="#_5-2-1-块作用域和闭包" aria-hidden="true" class="header-anchor">#</a> 5.2.1 块作用域和闭包</h5> <ul><li><code>let</code>可以用来劫持块作用域，并且在这个块作用域中声明一个变量。</li> <li><strong>本质上这是将一个块转换成一个可以被关闭的作用域</strong></li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span> <span class="token comment">// 闭包的块作用域！</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> j <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> j <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 正常工作</span>
</code></pre></div><ul><li><code>for</code>循环头部的<code>let</code>声明会有一个特殊的行为。变量在循环过程中不止被声明一次，<strong>每次迭代</strong>都会声明。随后的每个迭代都会使用上一个迭代结束时的值来初始化这个变量。</li></ul> <blockquote><p>上面这句话参照3.4.3–---2.let循环，即以下</p></blockquote> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token keyword">let</span> j<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> i <span class="token operator">=</span> j<span class="token punctuation">;</span> <span class="token comment">// 每个迭代重新绑定!</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span> 
   	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>循环改进：</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> i <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 正常工作</span>
</code></pre></div><h4 id="_5-3-模块"><a href="#_5-3-模块" aria-hidden="true" class="header-anchor">#</a> 5.3 模块</h4> <p>模块模式需要具备两个必要条件：</p> <ul><li>必须有外部的封闭函数，该函数必须至少<strong>被调用一次</strong>（每次调用都会创建一个新的模块实例，可以通过IIFE实现单例模式）</li> <li>封闭函数必须<strong>返回至少一个内部函数</strong>，这样内部函数才能在私有作用域中形成闭包，并且可以访问或者修改私有的状态。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">CoolModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> something <span class="token operator">=</span> <span class="token string">&quot;cool&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> another <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> something <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token function">doAnother</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> another<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span> <span class="token string">&quot; ! &quot;</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        doSomething<span class="token punctuation">:</span> doSomething<span class="token punctuation">,</span>
        doAnother<span class="token punctuation">:</span> doAnother
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token function">CoolModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

foo<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// cool</span>
foo<span class="token punctuation">.</span><span class="token function">doAnother</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 ! 2 ! 3</span>

<span class="token comment">// 1、必须通过调用CoolModule()来创建一个模块实例</span>
<span class="token comment">// 2、CoolModule()返回一个对象字面量语法{ key: value, ... }表示的对象，对象中含有对内部函数而不是内部数据变量的引用。内部数据变量保持隐藏且私有的状态。</span>
</code></pre></div><ul><li>使用IIFE实现单例模式</li></ul> <p><strong>立即</strong>调用这个函数并将返回值直接赋予给单例的模块标识符foo。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">CoolModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> something <span class="token operator">=</span> <span class="token string">&quot;cool&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> another <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> something <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token function">doAnother</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> another<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span> <span class="token string">&quot; ! &quot;</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        doSomething<span class="token punctuation">:</span> doSomething<span class="token punctuation">,</span>
        doAnother<span class="token punctuation">:</span> doAnother
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

foo<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// cool</span>
foo<span class="token punctuation">.</span><span class="token function">doAnother</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 ! 2 ! 3</span>
</code></pre></div><h4 id="_5-5-1-现代的模块机制"><a href="#_5-5-1-现代的模块机制" aria-hidden="true" class="header-anchor">#</a> 5.5.1 现代的模块机制</h4> <p>大多数模块依赖加载器/管理器本质上是将这种模块定义封装进一个友好的API。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> MyModules <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">Manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">function</span> <span class="token function">define</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> deps<span class="token punctuation">,</span> impl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
			deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> modules<span class="token punctuation">[</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        modules<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">impl</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> impl<span class="token punctuation">,</span> deps <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 核心，为了模块的定义引用了包装函数(可以传入任何依赖)，并且将返回值(模块的API)，储存在一个根据名字来管理的模块列表中。</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> modules<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        define<span class="token punctuation">:</span> define<span class="token punctuation">,</span>
        <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">get</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用上面的函数来定义模块：</p> <div class="language-Js extra-class"><pre class="language-js"><code>MyModules<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token parameter">who</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Let me introduct: &quot;</span> <span class="token operator">+</span> who<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        hello<span class="token punctuation">:</span> hello
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

MyModules<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;bar&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">bar</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> hungry <span class="token operator">=</span> <span class="token string">&quot;hippo&quot;</span><span class="token punctuation">;</span>
    
    <span class="token keyword">function</span> <span class="token function">awesome</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> bar<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span> hungry <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        awesome<span class="token punctuation">:</span> awesome
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> bar <span class="token operator">=</span> MyModules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token string">&quot;bar&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> MyModules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token string">&quot;foo&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
	bar<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span> <span class="token string">&quot;hippo&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">)</span> <span class="token comment">// Let me introduct: hippo</span>

foo<span class="token punctuation">.</span><span class="token function">awesome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// LET ME INTRODUCT: HIPPO</span>
</code></pre></div><h4 id="_5-5-2-未来的模块机制"><a href="#_5-5-2-未来的模块机制" aria-hidden="true" class="header-anchor">#</a> 5.5.2 未来的模块机制</h4> <p>在通过模块系统进行加载时，ES6会将文件当做独立的模块来处理。每个模块都可以导入其他模块或特定的API成员，同样可以导出自己的API成员。</p> <p>ES6模块没有“行内”格式，必须被定义在独立的文件中（一个文件一个模块）</p> <ul><li>基于函数的模块不能被静态识别（编译器无法识别），只有在运行时才会考虑API语义，因此可以在运行时修改一个模块的API。</li> <li>ES6模块API是静态的（API模块不会在运行时改变），会在编译期检查对导入模块的API成员的引用是否真实存在。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// bar.js</span>

<span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token parameter">who</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;Let me introduct: &quot;</span> <span class="token operator">+</span> who<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> hello<span class="token punctuation">;</span>


<span class="token comment">// foo.js</span>
<span class="token comment">// 仅从“bar”模块导入hello()</span>
<span class="token keyword">import</span> hello <span class="token keyword">from</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> hungry <span class="token operator">=</span> <span class="token string">&quot;hippo&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">awesome</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    	<span class="token function">hello</span><span class="token punctuation">(</span> hungry <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> awesome<span class="token punctuation">;</span>

<span class="token comment">// baz.js</span>
<span class="token comment">// 导入完整的“foo”和”bar“模块</span>
module foo <span class="token keyword">from</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">;</span>
module bar <span class="token keyword">from</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
	bar<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span> <span class="token string">&quot;rhino&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Let me introduct: rhino</span>

foo<span class="token punctuation">.</span><span class="token function">awesome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// LET ME INTRODUCT: HIPPO</span>
</code></pre></div><ul><li><code>import</code>：将一个模块中的一个或多个API导入到当前作用域中，并分别绑定在一个变量上</li> <li><code>module</code>：将整个模块的API导入并绑定到一个变量上。</li> <li><code>export</code>：将当前模块的一个标识符（变量、函数）导出为公共API</li></ul> <h3 id="附录a-动态作用域"><a href="#附录a-动态作用域" aria-hidden="true" class="header-anchor">#</a> 附录A 动态作用域</h3> <ul><li>词法作用域是在写代码或者定义时确定的，关注函数<strong>在何处声明</strong>，作用域链基于代码嵌套。</li> <li>动态作用域是在运行时确定的（<strong>this也是</strong>），关注函数<strong>从何处调用</strong>，作用域链基于调用栈。</li> <li>JavaScript并<strong>不具备</strong>动态作用域，它只有词法作用域。但是<code>this</code>机制某种程度上很像动态作用域。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// 词法作用域，关注函数在何处声明，a通过RHS引用到了全局作用域中的a</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">// 动态作用域，关注函数从何处调用，当foo()无法找到a的变量引用时，会顺着调用栈在调用foo()的地方查找a</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3(不是2！)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="附录b-块作用域的替代方案"><a href="#附录b-块作用域的替代方案" aria-hidden="true" class="header-anchor">#</a> 附录B 块作用域的替代方案</h3> <p>ES3开始，JavaScript中就有了块作用域，包括with和catch分句。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ES6环境</span>
<span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
</code></pre></div><p>上述代码在ES6环境中可以正常工作，但是在ES6之前的环境中如何实现呢？</p> <p>答案是<strong>使用catch分句</strong>，这是ES6中大部分功能迁移的首选方式。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
</code></pre></div><h4 id="b-1-traceur"><a href="#b-1-traceur" aria-hidden="true" class="header-anchor">#</a> B.1 Traceur</h4> <blockquote><p>Google 维护着一个名为Traceur 的项目，该项目正是用来将ES6 代码转换成兼容ES6 之前
的环境;</p></blockquote> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// 代码转换成如下形式</span>
<span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
</code></pre></div><h4 id="b-2-隐式和显式作用域"><a href="#b-2-隐式和显式作用域" aria-hidden="true" class="header-anchor">#</a> B.2 隐式和显式作用域</h4> <p><code>let</code>声明会创建一个显式的作用域并与其进行绑定，而不是隐式地劫持一个已经存在的作用域（对比前面的<code>let</code>定义）。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
</code></pre></div><p>存在的问题：</p> <p><code>let</code>声明不包含在ES6中，Traceur编译器也不接受这种代码</p> <ul><li>方案一：使用合法的ES6语法并且在代码规范上做一些妥协</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">/*let*/</span> <span class="token punctuation">{</span> <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
</code></pre></div><ul><li>方案二：使用let-er工具，生成完全标准的ES6代码，不会生成通过try/catch进行hack的ES3替代方案</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
</code></pre></div><h4 id="b-3-性能"><a href="#b-3-性能" aria-hidden="true" class="header-anchor">#</a> B.3 性能</h4> <ul><li>try/catch的性能的确很糟糕，但技术层面上没有合理的理由来说明try/catch必须这么慢，或者会一直慢下去。</li> <li>IIFE和try/catch不是完全等价的，因为如果把一段代码中的任意一部分拿出来用函数进行包裹，会改变这段代码的含义，其中的this、return、break和continue都会发生变化。IIFE并不是一个普适的方案，只适合在某些情况下进行手动操作。</li></ul> <h2 id="第二部分-this和对象原型"><a href="#第二部分-this和对象原型" aria-hidden="true" class="header-anchor">#</a> 第二部分 this和对象原型</h2> <h3 id="第1章-关于this"><a href="#第1章-关于this" aria-hidden="true" class="header-anchor">#</a> 第1章 关于this</h3> <ul><li><code>this</code>既不指向函数自身也不指向函数的词法作用域</li> <li><code>this</code>实际上是在函数被调用时发生的绑定，它指向什么完全取决于函数在哪里被调用。this和词法作用域是不一样的，不能混合使用。</li> <li>当一个函数被调用时，会创建一个活动记录（执行上下文）。这个记录会包含函数在哪里被调用（调用栈）、函数的调用方式、传入的参数等信息。<strong>this就是这个记录的一个属性</strong>，会在函数执行的过程中用到。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// 使用this，提供一种优雅的方式隐式“传递”一个对象引用。API设计更加简洁并且易于复用。</span>
<span class="token keyword">function</span> <span class="token function">identify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> greeting <span class="token operator">=</span> <span class="token string">&quot;Hello, I'm &quot;</span> <span class="token operator">+</span> <span class="token function">identify</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> greeting <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> me <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">&quot;Kyle&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> you <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">&quot;Reader&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">identify</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> me <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// KYLE</span>
<span class="token function">identify</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> you <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// READER</span>

<span class="token function">speak</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> me <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello, I'm KYLE</span>
<span class="token function">speak</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> you <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello, I'm READER</span>

<span class="token comment">// -----------------------------------------------</span>
<span class="token comment">// 词法作用域方案，显式传递上下文对象方式，会让代码变得越来越混乱</span>
<span class="token keyword">function</span> <span class="token function">identify</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> context<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">speak</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> greeting <span class="token operator">=</span> <span class="token string">&quot;Hello, I'm &quot;</span> <span class="token operator">+</span> <span class="token function">identify</span><span class="token punctuation">(</span> context <span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> greeting <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">identify</span><span class="token punctuation">(</span> you <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// READER</span>
<span class="token function">speak</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> me <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello, I'm KYLE</span>
</code></pre></div><h3 id="第2章-this全面解析"><a href="#第2章-this全面解析" aria-hidden="true" class="header-anchor">#</a> 第2章 this全面解析</h3> <h4 id="_2-1-调用位置"><a href="#_2-1-调用位置" aria-hidden="true" class="header-anchor">#</a> 2.1 调用位置</h4> <p>调用位置就是函数在代码中被调用的位置（而不是声明的位置）。</p> <p>查找方法：</p> <ul><li><p>分析调用栈：调用位置就是当前正在执行的函数的前一个调用中</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前调用栈是：baz</span>
    <span class="token comment">// 因此，当前调用位置是全局作用域</span>
    
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;baz&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- bar的调用位置</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前调用栈是：baz --&gt; bar</span>
    <span class="token comment">// 因此，当前调用位置在baz中</span>
    
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;bar&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- foo的调用位置</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前调用栈是：baz --&gt; bar --&gt; foo</span>
    <span class="token comment">// 因此，当前调用位置在bar中</span>
    
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;foo&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- baz的调用位置</span>
</code></pre></div></li> <li><p>使用开发者工具得到调用栈：</p> <p>设置断点或者插入<code>debugger;</code>语句，运行时调试器会在那个位置暂停，同时展示当前位置的函数调用列表，这就是调用栈。找到栈中的第二个元素，这就是真正的调用位置。</p></li></ul> <h4 id="_2-2-绑定规则"><a href="#_2-2-绑定规则" aria-hidden="true" class="header-anchor">#</a> 2.2 绑定规则</h4> <h5 id="_2-2-1-默认绑定"><a href="#_2-2-1-默认绑定" aria-hidden="true" class="header-anchor">#</a> 2.2.1 默认绑定</h5> <ul><li><strong>独立函数调用</strong>，可以把默认绑定看作是无法应用其他规则时的默认规则，this指向<strong>全局对象</strong>。</li> <li><strong>严格模式</strong>下，不能将全局对象用于默认绑定，this会绑定到<code>undefined</code>。只有函数<strong>运行</strong>在非严格模式下，默认绑定才能绑定到全局对象。在严格模式下<strong>调用</strong>函数则不影响默认绑定。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 运行在严格模式下，this会绑定到undefined</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">// 调用</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TypeError: this is undefined</span>

<span class="token comment">// --------------------------------------</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 运行</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 严格模式下调用函数则不影响默认绑定</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_2-2-2-隐式绑定"><a href="#_2-2-2-隐式绑定" aria-hidden="true" class="header-anchor">#</a> 2.2.2 隐式绑定</h5> <p>当函数引用有<strong>上下文对象</strong>时，隐式绑定规则会把函数中的this绑定到这个上下文对象。<code>对象属性引用链中只有上一层或者说最后一层在调用中起作用</code>。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    foo<span class="token punctuation">:</span> foo
<span class="token punctuation">}</span><span class="token punctuation">;</span>

obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><blockquote><p>隐式丢失</p></blockquote> <p><strong>被隐式绑定的函数特定情况下会丢失绑定对象，应用默认绑定，把this绑定到全局对象或者undefined上</strong>。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// 虽然bar是obj.foo的一个引用，但是实际上，它引用的是foo函数本身。</span>
<span class="token comment">// bar()是一个不带任何修饰的函数调用，应用默认绑定。</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    foo<span class="token punctuation">:</span> foo
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> bar <span class="token operator">=</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">;</span> <span class="token comment">// 函数别名</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">&quot;oops, global&quot;</span><span class="token punctuation">;</span> <span class="token comment">// a是全局对象的属性</span>

<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;oops, global&quot;</span>
</code></pre></div><p><strong>参数传递就是一种隐式赋值，传入函数时也会被隐式赋值。回调函数丢失this绑定是非常常见的</strong>。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">doFoo</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// fn其实引用的是foo</span>
    
    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- 调用位置！</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    foo<span class="token punctuation">:</span> foo
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">&quot;oops, global&quot;</span><span class="token punctuation">;</span> <span class="token comment">// a是全局对象的属性</span>

<span class="token function">doFoo</span><span class="token punctuation">(</span> obj<span class="token punctuation">.</span>foo <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;oops, global&quot;</span>

<span class="token comment">// ----------------------------------------</span>

<span class="token comment">// JS环境中内置的setTimeout()函数实现和下面的伪代码类似：</span>
<span class="token keyword">function</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 等待delay毫秒</span>
    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- 调用位置！</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_2-2-3-显式绑定"><a href="#_2-2-3-显式绑定" aria-hidden="true" class="header-anchor">#</a> 2.2.3 显式绑定</h5> <p>通过<code>call(..)</code> 或者 <code>apply(..)</code>方法。第一个参数是一个对象，在调用函数时将这个对象绑定到this。因为直接指定this的绑定对象，称之为显示绑定。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2  调用foo时强制把foo的this绑定到obj上</span>
</code></pre></div><p><strong>显示绑定无法解决丢失绑定问题</strong>。</p> <p>解决方案：</p> <ul><li>1、硬绑定</li></ul> <p>创建函数bar()，并在它的内部手动调用foo.call(obj)，强制把foo的this绑定到了obj。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">bar</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span> bar<span class="token punctuation">,</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

<span class="token comment">// 硬绑定的bar不可能再修改它的this</span>
<span class="token function">bar</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> window <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><p>典型应用场景是创建一个包裹函数，负责接收参数并返回值。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">something</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">,</span> something <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">+</span> something<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">bar</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> obj<span class="token punctuation">,</span> arguments <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2 3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span>
</code></pre></div><p>创建一个可以重复使用的辅助函数。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">something</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">,</span> something <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">+</span> something<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 简单的辅助绑定函数</span>
<span class="token keyword">function</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> obj<span class="token punctuation">,</span> arguments <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span> foo<span class="token punctuation">,</span> obj <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2 3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span>
</code></pre></div><p>ES5内置了<code>Function.prototype.bind</code>，bind会返回一个硬绑定的新函数，用法如下。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">something</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">,</span> something <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">+</span> something<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2 3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span>
</code></pre></div><ul><li>2、API调用的“上下文”</li></ul> <p>JS许多内置函数提供了一个可选参数，被称之为“上下文”（context），其作用和<code>bind(..)</code>一样，确保回调函数使用指定的this。这些函数实际上通过<code>call(..)</code>和<code>apply(..)</code>实现了显式绑定。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> el<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">&quot;awesome&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 调用foo(..)时把this绑定到obj</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span> foo<span class="token punctuation">,</span> obj <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 1 awesome 2 awesome 3 awesome</span>
</code></pre></div><h5 id="_2-2-4-new绑定"><a href="#_2-2-4-new绑定" aria-hidden="true" class="header-anchor">#</a> 2.2.4 new绑定</h5> <ul><li>在JS中，<code>构造函数</code>只是使用<code>new</code>操作符时被调用的<code>普通</code>函数，他们不属于某个类，也不会实例化一个类。</li> <li>包括内置对象函数（比如<code>Number(..)</code>）在内的所有函数都可以用new来调用，这种函数调用被称为构造函数调用。</li> <li>实际上并不存在所谓的“构造函数”，只有对于函数的“<strong>构造调用</strong>”。</li></ul> <p>使用new来调用函数，或者说发生构造函数调用时，会自动执行下面的操作。</p> <ul><li>1、创建（或者说构造）一个新对象。</li> <li>2、这个新对象会被执行[[Prototype]]连接。</li> <li>3、这个新对象会绑定到函数调用的this。</li> <li>4、如果函数没有返回其他对象，那么new表达式中的函数调用会自动返回这个新对象。</li></ul> <p>使用<code>new</code>来调用<code>foo(..)</code>时，会构造一个新对象并把它（bar）绑定到<code>foo(..)</code>调用中的this。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">foo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bar和foo(..)调用中的this进行绑定</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> bar<span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><h4 id="_2-3-this绑定优先级"><a href="#_2-3-this绑定优先级" aria-hidden="true" class="header-anchor">#</a> 2.3 this绑定优先级</h4> <p><strong>new 绑定 &gt; 显示绑定 &gt; 隐式绑定 &gt; 默认绑定</strong></p> <blockquote><p>现在我们可以根据优先级来判断函数在某个调用位置应用的是哪条规则。可以按照下面的
顺序来进行判断：</p></blockquote> <ol><li>函数是否在new 中调用（new 绑定）？如果是的话this 绑定的是新创建的对象。
var bar = new foo()</li> <li>函数是否通过call、apply（显式绑定）或者硬绑定调用？如果是的话，this 绑定的是
指定的对象。
var bar = foo.call(obj2)</li> <li>函数是否在某个上下文对象中调用（隐式绑定）？如果是的话，this 绑定的是那个上
下文对象。
var bar = obj1.foo()</li> <li>如果都不是的话，使用默认绑定。如果在严格模式下，就绑定到undefined，否则绑定到
全局对象。
var bar = foo()
就是这样。对于正常的函</li></ol> <div class="language-Flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token punctuation">:</span> Start
e<span class="token operator">=&gt;</span>end<span class="token punctuation">:</span> End
cond1<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> <span class="token keyword">new</span>绑定
op1<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> <span class="token keyword">this</span>绑定新创建的对象，
				<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				
cond2<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> 显示绑定
op2<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> <span class="token keyword">this</span>绑定指定的对象，
				<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span>
				
cond3<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> 隐式绑定
op3<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> <span class="token keyword">this</span>绑定上下文对象，
				<span class="token keyword">var</span> bar <span class="token operator">=</span> obj1<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				
op4<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 默认绑定
op5<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 函数体严格模式下绑定到<span class="token keyword">undefined</span>，
				否则绑定到全局对象，
				<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

st<span class="token operator">-</span><span class="token operator">&gt;</span>cond1
<span class="token function">cond1</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op1<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">cond1</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>cond2
<span class="token function">cond2</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op2<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">cond2</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>cond3
<span class="token function">cond3</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op3<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">cond3</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op4<span class="token operator">-</span><span class="token operator">&gt;</span>op5<span class="token operator">-</span><span class="token operator">&gt;</span>e
</code></pre></div><p>在<code>new</code>中使用硬绑定函数的目的是预先设置函数的一些参数，这样在使用new进行初始化时就可以只传入其余的参数（柯里化）。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> p1 <span class="token operator">+</span> p2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 之所以使用null是因为在本例中我们并不关心硬绑定的this是什么</span>
<span class="token comment">// 反正使用new时this会被修改</span>
<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;p1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> baz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">bar</span><span class="token punctuation">(</span> <span class="token string">&quot;p2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

baz<span class="token punctuation">.</span>val<span class="token punctuation">;</span> <span class="token comment">// p1p2</span>
</code></pre></div><h4 id="_2-4-this优先级绑定例外"><a href="#_2-4-this优先级绑定例外" aria-hidden="true" class="header-anchor">#</a> 2.4 this优先级绑定例外</h4> <h5 id="_2-4-1-被忽略的this"><a href="#_2-4-1-被忽略的this" aria-hidden="true" class="header-anchor">#</a> 2.4.1 被忽略的this</h5> <p><strong>把null或者undefined作为this的绑定对象传入call、apply或者bind，这些值在调用时会被忽略，实际应用的是<code>默认规则</code></strong>。</p> <p>下面两种情况下会传入null</p> <ul><li>使用<code>apply(..)</code>来“展开”一个数组，并当作参数传入一个函数</li> <li><code>bind(..)</code>可以对参数进行柯里化（预先设置一些参数）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;a:&quot;</span> <span class="token operator">+</span> a <span class="token operator">+</span> <span class="token string">&quot;，b:&quot;</span> <span class="token operator">+</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 把数组”展开“成参数</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a:2，b:3</span>

<span class="token comment">// 使用bind(..)进行柯里化</span>
<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bar</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a:2，b:3 </span>
</code></pre></div><p>总是传入null来忽略this绑定可能产生一些副作用。如果某个函数确实使用了this，那默认绑定规则会把this绑定到全局对象中。</p> <blockquote><p>更安全的this</p></blockquote> <p>安全的做法就是传入一个特殊的对象（空对象），把this绑定到这个对象不会对你的程序产生任何副作用。</p> <p>JS中创建一个空对象最简单的方法是Object.create(null)，这个和{}很像，但是并不会创建<code>Object.prototype</code>这个委托，所以比{}更空。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;a:&quot;</span> <span class="token operator">+</span> a <span class="token operator">+</span> <span class="token string">&quot;，b:&quot;</span> <span class="token operator">+</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 我们的空对象</span>
<span class="token keyword">var</span> ø <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 把数组”展开“成参数</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> ø<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a:2，b:3</span>

<span class="token comment">// 使用bind(..)进行柯里化</span>
<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span> ø<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bar</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a:2，b:3 </span>
</code></pre></div><h5 id="_2-4-2-间接引用"><a href="#_2-4-2-间接引用" aria-hidden="true" class="header-anchor">#</a> 2.4.2 间接引用</h5> <p>间接引用下，调用这个函数会应用默认绑定规则。间接引用最容易在赋值时发生。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// p.foo = o.foo的返回值是目标函数的引用，所以调用位置是foo()而不是p.foo()或者o.foo()</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> foo<span class="token punctuation">:</span> foo <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

o<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
<span class="token punctuation">(</span>p<span class="token punctuation">.</span>foo <span class="token operator">=</span> o<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><h5 id="_2-4-3-软绑定"><a href="#_2-4-3-软绑定" aria-hidden="true" class="header-anchor">#</a> 2.4.3 软绑定</h5> <ul><li>硬绑定可以把this强制绑定到指定的对象（new除外），防止函数调用应用默认绑定规则。但是会降低函数的灵活性，使用硬绑定之后就无法使用隐式绑定或者显式绑定来修改this。</li> <li><strong>如果给默认绑定指定一个全局对象和undefined以外的值</strong>，那就可以实现和硬绑定相同的效果，同时保留隐式绑定或者显示绑定修改this的能力。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 默认绑定规则，优先级排最后</span>
<span class="token comment">// 如果this绑定到全局对象或者undefined，那就把指定的默认对象obj绑定到this,否则不会修改this</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>softBind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">softBind</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token comment">// 捕获所有curried参数</span>
        <span class="token keyword">var</span> curried <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> arguments<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">var</span> <span class="token function-variable function">bound</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
            	<span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span> <span class="token operator">||</span> <span class="token keyword">this</span> <span class="token operator">===</span> <span class="token punctuation">(</span>window <span class="token operator">||</span> global<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> 
                	obj <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                curried<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> curried<span class="token punctuation">,</span> arguments <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        bound<span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> fn<span class="token punctuation">.</span>prototype <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bound<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用：软绑定版本的foo()可以手动将this绑定到obj2或者obj3上，但如果应用默认绑定，则会将this绑定到obj。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;name:&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;obj&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    obj2 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;obj2&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    obj3 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;obj3&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 默认绑定，应用软绑定，软绑定把this绑定到默认对象obj</span>
<span class="token keyword">var</span> fooOBJ <span class="token operator">=</span> foo<span class="token punctuation">.</span><span class="token function">softBind</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fooOBJ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name: obj </span>

<span class="token comment">// 隐式绑定规则</span>
obj2<span class="token punctuation">.</span>foo <span class="token operator">=</span> foo<span class="token punctuation">.</span><span class="token function">softBind</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span><span class="token punctuation">;</span>
obj2<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name: obj2 &lt;---- 看！！！</span>

<span class="token comment">// 显式绑定规则</span>
<span class="token function">fooOBJ</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> obj3 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name: obj3 &lt;---- 看！！！</span>

<span class="token comment">// 绑定丢失，应用软绑定</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span> obj2<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name: obj</span>
</code></pre></div><h4 id="_2-5-this词法"><a href="#_2-5-this词法" aria-hidden="true" class="header-anchor">#</a> 2.5 this词法</h4> <p>ES6新增一种特殊函数类型：箭头函数，箭头函数无法使用上述四条规则，而是根据外层（函数或者全局）作用域（词法作用域）来决定this.</p> <ul><li>foo()内部创建的箭头函数会捕获调用时foo()的this。由于foo()的this绑定到obj1，bar(引用箭头函数)的this也会绑定到obj1，<strong>箭头函数的绑定无法被修改</strong>(new也不行)。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回一个箭头函数</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// this继承自foo()</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> obj1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bar</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> obj2 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2，不是3！</span>
</code></pre></div><p><strong>箭头函数可以像bind(..) 一样确保函数的this 被绑定到指定对象</strong>
ES6之前和箭头函数类似的模式，采用的是词法作用域取代了传统的this机制。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// lexical capture of this</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> self<span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// self只是继承了foo()函数的this绑定</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><p>代码风格统一问题：如果既有this风格的代码，还会使用 <code>seft = this</code> 或者箭头函数来否定this机制。</p> <ul><li>只使用词法作用域并完全抛弃错误this风格的代码；</li> <li>完全采用this风格，在必要时使用<code>bind(..)</code>，尽量避免使用 <code>self = this</code> 和箭头函数。</li></ul> <h4 id="小结"><a href="#小结" aria-hidden="true" class="header-anchor">#</a> 小结</h4> <blockquote><p>如果要判断一个运行中函数的this 绑定，就需要找到这个函数的直接调用位置。找到之后
就可以顺序应用下面这四条规则来判断this 的绑定对象。</p></blockquote> <ol><li><p>由new 调用？绑定到新创建的对象。</p></li> <li><p>由call 或者apply（或者bind）调用？绑定到指定的对象。</p></li> <li><p>由上下文对象调用？绑定到那个上下文对象。</p></li> <li><p>默认：在严格模式下绑定到undefined，否则绑定到全局对象。</p> <p>一定要注意，有些调用可能在无意中使用默认绑定规则。如果想“更安全”地忽略this 绑
定，你可以使用一个DMZ 对象，比如ø = Object.create(null)，以保护全局对象。</p> <p>ES6 中的箭头函数并不会使用四条标准的绑定规则，而是根据当前的词法作用域来决定
this，具体来说，箭头函数会继承外层函数调用的this 绑定（无论this 绑定到什么）。这
其实和ES6 之前代码中的self = this 机制一样。</p></li></ol> <h3 id="第3章-对象"><a href="#第3章-对象" aria-hidden="true" class="header-anchor">#</a> 第3章 对象</h3> <h4 id="_3-1-语法"><a href="#_3-1-语法" aria-hidden="true" class="header-anchor">#</a> 3.1 语法</h4> <p>文字形式和构造形式生成的对象是一样的。</p> <ul><li><p>文字（声明）形式</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObj <span class="token operator">=</span> <span class="token punctuation">{</span>
    key<span class="token punctuation">:</span> value
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>构造形式</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myObj<span class="token punctuation">.</span>key <span class="token operator">=</span> value<span class="token punctuation">;</span>
</code></pre></div></li></ul> <h4 id="_3-2-类型"><a href="#_3-2-类型" aria-hidden="true" class="header-anchor">#</a> 3.2 类型</h4> <ul><li><p>基本数据类型：<code>string</code>、<code>number</code>、<code>boolean</code>、<code>null</code>、<code>undefined</code>、<code>symbol</code></p> <ul><li>上述6种数据类型本身不是对象，”JS中万物皆是对象“的说法是错误的</li> <li><code>typeof null</code>返回字符串”object“，实际上，<code>null</code>本身是基本数据类型，这是语言本身的一个bug。(原理是这样：<strong>不同的对象在底层都表示为二进制，在JS中二进制前三位都为0的话会被判断为object类型，null的二进制表示是全0，自然前三位也是0，所以执行typeof时会返回”object“</strong>)</li></ul></li> <li><p>引用数据类型：统称为<code>object</code>类型，称作对象子类型（内置对象），细分有<code>String</code>、<code>Number</code>、<code>Boolean</code>、<code>Object</code>、<code>Function</code>、<code>Array</code>、<code>Date</code>、<code>RegExp</code>、<code>Error</code></p></li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> strPrimitive <span class="token operator">=</span> <span class="token string">&quot;I am a string&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">typeof</span> strPrimitive<span class="token punctuation">;</span> <span class="token comment">// &quot;string&quot;</span>
strPrimitive <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">;</span> <span class="token comment">// false</span>

<span class="token keyword">var</span> strObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;I am a string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">typeof</span> strObject<span class="token punctuation">;</span> <span class="token comment">// &quot;object&quot;</span>
strObject <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token comment">// 检查sub-type对象</span>
<span class="token comment">// 可以认为子类型在内部借用了Object中的toString()方法</span>
<span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> strObject <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [object String]</span>
</code></pre></div><p>上述strPrimitive并不是一个对象，只是一个字面量，并且是一个不可变的值。如果需要执行一些操作，比如获取长度、访问其中某个字符等，那需要转换成String对象。</p> <ul><li>JS引擎会自动把字面量转换成String对象，所以可以访问属性和方法。数值字面量和布尔字面量同理。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> strPrimitive <span class="token operator">=</span> <span class="token string">&quot;I am a string&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> strPrimitive<span class="token punctuation">.</span>length <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 13</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> strPrimitive<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;m&quot;</span>
</code></pre></div><ul><li>null和undefined没有对应的构造形式，Date只有构造，没有文字形式。</li> <li>Object、Array、Function和RegExp（正则表达式），无论使用文字形式还是构造形式，它们都是对象，不是字面量。</li></ul> <h4 id="_3-3-内容"><a href="#_3-3-内容" aria-hidden="true" class="header-anchor">#</a> 3.3 内容</h4> <ul><li><p>对象的内容是由一些存储在特定命名位置的值（任意类型的）组成的，称之为<strong>属性</strong>。</p></li> <li><p>引擎内部，属性的值一般不保存在对象容器内部，存储在对象容器内部的是这些属性的名称，通过引用指向这些值真正的存储位置。</p></li> <li><p>.a语法称为”属性访问“，[&quot;a&quot;]语法称为”键访问“。它们访问的是同一个位置。</p></li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

myObject<span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// 2       属性 &lt;----&gt; 值</span>
myObject<span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 2    键  &lt;----&gt; 值</span>
</code></pre></div><ul><li>[&quot;..&quot;]语法使用字符串来访问属性，可以在程序中构造这个字符串</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> idx<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    idx <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 之后</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> myObject<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><ul><li>对象属性名永远是字符串，如果是其他类型，则会转换为一个字符串，数字也不例外。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

myObject<span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">;</span>
myObject<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">;</span>
myObject<span class="token punctuation">[</span>myObject<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;baz&quot;</span><span class="token punctuation">;</span>

myObject<span class="token punctuation">[</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// &quot;foo&quot;;</span>
myObject<span class="token punctuation">[</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// &quot;bar&quot;;</span>
myObject<span class="token punctuation">[</span><span class="token string">&quot;[object Object]&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// &quot;baz&quot;;</span>
</code></pre></div><h5 id="_3-3-1-可计算属性名"><a href="#_3-3-1-可计算属性名" aria-hidden="true" class="header-anchor">#</a> 3.3.1 可计算属性名</h5> <p>ES6增加可计算属性名，可以在文字形式中使用[ ]包裹一个表达式来当做属性名</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> prefix <span class="token operator">=</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>prefix <span class="token operator">+</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>prefix <span class="token operator">+</span> <span class="token string">&quot;baz&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token string">&quot;world&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

myObject<span class="token punctuation">[</span><span class="token string">&quot;foobar&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// hello</span>
myObject<span class="token punctuation">[</span><span class="token string">&quot;foobaz&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// world</span>
</code></pre></div><h5 id="_3-3-2-属性与方法"><a href="#_3-3-2-属性与方法" aria-hidden="true" class="header-anchor">#</a> 3.3.2 属性与方法</h5> <p>技术角度来说，函数永远不会”属于“一个对象。有些函数具有this引用，有时候这些this确实会指向调用位置的对象引用。但是这是this在运行时根据调用位置动态绑定的，本质上并没有把一个函数变成一个”方法“，函数和对象的关系最多只能是间接关系。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;foo&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> someFoo <span class="token operator">=</span> foo<span class="token punctuation">;</span> <span class="token comment">// 对foo的变量引用</span>

<span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    someFoo<span class="token punctuation">:</span> foo
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 对同一个对象的不同引用</span>
foo<span class="token punctuation">;</span> <span class="token comment">// function foo(){..}</span>

someFoo<span class="token punctuation">;</span> <span class="token comment">// function foo(){..}</span>

myObject<span class="token punctuation">.</span>someFoo<span class="token punctuation">;</span> <span class="token comment">// function foo(){..}</span>
</code></pre></div><h5 id="_3-3-3-数组"><a href="#_3-3-3-数组" aria-hidden="true" class="header-anchor">#</a> 3.3.3 数组</h5> <ul><li>数组期望的是数值下标，索引是非负数。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myArray <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

myArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 3</span>

myArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// &quot;foo&quot;</span>

myArray<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// &quot;bar&quot;</span>
</code></pre></div><ul><li>数组也是对象，可以给数组添加属性。（数组的length值并未发生变化）</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myArray <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

myArray<span class="token punctuation">.</span>baz <span class="token operator">=</span> <span class="token string">&quot;baz&quot;</span><span class="token punctuation">;</span>

myArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 3</span>

myArray<span class="token punctuation">.</span>baz<span class="token punctuation">;</span> <span class="token comment">// &quot;baz&quot;</span>
</code></pre></div><ul><li>如果添加的属性名”看起来“像一个数字，那它会变成一个数值下标。会修改数组的内容而不是添加一个属性。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myArray <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

myArray<span class="token punctuation">[</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;baz&quot;</span><span class="token punctuation">;</span>

myArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 4</span>

myArray<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// &quot;baz&quot;</span>
</code></pre></div><h5 id="_3-3-4-复制对象"><a href="#_3-3-4-复制对象" aria-hidden="true" class="header-anchor">#</a> 3.3.4 复制对象</h5> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">anotherFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/*..*/</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> anotherObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> anotherArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span> anotherObject<span class="token punctuation">,</span> <span class="token comment">// 引用，不是复本！</span>
    c<span class="token punctuation">:</span> anotherArray<span class="token punctuation">,</span> <span class="token comment">// 另一个引用！</span>
    d<span class="token punctuation">:</span> anotherFunction
<span class="token punctuation">}</span>

anotherArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> anotherObject<span class="token punctuation">,</span> myObject <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>对于<strong>浅拷贝</strong>（浅复制）：新对象中的a是复制的，但是b、c、d只是三个引用，和旧对象中是一样的。</p> <ul><li><p><code>Object.assign(..)</code>，ES6新增，第一个参数是目标对象，之后跟一个或多个源对象。遍历所有源对象的所有<strong>可枚举</strong>（enumerable）的<strong>自有键</strong>（owned key）,并把它们复制（使用=操作符赋值）到目标对象，最后返回目标对象。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> newObj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> myObject <span class="token punctuation">)</span><span class="token punctuation">;</span>

newObj<span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// 2</span>
newObj<span class="token punctuation">.</span>b <span class="token operator">===</span> anotherObject<span class="token punctuation">;</span> <span class="token comment">// true</span>
newObj<span class="token punctuation">.</span>c <span class="token operator">===</span> anotherArray<span class="token punctuation">;</span> <span class="token comment">// true</span>
newObj<span class="token punctuation">.</span>d <span class="token operator">===</span> anotherFunction<span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div></li></ul></li> <li><p>对于<strong>深拷贝</strong>（深复制）：除了复制myObject以外，还会复制anotherObject和anotherArray，问题在于anotherArray还引用了anotherObject和myObject，这样就由于循环引用导致死循环。</p> <ul><li><p><code>JSON安全</code>（可以被序列化为一个JSON字符串并且可以根据这个字符串解析出一个结构和值完全一样的对象）</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> newObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span> someObj <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul></li></ul> <h5 id="_3-3-5-属性描述符"><a href="#_3-3-5-属性描述符" aria-hidden="true" class="header-anchor">#</a> 3.3.5 属性描述符</h5> <p>ES5开始，所有的属性都具备了属性描述符（数据描述符）。</p> <ul><li><code>Object.getOwnPropertyDescriptor(..)</code>：获取对象属性对应的属性描述符</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span> myObject<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 		value: 2,</span>
<span class="token comment">// 		writable: true,		// 可写</span>
<span class="token comment">// 		enumerable: true,	// 可枚举</span>
<span class="token comment">// 		configurable: true	// 可配置</span>
<span class="token comment">// }</span>
</code></pre></div><ul><li><code>Object.defineProperty(..)</code>：添加新属性或者修改已有属性（configurable为true）</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span> myObject<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>		
	enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>	
	configurable<span class="token punctuation">:</span> <span class="token boolean">true</span>	
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

myObject<span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><ul><li><p>1、<code>Writable</code>：属性的值是否可修改。</p> <ul><li>false时，对于属性值的修改静默失败（silently failed）。严格模式下，产生TypeError错误。</li></ul></li> <li><p>2、<code>configurable</code>：属性是否可配置。</p> <ul><li>true时，使用<code>defineProperty(..)</code>修改属性描述符。</li> <li>false时，尝试使用<code>defineProperty(..)</code>会产生TypeError错误（无论是不是严格模式）。改成false是单向操作，无法撤销！</li> <li>false时，还是可以把<code>writable</code>的状态由true改为false，但是无法由false改为true。</li> <li>false时，禁止删除这个属性。<code>delete myObject.a</code>会静默失败。</li></ul></li> <li><p>3、<code>enumerable</code>：属性是否会出现在对象的属性枚举中，比如说<code>for..in</code>循环</p></li></ul> <h5 id="_3-3-6-不变性"><a href="#_3-3-6-不变性" aria-hidden="true" class="header-anchor">#</a> 3.3.6 不变性</h5> <p>实现属性或者对象不可改变的方法有如下多种，但是所有的方法创建的都是<strong>浅不变性</strong>，只会影响目标对象和它的直接属性。</p> <ul><li><p>1、对象常量</p> <p><code>writable:false</code>和<code>configurable:false</code>可以创建常量属性（不可修改、重定义或者删除）。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span> myObject<span class="token punctuation">,</span> <span class="token string">&quot;FAVORITE_NUMBER&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">,</span>
    writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>2、禁止扩展</p> <p><code>Object.preventExtensions(..)</code>，禁止一个对象添加新属性并且保留已有属性。</p> <p>非严格模式下，创建属性b会静默失败。严格模式下，抛出TypeError错误。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span><span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span> myObject <span class="token punctuation">)</span><span class="token punctuation">;</span>

myObject<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
myObject<span class="token punctuation">.</span>b<span class="token punctuation">;</span> <span class="token comment">// undefined</span>
</code></pre></div></li> <li><p>3、密封</p> <p><code>Object.seal(..)</code>，密封之后不仅不能添加新属性，也不能重新配置或者删除任何现有属性（但是可以修改属性的值）。</p> <p>内部会调用<code>Object.preventExtensions(..)</code>并把所有现有属性标记为<code>configurable:false</code>。</p></li> <li><p>4、冻结</p> <p><code>Object.freeze(..)</code>，禁止对于对象本身及其任意直接属性的修改（引用对象不受影响）。</p> <p>内部调用<code>Object.seal(..)</code>并把所有现有属性标记为<code>writable:false</code>。这样就无法修改属性的值。</p></li> <li><p>5、深度冻结</p> <p>在这个对象上调用<code>Object.freeze(..)</code>，然后遍历它引用的所有对象并在这些对象上调用<code>Object.freeze(..)</code>。但是这样有可能会在无意中冻结其他（共享）对象。</p></li></ul> <h5 id="_3-3-7-get"><a href="#_3-3-7-get" aria-hidden="true" class="header-anchor">#</a> 3.3.7 [[Get]]</h5> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

myObject<span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><ul><li><p>对象默认的[[Get]]操作可以控制属性值的获取</p></li> <li><p><code>myObject.a</code>在myObject上实现了[[Get]]操作（有点像函数调用：<code>[[Get]]()</code>）。</p></li></ul> <div class="language-Flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token punctuation">:</span> Start
e<span class="token operator">=&gt;</span>end<span class="token punctuation">:</span> End
op1<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> myObject<span class="token punctuation">.</span>a执行<span class="token punctuation">[</span><span class="token punctuation">[</span>Get<span class="token punctuation">]</span><span class="token punctuation">]</span>操作
cond1<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> 对象中是否有名称相同的属性
op2<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 查找成功，返回属性值
op3<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 没有找到，遍历可能存在的<span class="token punctuation">[</span><span class="token punctuation">[</span>Prototype<span class="token punctuation">]</span><span class="token punctuation">]</span>链
cond2<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> 原型链是否查找成功
op4<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 最终没有找到，返回<span class="token keyword">undefined</span>
st<span class="token operator">-</span><span class="token operator">&gt;</span>op1<span class="token operator">-</span><span class="token operator">&gt;</span>cond1
<span class="token function">cond1</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op2<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">cond1</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op3<span class="token operator">-</span><span class="token operator">&gt;</span>cond2
<span class="token function">cond2</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op2
<span class="token function">cond2</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op4<span class="token operator">-</span><span class="token operator">&gt;</span>e
</code></pre></div><blockquote><p>变量访问和对象属性访问的区别</p></blockquote> <div class="language-Flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token punctuation">:</span> Start
e<span class="token operator">=&gt;</span>end<span class="token punctuation">:</span> End
cond1<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> 变量访问
op1<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 查找词法作用域
op11<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 对象属性访问
op2<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>Get<span class="token punctuation">]</span><span class="token punctuation">]</span>操作
cond3<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> 是否查找成功
op3<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 查找成功，返回变量值
op4<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 查找失败，抛出
				ReferenceError异常
cond4<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> 是否查找成功
op5<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 查找成功，返回属性值
op6<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 查找失败，
				返回<span class="token keyword">undefined</span>

st<span class="token operator">-</span><span class="token operator">&gt;</span>cond1
<span class="token function">cond1</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op1<span class="token operator">-</span><span class="token operator">&gt;</span>cond3
<span class="token function">cond1</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op11<span class="token operator">-</span><span class="token operator">&gt;</span>op2<span class="token operator">-</span><span class="token operator">&gt;</span>cond4
<span class="token function">cond3</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op3<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">cond3</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op4<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">cond4</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op5<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">cond4</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op6<span class="token operator">-</span><span class="token operator">&gt;</span>e
</code></pre></div><ul><li>由于仅根据返回值无法判断出到底变量的值为undefined还是变量不存在，所以[[Get]]操作返回了undefined</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

myObject<span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// undefined</span>

myObject<span class="token punctuation">.</span>b<span class="token punctuation">;</span> <span class="token comment">// undefined</span>
</code></pre></div><h5 id="_3-3-8-put"><a href="#_3-3-8-put" aria-hidden="true" class="header-anchor">#</a> 3.3.8 [[Put]]</h5> <ul><li>误解：可能会认为给对象的属性赋值会触发[[Put]]来设置或者创建这个属性。实际情况并不完全如此。</li> <li>[[Put]]被触发时，实际行为取决于很多因素，包括对象中是否已经存在这个属性（这是最重要的因素）。</li> <li>对象默认的[[Put]]操作可以控制属性值的设置</li></ul> <div class="language-Flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token punctuation">:</span> Start
e<span class="token operator">=&gt;</span>end<span class="token punctuation">:</span> End
cond1<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> 属性是否存在
op11<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 请看第<span class="token number">5</span>章<span class="token punctuation">[</span><span class="token punctuation">[</span>Prototype<span class="token punctuation">]</span><span class="token punctuation">]</span>
cond2<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> <span class="token function">是否是访问描述符</span>
					<span class="token punctuation">(</span>参见<span class="token number">3.3</span><span class="token number">.9</span><span class="token punctuation">)</span>
op1<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 存在setter就调用setter
cond3<span class="token operator">=&gt;</span>condition<span class="token punctuation">:</span> 数据描述符中
				  writable为<span class="token boolean">false</span>？
op2<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 非严格模式下静默失败，
				严格模式下抛出TypeError异常
op3<span class="token operator">=&gt;</span>operation<span class="token punctuation">:</span> 将该值设置为属性的值

st<span class="token operator">-</span><span class="token operator">&gt;</span>cond1
<span class="token function">cond1</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>cond2
<span class="token function">cond1</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op11
<span class="token function">cond2</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op1<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">cond2</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>cond3
<span class="token function">cond3</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op2<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">cond3</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>op3<span class="token operator">-</span><span class="token operator">&gt;</span>e
</code></pre></div><h5 id="_3-3-9-getter和setter"><a href="#_3-3-9-getter和setter" aria-hidden="true" class="header-anchor">#</a> 3.3.9 Getter和Setter</h5> <ul><li>ES5中可以使用getter和setter部分改写[[Get]]和[[Put]]的默认操作，但是只能应用在单个属性上，无法应用在整个对象上。getter和setter是隐藏函数。</li> <li>当给属性定义getter、setter或者两者都有时，这个属性会被定义为”<strong>访问描述符</strong>“（和”数据描述符“相对）。会忽略它们的value和writable特性。关心的是set和get(还有configurable和enumerable)特性。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// 对象文字语法</span>
<span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 给a定义一个getter</span>
    <span class="token keyword">get</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// defineProperty(..)显式定义</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>
	myObject<span class="token punctuation">,</span>	<span class="token comment">// 目标对象</span>
    <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> 		<span class="token comment">// 属性名</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 给b设置一个getter访问描述符</span>
        <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">*</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        
        <span class="token comment">// 确保b会出现在对象的属性列表中</span>
        enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

myObject<span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// 2</span>

myObject<span class="token punctuation">.</span>b<span class="token punctuation">;</span> <span class="token comment">// 4</span>

myObject<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 没有定义setter，set操作无效</span>

myObject<span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><ul><li>定义setter</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 给a定义一个getter</span>
    <span class="token keyword">get</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_a_<span class="token punctuation">;</span> <span class="token comment">// _a_ 只是一种惯例，没有任何特殊的行为，和其他普通属性一样</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token comment">// 给a定义一个setter</span>
    <span class="token keyword">set</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_a_ <span class="token operator">=</span> val <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

myObject<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

myObject<span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// 4</span>
</code></pre></div><h5 id="_3-3-10-存在性"><a href="#_3-3-10-存在性" aria-hidden="true" class="header-anchor">#</a> 3.3.10 存在性</h5> <ul><li><p><code>in</code>：检查<strong>属性名</strong>是否在对象及其[[Prototype]]原型链中</p> <ul><li>对数组来说，<code>4 in [2, 4, 6]</code>返回false，因为这个数组包含的属性名是0、1、2</li></ul></li> <li><p><code>hasOwnProperty(..)</code>：只会检查属性名是否在对象中</p> <ul><li>对于<code>Object.create(null)</code>对象没有连接到Object.prototype，此时需要<code>Object.prototype.hasOwnProperty.call(myObject, &quot;a&quot;)</code>显式绑定到myObject。</li></ul></li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span> <span class="token keyword">in</span> myObject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span> <span class="token keyword">in</span> myObject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>

myObject<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span> <span class="token string">&quot;a&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
myObject<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span> <span class="token string">&quot;b&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre></div><ul><li><p><code>for..in</code>循环：遍历对象的可枚举<strong>属性名</strong>列表，包括[[Prototype]]原型链。</p> <ul><li>对于数组，不仅会包含所有数值索引，还会包含所有可枚举属性。遍历数组使用传统for循环</li></ul></li> <li><p><code>propertyIsEnumerable(..)</code>：只检查属性名是否在对象中并且<code>enumerable:true</code>。</p></li> <li><p><code>Object.keys(..)</code>：只查找属性名是否在对象中，返回一个数组，包含所有可枚举<strong>属性名</strong>。</p></li> <li><p><code>Object.getOwnPropertyNames(..)</code>：只查找属性名是否在对象中，返回一个数组，包含所有<strong>属性名</strong>，无论是否可枚举。</p></li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span> 
    myObject<span class="token punctuation">,</span> 
    <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> 
    <span class="token comment">// 让a像普通属性一样可以枚举</span>
    <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span> 
    myObject<span class="token punctuation">,</span> 
    <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> 
    <span class="token comment">// 让b不可枚举</span>
    <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>

myObject<span class="token punctuation">.</span>b<span class="token punctuation">;</span> <span class="token comment">// 3</span>
<span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span> <span class="token keyword">in</span> myObject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
myObject<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span> <span class="token string">&quot;b&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token keyword">in</span> myObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> k<span class="token punctuation">,</span> myObject<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// &quot;a&quot; 2</span>

myObject<span class="token punctuation">.</span><span class="token function">propertyIsEnumerable</span><span class="token punctuation">(</span> <span class="token string">&quot;a&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
myObject<span class="token punctuation">.</span><span class="token function">propertyIsEnumerable</span><span class="token punctuation">(</span> <span class="token string">&quot;b&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>

Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span> myObject <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [&quot;a&quot;]</span>
Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span> myObject <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [&quot;a&quot;, &quot;b&quot;]</span>
</code></pre></div><h4 id="_3-4-遍历"><a href="#_3-4-遍历" aria-hidden="true" class="header-anchor">#</a> 3.4 遍历</h4> <p>遍历对象属性时的顺序是不确定的。</p> <ul><li><p><code>forEach(..)</code>遍历数组中的所有值并忽略回调函数的返回值。</p></li> <li><p><code>every(..)</code>一直运行直到回调函数返回false（或者“假”值），会提前终止遍历</p></li> <li><p><code>some(..)</code>一直运行直到回调函数返回true（或者“真”值），会提前终止遍历</p></li> <li><p><code>for..of</code>：直接<strong>遍历值</strong></p> <ul><li><p>数组：直接遍历值而不是数组下标。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myArray <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token keyword">of</span> myArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 1</span>
<span class="token comment">// 2</span>
<span class="token comment">// 3</span>
</code></pre></div><p>数组有内置的<code>@@iterator</code>，因此<code>for..of</code>可以直接应用在数组上。使用ES6的<code>Symbol.iterator</code>来获取对象的<code>@@iterator</code>内部属性。<code>@@iterator</code>本身并不是一个迭代器对象，而是一个<strong>返回迭代器对象的函数</strong>。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// 手动遍历数组</span>
<span class="token keyword">var</span> myArray<span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> it <span class="token operator">=</span> myArray<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 1, done: false }</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 2, done: false }</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 3, done: false }</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { done: true }</span>
</code></pre></div></li> <li><p>对象：定义了迭代器就可以遍历。先向被访问对象请求一个迭代器对象，然后通过调用迭代器对象的<code>next()</code>方法遍历所有值。</p> <p>普通对象没有内置的<code>@@iterator</code>，无法自动完成<code>for..of</code>遍历。</p> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// 手动给对象定义@@iterator</span>

<span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span> myObject<span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">value</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> ks <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span> o <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token function-variable function">next</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span>
                    value<span class="token punctuation">:</span> o<span class="token punctuation">[</span>ks<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    done<span class="token punctuation">:</span> <span class="token punctuation">(</span>idx <span class="token operator">&gt;</span> ks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 结束条件</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 手动遍历myObject</span>
<span class="token keyword">var</span> it <span class="token operator">=</span> myArray<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 2, done: false }</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 3, done: false }</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: undefined, done: true }</span>

<span class="token comment">// 用for..of遍历myObject</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token keyword">of</span> myObject <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 2</span>
<span class="token comment">// 3</span>
</code></pre></div></li></ul></li></ul> <h3 id="第4章-混合对象“类”"><a href="#第4章-混合对象“类”" aria-hidden="true" class="header-anchor">#</a> 第4章 混合对象“类”</h3> <ul><li>类是一种设计模式。许多语言提供了对于面向类软件设计的原生语法。JS也有类似的语法，但是和其他语言中的类完全不同。</li> <li>类意味着复制。</li> <li>传统的类被实例化时，它的行为会被<strong>复制</strong>到实例中。类被继承时，行为也会被<strong>复制</strong>到子类中。</li> <li>多态（在继承链的不同层次名称相同但是功能不同的函数）看起来似乎是从子类引用父类，但是本质上引用的是复制的结果。</li> <li>多态并不表示子类和父类有关联，子类得到的只是父类的一份副本。类的继承其实就是<strong>复制</strong>。</li> <li>JS并不会（像类那样）自动创建对象的副本，不会自动执行复制行为。</li> <li>混入模式（无论显式还是隐式）可以用来模拟类的复制行为，但是通常会产生丑陋并且脆弱的语法，比如显式伪多态（<code>OtherObj.methodName.call(this, ...)</code>）,会让代码更加难懂并且难以维护。</li> <li>显式混入实际上无法完全模拟类的复制行为，因为对象（函数也是对象）只能复制引用，无法复制被引用的对象或者函数本身。</li> <li>在JS中模拟类是得不偿失的。</li></ul> <h4 id="_4-1-混入"><a href="#_4-1-混入" aria-hidden="true" class="header-anchor">#</a> 4.1 混入</h4> <ul><li>混入用来模拟类的复制行为。</li></ul> <h5 id="_4-1-1-显式混入"><a href="#_4-1-1-显式混入" aria-hidden="true" class="header-anchor">#</a> 4.1.1 显式混入</h5> <ul><li>混入处理的已经不再是类了，因为在JS中不存在类，<code>Vehicle</code>和<code>Car</code>都是对象，进行复制和粘贴。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// 非常简单的mixin(..)例子：</span>
<span class="token keyword">function</span> <span class="token function">mixin</span><span class="token punctuation">(</span> <span class="token parameter">sourceObj<span class="token punctuation">,</span> targetObj</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> sourceObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 只会在不存在的情况下复制</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> targetObj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            targetObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> sourceObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> targetObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> Vehicle <span class="token operator">=</span> <span class="token punctuation">{</span>
    engines<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    
    <span class="token function-variable function">ignition</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;Turning on my engine.&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token function-variable function">drive</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ignition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;Steering and moving forward!&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> Car <span class="token operator">=</span> <span class="token function">mixin</span><span class="token punctuation">(</span> Vehicle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    wheels<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    
    <span class="token function-variable function">drive</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Vehicle<span class="token punctuation">.</span><span class="token function">drive</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 显示多态(伪多态)调用，因为Vehicle和Car中都有drive</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        	<span class="token string">&quot;Rolling on all&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wheels <span class="token operator">+</span> <span class="token string">&quot;wheels!&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>另一种混入模式，先复制然后对Car进行特殊化，可以跳过存在性检查。不如第一种方法常用。</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// 可能有重写风险</span>
<span class="token keyword">function</span> <span class="token function">mixin</span><span class="token punctuation">(</span> <span class="token parameter">sourceObj<span class="token punctuation">,</span> targetObj</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> sourceObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        targetObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> sourceObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> targetObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> Vehicle <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 首先创建一个空对象并把Vehicle的内容复制进去</span>
<span class="token keyword">var</span> Car <span class="token operator">=</span> <span class="token function">mixin</span><span class="token punctuation">(</span> Vehicle<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 然后把新内容复制到Car中</span>
<span class="token function">mixin</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>
    wheels<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    
    <span class="token function-variable function">drive</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> Car <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>寄生继承，既是显式的又是隐式的</li></ul> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token comment">// “传统的JS类” Vehicle</span>
<span class="token keyword">function</span> <span class="token function">Vehicle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>engines <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Vehicle</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">ignition</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;Turning on my engine.&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Vehicle</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">drive</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ignition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;Steering and moving forward!&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// &quot;寄生类&quot;Car</span>
<span class="token keyword">function</span> <span class="token function">Car</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 首先，car是一个Vehicle</span>
    <span class="token keyword">var</span> car <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vehicle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 接着我们对car进行定制</span>
    car<span class="token punctuation">.</span>wheels <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 保存到Vehicle::drive()的特殊引用</span>
    <span class="token keyword">var</span> vehDrive <span class="token operator">=</span> car<span class="token punctuation">.</span><span class="token function">drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 重写Vehicle::drive()</span>
    car<span class="token punctuation">.</span><span class="token function-variable function">drive</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">vehDrive</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        	<span class="token string">&quot;Rolling on all &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wheels <span class="token operator">+</span> <span class="token string">&quot; wheels!&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> car<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> myCar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myCar<span class="token punctuation">.</span><span class="token function">drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Turning on my engine.</span>
<span class="token comment">// Steering and moving forward!</span>
<span class="token comment">// Rolling on all 4 wheels!</span>
</code></pre></div><p>调用<code>new Car()</code>时会创建一个新对象并绑定到Car的this上，上述代码没有使用这个新对象而是返回了我们自己的car对象，最初创建的这个对象会被丢弃。因此可以不使用new关键字调用Car()。结果是一致的，但是可以避免创建并丢弃多余的对象。</p> <h5 id="_4-1-2-隐式混入"><a href="#_4-1-2-隐式混入" aria-hidden="true" class="header-anchor">#</a> 4.1.2 隐式混入</h5> <div class="language-Js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Something <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">cool</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>greeting <span class="token operator">=</span> <span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Something<span class="token punctuation">.</span><span class="token function">cool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Something<span class="token punctuation">.</span>greeting<span class="token punctuation">;</span> <span class="token comment">// &quot;Hello World&quot;</span>
Something<span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token comment">// 1</span>

<span class="token keyword">var</span> Another <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">cool</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 隐式把Something混入Another</span>
        Something<span class="token punctuation">.</span><span class="token function">cool</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Another<span class="token punctuation">.</span><span class="token function">cool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Another<span class="token punctuation">.</span>greeting<span class="token punctuation">;</span> <span class="token comment">// &quot;Hello World&quot;</span>
Another<span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token comment">// 1 (count不是共享状态)</span>
</code></pre></div><h3 id="第5章-原型"><a href="#第5章-原型" aria-hidden="true" class="header-anchor">#</a> 第5章 原型</h3> <h4 id="_5-1-prototype"><a href="#_5-1-prototype" aria-hidden="true" class="header-anchor">#</a> 5.1 [[Prototype]]</h4> <blockquote><p><em>使用for..in 遍历对象时原理和查找[[Prototype]] 链类似，任何可以通过原型链访问到
（并且是enumerable，参见第3 章）的属性都会被枚举</em>。<code>使用in 操作符来检查属性在对象中是否存在时，同样会查找对象的整条原型链（无论属性是否可枚举）</code>：</p></blockquote> <h5 id="_5-1-1-object-prototype"><a href="#_5-1-1-object-prototype" aria-hidden="true" class="header-anchor">#</a> 5.1.1 Object.prototype</h5> <blockquote><p>所有普通的[[Prototype]] 链最终都会指向内置的Object.prototype。由于所有的“普通”
（内置，不是特定主机的扩展）对象都“源于”（或者说把[[Prototype]] 链的顶端设置为）
这个Object.prototype 对象.</p></blockquote> <p><img src="https://user-gold-cdn.xitu.io/2019/2/24/1691fc878b9beefa?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""></p> <h5 id="_5-1-2-属性设置和屏蔽"><a href="#_5-1-2-属性设置和屏蔽" aria-hidden="true" class="header-anchor">#</a> 5.1.2 属性设置和屏蔽</h5> <blockquote><p>如果属性名foo 既出现在myObject 中也出现在myObject 的[[Prototype]] 链上层， 那么就会发生屏蔽。</p></blockquote> <blockquote><p>，只读属性会阻止[[Prototype]] 链下层
隐式创建（屏蔽）同名属性。这样做主要是为了模拟类属性的继承。</p></blockquote> <h4 id="_5-2-类"><a href="#_5-2-类" aria-hidden="true" class="header-anchor">#</a> 5.2 &quot;类&quot;</h4> <h5 id="_5-2-1-“类”函数"><a href="#_5-2-1-“类”函数" aria-hidden="true" class="header-anchor">#</a> 5.2.1 “类”函数</h5> <h5 id="_5-2-2-“构造函数”"><a href="#_5-2-2-“构造函数”" aria-hidden="true" class="header-anchor">#</a> 5.2.2 “构造函数”</h5> <blockquote><p>函数不是构造函数，但是当且仅当使用new 时，函数调用会变成“构造函数调用”。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Foo 和你程序中的其他函数没有任何区别。函数本身并不是构造函数，然而，当你在普通的函数调用前面加上<code>new</code>关键字之后，就会把这个函数调用变成一个“构造函数调用”。实际上，<strong>new 会劫持所有普通函数并用构造对象的形式来调用它</strong>。</p></blockquote> <h5 id="_5-2-3-prototype改变导致constructor改变"><a href="#_5-2-3-prototype改变导致constructor改变" aria-hidden="true" class="header-anchor">#</a> 5.2.3 prototype改变导致constructor改变</h5> <blockquote><p>Foo.prototype 的.constructor 属性只是Foo 函数在声明时的默认属性。<strong>如果你创建了一个新对象并替换了函数默认的.prototype 对象引用，那么新对象并不会自动获.constructor 属性。</strong>
思考下面的代码：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* .. */</span> <span class="token punctuation">}</span>
<span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* .. */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个新原型对象</span>
<span class="token keyword">var</span> a1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a1<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Foo<span class="token punctuation">;</span> <span class="token comment">// false!</span>
a1<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Object<span class="token punctuation">;</span> <span class="token comment">// true!</span>
</code></pre></div><p>Object(..) 并没有“构造”a1，对吧？看起来应该是Foo()“构造”了它。大部分开发者
都认为是Foo() 执行了构造工作，但是问题在于，如果你认为“constructor”表示“由……
构造”的话，a1.constructor 应该是Foo，但是它并不是Foo ！</p> <blockquote><p>a1 并没有.constructor 属性，所以它会委托[[Prototype]] 链上的Foo.
prototype。但是这个对象也没有.constructor 属性（不过默认的Foo.prototype 对象有这
个属性！），所以它会继续委托，这次会委托给委托链顶端的Object.prototype。这个对象
有.constructor 属性，指向内置的Object(..) 函数。</p></blockquote> <h4 id="_5-3-（原型）继承-寄生式组合集成详解"><a href="#_5-3-（原型）继承-寄生式组合集成详解" aria-hidden="true" class="header-anchor">#</a> 5.3 （原型）继承(寄生式组合集成详解)</h4> <p><a href="https://github.com/MrGaoGang/lucky_docs/blob/master/article/javascript/Javascript%E5%AF%84%E7%94%9F%E5%BC%8F%E7%BB%84%E5%90%88%E7%BB%A7%E6%89%BF%E8%AF%A6%E8%A7%A3.md" target="_blank" rel="noopener noreferrer">请参考:寄生式组合继承详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="_5-4-对象关联"><a href="#_5-4-对象关联" aria-hidden="true" class="header-anchor">#</a> 5.4 对象关联</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>blah <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们如何通过内省找出a 的“祖先”（委托关联）呢？第一种方法是站在“类”的角度来
判断：</p> <div class="language-js extra-class"><pre class="language-js"><code>a <span class="token keyword">instanceof</span> <span class="token class-name">Foo</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div><p>instanceof 操作符的左操作数是一个普通的对象，右操作数是一个函数。instanceof 回答
的问题是：<strong>在a 的整条[[Prototype]] 链中是否有指向Foo.prototype 的对象？</strong></p> <p>可惜,<strong>这个方法只能处理对象（a）和函数（带.prototype 引用的Foo）之间的关系。如果你想判断两个对象（比如a 和b）之间是否通过[[Prototype]] 链关联，只用instanceof无法实现</strong>。</p> <p>判断两个对象的关联关系常用方法:</p> <ol><li>b.isPrototypeOf( c );</li></ol> <blockquote><p>注意，这个方法并不需要使用函数（“类”），它直接使用b 和c 之间的对象引用来判断它
们的关系</p></blockquote> <ol start="2"><li>Object.getPrototypeOf( a );接获取一个对象的[[Prototype]] 链</li></ol> <h3 id="第6章-行为委托"><a href="#第6章-行为委托" aria-hidden="true" class="header-anchor">#</a> 第6章 行为委托</h3> <h4 id="_6-3-对象关联"><a href="#_6-3-对象关联" aria-hidden="true" class="header-anchor">#</a> 6.3 对象关联</h4> <p><strong>原型模式和对象关联实现继承的区别</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>。下面是典型的（“原型”）面向对象风格：
<span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token parameter">who</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>me <span class="token operator">=</span> who<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">identify</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;I am &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>me<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Bar</span><span class="token punctuation">(</span><span class="token parameter">who</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">,</span> who <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Bar</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> <span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Bar</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">speak</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span> <span class="token string">&quot;Hello, &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">identify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span> <span class="token string">&quot;b1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span> <span class="token string">&quot;b2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
b1<span class="token punctuation">.</span><span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b2<span class="token punctuation">.</span><span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>子类Bar 继承了父类Foo，然后生成了b1 和b2 两个实例。b1 委托了Bar.prototype，后者委托了Foo.prototype。这种风格很常见，你应该很熟悉了。
下面我们看看如何使用对象关联风格来编写功能完全相同的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>Foo <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">init</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">who</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>me <span class="token operator">=</span> who<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">identify</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;I am &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>me<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Bar <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> Foo <span class="token punctuation">)</span><span class="token punctuation">;</span>
Bar<span class="token punctuation">.</span><span class="token function-variable function">speak</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span> <span class="token string">&quot;Hello, &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">identify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b1 <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> Bar <span class="token punctuation">)</span><span class="token punctuation">;</span>
b1<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span> <span class="token string">&quot;b1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b2 <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> Bar <span class="token punctuation">)</span><span class="token punctuation">;</span>

b2<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span> <span class="token string">&quot;b2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
b1<span class="token punctuation">.</span><span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b2<span class="token punctuation">.</span><span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>对象关联可以更好地支持关注分离（separation of concerns）原则，创建和初始化并不需要
合并为一个步骤。</p></blockquote> <h4 id="_6-4-更好的语法"><a href="#_6-4-更好的语法" aria-hidden="true" class="header-anchor">#</a> 6.4 更好的语法</h4> <blockquote><p>ES6 的class 语法可以简洁地定义类方法，这个特性让class 乍看起来更有吸引力（附录A 会介绍为什么要避免使用这个特性）：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>
<span class="token function">methodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* .. */</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>使用简洁方法methodName()存在的问题</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">var</span> Foo <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/*..*/</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">baz</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/*..*/</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>由于函数对象本身没有名称标识符， 所以bar() 的缩写形式
<code>（function()..）</code>实际上会变成一个匿名函数表达式并赋值给bar 属性</p></blockquote> <p><code>匿名函数没有name 标识符</code>，这会导致：</p> <ol><li>调试栈更难追踪；</li> <li>自我引用（递归、事件（解除）绑定，等等）更难；</li> <li>代码（稍微）更难理解。</li></ol> <p><strong>简洁方法会存在第二个问题</strong></p> <blockquote><p>如果你需要自我引用的话，那最好使用传统的具名函
数表达式来定义对应的函数（ · baz: function baz(){..}· ），不要使用简洁方法。</p></blockquote> <h4 id="_6-5-内省"><a href="#_6-5-内省" aria-hidden="true" class="header-anchor">#</a> 6.5 内省</h4> <ol><li>避免使用</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>a1<span class="token punctuation">.</span>something<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a1<span class="token punctuation">.</span><span class="token function">something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>推荐使用isPrototypeOf和getPrototypeOf</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 让Foo 和Bar 互相关联</span>
Foo<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span> Bar <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span> Bar <span class="token punctuation">)</span> <span class="token operator">===</span> Foo<span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token comment">// 让b1 关联到Foo 和Bar</span>
Foo<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span> b1 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
Bar<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span> b1 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span> b1 <span class="token punctuation">)</span> <span class="token operator">===</span> Bar<span class="token punctuation">;</span> <span class="token comment">// true</span>

</code></pre></div><h3 id="附录-a"><a href="#附录-a" aria-hidden="true" class="header-anchor">#</a> 附录 A</h3> <h3 id="es6-class语法糖"><a href="#es6-class语法糖" aria-hidden="true" class="header-anchor">#</a> ES6 class语法糖</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Widget</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">width<span class="token punctuation">,</span>height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width <span class="token operator">||</span> <span class="token number">50</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height <span class="token operator">||</span> <span class="token number">50</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">$where</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>
        width<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span>
        <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendTo</span><span class="token punctuation">(</span> $where <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Button</span> <span class="token keyword">extends</span> <span class="token class-name">Widget</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">width<span class="token punctuation">,</span>height<span class="token punctuation">,</span>label</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span> width<span class="token punctuation">,</span> height <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>label <span class="token operator">=</span> label <span class="token operator">||</span> <span class="token string">&quot;Default&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span> <span class="token string">&quot;&lt;button&gt;&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>label <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">$where</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span> $where <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;Button '&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>label <span class="token operator">+</span> <span class="token string">&quot;' clicked!&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>语法糖的优点</strong></p> <ol><li>不再引用杂乱的.prototype 了。</li> <li>Button 声明时直接“ 继承” 了Widget， 不再需要通过Object.create(..) 来替
换.prototype 对象，也不需要设置.<strong>proto</strong> 或者Object.setPrototypeOf(..)。</li> <li>可以通过super(..) 来实现相对多态，这样任何方法都可以引用原型链上层的同名方
法。这可以解决第4 章提到过的那个问题：构造函数不属于类，所以无法互相引用——super() 可以完美解决构造函数的问题。</li> <li>class 字面语法不能声明属性（只能声明方法）。</li> <li>可以通过extends 很自然地扩展对象（子）类型，甚至是内置的对象（子）类型，比如
rray 或RegExp。</li></ol> <p><strong>语法糖存在的问题</strong></p> <ol><li><p><code>class并不会像传统面向类的语言一样在声明时静态复制所有行为</code>。如果你（有意或无意）修改或者替换了父“类”中的一个方法，那子“类”和所有实例都会受到影响，<strong>因为它们在定义时并没有进行复制，只是使用基于[[Prototype]] 的实时委托</strong>;</p></li> <li><p>意外屏蔽问题。</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 噢，郁闷，我们的id 属性屏蔽了id() 方法</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;Id: &quot;</span> <span class="token operator">+</span> id <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> c1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">C</span><span class="token punctuation">(</span> <span class="token string">&quot;c1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
c1<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TypeError -- c1.id 现在是字符串&quot;c1</span>

</code></pre></div><p><a href="https://github.com/yygmind/Reading-Notes/edit/master/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84JavaScript%E4%B8%8A%E5%8D%B7.md" target="_blank" rel="noopener noreferrer">参考:你不知道的JavaScript上卷<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2/18/2021, 12:58:04 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.2111dc5c.js" defer></script><script src="/assets/js/5.74299f27.js" defer></script><script src="/assets/js/3.c83a9e42.js" defer></script><script src="/assets/js/99.f58c3413.js" defer></script>
  </body>
</html>
