<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>react-native bundle 到 bundle 生成到底发生了什么(metro 打包流程简析) | 高小哥漫谈前端</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/icons/icon.png">
    <script src="/jquery/jquery.slim.min.js"></script>
    <script src="/card-link/index.js"></script>
    <script src="/readmore/index.js"></script>
    <link rel="stylesheet" type="text/css" href="/jquery/jquery.fancybox.min.css">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9cfd884fe46fc31072811d47a486a552";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9b661d4664669986af91448c055407cb";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script src="/jquery/jquery.fancybox.min.js"></script>
    <meta name="description" content="旨在分享对技术的了解">
    <meta name="google-site-verification" content="Wb79TZlc0Jau32a2Iph43MkdTZTvx75ZdHEOvRmxuoo">
    <meta name="baidu-site-verification" content="code-V304SBt3wm">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.10be55ec.css" as="style"><link rel="preload" href="/assets/js/app.73ea5e02.js" as="script"><link rel="preload" href="/assets/js/6.289073ab.js" as="script"><link rel="preload" href="/assets/js/4.8a11a086.js" as="script"><link rel="preload" href="/assets/js/62.176b4934.js" as="script"><link rel="prefetch" href="/assets/js/1.1010c392.js"><link rel="prefetch" href="/assets/js/10.8e0be931.js"><link rel="prefetch" href="/assets/js/100.7a6820de.js"><link rel="prefetch" href="/assets/js/101.33dd8399.js"><link rel="prefetch" href="/assets/js/102.4e13a0ac.js"><link rel="prefetch" href="/assets/js/103.997d08cc.js"><link rel="prefetch" href="/assets/js/104.71ca249e.js"><link rel="prefetch" href="/assets/js/105.723f6541.js"><link rel="prefetch" href="/assets/js/106.479d3aff.js"><link rel="prefetch" href="/assets/js/107.07515053.js"><link rel="prefetch" href="/assets/js/108.14b8cd66.js"><link rel="prefetch" href="/assets/js/109.3da2d7bb.js"><link rel="prefetch" href="/assets/js/11.2fed4497.js"><link rel="prefetch" href="/assets/js/110.1bc45435.js"><link rel="prefetch" href="/assets/js/111.f609f969.js"><link rel="prefetch" href="/assets/js/112.e26e514d.js"><link rel="prefetch" href="/assets/js/113.8bcecedc.js"><link rel="prefetch" href="/assets/js/114.6d567640.js"><link rel="prefetch" href="/assets/js/115.09da8441.js"><link rel="prefetch" href="/assets/js/116.f5e5c05b.js"><link rel="prefetch" href="/assets/js/117.a73daa2f.js"><link rel="prefetch" href="/assets/js/118.39479ffc.js"><link rel="prefetch" href="/assets/js/119.aad5e206.js"><link rel="prefetch" href="/assets/js/12.7f1ff3f5.js"><link rel="prefetch" href="/assets/js/120.5a402eea.js"><link rel="prefetch" href="/assets/js/121.bc7cb7e4.js"><link rel="prefetch" href="/assets/js/122.2467b338.js"><link rel="prefetch" href="/assets/js/123.9f4ac2a4.js"><link rel="prefetch" href="/assets/js/124.6d819779.js"><link rel="prefetch" href="/assets/js/125.81459211.js"><link rel="prefetch" href="/assets/js/126.4b8aa4ec.js"><link rel="prefetch" href="/assets/js/127.8db1a036.js"><link rel="prefetch" href="/assets/js/128.ef686824.js"><link rel="prefetch" href="/assets/js/129.425c1cb5.js"><link rel="prefetch" href="/assets/js/13.a11aa5f3.js"><link rel="prefetch" href="/assets/js/130.6b0f6266.js"><link rel="prefetch" href="/assets/js/131.a73c7b27.js"><link rel="prefetch" href="/assets/js/132.5d3f6bf5.js"><link rel="prefetch" href="/assets/js/133.f37b61bb.js"><link rel="prefetch" href="/assets/js/134.261e944e.js"><link rel="prefetch" href="/assets/js/135.f8104638.js"><link rel="prefetch" href="/assets/js/136.375682a3.js"><link rel="prefetch" href="/assets/js/137.2acf5c54.js"><link rel="prefetch" href="/assets/js/138.31007c48.js"><link rel="prefetch" href="/assets/js/139.1a9d22d7.js"><link rel="prefetch" href="/assets/js/14.988fdb7e.js"><link rel="prefetch" href="/assets/js/140.7dcf7f1c.js"><link rel="prefetch" href="/assets/js/141.d314e1bf.js"><link rel="prefetch" href="/assets/js/142.09c070e1.js"><link rel="prefetch" href="/assets/js/143.f41e0be4.js"><link rel="prefetch" href="/assets/js/144.a791182e.js"><link rel="prefetch" href="/assets/js/145.f772c0e5.js"><link rel="prefetch" href="/assets/js/146.2b0cad9e.js"><link rel="prefetch" href="/assets/js/147.550a6168.js"><link rel="prefetch" href="/assets/js/148.74f59eec.js"><link rel="prefetch" href="/assets/js/149.34d75641.js"><link rel="prefetch" href="/assets/js/15.f99ce9b8.js"><link rel="prefetch" href="/assets/js/150.b586237d.js"><link rel="prefetch" href="/assets/js/151.79d65157.js"><link rel="prefetch" href="/assets/js/152.05cd688c.js"><link rel="prefetch" href="/assets/js/153.1d0b4546.js"><link rel="prefetch" href="/assets/js/154.e1b39046.js"><link rel="prefetch" href="/assets/js/155.d7b9bed4.js"><link rel="prefetch" href="/assets/js/156.731c0202.js"><link rel="prefetch" href="/assets/js/157.b83d33d5.js"><link rel="prefetch" href="/assets/js/158.58b4c4da.js"><link rel="prefetch" href="/assets/js/159.5da2f916.js"><link rel="prefetch" href="/assets/js/16.f12563c8.js"><link rel="prefetch" href="/assets/js/160.9f955318.js"><link rel="prefetch" href="/assets/js/161.1e7e5889.js"><link rel="prefetch" href="/assets/js/162.4a6b7cb1.js"><link rel="prefetch" href="/assets/js/163.c7b74968.js"><link rel="prefetch" href="/assets/js/164.6e7991d3.js"><link rel="prefetch" href="/assets/js/165.71599099.js"><link rel="prefetch" href="/assets/js/166.3239e534.js"><link rel="prefetch" href="/assets/js/167.53add172.js"><link rel="prefetch" href="/assets/js/168.0297a0b2.js"><link rel="prefetch" href="/assets/js/169.78af2f85.js"><link rel="prefetch" href="/assets/js/17.60ab668d.js"><link rel="prefetch" href="/assets/js/170.40e40ac5.js"><link rel="prefetch" href="/assets/js/171.b6901a32.js"><link rel="prefetch" href="/assets/js/172.d17d1ea1.js"><link rel="prefetch" href="/assets/js/173.6ed7236d.js"><link rel="prefetch" href="/assets/js/174.38f298bf.js"><link rel="prefetch" href="/assets/js/175.97964124.js"><link rel="prefetch" href="/assets/js/176.c0ee0486.js"><link rel="prefetch" href="/assets/js/177.892c766e.js"><link rel="prefetch" href="/assets/js/178.b0743baa.js"><link rel="prefetch" href="/assets/js/179.418e55da.js"><link rel="prefetch" href="/assets/js/18.6ccba2d3.js"><link rel="prefetch" href="/assets/js/180.3929c8b2.js"><link rel="prefetch" href="/assets/js/181.cb4704af.js"><link rel="prefetch" href="/assets/js/182.bf8a7ab1.js"><link rel="prefetch" href="/assets/js/183.6cdd91a6.js"><link rel="prefetch" href="/assets/js/184.fcfa922d.js"><link rel="prefetch" href="/assets/js/185.47f73a3b.js"><link rel="prefetch" href="/assets/js/186.31385184.js"><link rel="prefetch" href="/assets/js/187.6f228f00.js"><link rel="prefetch" href="/assets/js/188.a781e686.js"><link rel="prefetch" href="/assets/js/189.1faa1ff3.js"><link rel="prefetch" href="/assets/js/19.4bfb0281.js"><link rel="prefetch" href="/assets/js/190.956a4d89.js"><link rel="prefetch" href="/assets/js/191.d8c94155.js"><link rel="prefetch" href="/assets/js/192.65c1dcda.js"><link rel="prefetch" href="/assets/js/193.5e76824b.js"><link rel="prefetch" href="/assets/js/194.b68cf9c9.js"><link rel="prefetch" href="/assets/js/195.932ef891.js"><link rel="prefetch" href="/assets/js/196.d1e5bee5.js"><link rel="prefetch" href="/assets/js/197.bc189b6d.js"><link rel="prefetch" href="/assets/js/198.9948579d.js"><link rel="prefetch" href="/assets/js/199.721627ff.js"><link rel="prefetch" href="/assets/js/2.1b04819e.js"><link rel="prefetch" href="/assets/js/20.a37a254f.js"><link rel="prefetch" href="/assets/js/200.caab7457.js"><link rel="prefetch" href="/assets/js/201.8c41913e.js"><link rel="prefetch" href="/assets/js/202.6dd42c18.js"><link rel="prefetch" href="/assets/js/203.d4c5b465.js"><link rel="prefetch" href="/assets/js/204.7dfbcd0c.js"><link rel="prefetch" href="/assets/js/205.2e801684.js"><link rel="prefetch" href="/assets/js/206.767d0ec0.js"><link rel="prefetch" href="/assets/js/207.f0eae2a7.js"><link rel="prefetch" href="/assets/js/208.951673a6.js"><link rel="prefetch" href="/assets/js/209.489d3525.js"><link rel="prefetch" href="/assets/js/21.1b08bc72.js"><link rel="prefetch" href="/assets/js/210.954ba8b4.js"><link rel="prefetch" href="/assets/js/211.5c56eefb.js"><link rel="prefetch" href="/assets/js/212.94fa6428.js"><link rel="prefetch" href="/assets/js/213.1b87d38c.js"><link rel="prefetch" href="/assets/js/214.34564c96.js"><link rel="prefetch" href="/assets/js/215.8b496920.js"><link rel="prefetch" href="/assets/js/216.fc6ca96e.js"><link rel="prefetch" href="/assets/js/217.23679720.js"><link rel="prefetch" href="/assets/js/218.f258e179.js"><link rel="prefetch" href="/assets/js/219.3dd674ca.js"><link rel="prefetch" href="/assets/js/22.2fa27f56.js"><link rel="prefetch" href="/assets/js/220.8adbd73c.js"><link rel="prefetch" href="/assets/js/221.8e7844cb.js"><link rel="prefetch" href="/assets/js/222.93bb56e3.js"><link rel="prefetch" href="/assets/js/223.20e6ccc6.js"><link rel="prefetch" href="/assets/js/224.892da074.js"><link rel="prefetch" href="/assets/js/225.052af79c.js"><link rel="prefetch" href="/assets/js/226.80d25db9.js"><link rel="prefetch" href="/assets/js/227.489abab5.js"><link rel="prefetch" href="/assets/js/228.8addef99.js"><link rel="prefetch" href="/assets/js/229.464a7b69.js"><link rel="prefetch" href="/assets/js/23.7a06e795.js"><link rel="prefetch" href="/assets/js/230.ba642a38.js"><link rel="prefetch" href="/assets/js/231.8b72be64.js"><link rel="prefetch" href="/assets/js/232.6fca5391.js"><link rel="prefetch" href="/assets/js/233.b15b39c7.js"><link rel="prefetch" href="/assets/js/234.1e77827c.js"><link rel="prefetch" href="/assets/js/235.04654b6a.js"><link rel="prefetch" href="/assets/js/236.6d847606.js"><link rel="prefetch" href="/assets/js/237.e4adc220.js"><link rel="prefetch" href="/assets/js/238.ac719d7b.js"><link rel="prefetch" href="/assets/js/239.14800157.js"><link rel="prefetch" href="/assets/js/24.3b75f0d2.js"><link rel="prefetch" href="/assets/js/240.6727205f.js"><link rel="prefetch" href="/assets/js/241.96ddb7cc.js"><link rel="prefetch" href="/assets/js/242.55bfaa6b.js"><link rel="prefetch" href="/assets/js/243.49881e88.js"><link rel="prefetch" href="/assets/js/244.4b496a61.js"><link rel="prefetch" href="/assets/js/245.4645fe95.js"><link rel="prefetch" href="/assets/js/246.331bd849.js"><link rel="prefetch" href="/assets/js/247.c09b3662.js"><link rel="prefetch" href="/assets/js/248.bfb80c70.js"><link rel="prefetch" href="/assets/js/249.028fd3a4.js"><link rel="prefetch" href="/assets/js/25.ef652c39.js"><link rel="prefetch" href="/assets/js/250.bf52b304.js"><link rel="prefetch" href="/assets/js/251.53f7f5c3.js"><link rel="prefetch" href="/assets/js/252.b4c89a72.js"><link rel="prefetch" href="/assets/js/253.d4334f06.js"><link rel="prefetch" href="/assets/js/254.92e59845.js"><link rel="prefetch" href="/assets/js/255.e2b4f13c.js"><link rel="prefetch" href="/assets/js/256.172408ec.js"><link rel="prefetch" href="/assets/js/26.4958636b.js"><link rel="prefetch" href="/assets/js/27.c0c94908.js"><link rel="prefetch" href="/assets/js/28.6bbbf6c7.js"><link rel="prefetch" href="/assets/js/29.0a763889.js"><link rel="prefetch" href="/assets/js/3.d0acc44c.js"><link rel="prefetch" href="/assets/js/30.8ceb5299.js"><link rel="prefetch" href="/assets/js/31.ac86f1a0.js"><link rel="prefetch" href="/assets/js/32.47b1d1ab.js"><link rel="prefetch" href="/assets/js/33.bc1973ee.js"><link rel="prefetch" href="/assets/js/34.4a0f3bbd.js"><link rel="prefetch" href="/assets/js/35.9a41327b.js"><link rel="prefetch" href="/assets/js/36.bb1a1ca7.js"><link rel="prefetch" href="/assets/js/37.4b339009.js"><link rel="prefetch" href="/assets/js/38.bdf43207.js"><link rel="prefetch" href="/assets/js/39.556eb1e6.js"><link rel="prefetch" href="/assets/js/40.b898f3c0.js"><link rel="prefetch" href="/assets/js/41.e76810f7.js"><link rel="prefetch" href="/assets/js/42.40a9ea6b.js"><link rel="prefetch" href="/assets/js/43.e664fcdb.js"><link rel="prefetch" href="/assets/js/44.433e32c2.js"><link rel="prefetch" href="/assets/js/45.3107b044.js"><link rel="prefetch" href="/assets/js/46.866557c2.js"><link rel="prefetch" href="/assets/js/47.e9f8e957.js"><link rel="prefetch" href="/assets/js/48.f3de29fa.js"><link rel="prefetch" href="/assets/js/49.d34e576a.js"><link rel="prefetch" href="/assets/js/50.5d672386.js"><link rel="prefetch" href="/assets/js/51.32f4e560.js"><link rel="prefetch" href="/assets/js/52.6c14e155.js"><link rel="prefetch" href="/assets/js/53.def1453d.js"><link rel="prefetch" href="/assets/js/54.56935018.js"><link rel="prefetch" href="/assets/js/55.93be3908.js"><link rel="prefetch" href="/assets/js/56.3293e3e0.js"><link rel="prefetch" href="/assets/js/57.432d4525.js"><link rel="prefetch" href="/assets/js/58.76c0a4fa.js"><link rel="prefetch" href="/assets/js/59.0ca98755.js"><link rel="prefetch" href="/assets/js/60.b4650c99.js"><link rel="prefetch" href="/assets/js/61.8a47d50e.js"><link rel="prefetch" href="/assets/js/63.151202a0.js"><link rel="prefetch" href="/assets/js/64.76b3b34a.js"><link rel="prefetch" href="/assets/js/65.21083ff4.js"><link rel="prefetch" href="/assets/js/66.7425b20e.js"><link rel="prefetch" href="/assets/js/67.b588a963.js"><link rel="prefetch" href="/assets/js/68.119b84ba.js"><link rel="prefetch" href="/assets/js/69.6b53f4b2.js"><link rel="prefetch" href="/assets/js/7.93a66724.js"><link rel="prefetch" href="/assets/js/70.c1d38af2.js"><link rel="prefetch" href="/assets/js/71.42ae22ef.js"><link rel="prefetch" href="/assets/js/72.b35c1876.js"><link rel="prefetch" href="/assets/js/73.14061d3e.js"><link rel="prefetch" href="/assets/js/74.25780aed.js"><link rel="prefetch" href="/assets/js/75.06eba2f0.js"><link rel="prefetch" href="/assets/js/76.0acc5ad1.js"><link rel="prefetch" href="/assets/js/77.b689424a.js"><link rel="prefetch" href="/assets/js/78.c2a6f16b.js"><link rel="prefetch" href="/assets/js/79.29d173c7.js"><link rel="prefetch" href="/assets/js/8.9cfc6da2.js"><link rel="prefetch" href="/assets/js/80.0b83f59b.js"><link rel="prefetch" href="/assets/js/81.17581437.js"><link rel="prefetch" href="/assets/js/82.0af2c44e.js"><link rel="prefetch" href="/assets/js/83.76aa054c.js"><link rel="prefetch" href="/assets/js/84.3e5bb22b.js"><link rel="prefetch" href="/assets/js/85.c46dec3f.js"><link rel="prefetch" href="/assets/js/86.c5ccda72.js"><link rel="prefetch" href="/assets/js/87.5ba199bc.js"><link rel="prefetch" href="/assets/js/88.a86a7b44.js"><link rel="prefetch" href="/assets/js/89.43cd615d.js"><link rel="prefetch" href="/assets/js/9.308c624c.js"><link rel="prefetch" href="/assets/js/90.201d0e98.js"><link rel="prefetch" href="/assets/js/91.7a5f3fea.js"><link rel="prefetch" href="/assets/js/92.e0511e5a.js"><link rel="prefetch" href="/assets/js/93.8ad333c9.js"><link rel="prefetch" href="/assets/js/94.c446d050.js"><link rel="prefetch" href="/assets/js/95.5563bd89.js"><link rel="prefetch" href="/assets/js/96.be19a8d6.js"><link rel="prefetch" href="/assets/js/97.02d99111.js"><link rel="prefetch" href="/assets/js/98.8ef3ca96.js"><link rel="prefetch" href="/assets/js/99.21fb7c4e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.10be55ec.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/header.png" alt="高小哥漫谈前端" class="logo"> <span class="site-name can-hide">高小哥漫谈前端</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/javascript/index.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/achievement/index.html" class="nav-link">
  方案及成果
</a></div><div class="nav-item"><a href="/react/index.html" class="nav-link">
  React/RN
</a></div><div class="nav-item"><a href="/vue/index.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/lowcode/index.html" class="nav-link">
  低代码
</a></div><div class="nav-item"><a href="/android/index.html" class="nav-link">
  Android
</a></div><div class="nav-item"><a href="/ios/index.html" class="nav-link">
  iOS
</a></div><div class="nav-item"><a href="/iot/index.html" class="nav-link">
  物联网
</a></div><div class="nav-item"><a href="/nodejs/index.html" class="nav-link">
  AI/Node
</a></div><div class="nav-item"><a href="/architecture/index.html" class="nav-link">
  思考/设计模式/UML
</a></div><div class="nav-item"><a href="/other/index.html" class="nav-link">
  Docker/SQL/Git/Nginx
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="自己写的小工具" class="dropdown-title"><span class="title">自己写的小工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="自己写的小工具" class="mobile-dropdown-title"><span class="title">自己写的小工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://uibuilder.gaogangsever.cn/ui-builder/index.html#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  页面构建器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://uibuilder.gaogangsever.cn/flows/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  流程图
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/parse-jsx-to-css" target="_blank" rel="noopener noreferrer" class="nav-link external">
  解析JSX/Vue中的class到less/sass/css中
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/chengdu_house_tax" target="_blank" rel="noopener noreferrer" class="nav-link external">
  成都二手房工具集
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/tools/index.html" class="nav-link">
  其他推荐
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="提效工具推荐" class="dropdown-title"><span class="title">提效工具推荐</span> <span class="arrow down"></span></button> <button type="button" aria-label="提效工具推荐" class="mobile-dropdown-title"><span class="title">提效工具推荐</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://diffusionbee.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Stable Diffusion 客户端（文本生成图片）
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/orgs/nextcloud/repositories" target="_blank" rel="noopener noreferrer" class="nav-link external">
  免费开源的云盘 nextcloud
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/upscayl/upscayl" target="_blank" rel="noopener noreferrer" class="nav-link external">
  AI 将模糊图片变清晰 upscayl
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/yichengchen/clashX" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MAC 翻墙工具 clashX
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/emqx/emqx" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MQTX 协议开源docker emqx
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/wechaty/wechaty" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微信hack工具wechaty
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://app.quicktype.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  将json序列化为代码
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源" class="dropdown-title"><span class="title">开源</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源" class="mobile-dropdown-title"><span class="title">开源</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/article/oview/index.html" class="nav-link">
  图表库oView
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_recyclerview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_recyclerview
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_popup_window" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_popup_window
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/lucky_tools/blob/master/packages/mendix-cli/README.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue开发Mendix组件脚手架
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/cocos-webpack-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cocos web端开发
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/ui-designer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ui 构建器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/KotlinGank" target="_blank" rel="noopener noreferrer" class="nav-link external">
  kotlin App
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/tensorflow_object_detection" target="_blank" rel="noopener noreferrer" class="nav-link external">
  tensorflow object detection
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/react-native-file-hash-plugin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  react-native-file-hash-plugin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  issues
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/javascript/index.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/achievement/index.html" class="nav-link">
  方案及成果
</a></div><div class="nav-item"><a href="/react/index.html" class="nav-link">
  React/RN
</a></div><div class="nav-item"><a href="/vue/index.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/lowcode/index.html" class="nav-link">
  低代码
</a></div><div class="nav-item"><a href="/android/index.html" class="nav-link">
  Android
</a></div><div class="nav-item"><a href="/ios/index.html" class="nav-link">
  iOS
</a></div><div class="nav-item"><a href="/iot/index.html" class="nav-link">
  物联网
</a></div><div class="nav-item"><a href="/nodejs/index.html" class="nav-link">
  AI/Node
</a></div><div class="nav-item"><a href="/architecture/index.html" class="nav-link">
  思考/设计模式/UML
</a></div><div class="nav-item"><a href="/other/index.html" class="nav-link">
  Docker/SQL/Git/Nginx
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="自己写的小工具" class="dropdown-title"><span class="title">自己写的小工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="自己写的小工具" class="mobile-dropdown-title"><span class="title">自己写的小工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://uibuilder.gaogangsever.cn/ui-builder/index.html#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  页面构建器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://uibuilder.gaogangsever.cn/flows/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  流程图
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/parse-jsx-to-css" target="_blank" rel="noopener noreferrer" class="nav-link external">
  解析JSX/Vue中的class到less/sass/css中
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/chengdu_house_tax" target="_blank" rel="noopener noreferrer" class="nav-link external">
  成都二手房工具集
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/tools/index.html" class="nav-link">
  其他推荐
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="提效工具推荐" class="dropdown-title"><span class="title">提效工具推荐</span> <span class="arrow down"></span></button> <button type="button" aria-label="提效工具推荐" class="mobile-dropdown-title"><span class="title">提效工具推荐</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://diffusionbee.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Stable Diffusion 客户端（文本生成图片）
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/orgs/nextcloud/repositories" target="_blank" rel="noopener noreferrer" class="nav-link external">
  免费开源的云盘 nextcloud
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/upscayl/upscayl" target="_blank" rel="noopener noreferrer" class="nav-link external">
  AI 将模糊图片变清晰 upscayl
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/yichengchen/clashX" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MAC 翻墙工具 clashX
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/emqx/emqx" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MQTX 协议开源docker emqx
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/wechaty/wechaty" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微信hack工具wechaty
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://app.quicktype.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  将json序列化为代码
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源" class="dropdown-title"><span class="title">开源</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源" class="mobile-dropdown-title"><span class="title">开源</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/article/oview/index.html" class="nav-link">
  图表库oView
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_recyclerview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_recyclerview
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_popup_window" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_popup_window
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/lucky_tools/blob/master/packages/mendix-cli/README.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue开发Mendix组件脚手架
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/cocos-webpack-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cocos web端开发
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/ui-designer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ui 构建器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/KotlinGank" target="_blank" rel="noopener noreferrer" class="nav-link external">
  kotlin App
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/tensorflow_object_detection" target="_blank" rel="noopener noreferrer" class="nav-link external">
  tensorflow object detection
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/react-native-file-hash-plugin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  react-native-file-hash-plugin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  issues
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>react-native bundle 到 bundle 生成到底发生了什么(metro 打包流程简析)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#一、前言" class="sidebar-link">一、前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#二、metro-打包流程" class="sidebar-link">二、metro 打包流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#_1-命令参数解析" class="sidebar-link">1. 命令参数解析</a></li><li class="sidebar-sub-header"><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#_2-metro-server-启动" class="sidebar-link">2. Metro Server 启动</a></li><li class="sidebar-sub-header"><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#metro-构建-bundle-流程入口" class="sidebar-link">metro 构建 bundle: 流程入口</a></li><li class="sidebar-sub-header"><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#metro-构建-bundle-解析和转换" class="sidebar-link">metro 构建 bundle: 解析和转换</a></li><li class="sidebar-sub-header"><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#metro-构建-bundle-生成" class="sidebar-link">metro 构建 bundle: 生成</a></li></ul></li><li><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="ads-main"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAAgVBMVEUAAABvb29wcHBwcHBwcHBzc3NwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBvb29vb29ubm5wcHBwcHBwcHBwcHBwcHBubm5wcHBwcHBwcHBvb29wcHBwcHBiYmJvb29qampwcHBwcHDt3O1jAAAAKnRSTlMAVL/WqSr05MZizEAz+97CuFhL77GAd0QuEbyNhHNwPJsl6J5sXQQcDKLHDJAOAAABp0lEQVRYw+2U2ZKCMBBFA4QdHRHZBBR3p///A6csEloTghHfpjhPQFefQLgdMjMzI2PEX/YD+Hh3jStqWo5jmbSKS83+3lD6dAHPrLJIqx/AeLRnLkgsqsO4gEJHfm0SGCSpSy0DvrtLmzBuWs8BRrB+b0DSkBduVS+tRw0bQMzwuRJ5wNhoGqhYOgHjR8tA5VL6mcGQS7/AqEYNq2eDQSE48XSGuL2ahoJdblnFBI5PBrAN0bAExrIr7DAgQ6G0AA0iWbcEyD8JyQAWPGdbEMnZGj07InB3YcwQ95uAX4XgFjsqw04UQCEISng1mEMCDxBpG2tmyNEgrbfEByYRuQds6LnhBxCre+Tg6bJXnUiyAYN9Ef6rat4SPsge9mM+Rmb6cGTlo2iI2StyEsUBewaVwX/9pAtR0PRZ53sUQMeZkFSdQsRXGrIUtI5Fw1EYkJaMkrs87NGwoSZviALR4AFCC/Key1Y24KRosaZdgCMhkzHRZt+6D0MhGHzyAbbfWr3BxDx8hm0LhoZMAw3plwbLniy4mtg/jdLD/mncsH8iNpmZ+bf8ATswhv7fNYeiAAAAAElFTkSuQmCC" class="btn-control"> <div style="display:;"><img src="https://cdn-1252273386.cos.ap-guangzhou.myqcloud.com/images/5fb3a2e92e712c386d0ed758433dcfdc.png" class="my-wechat-m"> <div class="coor-tips">
      技术咨询、项目合作、广告投放、简历咨询、技术文档下载
      <a href="https://mp.weixin.qq.com/s?__biz=MzIyMTY4ODMxMg==&mid=2247485385&idx=1&sn=8341f3d51961d47d895fca4d5dddf9da&chksm=e839bf5edf4e364824e70597af29ade5cf33bb628abe64006379e0b955f39f1c5dcd33793ab2#rd" target="__blank">点击这里</a> 联系博主
    </div> </div></div> <div class="theme-default-content content__default"><h1 id="react-native-bundle-到-bundle-生成到底发生了什么-metro-打包流程简析"><a href="#react-native-bundle-到-bundle-生成到底发生了什么-metro-打包流程简析" class="header-anchor">#</a> react-native bundle 到 bundle 生成到底发生了什么(metro 打包流程简析)</h1> <p>本文结合代码约4万字左右，阅读大约需要1小时。</p> <p>本文涉及 <code>react-native</code>及 <code>metro</code> 版本</p> <ul><li><code>react-native@0.63.2</code></li> <li><code>metro@0.58.0</code></li></ul> <p>先来看一波本文的实例代码:很简单吧，一个<code>你好，世界</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// App.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StyleSheet<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> View <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-native&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>React<span class="token punctuation">.</span>Fragment<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>View style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>body<span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>Text style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token operator">&gt;</span>你好，世界<span class="token operator">&lt;</span><span class="token operator">/</span>Text<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>View<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>React<span class="token punctuation">.</span>Fragment<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> styles <span class="token operator">=</span> StyleSheet<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">&quot;white&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">flex</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">justifyContent</span><span class="token operator">:</span> <span class="token string">&quot;center&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">alignItems</span><span class="token operator">:</span> <span class="token string">&quot;center&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">textAlign</span><span class="token operator">:</span> <span class="token string">&quot;center&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&quot;red&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="一、前言"><a href="#一、前言" class="header-anchor">#</a> 一、前言</h2> <blockquote><p>众所周知，<code>react-native(下文简称rn)</code> 需要打成 <code>bundle</code> 包供 <code>android，ios</code> 加载；通常我们的打包命令为 <code>react-native bundle --entry-file index.js --bundle-output ./bundle/ios.bundle --platform ios --assets-dest ./bundle --dev false</code>；运行上述命令之后，rn 会默认使用 <code>metro</code> 作为打包工具，生成 <code>bundle</code> 包。</p></blockquote> <p>生成的 bundle 包大致分为四层:</p> <ul><li><strong>var 声明层</strong>: 对当前运行环境, bundle 启动时间，以及进程相关信息;</li> <li><strong>polyfill 层</strong>: <code>!(function(r){})</code> , 定义了对 <code>define（__d）</code>、 <code>require（__r）</code>、<code>clear（__c）</code> 的支持，以及 module（react-native 及第三方 dependences 依赖的 module） 的加载逻辑;</li> <li><strong>模块定义层</strong>: __d 定义的代码块，包括 RN 框架源码 js 部分、自定义 js 代码部分、图片资源信息，供 require 引入使用</li> <li><strong>require 层</strong>: r 定义的代码块，找到 d 定义的代码块 并执行</li></ul> <p>格式如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// var声明层</span>

<span class="token keyword">var</span> __BUNDLE_START_TIME__<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>nativePerformanceNow<span class="token operator">?</span><span class="token function">nativePerformanceNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>__DEV__<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span>process<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>process<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>process<span class="token punctuation">.</span>env<span class="token operator">=</span>process<span class="token punctuation">.</span>env<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token operator">=</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token operator">||</span><span class="token string">&quot;production&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//polyfill层</span>

<span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>r<span class="token punctuation">.</span>__r<span class="token operator">=</span>o<span class="token punctuation">,</span>r<span class="token punctuation">.</span><span class="token function-variable function">__d</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">r<span class="token punctuation">,</span>i<span class="token punctuation">,</span>n</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token keyword">var</span> o<span class="token operator">=</span><span class="token punctuation">{</span><span class="token literal-property property">dependencyMap</span><span class="token operator">:</span>n<span class="token punctuation">,</span><span class="token literal-property property">factory</span><span class="token operator">:</span>r<span class="token punctuation">,</span><span class="token literal-property property">hasError</span><span class="token operator">:</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">importedAll</span><span class="token operator">:</span>t<span class="token punctuation">,</span><span class="token literal-property property">importedDefault</span><span class="token operator">:</span>t<span class="token punctuation">,</span><span class="token literal-property property">isInitialized</span><span class="token operator">:</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">publicModule</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">exports</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>o<span class="token punctuation">}</span>


<span class="token operator">...</span>
<span class="token comment">// 模型定义层</span>
<span class="token function">__d</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">g<span class="token punctuation">,</span>r<span class="token punctuation">,</span>i<span class="token punctuation">,</span>a<span class="token punctuation">,</span>m<span class="token punctuation">,</span>e<span class="token punctuation">,</span>d</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> n<span class="token operator">=</span><span class="token function">r</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t<span class="token operator">=</span><span class="token function">r</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>o<span class="token operator">=</span><span class="token function">n</span><span class="token punctuation">(</span><span class="token function">r</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>u<span class="token operator">=</span><span class="token function">r</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>t<span class="token punctuation">.</span>AppRegistry<span class="token punctuation">.</span><span class="token function">registerComponent</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> o<span class="token punctuation">.</span>default<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">402</span><span class="token punctuation">,</span><span class="token number">403</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span><span class="token punctuation">.</span>
<span class="token function">__d</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>e<span class="token punctuation">,</span>t<span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token constant">R</span><span class="token punctuation">,</span><span class="token constant">S</span><span class="token punctuation">,</span>c</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token constant">R</span><span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">&quot;ReactNativeSSR&quot;</span><span class="token punctuation">,</span><span class="token literal-property property">displayName</span><span class="token operator">:</span><span class="token string">&quot;ReactNativeSSR&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">403</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// require层</span>
<span class="token function">__r</span><span class="token punctuation">(</span><span class="token number">93</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__r</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre></div><p>看完上面的代码不知你是否疑问？</p> <ol><li><p><code>var</code> 定义层和 <code>polyfill</code> 的代码是在什么时机生成的？</p></li> <li><p>我们知道<code>_d()</code>有三个参数，分别是对应 <code>factory</code> 函数，当前 <code>moduleId</code> 以及 <code>module</code> 依赖关系</p> <ul><li><code>metro</code> 使用什么去做整个工程的依赖分析？</li> <li><code>moduleId</code> 如何生成？</li></ul></li> <li><p><code>metro</code> 如何打包？</p></li></ol> <p>日常开发中我们可能并么有在意，整个 rn 打包逻辑；现在就让笔者带您走入 rn 打包的世界！</p> <h2 id="二、metro-打包流程"><a href="#二、metro-打包流程" class="header-anchor">#</a> 二、metro 打包流程</h2> <p>通过翻阅源码和 Metro 官网，我们知道 metro 打包的整个流程大致分为:</p> <ul><li><code>命令参数解析</code></li> <li><code>metro 打包服务启动</code></li> <li><code>打包 js 和资源文件</code> <ul><li>解析，转化和生成</li></ul></li> <li><code>停止打包服务</code></li></ul> <p><img src="/assets/img/metro.7cd688e4.png" alt=""></p> <h3 id="_1-命令参数解析"><a href="#_1-命令参数解析" class="header-anchor">#</a> 1. 命令参数解析</h3> <p>首先我们来看看 <code>react-native bundle</code>的实现以及参数如何解析；由于 bundle 是 react-native 的一个子命令，那么我们寻找的思路可以从 react-native 包入手；其文件路径如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/react-native/local-cli/cli.js</span>
<span class="token comment">// react-native 命令入口</span>

<span class="token keyword">var</span> cli <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@react-native-community/cli'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>require<span class="token punctuation">.</span>main <span class="token operator">===</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cli<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// node_modules/react-native/node_modules/@react-native-community/cli/build/index.js</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">setupAndRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">var</span> _commands <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./commands&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在node_modules/react-native/node_modules/@react-native-community/cli/build/commands/index.js 中注册了 react-native的所有命令</span>

<span class="token keyword">var</span> _start <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./start/start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _bundle <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./bundle/bundle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _ramBundle <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./bundle/ramBundle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _link <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./link/link&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _unlink <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./link/unlink&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _install <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./install/install&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _uninstall <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./install/uninstall&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _upgrade <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./upgrade/upgrade&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _info <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./info/info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _config <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config/config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _init <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./init&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _doctor <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./doctor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>由于本文主要分析 react-native 打包流程，所以只需查看<code>react-native/node_modules/@react-native-community/cli/build/commands/bundle/bundle.js</code>即可。</p> <p>在 bundle.js 文件中主要注册了 bundle 命令，但是具体的实现却使用了<code>buildBundle.js</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/react-native/node_modules/@react-native-community/cli/build/commands/bundle/bundle.js</span>

<span class="token keyword">var</span> _buildBundle <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./buildBundle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _bundleCommandLineArgs <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./bundleCommandLineArgs&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> obj <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> obj <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bundleWithOutput</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> config<span class="token punctuation">,</span> args<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// bundle打包的具体实现</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _buildBundle<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> config<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> _default <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;bundle&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">&quot;builds the javascript bundle for offline use&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">func</span><span class="token operator">:</span> bundleWithOutput<span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> _bundleCommandLineArgs<span class="token punctuation">.</span>default<span class="token punctuation">,</span>
  <span class="token comment">// Used by `ramBundle.js`</span>
  <span class="token literal-property property">withOutput</span><span class="token operator">:</span> bundleWithOutput<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>default <span class="token operator">=</span> _default<span class="token punctuation">;</span>
<span class="token keyword">const</span> withOutput <span class="token operator">=</span> bundleWithOutput<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>withOutput <span class="token operator">=</span> withOutput<span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-metro-server-启动"><a href="#_2-metro-server-启动" class="header-anchor">#</a> 2. Metro Server 启动</h3> <p>在<code>node_modules/react-native/node_modules/@react-native-community/cli/build/commands/bundle/buildBundle.js</code>文件中默认导出的 <code>buildBundle</code> 方法才是整个<code>react-native bundle</code>执行的入口。在入口中主要做了如下几件事情:</p> <ul><li><p><strong>合并 metro 默认配置和自定义配置，并设置 maxWorkers,resetCache</strong></p></li> <li><p><strong>根据解析得到参数，构建 requestOptions，传递给打包函数</strong></p></li> <li><p><strong>实例化 metro Server</strong></p></li> <li><p><strong>启动 metro 构建 bundle</strong></p></li> <li><p><strong>处理资源文件，解析</strong></p></li> <li><p><strong>关闭 Metro Server</strong></p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/react-native/node_modules/@react-native-community/cli/build/commands/bundle/buildBundle.js</span>
<span class="token comment">// metro打包服务，也是metro的核心</span>
<span class="token keyword">function</span> <span class="token function">_Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;metro/src/Server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function-variable function">_Server</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;metro/src/shared/output/bundle&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function-variable function">_bundle</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 保存资源文件</span>
<span class="token keyword">var</span> _saveAssets <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./saveAssets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 提供了metro的默认配置</span>
<span class="token keyword">var</span> _loadMetroConfig <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../../tools/loadMetroConfig&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">buildBundle</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> output <span class="token operator">=</span> <span class="token function">_bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 合并metro默认配置和自定义配置，并设置maxWorkers,resetCache</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _loadMetroConfig<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">maxWorkers</span><span class="token operator">:</span> args<span class="token punctuation">.</span>maxWorkers<span class="token punctuation">,</span>
    <span class="token literal-property property">resetCache</span><span class="token operator">:</span> args<span class="token punctuation">.</span>resetCache<span class="token punctuation">,</span>
    <span class="token literal-property property">config</span><span class="token operator">:</span> args<span class="token punctuation">.</span>config<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...</span>

  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>dev <span class="token operator">?</span> <span class="token string">&quot;development&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据命令行的入参 --sourcemap-output 构建 sourceMapUrl</span>
  <span class="token keyword">let</span> sourceMapUrl <span class="token operator">=</span> args<span class="token punctuation">.</span>sourcemapOutput<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceMapUrl <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>args<span class="token punctuation">.</span>sourcemapUseAbsolutePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sourceMapUrl <span class="token operator">=</span> <span class="token function">_path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>sourceMapUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 根据解析得到参数，构建requestOptions，传递给打包函数</span>
  <span class="token keyword">const</span> requestOpts <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">entryFile</span><span class="token operator">:</span> args<span class="token punctuation">.</span>entryFile<span class="token punctuation">,</span>
    sourceMapUrl<span class="token punctuation">,</span>
    <span class="token literal-property property">dev</span><span class="token operator">:</span> args<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
    <span class="token literal-property property">minify</span><span class="token operator">:</span> args<span class="token punctuation">.</span>minify <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> args<span class="token punctuation">.</span>minify <span class="token operator">:</span> <span class="token operator">!</span>args<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
    <span class="token literal-property property">platform</span><span class="token operator">:</span> args<span class="token punctuation">.</span>platform<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 实例化metro 服务</span>
  <span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token function">_Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 启动打包, what? 作者不是说的是Server打包吗？为什么是output？ 答：下面会讲解</span>
    <span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token keyword">await</span> output<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> requestOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将打包生成的bundle保存到对应的目录</span>
    <span class="token keyword">await</span> output<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>bundle<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token function">_cliTools</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Save the assets of the bundle</span>
    <span class="token comment">//  处理资源文件，解析，并在下一步保存在--assets-dest指定的位置</span>
    <span class="token keyword">const</span> outputAssets <span class="token operator">=</span> <span class="token keyword">await</span> server<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span><span class="token function">_Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token constant">DEFAULT_BUNDLE_OPTIONS</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>requestOpts<span class="token punctuation">,</span>
      <span class="token literal-property property">bundleType</span><span class="token operator">:</span> <span class="token string">&quot;todo&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// When we're done saving bundle output and the assets, we're done.</span>
    <span class="token comment">// 保存资源文件到指定目录</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _saveAssets<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">(</span>
      outputAssets<span class="token punctuation">,</span>
      args<span class="token punctuation">.</span>platform<span class="token punctuation">,</span>
      args<span class="token punctuation">.</span>assetsDest
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// 停止metro 打包服务</span>
    server<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> _default <span class="token operator">=</span> buildBundle<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>default <span class="token operator">=</span> _default<span class="token punctuation">;</span>
</code></pre></div><p>从上述代码可以看到具体的打包实现都在<code>output.build(server, requestOpts)</code>中，output<code>是</code>outputBundle<code>类型，这部分代码在</code> Metro JS` 中，具体的路径为：node_modules/metro/src/shared/output/bundle.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/shared/output/bundle.js</span>

<span class="token keyword">function</span> <span class="token function">buildBundle</span><span class="token punctuation">(</span><span class="token parameter">packagerClient<span class="token punctuation">,</span> requestOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> packagerClient<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
    <span class="token function">_objectSpread</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Server<span class="token punctuation">.</span><span class="token constant">DEFAULT_BUNDLE_OPTIONS</span><span class="token punctuation">,</span> requestOptions<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">bundleType</span><span class="token operator">:</span> <span class="token string">&quot;bundle&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span>build <span class="token operator">=</span> buildBundle<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>save <span class="token operator">=</span> saveBundleAndMap<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>formatName <span class="token operator">=</span> <span class="token string">&quot;bundle&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到虽说使用的<code>output.build(server, requestOpts)</code>进行打包，其实是使用传入的<code>packagerClient.build</code>进行打包。而<code>packagerClient</code>是我们刚传入的<code>Server</code>。而<code>Server</code>就是下面我们要分析打包流程。其源码位置为:<code>node_modules/metro/src/Server.js</code></p> <h3 id="metro-构建-bundle-流程入口"><a href="#metro-构建-bundle-流程入口" class="header-anchor">#</a> metro 构建 bundle: 流程入口</h3> <p>通过上面的分析，我们已经知晓整个<code>react-native bundle</code> 打包服务的启动在<code>node_modules/metro/src/Server.js</code>的<code>build</code>方法中:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{</span>
  <span class="token comment">// 构建函数，初始化属性</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_config <span class="token operator">=</span> config<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_createModuleId <span class="token operator">=</span> config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span><span class="token function">createModuleIdFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_bundler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IncrementalBundler</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">watch</span><span class="token operator">:</span> options <span class="token operator">?</span> options<span class="token punctuation">.</span>watch <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_nextBundleBuildID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将传递进来的参数，按照模块进行拆分，一遍更好的管理；其拆分的格式如下:</span>
      <span class="token comment">//         {</span>
      <span class="token comment">//     entryFile: options.entryFile,</span>
      <span class="token comment">//     transformOptions: {</span>
      <span class="token comment">//       customTransformOptions: options.customTransformOptions,</span>
      <span class="token comment">//       dev: options.dev,</span>
      <span class="token comment">//       hot: options.hot,</span>
      <span class="token comment">//       minify: options.minify,</span>
      <span class="token comment">//       platform: options.platform,</span>
      <span class="token comment">//       type: &quot;module&quot;</span>
      <span class="token comment">//     },</span>
      <span class="token comment">//     serializerOptions: {</span>
      <span class="token comment">//       excludeSource: options.excludeSource,</span>
      <span class="token comment">//       inlineSourceMap: options.inlineSourceMap,</span>
      <span class="token comment">//       modulesOnly: options.modulesOnly,</span>
      <span class="token comment">//       runModule: options.runModule,</span>
      <span class="token comment">//       sourceMapUrl: options.sourceMapUrl,</span>
      <span class="token comment">//       sourceUrl: options.sourceUrl</span>
      <span class="token comment">//     },</span>
      <span class="token comment">//     graphOptions: {</span>
      <span class="token comment">//       shallow: options.shallow</span>
      <span class="token comment">//     },</span>
      <span class="token comment">//     onProgress: options.onProgress</span>
      <span class="token comment">//   }</span>

      <span class="token keyword">const</span> _splitBundleOptions <span class="token operator">=</span> <span class="token function">splitBundleOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
        entryFile <span class="token operator">=</span> _splitBundleOptions<span class="token punctuation">.</span>entryFile<span class="token punctuation">,</span>
        graphOptions <span class="token operator">=</span> _splitBundleOptions<span class="token punctuation">.</span>graphOptions<span class="token punctuation">,</span>
        onProgress <span class="token operator">=</span> _splitBundleOptions<span class="token punctuation">.</span>onProgress<span class="token punctuation">,</span>
        serializerOptions <span class="token operator">=</span> _splitBundleOptions<span class="token punctuation">.</span>serializerOptions<span class="token punctuation">,</span>
        transformOptions <span class="token operator">=</span> _splitBundleOptions<span class="token punctuation">.</span>transformOptions<span class="token punctuation">;</span>

      <span class="token comment">// metro打包核心：解析(Resolution)和转换(Transformation)</span>
      <span class="token keyword">const</span> _ref13 <span class="token operator">=</span> <span class="token keyword">yield</span> _this2<span class="token punctuation">.</span>_bundler<span class="token punctuation">.</span><span class="token function">buildGraph</span><span class="token punctuation">(</span>
          entryFile<span class="token punctuation">,</span>
          transformOptions<span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            onProgress<span class="token punctuation">,</span>
            <span class="token literal-property property">shallow</span><span class="token operator">:</span> graphOptions<span class="token punctuation">.</span>shallow<span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        prepend <span class="token operator">=</span> _ref13<span class="token punctuation">.</span>prepend<span class="token punctuation">,</span>
        graph <span class="token operator">=</span> _ref13<span class="token punctuation">.</span>graph<span class="token punctuation">;</span>

      <span class="token comment">// 获取构建入口文件路径</span>
      <span class="token keyword">const</span> entryPoint <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>_this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span> entryFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 初始化构建参数，此处的参数来源于: 命令行 &amp;&amp; 自定义metro配置metro.config.js &amp;&amp; 默认的metro配置</span>
      <span class="token keyword">const</span> bundleOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">asyncRequireModulePath</span><span class="token operator">:</span>
          _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>transformer<span class="token punctuation">.</span>asyncRequireModulePath<span class="token punctuation">,</span>
        <span class="token literal-property property">processModuleFilter</span><span class="token operator">:</span> _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>processModuleFilter<span class="token punctuation">,</span>
        <span class="token literal-property property">createModuleId</span><span class="token operator">:</span> _this2<span class="token punctuation">.</span>_createModuleId<span class="token punctuation">,</span> <span class="token comment">// 里面自定义/默认的createModuleIdFactory给每个module生成id; 其默认生成规则详情请见: node_modules/metro/src/lib/createModuleIdFactory.js</span>
        <span class="token literal-property property">getRunModuleStatement</span><span class="token operator">:</span> _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>getRunModuleStatement<span class="token punctuation">,</span> <span class="token comment">// 给方法签名</span>
        <span class="token comment">// 默认值为     getRunModuleStatement: moduleId =&gt; `__r(${JSON.stringify(moduleId)});`,</span>
        <span class="token comment">//  详情请见: node_modules/metro-config/src/defaults/index.js</span>
        <span class="token literal-property property">dev</span><span class="token operator">:</span> transformOptions<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
        <span class="token literal-property property">projectRoot</span><span class="token operator">:</span> _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span>
        <span class="token literal-property property">modulesOnly</span><span class="token operator">:</span> serializerOptions<span class="token punctuation">.</span>modulesOnly<span class="token punctuation">,</span>
        <span class="token literal-property property">runBeforeMainModule</span><span class="token operator">:</span> _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span><span class="token function">getModulesRunBeforeMainModule</span><span class="token punctuation">(</span>
          path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>_this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span> entryPoint<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 指定在主模块前运行的模块, 默认值: getModulesRunBeforeMainModule: () =&gt; []</span>
        <span class="token comment">// 详情请见: node_modules/metro-config/src/defaults/index.js</span>

        <span class="token literal-property property">runModule</span><span class="token operator">:</span> serializerOptions<span class="token punctuation">.</span>runModule<span class="token punctuation">,</span>
        <span class="token literal-property property">sourceMapUrl</span><span class="token operator">:</span> serializerOptions<span class="token punctuation">.</span>sourceMapUrl<span class="token punctuation">,</span>
        <span class="token literal-property property">sourceUrl</span><span class="token operator">:</span> serializerOptions<span class="token punctuation">.</span>sourceUrl<span class="token punctuation">,</span>
        <span class="token literal-property property">inlineSourceMap</span><span class="token operator">:</span> serializerOptions<span class="token punctuation">.</span>inlineSourceMap<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> bundleCode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> bundleMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token comment">// 是否使用自定义生成，如果是，则调用自定义生成的函数，获取最终代码</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>customSerializer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> bundle <span class="token operator">=</span> _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span><span class="token function">customSerializer</span><span class="token punctuation">(</span>
          entryPoint<span class="token punctuation">,</span>
          prepend<span class="token punctuation">,</span>
          graph<span class="token punctuation">,</span>
          bundleOptions
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> bundle <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          bundleCode <span class="token operator">=</span> bundle<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          bundleCode <span class="token operator">=</span> bundle<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
          bundleMap <span class="token operator">=</span> bundle<span class="token punctuation">.</span>map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 此处笔者将其拆分成两个步骤，比较容易分析</span>

        <span class="token comment">// 将解析及转化之后的数据，生成如下格式化的数据</span>
        <span class="token comment">// {</span>
        <span class="token comment">//   pre: string, // var定义部分及poyfill部分的代码</span>
        <span class="token comment">//   post: string, // require部分代码</span>
        <span class="token comment">//   modules: [[number, string]], // 模块定义部分，第一个参数为number，第二个参数为具体的代码</span>
        <span class="token comment">// }</span>
        <span class="token keyword">var</span> base <span class="token operator">=</span> <span class="token function">baseJSBundle</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span> prepend<span class="token punctuation">,</span> graph<span class="token punctuation">,</span> bundleOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将js module进行排序并进行字符串拼接生成最终的代码</span>
        bundleCode <span class="token operator">=</span> <span class="token function">bundleToString</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bundleMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bundleMap <span class="token operator">=</span> <span class="token function">sourceMapString</span><span class="token punctuation">(</span>
          <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>prepend<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
            <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>_this2<span class="token punctuation">.</span><span class="token function">_getSortedModules</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">excludeSource</span><span class="token operator">:</span> serializerOptions<span class="token punctuation">.</span>excludeSource<span class="token punctuation">,</span>
            <span class="token literal-property property">processModuleFilter</span><span class="token operator">:</span> _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>processModuleFilter<span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">code</span><span class="token operator">:</span> bundleCode<span class="token punctuation">,</span>
        <span class="token literal-property property">map</span><span class="token operator">:</span> bundleMap<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这个 build 函数中，首先执行了 <code>buildGraph，而</code> <code>this._bundler</code> 的初始化发生在 Server 的 <code>constructor</code> 中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>_bundler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IncrementalBundler</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">watch</span><span class="token operator">:</span> options <span class="token operator">?</span> options<span class="token punctuation">.</span>watch <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>此处的<code>_bundler</code>是 <code>IncrementalBundler</code> 的实例，它的 <code>buildGraph</code> 函数完成了打包过程中前两步 <code>Resolution</code> 和 <code>Transformation</code> 。 下面我们就来详细查看一下 Metro 解析，转换过程。</p> <h3 id="metro-构建-bundle-解析和转换"><a href="#metro-构建-bundle-解析和转换" class="header-anchor">#</a> metro 构建 bundle: 解析和转换</h3> <p>在上面一节我们知道 metro 使用<code>IncrementalBundler</code>进行 js 代码的解析和转换，在 Metro 使用<code>IncrementalBundler</code>进行解析转换的主要作用是：</p> <ul><li>返回了<strong>以入口文件为入口的所有相关依赖文件的依赖图谱和 babel 转换后的代码</strong>；</li> <li>返回了<strong>var 定义部分及 polyfill 部分所有相关依赖文件的依赖图谱和 babel 转换后的代码</strong>；</li></ul> <p>整体流程如图所示:</p> <p><img src="/assets/img/metro-build.a44983e0.png" alt=""></p> <p>通过上述的流程我们总结如下几点:</p> <ol><li>整个 metro 进行依赖分析和 babel 转换主要通过了<a href="https://github.com/facebook/jest/tree/master/packages/jest-haste-map/src" target="_blank" rel="noopener noreferrer">JestHasteMap<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>去做依赖分析；</li> <li>在做依赖分析的通过，metro 会监听当前目录的文件变化，然后以最小变化生成最终依赖关系图谱；</li> <li>不管是入口文件解析还是 polyfill 文件的依赖解析都是使用了<a href="https://github.com/facebook/jest/tree/master/packages/jest-haste-map/src" target="_blank" rel="noopener noreferrer">JestHasteMap<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>;</li></ol> <p>下面，我们来分析其具体过程如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/IncrementalBundler.js</span>


<span class="token function">buildGraph</span><span class="token punctuation">(</span><span class="token parameter">entryFile<span class="token punctuation">,</span> transformOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> otherOptions <span class="token operator">=</span>
      arguments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span>
        <span class="token operator">?</span> arguments<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">onProgress</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            <span class="token literal-property property">shallow</span><span class="token operator">:</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 核心构建在buildGraphForEntries中，通过入口文件进行依赖解析，得到bundle require部分和模块定义部分，其生成的格式为</span>
    <span class="token comment">//    {</span>
    <span class="token comment">//         dependencies: new Map(),</span>
    <span class="token comment">//         entryPoints,</span>
    <span class="token comment">//         importBundleNames: new Set()</span>
    <span class="token comment">//    }</span>
      <span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token keyword">yield</span> _this2<span class="token punctuation">.</span><span class="token function">buildGraphForEntries</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>entryFile<span class="token punctuation">]</span><span class="token punctuation">,</span>
        transformOptions<span class="token punctuation">,</span>
        otherOptions
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> transformOptionsWithoutType <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">customTransformOptions</span><span class="token operator">:</span> transformOptions<span class="token punctuation">.</span>customTransformOptions<span class="token punctuation">,</span>
        <span class="token literal-property property">dev</span><span class="token operator">:</span> transformOptions<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
        <span class="token literal-property property">experimentalImportSupport</span><span class="token operator">:</span> transformOptions<span class="token punctuation">.</span>experimentalImportSupport<span class="token punctuation">,</span>
        <span class="token literal-property property">hot</span><span class="token operator">:</span> transformOptions<span class="token punctuation">.</span>hot<span class="token punctuation">,</span>
        <span class="token literal-property property">minify</span><span class="token operator">:</span> transformOptions<span class="token punctuation">.</span>minify<span class="token punctuation">,</span>
        <span class="token literal-property property">unstable_disableES6Transforms</span><span class="token operator">:</span>
          transformOptions<span class="token punctuation">.</span>unstable_disableES6Transforms<span class="token punctuation">,</span>
        <span class="token literal-property property">platform</span><span class="token operator">:</span> transformOptions<span class="token punctuation">.</span>platform
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//   bundle前面的var声明和polyfill，生成的格式为:</span>
        <span class="token comment">// [</span>
        <span class="token comment">//     {</span>
        <span class="token comment">//         inverseDependencies: Set(0) {},</span>
        <span class="token comment">//         path: '/Users/mrgaogang/Desktop/react-native-ssr/ReactNativeSSR/node_modules/react-native/Libraries/polyfills/Object.es7.js',</span>
        <span class="token comment">//         dependencies: Map(0) {},</span>
        <span class="token comment">//         getSource: [Function: getSource],</span>
        <span class="token comment">//         output: [ [Object] ]</span>
        <span class="token comment">//     }</span>
        <span class="token comment">// ]</span>
      <span class="token keyword">const</span> prepend <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getPrependedScripts</span><span class="token punctuation">(</span>
        _this2<span class="token punctuation">.</span>_config<span class="token punctuation">,</span>
        transformOptionsWithoutType<span class="token punctuation">,</span>
        _this2<span class="token punctuation">.</span>_bundler<span class="token punctuation">,</span>
        _this2<span class="token punctuation">.</span>_deltaBundler
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        prepend<span class="token punctuation">,</span>
        graph
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="require-和模块定义部分解析和依赖生成"><a href="#require-和模块定义部分解析和依赖生成" class="header-anchor">#</a> require 和模块定义部分解析和依赖生成</h4> <p>在 <code>buildGraphForEntries</code>中利用<code>_deltaBundler.buildGraph</code>生成 graph,</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/IncrementalBundler.js</span>

  <span class="token function">buildGraphForEntries</span><span class="token punctuation">(</span><span class="token parameter">entryFiles<span class="token punctuation">,</span> transformOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token keyword">const</span> absoluteEntryFiles <span class="token operator">=</span> entryFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">entryFile</span> <span class="token operator">=&gt;</span>
        path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span> entryFile<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 调用 DeltaBundler.buildGraph</span>
      <span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token keyword">yield</span> _this<span class="token punctuation">.</span>_deltaBundler<span class="token punctuation">.</span><span class="token function">buildGraph</span><span class="token punctuation">(</span>absoluteEntryFiles<span class="token punctuation">,</span> <span class="token punctuation">{</span>
       <span class="token comment">// ... 一些其他的参数</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ....</span>
      <span class="token keyword">return</span> graph<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// node_modules/metro/src/DeltaBundler.js</span>
  <span class="token function">buildGraph</span><span class="token punctuation">(</span><span class="token parameter">entryPoints<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用node_modules/metro/src/Bundler.js 获取模块依赖图谱</span>
      <span class="token keyword">const</span> depGraph <span class="token operator">=</span> <span class="token keyword">yield</span> _this<span class="token punctuation">.</span>_bundler<span class="token punctuation">.</span><span class="token function">getDependencyGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 监听文件变化，如果文件存在变化则更新文件之间的依赖</span>
      <span class="token keyword">const</span> deltaCalculator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeltaCalculator</span><span class="token punctuation">(</span>
        entryPoints<span class="token punctuation">,</span>
        depGraph<span class="token punctuation">,</span>
        options
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 计算模块之间的变化，包括模块的增加删除和修改，如果有变化则第一时间更新</span>
      <span class="token keyword">yield</span> deltaCalculator<span class="token punctuation">.</span><span class="token function">getDelta</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">reset</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">shallow</span><span class="token operator">:</span> options<span class="token punctuation">.</span>shallow
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 根据返回的依赖图谱以及文件变化检测之后的结果，返回如下格式的的模块依赖信息。(完整格式化后面会给出)</span>
    <span class="token comment">//    {</span>
    <span class="token comment">//         dependencies: new Map(),</span>
    <span class="token comment">//         entryPoints,</span>
    <span class="token comment">//         importBundleNames: new Set()</span>
    <span class="token comment">//    }</span>
      <span class="token keyword">const</span> graph <span class="token operator">=</span> deltaCalculator<span class="token punctuation">.</span><span class="token function">getGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      _this<span class="token punctuation">.</span>_deltaCalculators<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> deltaCalculator<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> graph<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">//  node_modules/metro/src/Bundler.js</span>
<span class="token comment">//  依赖图谱分析</span>
<span class="token keyword">class</span> <span class="token class-name">Bundler</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Bundler又使用DependencyGraph进行依赖分析，生成依赖图谱</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_depGraphPromise <span class="token operator">=</span> DependencyGraph<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_depGraphPromise
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">dependencyGraph</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_transformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">(</span>
          config<span class="token punctuation">,</span>
          dependencyGraph<span class="token punctuation">.</span><span class="token function">getSha1</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>dependencyGraph<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to construct transformer: &quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getDependencyGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_depGraphPromise<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 依赖分析图谱 DependencyGraph.load使用 JestHasteMap进行依赖分析</span>
<span class="token comment">// node_modules/metro/src/node-haste/DependencyGraph.js</span>

<span class="token keyword">static</span> <span class="token function">_createHaste</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> watch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JestHasteMap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">cacheDirectory</span><span class="token operator">:</span> config<span class="token punctuation">.</span>hasteMapCacheDirectory<span class="token punctuation">,</span>
      <span class="token literal-property property">computeDependencies</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">computeSha1</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">extensions</span><span class="token operator">:</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>sourceExts<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>assetExts<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">forceNodeFilesystemAPI</span><span class="token operator">:</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>useWatchman<span class="token punctuation">,</span>
      <span class="token literal-property property">hasteImplModulePath</span><span class="token operator">:</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>hasteImplModulePath<span class="token punctuation">,</span>
      <span class="token literal-property property">ignorePattern</span><span class="token operator">:</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>blacklistRE <span class="token operator">||</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"> ^</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">mapper</span><span class="token operator">:</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>virtualMapper<span class="token punctuation">,</span>
      <span class="token literal-property property">maxWorkers</span><span class="token operator">:</span> config<span class="token punctuation">.</span>maxWorkers<span class="token punctuation">,</span>
      <span class="token literal-property property">mocksPattern</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;metro-&quot;</span> <span class="token operator">+</span> <span class="token constant">JEST_HASTE_MAP_CACHE_BREAKER</span><span class="token punctuation">,</span>
      <span class="token literal-property property">platforms</span><span class="token operator">:</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>platforms<span class="token punctuation">,</span>
      <span class="token literal-property property">retainAllFiles</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">resetCache</span><span class="token operator">:</span> config<span class="token punctuation">.</span>resetCache<span class="token punctuation">,</span>
      <span class="token literal-property property">rootDir</span><span class="token operator">:</span> config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span>
      <span class="token literal-property property">roots</span><span class="token operator">:</span> config<span class="token punctuation">.</span>watchFolders<span class="token punctuation">,</span>
      <span class="token literal-property property">throwOnModuleCollision</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">useWatchman</span><span class="token operator">:</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>useWatchman<span class="token punctuation">,</span>
      <span class="token literal-property property">watch</span><span class="token operator">:</span> watch <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token operator">!</span>ci<span class="token punctuation">.</span>isCI <span class="token operator">:</span> watch
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> haste <span class="token operator">=</span> DependencyGraph<span class="token punctuation">.</span><span class="token function">_createHaste</span><span class="token punctuation">(</span>
        config<span class="token punctuation">,</span>
        options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>watch
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> _ref2 <span class="token operator">=</span> <span class="token keyword">yield</span> haste<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        hasteFS <span class="token operator">=</span> _ref2<span class="token punctuation">.</span>hasteFS<span class="token punctuation">,</span>
        moduleMap <span class="token operator">=</span> _ref2<span class="token punctuation">.</span>moduleMap<span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DependencyGraph</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        haste<span class="token punctuation">,</span>
        <span class="token literal-property property">initialHasteFS</span><span class="token operator">:</span> hasteFS<span class="token punctuation">,</span>
        <span class="token literal-property property">initialModuleMap</span><span class="token operator">:</span> moduleMap<span class="token punctuation">,</span>
        config
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


<span class="token comment">//   JestHasteMap是一个用于node.js静态资源的依赖项管理系统。它提供了为节点模块解析和Facebook的haste模块系统静态解析JavaScript模块依赖性的功能。</span>

<span class="token comment">// 由于haste map创建是同步的，且大多数任务被I / O阻塞，因此采用了电脑的多内核进行并行操作。</span>

</code></pre></div><p>经过<code>DependencyGraph.load</code>和<code>DeltaCalculator</code>之后，生成的依赖图谱格式如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">404</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 每一个模块的依赖信息等</span>
    <span class="token string">'/Users/mrgaogang/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

            <span class="token literal-property property">inverseDependencies</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token string">'/Users/mrgaogang/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/Users/mrgaogang/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span><span class="token punctuation">,</span> <span class="token comment">// 模块路径</span>
            <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">8</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 该模块依赖的其他模块</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">getSource</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// 打包的改模块的代码</span>
                <span class="token literal-property property">lineCount</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token literal-property property">functionMap</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">names</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'&lt;global&gt;'</span><span class="token punctuation">,</span> <span class="token string">'App'</span><span class="token punctuation">,</span> <span class="token string">'render'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">mappings</span><span class="token operator">:</span> <span class="token string">'AAA;eCW;ECC;GDQ;CDC'</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'js/module'</span> <span class="token comment">// 类型，metro会通过是否startWidth('js')判断是否为js模块</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">entryPoints</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 入口</span>
    <span class="token string">'/Users/mrgaogang/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">importBundleNames</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><h4 id="var-及-polyfill-部分解析"><a href="#var-及-polyfill-部分解析" class="header-anchor">#</a> var 及 polyfill 部分解析</h4> <p>前面看到在<code>IncrementalBundler.js的 buildGraph</code>中通过<code>getPrependedScripts</code>获取到<strong>var 和 polyfill</strong>部分的代码；下面我们一些查看一下<code>getPrependedScripts</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/lib/getPreludeCode.js</span>
<span class="token keyword">function</span> <span class="token function">_getPrependedScripts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _getPrependedScripts <span class="token operator">=</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>
    config<span class="token punctuation">,</span>
    options<span class="token punctuation">,</span>
    bundler<span class="token punctuation">,</span>
    deltaBundler
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取所有的polyfills，包括默认的和自定义的polyfill</span>
    <span class="token comment">// 默认的polyfill请见: node_modules/react-native/node_modules/@react-native-community/cli/build/tools/loadMetroConfig.js getDefaultConfig:function 中使用了 node_modules/react-native/rn-get-polyfills.js 也即</span>
    <span class="token comment">// module.exports = () =&gt; [</span>
    <span class="token comment">//     require.resolve('./Libraries/polyfills/console.js'),</span>
    <span class="token comment">//     require.resolve('./Libraries/polyfills/error-guard.js'),</span>
    <span class="token comment">//     require.resolve('./Libraries/polyfills/Object.es7.js'),</span>
    <span class="token comment">// ];</span>

    <span class="token keyword">const</span> polyfillModuleNames <span class="token operator">=</span> config<span class="token punctuation">.</span>serializer
      <span class="token punctuation">.</span><span class="token function">getPolyfills</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">platform</span><span class="token operator">:</span> options<span class="token punctuation">.</span>platform<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>polyfillModuleNames<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> transformOptions <span class="token operator">=</span> <span class="token function">_objectSpread</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;script&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过  deltaBundler.buildGraph 分析 如下四个文件及自定义polyfill的依赖关系图谱</span>
    <span class="token comment">//      metro/src/lib/polyfills/require.js</span>
    <span class="token comment">//     require.resolve('./Libraries/polyfills/console.js'),</span>
    <span class="token comment">//     require.resolve('./Libraries/polyfills/error-guard.js'),</span>
    <span class="token comment">//     require.resolve('./Libraries/polyfills/Object.es7.js'),</span>
    <span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token keyword">yield</span> deltaBundler<span class="token punctuation">.</span><span class="token function">buildGraph</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span>defaults<span class="token punctuation">.</span>moduleSystem<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>polyfillModuleNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token keyword">yield</span> transformHelpers<span class="token punctuation">.</span><span class="token function">getResolveDependencyFn</span><span class="token punctuation">(</span>
          bundler<span class="token punctuation">,</span>
          options<span class="token punctuation">.</span>platform
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token keyword">yield</span> transformHelpers<span class="token punctuation">.</span><span class="token function">getTransformFn</span><span class="token punctuation">(</span>
          <span class="token punctuation">[</span>defaults<span class="token punctuation">.</span>moduleSystem<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
            <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>polyfillModuleNames<span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          bundler<span class="token punctuation">,</span>
          deltaBundler<span class="token punctuation">,</span>
          config<span class="token punctuation">,</span>
          transformOptions
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">onProgress</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token literal-property property">experimentalImportBundleSupport</span><span class="token operator">:</span>
          config<span class="token punctuation">.</span>transformer<span class="token punctuation">.</span>experimentalImportBundleSupport<span class="token punctuation">,</span>
        <span class="token literal-property property">shallow</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token comment">// 返回 var定义部分和 经过  deltaBundler.buildGraph 分析的之后的polyfill依赖图谱</span>
      <span class="token function">_getPrelude</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">dev</span><span class="token operator">:</span> options<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>graph<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">_getPrependedScripts</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_getPrelude</span><span class="token punctuation">(</span><span class="token parameter">_ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dev <span class="token operator">=</span> _ref<span class="token punctuation">.</span>dev<span class="token punctuation">;</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">getPreludeCode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">isDev</span><span class="token operator">:</span> dev<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;__prelude__&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">getSource</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">inverseDependencies</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;js/script/virtual&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          code<span class="token punctuation">,</span>
          <span class="token literal-property property">lineCount</span><span class="token operator">:</span> <span class="token function">countLines</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// node_modules/metro/src/lib/getPreludeCode.js</span>
<span class="token comment">// var定义部分的代码</span>
<span class="token keyword">function</span> <span class="token function">getPreludeCode</span><span class="token punctuation">(</span><span class="token parameter">_ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> extraVars <span class="token operator">=</span> _ref<span class="token punctuation">.</span>extraVars<span class="token punctuation">,</span>
    isDev <span class="token operator">=</span> _ref<span class="token punctuation">.</span>isDev<span class="token punctuation">;</span>
  <span class="token keyword">const</span> vars <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;__BUNDLE_START_TIME__=this.nativePerformanceNow?nativePerformanceNow():Date.now()&quot;</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__DEV__=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>isDev<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">_toConsumableArray</span><span class="token punctuation">(</span><span class="token function">formatExtraVars</span><span class="token punctuation">(</span>extraVars<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;process=this.process||{}&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">var </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vars<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">processEnv</span><span class="token punctuation">(</span>
    isDev <span class="token operator">?</span> <span class="token string">&quot;development&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;production&quot;</span>
  <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此处还有一个部分作者没有详细进行讲述，那就是使用<a href="https://github.com/facebook/jest/tree/master/packages/jest-haste-map/src" target="_blank" rel="noopener noreferrer">JestHasteMap<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 进行文件依赖解析详细部分；后续笔者会单独出一篇文章进行讲解，关于查阅。</p> <p>至此，metro 对入口文件及 polyfills 依赖分析及代码生成以及讲述完毕，回过头再看一下此章节的开头部分，不知您是否已豁然开朗。讲述了 Metro 的解析和转换，下面部分将讲述 Metro 如果通过转换后的文件依赖图谱生成最终的 bundle 代码。</p> <h3 id="metro-构建-bundle-生成"><a href="#metro-构建-bundle-生成" class="header-anchor">#</a> metro 构建 bundle: 生成</h3> <p>回到最开始的 Server 服务启动代码部分，我们发现经过<code>buildGraph</code>之后得到了<code>prepend: var及polyfill部分的代码和依赖关系</code>以及<code>graph: 入口文件的依赖关系及代码</code>；在<strong>没有提供自定义生成的情况下</strong> metro 使用了<code>baseJSBundle</code>将依赖关系图谱和每个模块的代码经过一系列的操作最终使用 <code>bundleToString</code> 转换成最终的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code>
      <span class="token comment">// metro打包核心：解析(Resolution)和转换(Transformation)</span>
      <span class="token keyword">const</span> _ref13 <span class="token operator">=</span> <span class="token keyword">yield</span> _this2<span class="token punctuation">.</span>_bundler<span class="token punctuation">.</span><span class="token function">buildGraph</span><span class="token punctuation">(</span>
          entryFile<span class="token punctuation">,</span>
          transformOptions<span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            onProgress<span class="token punctuation">,</span>
            <span class="token literal-property property">shallow</span><span class="token operator">:</span> graphOptions<span class="token punctuation">.</span>shallow<span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        prepend <span class="token operator">=</span> _ref13<span class="token punctuation">.</span>prepend<span class="token punctuation">,</span>
        graph <span class="token operator">=</span> _ref13<span class="token punctuation">.</span>graph<span class="token punctuation">;</span>
        <span class="token comment">// ....</span>
        <span class="token comment">// 此处笔者将其拆分成两个步骤，比较容易分析</span>

        <span class="token comment">// 将解析及转化之后的数据，生成如下格式化的数据</span>
        <span class="token comment">// {</span>
        <span class="token comment">//   pre: string, // var定义部分及poyfill部分的代码</span>
        <span class="token comment">//   post: string, // require部分代码</span>
        <span class="token comment">//   modules: [[number, string]], // 模块定义部分，第一个参数为number，第二个参数为具体的代码</span>
        <span class="token comment">// }</span>
        <span class="token keyword">var</span> base <span class="token operator">=</span> <span class="token function">baseJSBundle</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span> prepend<span class="token punctuation">,</span> graph<span class="token punctuation">,</span> bundleOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将js module进行排序并进行字符串拼接生成最终的代码</span>
        bundleCode <span class="token operator">=</span> <span class="token function">bundleToString</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span>

</code></pre></div><p>在关注<code>baseJSBundle</code>之前，我们先来回顾一下，graph 和 prepend 的数据结构:其主要包括如下几个信息:</p> <ol><li><strong>文件相关的依赖关系</strong></li> <li><strong>指定 module 经过 babel 之后的代码</strong></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// graph</span>
<span class="token punctuation">[</span>
<span class="token punctuation">{</span>
  <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">404</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 入口文件下每个文件所依赖其他文件的关系图谱</span>
    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token punctuation">{</span>
    <span class="token literal-property property">inverseDependencies</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">8</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token string">'@babel/runtime/helpers/createClass'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">absolutePath</span><span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/node_modules/@babel/runtime/helpers/createClass.js'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'@babel/runtime/helpers/createClass'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">isAsync</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// ....</span>
      <span class="token string">'react'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">absolutePath</span><span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/node_modules/react/index.js'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">isAsync</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'react-native'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">absolutePath</span><span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/node_modules/react-native/index.js'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'react-native'</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">isAsync</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">getSource</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">// 对应文件转换后的代码</span>
          <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__d(function(g,r,i,a,m,e,d){var t=r(d[0]);Object.defineProperty(e,&quot;__esModule&quot;,{value:!0}),e.default=void 0;var n=t(r(d[1])),u=t(r(d[2])),l=t(r(d[3])),c=t(r(d[4])),f=t(r(d[5])),o=t(r(d[6])),s=r(d[7]);function y(){if(&quot;undefined&quot;==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if(&quot;function&quot;==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}var p=(function(t){(0,l.default)(R,t);var p,h,x=(p=R,h=y(),function(){var t,n=(0,f.default)(p);if(h){var u=(0,f.default)(this).constructor;t=Reflect.construct(n,arguments,u)}else t=n.apply(this,arguments);return(0,c.default)(this,t)});function R(){return(0,n.default)(this,R),x.apply(this,arguments)}return(0,u.default)(R,[{key:&quot;render&quot;,value:function(){return o.default.createElement(o.default.Fragment,null,o.default.createElement(s.View,{style:v.body},o.default.createElement(s.Text,{style:v.text},&quot;\\u4f60\\u597d\\uff0c\\u4e16\\u754c&quot;)))}}]),R})(o.default.Component);e.default=p;var v=s.StyleSheet.create({body:{backgroundColor:'white',flex:1,justifyContent:'center',alignItems:'center'},text:{textAlign:'center',color:'red'}})});</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          <span class="token literal-property property">lineCount</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">177</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'_react'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">179</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'_interopRequireDefault'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">181</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'r'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">183</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'d'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">185</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'_reactNative'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment">// .....</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token literal-property property">functionMap</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">names</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'&lt;global&gt;'</span><span class="token punctuation">,</span> <span class="token string">'App'</span><span class="token punctuation">,</span> <span class="token string">'render'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">mappings</span><span class="token operator">:</span> <span class="token string">'AAA;eCW;ECC;GDQ;CDC'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'js/module'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">inverseDependencies</span><span class="token operator">:</span> <span class="token punctuation">[</span>Set<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token punctuation">[</span>Map<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">getSource</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/app.json'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">inverseDependencies</span><span class="token operator">:</span> <span class="token punctuation">[</span>Set<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/app.json'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">getSource</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">entryPoints</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">//入口文件</span>
    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">importBundleNames</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">]</span>
</code></pre></div><h4 id="basejsbundle"><a href="#basejsbundle" class="header-anchor">#</a> baseJSBundle</h4> <p>下面我们我们重点关注一下<code>baseJSBundle</code>是如何处理上述的数据结构的:</p> <ul><li><p><code>baseJSBundle</code>整体调用了三次 <code>processModules</code>分别用于解析出: <code>preCode</code> , <code>postCode</code> 和 <code>modules</code> 其对应的分别是<strong>var 和 polyfills 部分的代码</strong> , <strong>require 部分的代码</strong> , <strong>_d 部分的代码</strong></p></li> <li><p><code>processModules</code> 经过两次 <code>filter</code> 过滤出所有类型为 <code>js/</code>类型的数据，第二次过滤使用用户自定义 <code>filter</code> 函数；过滤完成之后使用 <code>wrapModule</code> 转换成<code>_d(factory,moduleId,dependencies)</code>的代码</p></li> <li><p><strong>baseJSBundle</strong></p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/DeltaBundler/Serializers/baseJSBundle.js</span>
<span class="token keyword">function</span> <span class="token function">baseJSBundle</span><span class="token punctuation">(</span><span class="token parameter">entryPoint<span class="token punctuation">,</span> preModules<span class="token punctuation">,</span> graph<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> graph<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> processModulesOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">filter</span><span class="token operator">:</span> options<span class="token punctuation">.</span>processModuleFilter<span class="token punctuation">,</span>
    <span class="token literal-property property">createModuleId</span><span class="token operator">:</span> options<span class="token punctuation">.</span>createModuleId<span class="token punctuation">,</span>
    <span class="token literal-property property">dev</span><span class="token operator">:</span> options<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
    <span class="token literal-property property">projectRoot</span><span class="token operator">:</span> options<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// Do not prepend polyfills or the require runtime when only modules are requested</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>modulesOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    preModules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 通过processModules将metro解析后的prepend依赖关系图谱和代码，filter+join成对应的bundle出的代码</span>
  <span class="token keyword">const</span> preCode <span class="token operator">=</span> <span class="token function">processModules</span><span class="token punctuation">(</span>preModules<span class="token punctuation">,</span> processModulesOptions<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_ref</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> _ref2 <span class="token operator">=</span> <span class="token function">_slicedToArray</span><span class="token punctuation">(</span>_ref<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=</span> _ref2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        code <span class="token operator">=</span> _ref2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>graph<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">-</span> options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 使用getAppendScripts获取入口文件及所有的runBeforeMainModule文件的依赖图谱和 使用 getRunModuleStatement 方法生成_r(moduleId)的代码，调用processModules生成最终代码</span>
  <span class="token keyword">const</span> postCode <span class="token operator">=</span> <span class="token function">processModules</span><span class="token punctuation">(</span>
    <span class="token function">getAppendScripts</span><span class="token punctuation">(</span>
      entryPoint<span class="token punctuation">,</span>
      <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>preModules<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      graph<span class="token punctuation">.</span>importBundleNames<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">asyncRequireModulePath</span><span class="token operator">:</span> options<span class="token punctuation">.</span>asyncRequireModulePath<span class="token punctuation">,</span>
        <span class="token literal-property property">createModuleId</span><span class="token operator">:</span> options<span class="token punctuation">.</span>createModuleId<span class="token punctuation">,</span>
        <span class="token literal-property property">getRunModuleStatement</span><span class="token operator">:</span> options<span class="token punctuation">.</span>getRunModuleStatement<span class="token punctuation">,</span>
        <span class="token literal-property property">inlineSourceMap</span><span class="token operator">:</span> options<span class="token punctuation">.</span>inlineSourceMap<span class="token punctuation">,</span>
        <span class="token literal-property property">projectRoot</span><span class="token operator">:</span> options<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span>
        <span class="token literal-property property">runBeforeMainModule</span><span class="token operator">:</span> options<span class="token punctuation">.</span>runBeforeMainModule<span class="token punctuation">,</span>
        <span class="token literal-property property">runModule</span><span class="token operator">:</span> options<span class="token punctuation">.</span>runModule<span class="token punctuation">,</span>
        <span class="token literal-property property">sourceMapUrl</span><span class="token operator">:</span> options<span class="token punctuation">.</span>sourceMapUrl<span class="token punctuation">,</span>
        <span class="token literal-property property">sourceUrl</span><span class="token operator">:</span> options<span class="token punctuation">.</span>sourceUrl<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    processModulesOptions
  <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_ref3</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> _ref4 <span class="token operator">=</span> <span class="token function">_slicedToArray</span><span class="token punctuation">(</span>_ref3<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=</span> _ref4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        code <span class="token operator">=</span> _ref4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">pre</span><span class="token operator">:</span> preCode<span class="token punctuation">,</span>
    <span class="token literal-property property">post</span><span class="token operator">:</span> postCode<span class="token punctuation">,</span>
    <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token function">processModules</span><span class="token punctuation">(</span>
      <span class="token comment">// 使用processModules获取所有`_d`部分的代码数组</span>
      <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>graph<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      processModulesOptions
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_ref5</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> _ref6 <span class="token operator">=</span> <span class="token function">_slicedToArray</span><span class="token punctuation">(</span>_ref5<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        module <span class="token operator">=</span> _ref6<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        code <span class="token operator">=</span> _ref6<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">[</span>options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>processModules</strong></li></ul> <p><code>processModules</code> 经过两次 <code>filter</code> 过滤出所有类型为 <code>js/</code>类型的数据，第二次过滤使用用户自定义 <code>filter</code> 函数；过滤完成之后使用 wrapModule 转换成<code>_d(factory,moduleId,dependencies)</code>的代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/DeltaBundler/Serializers/helpers/processModules.js</span>

<span class="token keyword">function</span> <span class="token function">processModules</span><span class="token punctuation">(</span><span class="token parameter">modules<span class="token punctuation">,</span> _ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> _ref$filter <span class="token operator">=</span> _ref<span class="token punctuation">.</span>filter<span class="token punctuation">,</span>
    filter <span class="token operator">=</span> _ref$filter <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span> <span class="token operator">:</span> _ref$filter<span class="token punctuation">,</span>
    createModuleId <span class="token operator">=</span> _ref<span class="token punctuation">.</span>createModuleId<span class="token punctuation">,</span>
    dev <span class="token operator">=</span> _ref<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
    projectRoot <span class="token operator">=</span> _ref<span class="token punctuation">.</span>projectRoot<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isJsModule<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
      module<span class="token punctuation">,</span>
      <span class="token function">wrapModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        createModuleId<span class="token punctuation">,</span>
        dev<span class="token punctuation">,</span>
        projectRoot<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// node_modules/metro/src/DeltaBundler/Serializers/helpers/js.js</span>
<span class="token keyword">function</span> <span class="token function">wrapModule</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token function">getJsOutput</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果类型为js/script则直接返回其代码</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>output<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;js/script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> output<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> moduleId <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// d(factory,moduleId,dependencies)后面两个参数生成</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">[</span>
    moduleId<span class="token punctuation">,</span>
    Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dependency</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>dependency<span class="token punctuation">.</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Add the module relative path as the last parameter (to make it easier to do</span>
  <span class="token comment">// requires by name when debugging).</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    params<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span> module<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 进行代码转换，因为在获取到的依赖图谱中只有_d(factory)，需要加上用moduleId和依赖关系</span>
  <span class="token keyword">return</span> <span class="token function">addParamsToDefineCall</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>output<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getJsOutput</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> jsModules <span class="token operator">=</span> module<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_ref</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> type <span class="token operator">=</span> _ref<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token keyword">return</span> type<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;js/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    jsModules<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Modules must have exactly one JS output, but </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> has </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      jsModules<span class="token punctuation">.</span>length
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> JS outputs.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> jsOutput <span class="token operator">=</span> jsModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    Number<span class="token punctuation">.</span><span class="token function">isFinite</span><span class="token punctuation">(</span>jsOutput<span class="token punctuation">.</span>data<span class="token punctuation">.</span>lineCount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">JS output must populate lineCount, but </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> has </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      jsOutput<span class="token punctuation">.</span>type
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> output with lineCount '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>jsOutput<span class="token punctuation">.</span>data<span class="token punctuation">.</span>lineCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> jsOutput<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isJsModule</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isJsOutput<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isJsOutput</span><span class="token punctuation">(</span><span class="token parameter">output</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> output<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;js/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// node_modules/metro/src/lib/addParamsToDefineCall.js</span>
<span class="token keyword">function</span> <span class="token function">addParamsToDefineCall</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> index <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>
    <span class="token keyword">var</span> _len <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      paramsToAdd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>_len <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> _len <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      _key <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    _key <span class="token operator">&lt;</span> _len<span class="token punctuation">;</span>
    _key<span class="token operator">++</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    paramsToAdd<span class="token punctuation">[</span>_key <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> arguments<span class="token punctuation">[</span>_key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> params <span class="token operator">=</span> paramsToAdd<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    param <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;undefined&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> code<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> code<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>getAppendScripts</strong></li></ul> <p>上面讲到 <code>getAppendScripts</code> 主要作用是: <strong>获取入口文件及所有的 runBeforeMainModule 文件的依赖图谱和 使用 getRunModuleStatement 方法生成<code>_r(moduleId)</code>的代码</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getAppendScripts</span><span class="token punctuation">(</span><span class="token parameter">entryPoint<span class="token punctuation">,</span> modules<span class="token punctuation">,</span> importBundleNames<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果有importBundleNames插入对应代码</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>importBundleNames<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> importBundleNamesObject <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    importBundleNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">absolutePath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> bundlePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span> absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      importBundleNamesObject<span class="token punctuation">[</span>options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span>
        bundlePath<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>bundlePath<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.bundle&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(function(){var $$=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span><span class="token function">getRunModuleStatement</span><span class="token punctuation">(</span>
      options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>asyncRequireModulePath<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">$$.addImportBundleNames(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>
      <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>importBundleNamesObject<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)})();</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    output<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">&quot;$$importBundleNames&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">getSource</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">inverseDependencies</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;js/script/virtual&quot;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            code<span class="token punctuation">,</span>
            <span class="token literal-property property">lineCount</span><span class="token operator">:</span> <span class="token function">countLines</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>runModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 聚合runBeforeMainModule和入口文件，前讲过runBeforeMainModule的默认值为: /node_modules/metro/src/lib/polyfills/require.js</span>
    <span class="token keyword">const</span> paths <span class="token operator">=</span> <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>runBeforeMainModule<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      entryPoint<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> path <span class="token keyword">of</span> paths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>modules<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> module<span class="token punctuation">.</span>path <span class="token operator">===</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过getRunModuleStatement函数生成 _r(moduleId)的代码</span>
        <span class="token comment">//   getRunModuleStatement默认值详情请见: node_modules/metro-config/src/defaults/index.js</span>
        <span class="token keyword">const</span> code <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">getRunModuleStatement</span><span class="token punctuation">(</span>
          options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        output<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">require-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function-variable function">getSource</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token literal-property property">inverseDependencies</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;js/script/virtual&quot;</span><span class="token punctuation">,</span>
              <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                code<span class="token punctuation">,</span>
                <span class="token literal-property property">lineCount</span><span class="token operator">:</span> <span class="token function">countLines</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">return</span> output<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此 <code>baseJSBundle</code>我们已经分析完成。</p> <h4 id="bundletostring"><a href="#bundletostring" class="header-anchor">#</a> bundleToString</h4> <p>经过前面一个步骤<code>bundleToBundle</code>我们分别获取到了: <code>preCode</code> , <code>postCode</code> 和 <code>modules</code> 其对应的分别是<strong>var 和 polyfills 部分的代码</strong> , <strong>require 部分的代码</strong> , <strong>_d 部分的代码</strong>
而<code>bundleToString</code>的作用如下:</p> <ul><li>先将 var 及 polyfill 部分的代码使用\n 进行字符串拼接；</li> <li>然后将<code>_d</code> 部分的代码使用 <code>moduleId</code> 进行<strong>升序排列</strong>并使用字符串拼接的方式构造<code>_d</code> 部分的代码;</li> <li>最后合如<code>_r</code>部分的代码</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">bundleToString</span><span class="token punctuation">(</span><span class="token parameter">bundle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> code <span class="token operator">=</span> bundle<span class="token punctuation">.</span>pre<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> bundle<span class="token punctuation">.</span>pre <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sortedModules <span class="token operator">=</span> bundle<span class="token punctuation">.</span>modules
    <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// The order of the modules needs to be deterministic in order for source</span>
    <span class="token comment">// maps to work properly.</span>
    <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> _ref <span class="token keyword">of</span> sortedModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _ref2 <span class="token operator">=</span> <span class="token function">_slicedToArray</span><span class="token punctuation">(</span>_ref<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> id <span class="token operator">=</span> _ref2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> moduleCode <span class="token operator">=</span> _ref2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>moduleCode<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      code <span class="token operator">+=</span> moduleCode <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>id<span class="token punctuation">,</span> moduleCode<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>bundle<span class="token punctuation">.</span>post<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    code <span class="token operator">+=</span> bundle<span class="token punctuation">.</span>post<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    code <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">,</span>
    <span class="token literal-property property">metadata</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">pre</span><span class="token operator">:</span> bundle<span class="token punctuation">.</span>pre<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      <span class="token literal-property property">post</span><span class="token operator">:</span> bundle<span class="token punctuation">.</span>post<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      modules<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ol><li><strong>react-native 使用 metro 打包之后的 bundle 大致分为四层</strong></li></ol> <p>bundle 包大致分为四层:</p> <ul><li><strong>var 声明层</strong>: 对当前运行环境, bundle 启动时间，以及进程相关信息;</li> <li><strong>poyfill 层</strong>: <code>!(function(r){})</code> , 定义了对 <code>define（__d）</code>、 <code>require（__r）</code>、<code>clear（__c）</code> 的支持，以及 module（react-native 及第三方 dependences 依赖的 module） 的加载逻辑;</li> <li><strong>模块定义层</strong>: <code>__d</code> 定义的代码块，包括 RN 框架源码 js 部分、自定义 js 代码部分、图片资源信息，供 require 引入使用</li> <li><strong>require 层</strong>: r 定义的代码块，找到 d 定义的代码块 并执行</li></ul> <ol start="2"><li><p><strong><code>react-native</code>使用 <code>metro</code> 进行打包主要分为三个步骤: 解析，转化和生成</strong>;
<img src="/assets/img/metro.7cd688e4.png" alt=""></p></li> <li><p><strong>解析和转化部分: Metro Server 使用<code>IncrementalBundler</code>进行 js 代码的解析和转换</strong></p></li></ol> <p>在 Metro 使用<code>IncrementalBundler</code>进行解析转换的主要作用是：</p> <ul><li>返回了<strong>以入口文件为入口的所有相关依赖文件的依赖图谱和 babel 转换后的代码</strong>；</li> <li>返回了<strong>var 定义部分及 polyfill 部分所有相关依赖文件的依赖图谱和 babel 转换后的代码</strong>；</li></ul> <p>整体流程如图所示:</p> <p><img src="/assets/img/metro-build.a44983e0.png" alt=""></p> <p>通过上述的流程我们总结如下几点:</p> <ol><li>整个 metro 进行依赖分析和 babel 转换主要通过了<a href="https://github.com/facebook/jest/tree/master/packages/jest-haste-map/src" target="_blank" rel="noopener noreferrer">JestHasteMap<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>去做依赖分析；</li> <li>在做依赖分析的通过，metro 会监听当前目录的文件变化，然后以最小变化生成最终依赖关系图谱；</li> <li>不管是入口文件解析还是 polyfill 文件的依赖解析都是使用了<a href="https://github.com/facebook/jest/tree/master/packages/jest-haste-map/src" target="_blank" rel="noopener noreferrer">JestHasteMap<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>;</li></ol> <p>生成的对应依赖关系图谱格式如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// graph</span>
<span class="token punctuation">[</span>
<span class="token punctuation">{</span>
  <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">404</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 入口文件下每个文件所依赖其他文件的关系图谱</span>
    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token punctuation">{</span>
    <span class="token literal-property property">inverseDependencies</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">8</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token string">'@babel/runtime/helpers/createClass'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">absolutePath</span><span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/node_modules/@babel/runtime/helpers/createClass.js'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'@babel/runtime/helpers/createClass'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">isAsync</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// ....</span>
      <span class="token string">'react'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">absolutePath</span><span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/node_modules/react/index.js'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">isAsync</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'react-native'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">absolutePath</span><span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/node_modules/react-native/index.js'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'react-native'</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">isAsync</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">getSource</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">// 对应文件转换后的代码</span>
          <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__d(function(g,r,i,a,m,e,d){var t=r(d[0]);Object.defineProperty(e,&quot;__esModule&quot;,{value:!0}),e.default=void 0;var n=t(r(d[1])),u=t(r(d[2])),l=t(r(d[3])),c=t(r(d[4])),f=t(r(d[5])),o=t(r(d[6])),s=r(d[7]);function y(){if(&quot;undefined&quot;==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if(&quot;function&quot;==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}var p=(function(t){(0,l.default)(R,t);var p,h,x=(p=R,h=y(),function(){var t,n=(0,f.default)(p);if(h){var u=(0,f.default)(this).constructor;t=Reflect.construct(n,arguments,u)}else t=n.apply(this,arguments);return(0,c.default)(this,t)});function R(){return(0,n.default)(this,R),x.apply(this,arguments)}return(0,u.default)(R,[{key:&quot;render&quot;,value:function(){return o.default.createElement(o.default.Fragment,null,o.default.createElement(s.View,{style:v.body},o.default.createElement(s.Text,{style:v.text},&quot;\\u4f60\\u597d\\uff0c\\u4e16\\u754c&quot;)))}}]),R})(o.default.Component);e.default=p;var v=s.StyleSheet.create({body:{backgroundColor:'white',flex:1,justifyContent:'center',alignItems:'center'},text:{textAlign:'center',color:'red'}})});</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          <span class="token literal-property property">lineCount</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">177</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'_react'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">179</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'_interopRequireDefault'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">181</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'r'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">183</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'d'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">185</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'_reactNative'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment">// .....</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token literal-property property">functionMap</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">names</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'&lt;global&gt;'</span><span class="token punctuation">,</span> <span class="token string">'App'</span><span class="token punctuation">,</span> <span class="token string">'render'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">mappings</span><span class="token operator">:</span> <span class="token string">'AAA;eCW;ECC;GDQ;CDC'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'js/module'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">inverseDependencies</span><span class="token operator">:</span> <span class="token punctuation">[</span>Set<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token punctuation">[</span>Map<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">getSource</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/app.json'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">inverseDependencies</span><span class="token operator">:</span> <span class="token punctuation">[</span>Set<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/app.json'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">getSource</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">entryPoints</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">//入口文件</span>
    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">importBundleNames</span><span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">]</span>
</code></pre></div><ol start="4"><li><strong>metro 代码生成部分使用 <code>baseJSBundle</code> 得到代码，并使用 <code>baseToString</code> 拼接最终 <code>Bundle</code> 代码</strong></li></ol> <p>在 <code>baseJSBundle</code> 中:</p> <ul><li><p><code>baseJSBundle</code>整体调用了三次 <code>processModules</code>分别用于解析出: <code>preCode</code> , <code>postCode</code> 和 <code>modules</code> 其对应的分别是<strong>var 和 polyfills 部分的代码</strong> , <strong>require 部分的代码</strong> , <strong><code>_d</code> 部分的代码</strong></p></li> <li><p><code>processModules</code> 经过两次 <code>filter</code> 过滤出所有类型为 <code>js/</code>类型的数据，第二次过滤使用用户自定义 <code>filter</code> 函数；过滤完成之后使用 <code>wrapModule</code> 转换成<code>_d(factory,moduleId,dependencies)</code>的代码</p></li></ul> <p>在<code>baseToString</code>中:</p> <ul><li>先将 var 及 polyfill 部分的代码使用\n 进行字符串拼接；</li> <li>然后将<code>_d</code> 部分的代码使用 <code>moduleId</code> 进行<strong>升序排列</strong>并使用字符串拼接的方式构造<code>_d</code> 部分的代码;</li> <li>最后合如<code>_r</code>部分的代码</li></ul></div> <div class="post-copyright-container"><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>
      mrgaogang.github.io
    </li> <li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://mrgaogang.github.io/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html" title="声明博客的许可协议">https://mrgaogang.github.io/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html</a></li> <li class="post-copyright-license"><strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用
      <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="external nofollow" target="_blank">CC BY-SA 4.0</a>
      许可协议。转载请注明出处！
    </li></ul></div> <div data-v-b4bf293e><div class="encourage" data-v-b4bf293e><button data-v-b4bf293e><span class="button-content" data-v-b4bf293e><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-v-b4bf293e><path d="M0 0H24V24H0z" fill="none" data-v-b4bf293e></path> <path d="M12.001 4.529c2.349-2.109 5.979-2.039 8.242.228 2.262 2.268 2.34 5.88.236 8.236l-8.48 8.492-8.478-8.492c-2.104-2.356-2.025-5.974.236-8.236 2.265-2.264 5.888-2.34 8.244-.228z" fill="currentColor" data-v-b4bf293e></path></svg>
        鼓励一下
      </span></button></div> <!----></div> <div class="divider-comment"></div> <div class="comments-wrapper"><!----></div> <footer class="page-edit"><!----> <div class="edit-link"><a target="_blank" href="https://github.com/MrGaoGang/lucky_docs/edit/master/docs/react/react-native_bundle到bundle生成到底发生了什么.md">Edit This Page</a></div> <div class="last-updated"><span class="prefix">【未经作者允许禁止转载】 Last Updated: </span> <span class="time">8/24/2023, 7:52:10 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/react/react-hooks.html" class="prev">
          /react/react-hooks.html
        </a></span> <span class="next"><a href="/react/react-redux使用hooks.html">
          React-Redux 使用 Hooks
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.73ea5e02.js" defer></script><script src="/assets/js/6.289073ab.js" defer></script><script src="/assets/js/4.8a11a086.js" defer></script><script src="/assets/js/62.176b4934.js" defer></script>
  </body>
</html>
