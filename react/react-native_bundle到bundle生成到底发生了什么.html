<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>react-native bundle 到 bundle 生成到底发生了什么(metro 打包流程简析) | 高先生的博客</title>
    <meta name="description" content="旨在分享对技术的了解">
    <link rel="icon" href="/icons/icon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9cfd884fe46fc31072811d47a486a552";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    
    <link rel="preload" href="/assets/css/0.styles.8164cbfa.css" as="style"><link rel="preload" href="/assets/js/app.41067249.js" as="script"><link rel="preload" href="/assets/js/5.49ac7986.js" as="script"><link rel="preload" href="/assets/js/3.c83a9e42.js" as="script"><link rel="preload" href="/assets/js/30.7f6582fd.js" as="script"><link rel="prefetch" href="/assets/js/1.02e40fdf.js"><link rel="prefetch" href="/assets/js/10.1e8266d3.js"><link rel="prefetch" href="/assets/js/100.9dce2fe9.js"><link rel="prefetch" href="/assets/js/101.403ba413.js"><link rel="prefetch" href="/assets/js/102.0ea28425.js"><link rel="prefetch" href="/assets/js/103.f950b1c3.js"><link rel="prefetch" href="/assets/js/104.afa755af.js"><link rel="prefetch" href="/assets/js/105.c68e72e2.js"><link rel="prefetch" href="/assets/js/106.7d783635.js"><link rel="prefetch" href="/assets/js/107.1d966f23.js"><link rel="prefetch" href="/assets/js/108.acf1aa56.js"><link rel="prefetch" href="/assets/js/109.61cb8342.js"><link rel="prefetch" href="/assets/js/11.a411b8c7.js"><link rel="prefetch" href="/assets/js/110.4a58668f.js"><link rel="prefetch" href="/assets/js/111.2884e3dc.js"><link rel="prefetch" href="/assets/js/112.9a090b19.js"><link rel="prefetch" href="/assets/js/113.afa0740f.js"><link rel="prefetch" href="/assets/js/114.d82f1328.js"><link rel="prefetch" href="/assets/js/115.1e02db7d.js"><link rel="prefetch" href="/assets/js/116.58dd10cc.js"><link rel="prefetch" href="/assets/js/117.1230ec65.js"><link rel="prefetch" href="/assets/js/118.ea5fe55e.js"><link rel="prefetch" href="/assets/js/119.7e4d9c86.js"><link rel="prefetch" href="/assets/js/12.7aeb7d8b.js"><link rel="prefetch" href="/assets/js/120.b50ce194.js"><link rel="prefetch" href="/assets/js/121.f361ffba.js"><link rel="prefetch" href="/assets/js/122.2598f008.js"><link rel="prefetch" href="/assets/js/123.a0a00e0e.js"><link rel="prefetch" href="/assets/js/124.7f265ca2.js"><link rel="prefetch" href="/assets/js/125.5a06a31b.js"><link rel="prefetch" href="/assets/js/126.0748a5aa.js"><link rel="prefetch" href="/assets/js/127.d29bf692.js"><link rel="prefetch" href="/assets/js/128.9410dbb6.js"><link rel="prefetch" href="/assets/js/129.bd87e496.js"><link rel="prefetch" href="/assets/js/13.e9ee8cac.js"><link rel="prefetch" href="/assets/js/130.025c7ba2.js"><link rel="prefetch" href="/assets/js/131.6b973e71.js"><link rel="prefetch" href="/assets/js/132.1c90fbb6.js"><link rel="prefetch" href="/assets/js/133.2c6859b8.js"><link rel="prefetch" href="/assets/js/134.a189852a.js"><link rel="prefetch" href="/assets/js/135.8195ce91.js"><link rel="prefetch" href="/assets/js/136.625fb975.js"><link rel="prefetch" href="/assets/js/137.5eb366e2.js"><link rel="prefetch" href="/assets/js/138.194089bf.js"><link rel="prefetch" href="/assets/js/139.cbfc68bd.js"><link rel="prefetch" href="/assets/js/14.8d97b7c1.js"><link rel="prefetch" href="/assets/js/140.45d05d58.js"><link rel="prefetch" href="/assets/js/141.4c28939b.js"><link rel="prefetch" href="/assets/js/142.663f9da3.js"><link rel="prefetch" href="/assets/js/143.da04adec.js"><link rel="prefetch" href="/assets/js/144.806d8fe3.js"><link rel="prefetch" href="/assets/js/145.77932cfc.js"><link rel="prefetch" href="/assets/js/146.bdd87071.js"><link rel="prefetch" href="/assets/js/147.71710cc3.js"><link rel="prefetch" href="/assets/js/148.48aeca5d.js"><link rel="prefetch" href="/assets/js/149.85c9af98.js"><link rel="prefetch" href="/assets/js/15.916213e5.js"><link rel="prefetch" href="/assets/js/150.148efff8.js"><link rel="prefetch" href="/assets/js/151.103e2871.js"><link rel="prefetch" href="/assets/js/152.ac1fed4e.js"><link rel="prefetch" href="/assets/js/153.d036e165.js"><link rel="prefetch" href="/assets/js/154.a5908a61.js"><link rel="prefetch" href="/assets/js/155.414f2c5d.js"><link rel="prefetch" href="/assets/js/156.e77c5113.js"><link rel="prefetch" href="/assets/js/157.9bad2c2d.js"><link rel="prefetch" href="/assets/js/158.04e704f8.js"><link rel="prefetch" href="/assets/js/159.cc68d75d.js"><link rel="prefetch" href="/assets/js/16.77d8b6d3.js"><link rel="prefetch" href="/assets/js/160.b2a21450.js"><link rel="prefetch" href="/assets/js/161.5f91a848.js"><link rel="prefetch" href="/assets/js/162.9a16e2fa.js"><link rel="prefetch" href="/assets/js/163.cc158a46.js"><link rel="prefetch" href="/assets/js/164.f6bbe094.js"><link rel="prefetch" href="/assets/js/165.66ab2d0d.js"><link rel="prefetch" href="/assets/js/166.1f9ea12f.js"><link rel="prefetch" href="/assets/js/167.208d9498.js"><link rel="prefetch" href="/assets/js/168.9be3a57b.js"><link rel="prefetch" href="/assets/js/169.6d12da00.js"><link rel="prefetch" href="/assets/js/17.2d89c1ad.js"><link rel="prefetch" href="/assets/js/18.e9fba40c.js"><link rel="prefetch" href="/assets/js/19.44e715ca.js"><link rel="prefetch" href="/assets/js/2.7636f56d.js"><link rel="prefetch" href="/assets/js/20.879bdf9c.js"><link rel="prefetch" href="/assets/js/21.05408205.js"><link rel="prefetch" href="/assets/js/22.ffb89f14.js"><link rel="prefetch" href="/assets/js/23.3fb279be.js"><link rel="prefetch" href="/assets/js/24.8f5d6d52.js"><link rel="prefetch" href="/assets/js/25.a9498604.js"><link rel="prefetch" href="/assets/js/26.a0b4bf9e.js"><link rel="prefetch" href="/assets/js/27.2e3d7bf0.js"><link rel="prefetch" href="/assets/js/28.dd0fb4c2.js"><link rel="prefetch" href="/assets/js/29.bde3c907.js"><link rel="prefetch" href="/assets/js/31.2f73cb95.js"><link rel="prefetch" href="/assets/js/32.ad8d2044.js"><link rel="prefetch" href="/assets/js/33.c14e35e5.js"><link rel="prefetch" href="/assets/js/34.0fde8ba6.js"><link rel="prefetch" href="/assets/js/35.ba1dee5c.js"><link rel="prefetch" href="/assets/js/36.51ee6d61.js"><link rel="prefetch" href="/assets/js/37.015c685e.js"><link rel="prefetch" href="/assets/js/38.57ed3002.js"><link rel="prefetch" href="/assets/js/39.875e01bb.js"><link rel="prefetch" href="/assets/js/40.720eaf89.js"><link rel="prefetch" href="/assets/js/41.a8e36e09.js"><link rel="prefetch" href="/assets/js/42.bb887473.js"><link rel="prefetch" href="/assets/js/43.208b2bd4.js"><link rel="prefetch" href="/assets/js/44.469e1e46.js"><link rel="prefetch" href="/assets/js/45.c9ac4261.js"><link rel="prefetch" href="/assets/js/46.58ce0f10.js"><link rel="prefetch" href="/assets/js/47.4d6861ae.js"><link rel="prefetch" href="/assets/js/48.82ef8f18.js"><link rel="prefetch" href="/assets/js/49.e350daf3.js"><link rel="prefetch" href="/assets/js/50.9fa515b8.js"><link rel="prefetch" href="/assets/js/51.91e2a374.js"><link rel="prefetch" href="/assets/js/52.83e3c4df.js"><link rel="prefetch" href="/assets/js/53.4dc6ea77.js"><link rel="prefetch" href="/assets/js/54.0cd58c60.js"><link rel="prefetch" href="/assets/js/55.7884ad17.js"><link rel="prefetch" href="/assets/js/56.f722e889.js"><link rel="prefetch" href="/assets/js/57.38df2724.js"><link rel="prefetch" href="/assets/js/58.38c630ad.js"><link rel="prefetch" href="/assets/js/59.0e54ff7e.js"><link rel="prefetch" href="/assets/js/6.ec8e2322.js"><link rel="prefetch" href="/assets/js/60.ae553e2e.js"><link rel="prefetch" href="/assets/js/61.25d00070.js"><link rel="prefetch" href="/assets/js/62.b459b0ea.js"><link rel="prefetch" href="/assets/js/63.52dc00c2.js"><link rel="prefetch" href="/assets/js/64.ef5e08b3.js"><link rel="prefetch" href="/assets/js/65.68f0aae1.js"><link rel="prefetch" href="/assets/js/66.94180d06.js"><link rel="prefetch" href="/assets/js/67.4927ad63.js"><link rel="prefetch" href="/assets/js/68.833ec0d7.js"><link rel="prefetch" href="/assets/js/69.bc852310.js"><link rel="prefetch" href="/assets/js/7.f2fb179e.js"><link rel="prefetch" href="/assets/js/70.58367678.js"><link rel="prefetch" href="/assets/js/71.e6365f6d.js"><link rel="prefetch" href="/assets/js/72.0d567d34.js"><link rel="prefetch" href="/assets/js/73.d3ff291c.js"><link rel="prefetch" href="/assets/js/74.96bf1c7f.js"><link rel="prefetch" href="/assets/js/75.c3fcd3e3.js"><link rel="prefetch" href="/assets/js/76.1eda7ff0.js"><link rel="prefetch" href="/assets/js/77.5b52f5ee.js"><link rel="prefetch" href="/assets/js/78.29cd0b94.js"><link rel="prefetch" href="/assets/js/79.6074aba6.js"><link rel="prefetch" href="/assets/js/8.01e92a67.js"><link rel="prefetch" href="/assets/js/80.6a9d200c.js"><link rel="prefetch" href="/assets/js/81.f5c9f90e.js"><link rel="prefetch" href="/assets/js/82.695e2419.js"><link rel="prefetch" href="/assets/js/83.abcbf5b8.js"><link rel="prefetch" href="/assets/js/84.eed62881.js"><link rel="prefetch" href="/assets/js/85.7239e9a3.js"><link rel="prefetch" href="/assets/js/86.dc60ad80.js"><link rel="prefetch" href="/assets/js/87.2418f619.js"><link rel="prefetch" href="/assets/js/88.22ac89ee.js"><link rel="prefetch" href="/assets/js/89.3f66a9b7.js"><link rel="prefetch" href="/assets/js/9.a95120b0.js"><link rel="prefetch" href="/assets/js/90.14f864f3.js"><link rel="prefetch" href="/assets/js/91.3b6f998d.js"><link rel="prefetch" href="/assets/js/92.c16e0990.js"><link rel="prefetch" href="/assets/js/93.a0b37916.js"><link rel="prefetch" href="/assets/js/94.35daccad.js"><link rel="prefetch" href="/assets/js/95.16f9adf2.js"><link rel="prefetch" href="/assets/js/96.baabcef4.js"><link rel="prefetch" href="/assets/js/97.781cf1c6.js"><link rel="prefetch" href="/assets/js/98.e8cde142.js"><link rel="prefetch" href="/assets/js/99.b05339e2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8164cbfa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/header.png" alt="高先生的博客" class="logo"> <span class="site-name can-hide">高先生的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="http://gaogangsever.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  页面构建器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/javascript/index.html" class="nav-link">前端</a></div><div class="nav-item"><a href="/vue/index.html" class="nav-link">Vue</a></div><div class="nav-item"><a href="/react/index.html" class="nav-link">React/RN</a></div><div class="nav-item"><a href="/ai/index.html" class="nav-link">AI</a></div><div class="nav-item"><a href="/android/index.html" class="nav-link">Android</a></div><div class="nav-item"><a href="/ios/index.html" class="nav-link">iOS</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">低代码Mendix</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mendix/index.html" class="nav-link">1. Mendix介绍</a></li><li class="dropdown-item"><!----> <a href="/mendix/widgets/index.html" class="nav-link">2. 组件开发</a></li><li class="dropdown-item"><!----> <a href="/mendix/study.html" class="nav-link">3. Mendix学习</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/other/git.html" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/other/vscode.html" class="nav-link">vscode</a></li><li class="dropdown-item"><!----> <a href="https://yeasy.gitbook.io/docker_practice/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  docker
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开源</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/article/oview/index.html" class="nav-link">图表库oView</a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_recyclerview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_recyclerview
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_popup_window" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_popup_window
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/lucky_tools/blob/master/packages/mendix-cli/README.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue开发Mendix组件脚手架
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/cocos-webpack-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cocos web端开发
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/ui-designer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ui 构建器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/KotlinGank" target="_blank" rel="noopener noreferrer" class="nav-link external">
  kotlin App
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/tensorflow_object_detection" target="_blank" rel="noopener noreferrer" class="nav-link external">
  tensorflow object detection
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="http://gaogangsever.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  页面构建器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/javascript/index.html" class="nav-link">前端</a></div><div class="nav-item"><a href="/vue/index.html" class="nav-link">Vue</a></div><div class="nav-item"><a href="/react/index.html" class="nav-link">React/RN</a></div><div class="nav-item"><a href="/ai/index.html" class="nav-link">AI</a></div><div class="nav-item"><a href="/android/index.html" class="nav-link">Android</a></div><div class="nav-item"><a href="/ios/index.html" class="nav-link">iOS</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">低代码Mendix</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mendix/index.html" class="nav-link">1. Mendix介绍</a></li><li class="dropdown-item"><!----> <a href="/mendix/widgets/index.html" class="nav-link">2. 组件开发</a></li><li class="dropdown-item"><!----> <a href="/mendix/study.html" class="nav-link">3. Mendix学习</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/other/git.html" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/other/vscode.html" class="nav-link">vscode</a></li><li class="dropdown-item"><!----> <a href="https://yeasy.gitbook.io/docker_practice/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  docker
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开源</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/article/oview/index.html" class="nav-link">图表库oView</a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_recyclerview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_recyclerview
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_popup_window" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_popup_window
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/lucky_tools/blob/master/packages/mendix-cli/README.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue开发Mendix组件脚手架
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/cocos-webpack-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cocos web端开发
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/ui-designer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ui 构建器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/KotlinGank" target="_blank" rel="noopener noreferrer" class="nav-link external">
  kotlin App
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/tensorflow_object_detection" target="_blank" rel="noopener noreferrer" class="nav-link external">
  tensorflow object detection
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>react-native bundle 到 bundle 生成到底发生了什么(metro 打包流程简析)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#一、前言" class="sidebar-link">一、前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#二、metro-打包流程" class="sidebar-link">二、metro 打包流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#_1-命令参数解析" class="sidebar-link">1. 命令参数解析</a></li><li class="sidebar-sub-header"><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#_2-metro-server-启动" class="sidebar-link">2. Metro Server 启动</a></li><li class="sidebar-sub-header"><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#metro-构建-bundle-流程入口" class="sidebar-link">metro 构建 bundle: 流程入口</a></li><li class="sidebar-sub-header"><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#metro-构建-bundle-解析和转换" class="sidebar-link">metro 构建 bundle: 解析和转换</a></li><li class="sidebar-sub-header"><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#metro-构建-bundle-生成" class="sidebar-link">metro 构建 bundle: 生成</a></li></ul></li><li><a href="/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-native-bundle-到-bundle-生成到底发生了什么-metro-打包流程简析"><a href="#react-native-bundle-到-bundle-生成到底发生了什么-metro-打包流程简析" aria-hidden="true" class="header-anchor">#</a> react-native bundle 到 bundle 生成到底发生了什么(metro 打包流程简析)</h1> <p>本文结合代码约4万字左右，阅读大约需要1小时。</p> <p>本文涉及 <code>react-native</code>及 <code>metro</code> 版本</p> <ul><li><code>react-native@0.63.2</code></li> <li><code>metro@0.58.0</code></li></ul> <p>先来看一波本文的实例代码:很简单吧，一个<code>你好，世界</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// App.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StyleSheet<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> View <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-native&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>React<span class="token punctuation">.</span>Fragment<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>View style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>body<span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>Text style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token operator">&gt;</span>你好，世界<span class="token operator">&lt;</span><span class="token operator">/</span>Text<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>View<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>React<span class="token punctuation">.</span>Fragment<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> styles <span class="token operator">=</span> StyleSheet<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  body<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    backgroundColor<span class="token punctuation">:</span> <span class="token string">&quot;white&quot;</span><span class="token punctuation">,</span>
    flex<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    justifyContent<span class="token punctuation">:</span> <span class="token string">&quot;center&quot;</span><span class="token punctuation">,</span>
    alignItems<span class="token punctuation">:</span> <span class="token string">&quot;center&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  text<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    textAlign<span class="token punctuation">:</span> <span class="token string">&quot;center&quot;</span><span class="token punctuation">,</span>
    color<span class="token punctuation">:</span> <span class="token string">&quot;red&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="一、前言"><a href="#一、前言" aria-hidden="true" class="header-anchor">#</a> 一、前言</h2> <blockquote><p>众所周知，<code>react-native(下文简称rn)</code> 需要打成 <code>bundle</code> 包供 <code>android，ios</code> 加载；通常我们的打包命令为 <code>react-native bundle --entry-file index.js --bundle-output ./bundle/ios.bundle --platform ios --assets-dest ./bundle --dev false</code>；运行上述命令之后，rn 会默认使用 <code>metro</code> 作为打包工具，生成 <code>bundle</code> 包。</p></blockquote> <p>生成的 bundle 包大致分为四层:</p> <ul><li><strong>var 声明层</strong>: 对当前运行环境, bundle 启动时间，以及进程相关信息;</li> <li><strong>polyfill 层</strong>: <code>!(function(r){})</code> , 定义了对 <code>define（__d）</code>、 <code>require（__r）</code>、<code>clear（__c）</code> 的支持，以及 module（react-native 及第三方 dependences 依赖的 module） 的加载逻辑;</li> <li><strong>模块定义层</strong>: __d 定义的代码块，包括 RN 框架源码 js 部分、自定义 js 代码部分、图片资源信息，供 require 引入使用</li> <li><strong>require 层</strong>: r 定义的代码块，找到 d 定义的代码块 并执行</li></ul> <p>格式如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// var声明层</span>

<span class="token keyword">var</span> __BUNDLE_START_TIME__<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>nativePerformanceNow<span class="token operator">?</span><span class="token function">nativePerformanceNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>__DEV__<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span>process<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>process<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>process<span class="token punctuation">.</span>env<span class="token operator">=</span>process<span class="token punctuation">.</span>env<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token operator">=</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token operator">||</span><span class="token string">&quot;production&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//polyfill层</span>

<span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>r<span class="token punctuation">.</span>__r<span class="token operator">=</span>o<span class="token punctuation">,</span>r<span class="token punctuation">.</span><span class="token function-variable function">__d</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">r<span class="token punctuation">,</span>i<span class="token punctuation">,</span>n</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token keyword">var</span> o<span class="token operator">=</span><span class="token punctuation">{</span>dependencyMap<span class="token punctuation">:</span>n<span class="token punctuation">,</span>factory<span class="token punctuation">:</span>r<span class="token punctuation">,</span>hasError<span class="token punctuation">:</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span>importedAll<span class="token punctuation">:</span>t<span class="token punctuation">,</span>importedDefault<span class="token punctuation">:</span>t<span class="token punctuation">,</span>isInitialized<span class="token punctuation">:</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span>publicModule<span class="token punctuation">:</span><span class="token punctuation">{</span>exports<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>o<span class="token punctuation">}</span>


<span class="token operator">...</span>
<span class="token comment">// 模型定义层</span>
<span class="token function">__d</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">g<span class="token punctuation">,</span>r<span class="token punctuation">,</span>i<span class="token punctuation">,</span>a<span class="token punctuation">,</span>m<span class="token punctuation">,</span>e<span class="token punctuation">,</span>d</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> n<span class="token operator">=</span><span class="token function">r</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t<span class="token operator">=</span><span class="token function">r</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>o<span class="token operator">=</span><span class="token function">n</span><span class="token punctuation">(</span><span class="token function">r</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>u<span class="token operator">=</span><span class="token function">r</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>t<span class="token punctuation">.</span>AppRegistry<span class="token punctuation">.</span><span class="token function">registerComponent</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> o<span class="token punctuation">.</span>default<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">402</span><span class="token punctuation">,</span><span class="token number">403</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span><span class="token punctuation">.</span>
<span class="token function">__d</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>e<span class="token punctuation">,</span>t<span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token constant">R</span><span class="token punctuation">,</span><span class="token constant">S</span><span class="token punctuation">,</span>c</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token constant">R</span><span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">&quot;ReactNativeSSR&quot;</span><span class="token punctuation">,</span>displayName<span class="token punctuation">:</span><span class="token string">&quot;ReactNativeSSR&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">403</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// require层</span>
<span class="token function">__r</span><span class="token punctuation">(</span><span class="token number">93</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__r</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre></div><p>看完上面的代码不知你是否疑问？</p> <ol><li><p><code>var</code> 定义层和 <code>polyfill</code> 的代码是在什么时机生成的？</p></li> <li><p>我们知道<code>_d()</code>有三个参数，分别是对应 <code>factory</code> 函数，当前 <code>moduleId</code> 以及 <code>module</code> 依赖关系</p> <ul><li><code>metro</code> 使用什么去做整个工程的依赖分析？</li> <li><code>moduleId</code> 如何生成？</li></ul></li> <li><p><code>metro</code> 如何打包？</p></li></ol> <p>日常开发中我们可能并么有在意，整个 rn 打包逻辑；现在就让笔者带您走入 rn 打包的世界！</p> <h2 id="二、metro-打包流程"><a href="#二、metro-打包流程" aria-hidden="true" class="header-anchor">#</a> 二、metro 打包流程</h2> <p>通过翻阅源码和 Metro 官网，我们知道 metro 打包的整个流程大致分为:</p> <ul><li><code>命令参数解析</code></li> <li><code>metro 打包服务启动</code></li> <li><code>打包 js 和资源文件</code> <ul><li>解析，转化和生成</li></ul></li> <li><code>停止打包服务</code></li></ul> <p><img src="/assets/img/metro.7cd688e4.png" alt=""></p> <h3 id="_1-命令参数解析"><a href="#_1-命令参数解析" aria-hidden="true" class="header-anchor">#</a> 1. 命令参数解析</h3> <p>首先我们来看看 <code>react-native bundle</code>的实现以及参数如何解析；由于 bundle 是 react-native 的一个子命令，那么我们寻找的思路可以从 react-native 包入手；其文件路径如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/react-native/local-cli/cli.js</span>
<span class="token comment">// react-native 命令入口</span>

<span class="token keyword">var</span> cli <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@react-native-community/cli'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>require<span class="token punctuation">.</span>main <span class="token operator">===</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cli<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// node_modules/react-native/node_modules/@react-native-community/cli/build/index.js</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">setupAndRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">var</span> _commands <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./commands&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在node_modules/react-native/node_modules/@react-native-community/cli/build/commands/index.js 中注册了 react-native的所有命令</span>

<span class="token keyword">var</span> _start <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./start/start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _bundle <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./bundle/bundle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _ramBundle <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./bundle/ramBundle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _link <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./link/link&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _unlink <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./link/unlink&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _install <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./install/install&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _uninstall <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./install/uninstall&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _upgrade <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./upgrade/upgrade&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _info <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./info/info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _config <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config/config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _init <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./init&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _doctor <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./doctor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>由于本文主要分析 react-native 打包流程，所以只需查看<code>react-native/node_modules/@react-native-community/cli/build/commands/bundle/bundle.js</code>即可。</p> <p>在 bundle.js 文件中主要注册了 bundle 命令，但是具体的实现却使用了<code>buildBundle.js</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/react-native/node_modules/@react-native-community/cli/build/commands/bundle/bundle.js</span>

<span class="token keyword">var</span> _buildBundle <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./buildBundle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _bundleCommandLineArgs <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./bundleCommandLineArgs&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> obj <span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> obj <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bundleWithOutput</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> config<span class="token punctuation">,</span> args<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// bundle打包的具体实现</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _buildBundle<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> config<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> _default <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">&quot;bundle&quot;</span><span class="token punctuation">,</span>
  description<span class="token punctuation">:</span> <span class="token string">&quot;builds the javascript bundle for offline use&quot;</span><span class="token punctuation">,</span>
  func<span class="token punctuation">:</span> bundleWithOutput<span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> _bundleCommandLineArgs<span class="token punctuation">.</span>default<span class="token punctuation">,</span>
  <span class="token comment">// Used by `ramBundle.js`</span>
  withOutput<span class="token punctuation">:</span> bundleWithOutput<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>default <span class="token operator">=</span> _default<span class="token punctuation">;</span>
<span class="token keyword">const</span> withOutput <span class="token operator">=</span> bundleWithOutput<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>withOutput <span class="token operator">=</span> withOutput<span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-metro-server-启动"><a href="#_2-metro-server-启动" aria-hidden="true" class="header-anchor">#</a> 2. Metro Server 启动</h3> <p>在<code>node_modules/react-native/node_modules/@react-native-community/cli/build/commands/bundle/buildBundle.js</code>文件中默认导出的 <code>buildBundle</code> 方法才是整个<code>react-native bundle</code>执行的入口。在入口中主要做了如下几件事情:</p> <ul><li><p><strong>合并 metro 默认配置和自定义配置，并设置 maxWorkers,resetCache</strong></p></li> <li><p><strong>根据解析得到参数，构建 requestOptions，传递给打包函数</strong></p></li> <li><p><strong>实例化 metro Server</strong></p></li> <li><p><strong>启动 metro 构建 bundle</strong></p></li> <li><p><strong>处理资源文件，解析</strong></p></li> <li><p><strong>关闭 Metro Server</strong></p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/react-native/node_modules/@react-native-community/cli/build/commands/bundle/buildBundle.js</span>
<span class="token comment">// metro打包服务，也是metro的核心</span>
<span class="token keyword">function</span> <span class="token function">_Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;metro/src/Server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function-variable function">_Server</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;metro/src/shared/output/bundle&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function-variable function">_bundle</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 保存资源文件</span>
<span class="token keyword">var</span> _saveAssets <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./saveAssets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 提供了metro的默认配置</span>
<span class="token keyword">var</span> _loadMetroConfig <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../../tools/loadMetroConfig&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">buildBundle</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> output <span class="token operator">=</span> <span class="token function">_bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 合并metro默认配置和自定义配置，并设置maxWorkers,resetCache</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _loadMetroConfig<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    maxWorkers<span class="token punctuation">:</span> args<span class="token punctuation">.</span>maxWorkers<span class="token punctuation">,</span>
    resetCache<span class="token punctuation">:</span> args<span class="token punctuation">.</span>resetCache<span class="token punctuation">,</span>
    config<span class="token punctuation">:</span> args<span class="token punctuation">.</span>config<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...</span>

  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>dev <span class="token operator">?</span> <span class="token string">&quot;development&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据命令行的入参 --sourcemap-output 构建 sourceMapUrl</span>
  <span class="token keyword">let</span> sourceMapUrl <span class="token operator">=</span> args<span class="token punctuation">.</span>sourcemapOutput<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceMapUrl <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>args<span class="token punctuation">.</span>sourcemapUseAbsolutePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sourceMapUrl <span class="token operator">=</span> <span class="token function">_path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>sourceMapUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 根据解析得到参数，构建requestOptions，传递给打包函数</span>
  <span class="token keyword">const</span> requestOpts <span class="token operator">=</span> <span class="token punctuation">{</span>
    entryFile<span class="token punctuation">:</span> args<span class="token punctuation">.</span>entryFile<span class="token punctuation">,</span>
    sourceMapUrl<span class="token punctuation">,</span>
    dev<span class="token punctuation">:</span> args<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
    minify<span class="token punctuation">:</span> args<span class="token punctuation">.</span>minify <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> args<span class="token punctuation">.</span>minify <span class="token punctuation">:</span> <span class="token operator">!</span>args<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
    platform<span class="token punctuation">:</span> args<span class="token punctuation">.</span>platform<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 实例化metro 服务</span>
  <span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token function">_Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 启动打包, what? 作者不是说的是Server打包吗？为什么是output？ 答：下面会讲解</span>
    <span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token keyword">await</span> output<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> requestOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将打包生成的bundle保存到对应的目录</span>
    <span class="token keyword">await</span> output<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>bundle<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token function">_cliTools</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Save the assets of the bundle</span>
    <span class="token comment">//  处理资源文件，解析，并在下一步保存在--assets-dest指定的位置</span>
    <span class="token keyword">const</span> outputAssets <span class="token operator">=</span> <span class="token keyword">await</span> server<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span><span class="token function">_Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token constant">DEFAULT_BUNDLE_OPTIONS</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>requestOpts<span class="token punctuation">,</span>
      bundleType<span class="token punctuation">:</span> <span class="token string">&quot;todo&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// When we're done saving bundle output and the assets, we're done.</span>
    <span class="token comment">// 保存资源文件到指定目录</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _saveAssets<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">(</span>
      outputAssets<span class="token punctuation">,</span>
      args<span class="token punctuation">.</span>platform<span class="token punctuation">,</span>
      args<span class="token punctuation">.</span>assetsDest
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// 停止metro 打包服务</span>
    server<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> _default <span class="token operator">=</span> buildBundle<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>default <span class="token operator">=</span> _default<span class="token punctuation">;</span>
</code></pre></div><p>从上述代码可以看到具体的打包实现都在<code>output.build(server, requestOpts)</code>中，output<code>是</code>outputBundle<code>类型，这部分代码在</code> Metro JS` 中，具体的路径为：node_modules/metro/src/shared/output/bundle.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/shared/output/bundle.js</span>

<span class="token keyword">function</span> <span class="token function">buildBundle</span><span class="token punctuation">(</span><span class="token parameter">packagerClient<span class="token punctuation">,</span> requestOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> packagerClient<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
    <span class="token function">_objectSpread</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Server<span class="token punctuation">.</span><span class="token constant">DEFAULT_BUNDLE_OPTIONS</span><span class="token punctuation">,</span> requestOptions<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      bundleType<span class="token punctuation">:</span> <span class="token string">&quot;bundle&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span>build <span class="token operator">=</span> buildBundle<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>save <span class="token operator">=</span> saveBundleAndMap<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>formatName <span class="token operator">=</span> <span class="token string">&quot;bundle&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到虽说使用的<code>output.build(server, requestOpts)</code>进行打包，其实是使用传入的<code>packagerClient.build</code>进行打包。而<code>packagerClient</code>是我们刚传入的<code>Server</code>。而<code>Server</code>就是下面我们要分析打包流程。其源码位置为:<code>node_modules/metro/src/Server.js</code></p> <h3 id="metro-构建-bundle-流程入口"><a href="#metro-构建-bundle-流程入口" aria-hidden="true" class="header-anchor">#</a> metro 构建 bundle: 流程入口</h3> <p>通过上面的分析，我们已经知晓整个<code>react-native bundle</code> 打包服务的启动在<code>node_modules/metro/src/Server.js</code>的<code>build</code>方法中:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{</span>
  <span class="token comment">// 构建函数，初始化属性</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_config <span class="token operator">=</span> config<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_createModuleId <span class="token operator">=</span> config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span><span class="token function">createModuleIdFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_bundler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IncrementalBundler</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      watch<span class="token punctuation">:</span> options <span class="token operator">?</span> options<span class="token punctuation">.</span>watch <span class="token punctuation">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_nextBundleBuildID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将传递进来的参数，按照模块进行拆分，一遍更好的管理；其拆分的格式如下:</span>
      <span class="token comment">//         {</span>
      <span class="token comment">//     entryFile: options.entryFile,</span>
      <span class="token comment">//     transformOptions: {</span>
      <span class="token comment">//       customTransformOptions: options.customTransformOptions,</span>
      <span class="token comment">//       dev: options.dev,</span>
      <span class="token comment">//       hot: options.hot,</span>
      <span class="token comment">//       minify: options.minify,</span>
      <span class="token comment">//       platform: options.platform,</span>
      <span class="token comment">//       type: &quot;module&quot;</span>
      <span class="token comment">//     },</span>
      <span class="token comment">//     serializerOptions: {</span>
      <span class="token comment">//       excludeSource: options.excludeSource,</span>
      <span class="token comment">//       inlineSourceMap: options.inlineSourceMap,</span>
      <span class="token comment">//       modulesOnly: options.modulesOnly,</span>
      <span class="token comment">//       runModule: options.runModule,</span>
      <span class="token comment">//       sourceMapUrl: options.sourceMapUrl,</span>
      <span class="token comment">//       sourceUrl: options.sourceUrl</span>
      <span class="token comment">//     },</span>
      <span class="token comment">//     graphOptions: {</span>
      <span class="token comment">//       shallow: options.shallow</span>
      <span class="token comment">//     },</span>
      <span class="token comment">//     onProgress: options.onProgress</span>
      <span class="token comment">//   }</span>

      <span class="token keyword">const</span> _splitBundleOptions <span class="token operator">=</span> <span class="token function">splitBundleOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
        entryFile <span class="token operator">=</span> _splitBundleOptions<span class="token punctuation">.</span>entryFile<span class="token punctuation">,</span>
        graphOptions <span class="token operator">=</span> _splitBundleOptions<span class="token punctuation">.</span>graphOptions<span class="token punctuation">,</span>
        onProgress <span class="token operator">=</span> _splitBundleOptions<span class="token punctuation">.</span>onProgress<span class="token punctuation">,</span>
        serializerOptions <span class="token operator">=</span> _splitBundleOptions<span class="token punctuation">.</span>serializerOptions<span class="token punctuation">,</span>
        transformOptions <span class="token operator">=</span> _splitBundleOptions<span class="token punctuation">.</span>transformOptions<span class="token punctuation">;</span>

      <span class="token comment">// metro打包核心：解析(Resolution)和转换(Transformation)</span>
      <span class="token keyword">const</span> _ref13 <span class="token operator">=</span> <span class="token keyword">yield</span> _this2<span class="token punctuation">.</span>_bundler<span class="token punctuation">.</span><span class="token function">buildGraph</span><span class="token punctuation">(</span>
          entryFile<span class="token punctuation">,</span>
          transformOptions<span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            onProgress<span class="token punctuation">,</span>
            shallow<span class="token punctuation">:</span> graphOptions<span class="token punctuation">.</span>shallow<span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        prepend <span class="token operator">=</span> _ref13<span class="token punctuation">.</span>prepend<span class="token punctuation">,</span>
        graph <span class="token operator">=</span> _ref13<span class="token punctuation">.</span>graph<span class="token punctuation">;</span>

      <span class="token comment">// 获取构建入口文件路径</span>
      <span class="token keyword">const</span> entryPoint <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>_this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span> entryFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 初始化构建参数，此处的参数来源于: 命令行 &amp;&amp; 自定义metro配置metro.config.js &amp;&amp; 默认的metro配置</span>
      <span class="token keyword">const</span> bundleOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
        asyncRequireModulePath<span class="token punctuation">:</span>
          _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>transformer<span class="token punctuation">.</span>asyncRequireModulePath<span class="token punctuation">,</span>
        processModuleFilter<span class="token punctuation">:</span> _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>processModuleFilter<span class="token punctuation">,</span>
        createModuleId<span class="token punctuation">:</span> _this2<span class="token punctuation">.</span>_createModuleId<span class="token punctuation">,</span> <span class="token comment">// 里面自定义/默认的createModuleIdFactory给每个module生成id; 其默认生成规则详情请见: node_modules/metro/src/lib/createModuleIdFactory.js</span>
        getRunModuleStatement<span class="token punctuation">:</span> _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>getRunModuleStatement<span class="token punctuation">,</span> <span class="token comment">// 给方法签名</span>
        <span class="token comment">// 默认值为     getRunModuleStatement: moduleId =&gt; `__r(${JSON.stringify(moduleId)});`,</span>
        <span class="token comment">//  详情请见: node_modules/metro-config/src/defaults/index.js</span>
        dev<span class="token punctuation">:</span> transformOptions<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
        projectRoot<span class="token punctuation">:</span> _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span>
        modulesOnly<span class="token punctuation">:</span> serializerOptions<span class="token punctuation">.</span>modulesOnly<span class="token punctuation">,</span>
        runBeforeMainModule<span class="token punctuation">:</span> _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span><span class="token function">getModulesRunBeforeMainModule</span><span class="token punctuation">(</span>
          path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>_this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span> entryPoint<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 指定在主模块前运行的模块, 默认值: getModulesRunBeforeMainModule: () =&gt; []</span>
        <span class="token comment">// 详情请见: node_modules/metro-config/src/defaults/index.js</span>

        runModule<span class="token punctuation">:</span> serializerOptions<span class="token punctuation">.</span>runModule<span class="token punctuation">,</span>
        sourceMapUrl<span class="token punctuation">:</span> serializerOptions<span class="token punctuation">.</span>sourceMapUrl<span class="token punctuation">,</span>
        sourceUrl<span class="token punctuation">:</span> serializerOptions<span class="token punctuation">.</span>sourceUrl<span class="token punctuation">,</span>
        inlineSourceMap<span class="token punctuation">:</span> serializerOptions<span class="token punctuation">.</span>inlineSourceMap<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> bundleCode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> bundleMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token comment">// 是否使用自定义生成，如果是，则调用自定义生成的函数，获取最终代码</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>customSerializer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> bundle <span class="token operator">=</span> _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span><span class="token function">customSerializer</span><span class="token punctuation">(</span>
          entryPoint<span class="token punctuation">,</span>
          prepend<span class="token punctuation">,</span>
          graph<span class="token punctuation">,</span>
          bundleOptions
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> bundle <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          bundleCode <span class="token operator">=</span> bundle<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          bundleCode <span class="token operator">=</span> bundle<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
          bundleMap <span class="token operator">=</span> bundle<span class="token punctuation">.</span>map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 此处笔者将其拆分成两个步骤，比较容易分析</span>

        <span class="token comment">// 将解析及转化之后的数据，生成如下格式化的数据</span>
        <span class="token comment">// {</span>
        <span class="token comment">//   pre: string, // var定义部分及poyfill部分的代码</span>
        <span class="token comment">//   post: string, // require部分代码</span>
        <span class="token comment">//   modules: [[number, string]], // 模块定义部分，第一个参数为number，第二个参数为具体的代码</span>
        <span class="token comment">// }</span>
        <span class="token keyword">var</span> base <span class="token operator">=</span> <span class="token function">baseJSBundle</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span> prepend<span class="token punctuation">,</span> graph<span class="token punctuation">,</span> bundleOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将js module进行排序并进行字符串拼接生成最终的代码</span>
        bundleCode <span class="token operator">=</span> <span class="token function">bundleToString</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bundleMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bundleMap <span class="token operator">=</span> <span class="token function">sourceMapString</span><span class="token punctuation">(</span>
          <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>prepend<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
            <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>_this2<span class="token punctuation">.</span><span class="token function">_getSortedModules</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            excludeSource<span class="token punctuation">:</span> serializerOptions<span class="token punctuation">.</span>excludeSource<span class="token punctuation">,</span>
            processModuleFilter<span class="token punctuation">:</span> _this2<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>processModuleFilter<span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        code<span class="token punctuation">:</span> bundleCode<span class="token punctuation">,</span>
        map<span class="token punctuation">:</span> bundleMap<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这个 build 函数中，首先执行了 <code>buildGraph，而</code> <code>this._bundler</code> 的初始化发生在 Server 的 <code>constructor</code> 中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>_bundler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IncrementalBundler</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  watch<span class="token punctuation">:</span> options <span class="token operator">?</span> options<span class="token punctuation">.</span>watch <span class="token punctuation">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>此处的<code>_bundler</code>是 <code>IncrementalBundler</code> 的实例，它的 <code>buildGraph</code> 函数完成了打包过程中前两步 <code>Resolution</code> 和 <code>Transformation</code> 。 下面我们就来详细查看一下 Metro 解析，转换过程。</p> <h3 id="metro-构建-bundle-解析和转换"><a href="#metro-构建-bundle-解析和转换" aria-hidden="true" class="header-anchor">#</a> metro 构建 bundle: 解析和转换</h3> <p>在上面一节我们知道 metro 使用<code>IncrementalBundler</code>进行 js 代码的解析和转换，在 Metro 使用<code>IncrementalBundler</code>进行解析转换的主要作用是：</p> <ul><li>返回了<strong>以入口文件为入口的所有相关依赖文件的依赖图谱和 babel 转换后的代码</strong>；</li> <li>返回了<strong>var 定义部分及 polyfill 部分所有相关依赖文件的依赖图谱和 babel 转换后的代码</strong>；</li></ul> <p>整体流程如图所示:</p> <p><img src="/assets/img/metro-build.a44983e0.png" alt=""></p> <p>通过上述的流程我们总结如下几点:</p> <ol><li>整个 metro 进行依赖分析和 babel 转换主要通过了<a href="https://github.com/facebook/jest/tree/master/packages/jest-haste-map/src" target="_blank" rel="noopener noreferrer">JestHasteMap<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>去做依赖分析；</li> <li>在做依赖分析的通过，metro 会监听当前目录的文件变化，然后以最小变化生成最终依赖关系图谱；</li> <li>不管是入口文件解析还是 polyfill 文件的依赖解析都是使用了<a href="https://github.com/facebook/jest/tree/master/packages/jest-haste-map/src" target="_blank" rel="noopener noreferrer">JestHasteMap<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>;</li></ol> <p>下面，我们来分析其具体过程如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/IncrementalBundler.js</span>


<span class="token function">buildGraph</span><span class="token punctuation">(</span><span class="token parameter">entryFile<span class="token punctuation">,</span> transformOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> otherOptions <span class="token operator">=</span>
      arguments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span>
        <span class="token operator">?</span> arguments<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token punctuation">:</span> <span class="token punctuation">{</span>
            onProgress<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            shallow<span class="token punctuation">:</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 核心构建在buildGraphForEntries中，通过入口文件进行依赖解析，得到bundle require部分和模块定义部分，其生成的格式为</span>
    <span class="token comment">//    {</span>
    <span class="token comment">//         dependencies: new Map(),</span>
    <span class="token comment">//         entryPoints,</span>
    <span class="token comment">//         importBundleNames: new Set()</span>
    <span class="token comment">//    }</span>
      <span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token keyword">yield</span> _this2<span class="token punctuation">.</span><span class="token function">buildGraphForEntries</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>entryFile<span class="token punctuation">]</span><span class="token punctuation">,</span>
        transformOptions<span class="token punctuation">,</span>
        otherOptions
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> transformOptionsWithoutType <span class="token operator">=</span> <span class="token punctuation">{</span>
        customTransformOptions<span class="token punctuation">:</span> transformOptions<span class="token punctuation">.</span>customTransformOptions<span class="token punctuation">,</span>
        dev<span class="token punctuation">:</span> transformOptions<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
        experimentalImportSupport<span class="token punctuation">:</span> transformOptions<span class="token punctuation">.</span>experimentalImportSupport<span class="token punctuation">,</span>
        hot<span class="token punctuation">:</span> transformOptions<span class="token punctuation">.</span>hot<span class="token punctuation">,</span>
        minify<span class="token punctuation">:</span> transformOptions<span class="token punctuation">.</span>minify<span class="token punctuation">,</span>
        unstable_disableES6Transforms<span class="token punctuation">:</span>
          transformOptions<span class="token punctuation">.</span>unstable_disableES6Transforms<span class="token punctuation">,</span>
        platform<span class="token punctuation">:</span> transformOptions<span class="token punctuation">.</span>platform
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//   bundle前面的var声明和polyfill，生成的格式为:</span>
        <span class="token comment">// [</span>
        <span class="token comment">//     {</span>
        <span class="token comment">//         inverseDependencies: Set(0) {},</span>
        <span class="token comment">//         path: '/Users/mrgaogang/Desktop/react-native-ssr/ReactNativeSSR/node_modules/react-native/Libraries/polyfills/Object.es7.js',</span>
        <span class="token comment">//         dependencies: Map(0) {},</span>
        <span class="token comment">//         getSource: [Function: getSource],</span>
        <span class="token comment">//         output: [ [Object] ]</span>
        <span class="token comment">//     }</span>
        <span class="token comment">// ]</span>
      <span class="token keyword">const</span> prepend <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getPrependedScripts</span><span class="token punctuation">(</span>
        _this2<span class="token punctuation">.</span>_config<span class="token punctuation">,</span>
        transformOptionsWithoutType<span class="token punctuation">,</span>
        _this2<span class="token punctuation">.</span>_bundler<span class="token punctuation">,</span>
        _this2<span class="token punctuation">.</span>_deltaBundler
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        prepend<span class="token punctuation">,</span>
        graph
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="require-和模块定义部分解析和依赖生成"><a href="#require-和模块定义部分解析和依赖生成" aria-hidden="true" class="header-anchor">#</a> require 和模块定义部分解析和依赖生成</h4> <p>在 <code>buildGraphForEntries</code>中利用<code>_deltaBundler.buildGraph</code>生成 graph,</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/IncrementalBundler.js</span>

  <span class="token function">buildGraphForEntries</span><span class="token punctuation">(</span><span class="token parameter">entryFiles<span class="token punctuation">,</span> transformOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token keyword">const</span> absoluteEntryFiles <span class="token operator">=</span> entryFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">entryFile</span> <span class="token operator">=&gt;</span>
        path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span> entryFile<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 调用 DeltaBundler.buildGraph</span>
      <span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token keyword">yield</span> _this<span class="token punctuation">.</span>_deltaBundler<span class="token punctuation">.</span><span class="token function">buildGraph</span><span class="token punctuation">(</span>absoluteEntryFiles<span class="token punctuation">,</span> <span class="token punctuation">{</span>
       <span class="token comment">// ... 一些其他的参数</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ....</span>
      <span class="token keyword">return</span> graph<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// node_modules/metro/src/DeltaBundler.js</span>
  <span class="token function">buildGraph</span><span class="token punctuation">(</span><span class="token parameter">entryPoints<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用node_modules/metro/src/Bundler.js 获取模块依赖图谱</span>
      <span class="token keyword">const</span> depGraph <span class="token operator">=</span> <span class="token keyword">yield</span> _this<span class="token punctuation">.</span>_bundler<span class="token punctuation">.</span><span class="token function">getDependencyGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 监听文件变化，如果文件存在变化则更新文件之间的依赖</span>
      <span class="token keyword">const</span> deltaCalculator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeltaCalculator</span><span class="token punctuation">(</span>
        entryPoints<span class="token punctuation">,</span>
        depGraph<span class="token punctuation">,</span>
        options
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 计算模块之间的变化，包括模块的增加删除和修改，如果有变化则第一时间更新</span>
      <span class="token keyword">yield</span> deltaCalculator<span class="token punctuation">.</span><span class="token function">getDelta</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        reset<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        shallow<span class="token punctuation">:</span> options<span class="token punctuation">.</span>shallow
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 根据返回的依赖图谱以及文件变化检测之后的结果，返回如下格式的的模块依赖信息。(完整格式化后面会给出)</span>
    <span class="token comment">//    {</span>
    <span class="token comment">//         dependencies: new Map(),</span>
    <span class="token comment">//         entryPoints,</span>
    <span class="token comment">//         importBundleNames: new Set()</span>
    <span class="token comment">//    }</span>
      <span class="token keyword">const</span> graph <span class="token operator">=</span> deltaCalculator<span class="token punctuation">.</span><span class="token function">getGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      _this<span class="token punctuation">.</span>_deltaCalculators<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> deltaCalculator<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> graph<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">//  node_modules/metro/src/Bundler.js</span>
<span class="token comment">//  依赖图谱分析</span>
<span class="token keyword">class</span> <span class="token class-name">Bundler</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Bundler又使用DependencyGraph进行依赖分析，生成依赖图谱</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_depGraphPromise <span class="token operator">=</span> DependencyGraph<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_depGraphPromise
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">dependencyGraph</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_transformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">(</span>
          config<span class="token punctuation">,</span>
          dependencyGraph<span class="token punctuation">.</span><span class="token function">getSha1</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>dependencyGraph<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to construct transformer: &quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getDependencyGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_depGraphPromise<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 依赖分析图谱 DependencyGraph.load使用 JestHasteMap进行依赖分析</span>
<span class="token comment">// node_modules/metro/src/node-haste/DependencyGraph.js</span>

<span class="token keyword">static</span> <span class="token function">_createHaste</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> watch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JestHasteMap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      cacheDirectory<span class="token punctuation">:</span> config<span class="token punctuation">.</span>hasteMapCacheDirectory<span class="token punctuation">,</span>
      computeDependencies<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      computeSha1<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      extensions<span class="token punctuation">:</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>sourceExts<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>assetExts<span class="token punctuation">)</span><span class="token punctuation">,</span>
      forceNodeFilesystemAPI<span class="token punctuation">:</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>useWatchman<span class="token punctuation">,</span>
      hasteImplModulePath<span class="token punctuation">:</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>hasteImplModulePath<span class="token punctuation">,</span>
      ignorePattern<span class="token punctuation">:</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>blacklistRE <span class="token operator">||</span> <span class="token regex">/ ^/</span><span class="token punctuation">,</span>
      mapper<span class="token punctuation">:</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>virtualMapper<span class="token punctuation">,</span>
      maxWorkers<span class="token punctuation">:</span> config<span class="token punctuation">.</span>maxWorkers<span class="token punctuation">,</span>
      mocksPattern<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">&quot;metro-&quot;</span> <span class="token operator">+</span> <span class="token constant">JEST_HASTE_MAP_CACHE_BREAKER</span><span class="token punctuation">,</span>
      platforms<span class="token punctuation">:</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>platforms<span class="token punctuation">,</span>
      retainAllFiles<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      resetCache<span class="token punctuation">:</span> config<span class="token punctuation">.</span>resetCache<span class="token punctuation">,</span>
      rootDir<span class="token punctuation">:</span> config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span>
      roots<span class="token punctuation">:</span> config<span class="token punctuation">.</span>watchFolders<span class="token punctuation">,</span>
      throwOnModuleCollision<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      useWatchman<span class="token punctuation">:</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>useWatchman<span class="token punctuation">,</span>
      watch<span class="token punctuation">:</span> watch <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token operator">!</span>ci<span class="token punctuation">.</span>isCI <span class="token punctuation">:</span> watch
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> haste <span class="token operator">=</span> DependencyGraph<span class="token punctuation">.</span><span class="token function">_createHaste</span><span class="token punctuation">(</span>
        config<span class="token punctuation">,</span>
        options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>watch
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> _ref2 <span class="token operator">=</span> <span class="token keyword">yield</span> haste<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        hasteFS <span class="token operator">=</span> _ref2<span class="token punctuation">.</span>hasteFS<span class="token punctuation">,</span>
        moduleMap <span class="token operator">=</span> _ref2<span class="token punctuation">.</span>moduleMap<span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DependencyGraph</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        haste<span class="token punctuation">,</span>
        initialHasteFS<span class="token punctuation">:</span> hasteFS<span class="token punctuation">,</span>
        initialModuleMap<span class="token punctuation">:</span> moduleMap<span class="token punctuation">,</span>
        config
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


<span class="token comment">//   JestHasteMap是一个用于node.js静态资源的依赖项管理系统。它提供了为节点模块解析和Facebook的haste模块系统静态解析JavaScript模块依赖性的功能。</span>

<span class="token comment">// 由于haste map创建是同步的，且大多数任务被I / O阻塞，因此采用了电脑的多内核进行并行操作。</span>

</code></pre></div><p>经过<code>DependencyGraph.load</code>和<code>DeltaCalculator</code>之后，生成的依赖图谱格式如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  dependencies<span class="token punctuation">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">404</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 每一个模块的依赖信息等</span>
    <span class="token string">'/Users/mrgaogang/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

            inverseDependencies<span class="token punctuation">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token string">'/Users/mrgaogang/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            path<span class="token punctuation">:</span> <span class="token string">'/Users/mrgaogang/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span><span class="token punctuation">,</span> <span class="token comment">// 模块路径</span>
            dependencies<span class="token punctuation">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">8</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 该模块依赖的其他模块</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            getSource<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
            output<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                code<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// 打包的改模块的代码</span>
                lineCount<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                map<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
                functionMap<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    names<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'&lt;global&gt;'</span><span class="token punctuation">,</span> <span class="token string">'App'</span><span class="token punctuation">,</span> <span class="token string">'render'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    mappings<span class="token punctuation">:</span> <span class="token string">'AAA;eCW;ECC;GDQ;CDC'</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                type<span class="token punctuation">:</span> <span class="token string">'js/module'</span> <span class="token comment">// 类型，metro会通过是否startWidth('js')判断是否为js模块</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  entryPoints<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment">// 入口</span>
    <span class="token string">'/Users/mrgaogang/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  importBundleNames<span class="token punctuation">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><h4 id="var-及-polyfill-部分解析"><a href="#var-及-polyfill-部分解析" aria-hidden="true" class="header-anchor">#</a> var 及 polyfill 部分解析</h4> <p>前面看到在<code>IncrementalBundler.js的 buildGraph</code>中通过<code>getPrependedScripts</code>获取到<strong>var 和 polyfill</strong>部分的代码；下面我们一些查看一下<code>getPrependedScripts</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/lib/getPreludeCode.js</span>
<span class="token keyword">function</span> <span class="token function">_getPrependedScripts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _getPrependedScripts <span class="token operator">=</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>
    config<span class="token punctuation">,</span>
    options<span class="token punctuation">,</span>
    bundler<span class="token punctuation">,</span>
    deltaBundler
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取所有的polyfills，包括默认的和自定义的polyfill</span>
    <span class="token comment">// 默认的polyfill请见: node_modules/react-native/node_modules/@react-native-community/cli/build/tools/loadMetroConfig.js getDefaultConfig:function 中使用了 node_modules/react-native/rn-get-polyfills.js 也即</span>
    <span class="token comment">// module.exports = () =&gt; [</span>
    <span class="token comment">//     require.resolve('./Libraries/polyfills/console.js'),</span>
    <span class="token comment">//     require.resolve('./Libraries/polyfills/error-guard.js'),</span>
    <span class="token comment">//     require.resolve('./Libraries/polyfills/Object.es7.js'),</span>
    <span class="token comment">// ];</span>

    <span class="token keyword">const</span> polyfillModuleNames <span class="token operator">=</span> config<span class="token punctuation">.</span>serializer
      <span class="token punctuation">.</span><span class="token function">getPolyfills</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        platform<span class="token punctuation">:</span> options<span class="token punctuation">.</span>platform<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>polyfillModuleNames<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> transformOptions <span class="token operator">=</span> <span class="token function">_objectSpread</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token string">&quot;script&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过  deltaBundler.buildGraph 分析 如下四个文件及自定义polyfill的依赖关系图谱</span>
    <span class="token comment">//      metro/src/lib/polyfills/require.js</span>
    <span class="token comment">//     require.resolve('./Libraries/polyfills/console.js'),</span>
    <span class="token comment">//     require.resolve('./Libraries/polyfills/error-guard.js'),</span>
    <span class="token comment">//     require.resolve('./Libraries/polyfills/Object.es7.js'),</span>
    <span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token keyword">yield</span> deltaBundler<span class="token punctuation">.</span><span class="token function">buildGraph</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span>defaults<span class="token punctuation">.</span>moduleSystem<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>polyfillModuleNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        resolve<span class="token punctuation">:</span> <span class="token keyword">yield</span> transformHelpers<span class="token punctuation">.</span><span class="token function">getResolveDependencyFn</span><span class="token punctuation">(</span>
          bundler<span class="token punctuation">,</span>
          options<span class="token punctuation">.</span>platform
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        transform<span class="token punctuation">:</span> <span class="token keyword">yield</span> transformHelpers<span class="token punctuation">.</span><span class="token function">getTransformFn</span><span class="token punctuation">(</span>
          <span class="token punctuation">[</span>defaults<span class="token punctuation">.</span>moduleSystem<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
            <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>polyfillModuleNames<span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          bundler<span class="token punctuation">,</span>
          deltaBundler<span class="token punctuation">,</span>
          config<span class="token punctuation">,</span>
          transformOptions
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        onProgress<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        experimentalImportBundleSupport<span class="token punctuation">:</span>
          config<span class="token punctuation">.</span>transformer<span class="token punctuation">.</span>experimentalImportBundleSupport<span class="token punctuation">,</span>
        shallow<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token comment">// 返回 var定义部分和 经过  deltaBundler.buildGraph 分析的之后的polyfill依赖图谱</span>
      <span class="token function">_getPrelude</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        dev<span class="token punctuation">:</span> options<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>graph<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">_getPrependedScripts</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_getPrelude</span><span class="token punctuation">(</span><span class="token parameter">_ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dev <span class="token operator">=</span> _ref<span class="token punctuation">.</span>dev<span class="token punctuation">;</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">getPreludeCode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    isDev<span class="token punctuation">:</span> dev<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;__prelude__&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    dependencies<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">getSource</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span>
    inverseDependencies<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> name<span class="token punctuation">,</span>
    output<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> <span class="token string">&quot;js/script/virtual&quot;</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          code<span class="token punctuation">,</span>
          lineCount<span class="token punctuation">:</span> <span class="token function">countLines</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span>
          map<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// node_modules/metro/src/lib/getPreludeCode.js</span>
<span class="token comment">// var定义部分的代码</span>
<span class="token keyword">function</span> <span class="token function">getPreludeCode</span><span class="token punctuation">(</span><span class="token parameter">_ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> extraVars <span class="token operator">=</span> _ref<span class="token punctuation">.</span>extraVars<span class="token punctuation">,</span>
    isDev <span class="token operator">=</span> _ref<span class="token punctuation">.</span>isDev<span class="token punctuation">;</span>
  <span class="token keyword">const</span> vars <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;__BUNDLE_START_TIME__=this.nativePerformanceNow?nativePerformanceNow():Date.now()&quot;</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__DEV__=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>isDev<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">_toConsumableArray</span><span class="token punctuation">(</span><span class="token function">formatExtraVars</span><span class="token punctuation">(</span>extraVars<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;process=this.process||{}&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">var </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vars<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">processEnv</span><span class="token punctuation">(</span>
    isDev <span class="token operator">?</span> <span class="token string">&quot;development&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;production&quot;</span>
  <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此处还有一个部分作者没有详细进行讲述，那就是使用<a href="https://github.com/facebook/jest/tree/master/packages/jest-haste-map/src" target="_blank" rel="noopener noreferrer">JestHasteMap<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 进行文件依赖解析详细部分；后续笔者会单独出一篇文章进行讲解，关于查阅。</p> <p>至此，metro 对入口文件及 polyfills 依赖分析及代码生成以及讲述完毕，回过头再看一下此章节的开头部分，不知您是否已豁然开朗。讲述了 Metro 的解析和转换，下面部分将讲述 Metro 如果通过转换后的文件依赖图谱生成最终的 bundle 代码。</p> <h3 id="metro-构建-bundle-生成"><a href="#metro-构建-bundle-生成" aria-hidden="true" class="header-anchor">#</a> metro 构建 bundle: 生成</h3> <p>回到最开始的 Server 服务启动代码部分，我们发现经过<code>buildGraph</code>之后得到了<code>prepend: var及polyfill部分的代码和依赖关系</code>以及<code>graph: 入口文件的依赖关系及代码</code>；在<strong>没有提供自定义生成的情况下</strong> metro 使用了<code>baseJSBundle</code>将依赖关系图谱和每个模块的代码经过一系列的操作最终使用 <code>bundleToString</code> 转换成最终的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code>
      <span class="token comment">// metro打包核心：解析(Resolution)和转换(Transformation)</span>
      <span class="token keyword">const</span> _ref13 <span class="token operator">=</span> <span class="token keyword">yield</span> _this2<span class="token punctuation">.</span>_bundler<span class="token punctuation">.</span><span class="token function">buildGraph</span><span class="token punctuation">(</span>
          entryFile<span class="token punctuation">,</span>
          transformOptions<span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            onProgress<span class="token punctuation">,</span>
            shallow<span class="token punctuation">:</span> graphOptions<span class="token punctuation">.</span>shallow<span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        prepend <span class="token operator">=</span> _ref13<span class="token punctuation">.</span>prepend<span class="token punctuation">,</span>
        graph <span class="token operator">=</span> _ref13<span class="token punctuation">.</span>graph<span class="token punctuation">;</span>
        <span class="token comment">// ....</span>
        <span class="token comment">// 此处笔者将其拆分成两个步骤，比较容易分析</span>

        <span class="token comment">// 将解析及转化之后的数据，生成如下格式化的数据</span>
        <span class="token comment">// {</span>
        <span class="token comment">//   pre: string, // var定义部分及poyfill部分的代码</span>
        <span class="token comment">//   post: string, // require部分代码</span>
        <span class="token comment">//   modules: [[number, string]], // 模块定义部分，第一个参数为number，第二个参数为具体的代码</span>
        <span class="token comment">// }</span>
        <span class="token keyword">var</span> base <span class="token operator">=</span> <span class="token function">baseJSBundle</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span> prepend<span class="token punctuation">,</span> graph<span class="token punctuation">,</span> bundleOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将js module进行排序并进行字符串拼接生成最终的代码</span>
        bundleCode <span class="token operator">=</span> <span class="token function">bundleToString</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span>

</code></pre></div><p>在关注<code>baseJSBundle</code>之前，我们先来回顾一下，graph 和 prepend 的数据结构:其主要包括如下几个信息:</p> <ol><li><strong>文件相关的依赖关系</strong></li> <li><strong>指定 module 经过 babel 之后的代码</strong></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// graph</span>
<span class="token punctuation">[</span>
<span class="token punctuation">{</span>
  dependencies<span class="token punctuation">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">404</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 入口文件下每个文件所依赖其他文件的关系图谱</span>
    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token punctuation">{</span>
    inverseDependencies<span class="token punctuation">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span><span class="token punctuation">,</span>
    dependencies<span class="token punctuation">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">8</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token string">'@babel/runtime/helpers/createClass'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        absolutePath<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/node_modules/@babel/runtime/helpers/createClass.js'</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          name<span class="token punctuation">:</span> <span class="token string">'@babel/runtime/helpers/createClass'</span><span class="token punctuation">,</span>
          data<span class="token punctuation">:</span> <span class="token punctuation">{</span> isAsync<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// ....</span>
      <span class="token string">'react'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        absolutePath<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/node_modules/react/index.js'</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'react'</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">{</span> isAsync<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'react-native'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        absolutePath<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/node_modules/react-native/index.js'</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'react-native'</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">{</span> isAsync<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    getSource<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
    output<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token comment">// 对应文件转换后的代码</span>
          code<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__d(function(g,r,i,a,m,e,d){var t=r(d[0]);Object.defineProperty(e,&quot;__esModule&quot;,{value:!0}),e.default=void 0;var n=t(r(d[1])),u=t(r(d[2])),l=t(r(d[3])),c=t(r(d[4])),f=t(r(d[5])),o=t(r(d[6])),s=r(d[7]);function y(){if(&quot;undefined&quot;==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if(&quot;function&quot;==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}var p=(function(t){(0,l.default)(R,t);var p,h,x=(p=R,h=y(),function(){var t,n=(0,f.default)(p);if(h){var u=(0,f.default)(this).constructor;t=Reflect.construct(n,arguments,u)}else t=n.apply(this,arguments);return(0,c.default)(this,t)});function R(){return(0,n.default)(this,R),x.apply(this,arguments)}return(0,u.default)(R,[{key:&quot;render&quot;,value:function(){return o.default.createElement(o.default.Fragment,null,o.default.createElement(s.View,{style:v.body},o.default.createElement(s.Text,{style:v.text},&quot;\\u4f60\\u597d\\uff0c\\u4e16\\u754c&quot;)))}}]),R})(o.default.Component);e.default=p;var v=s.StyleSheet.create({body:{backgroundColor:'white',flex:1,justifyContent:'center',alignItems:'center'},text:{textAlign:'center',color:'red'}})});</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          lineCount<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          map<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">177</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'_react'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">179</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'_interopRequireDefault'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">181</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'r'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">183</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'d'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">185</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'_reactNative'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment">// .....</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          functionMap<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            names<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'&lt;global&gt;'</span><span class="token punctuation">,</span> <span class="token string">'App'</span><span class="token punctuation">,</span> <span class="token string">'render'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            mappings<span class="token punctuation">:</span> <span class="token string">'AAA;eCW;ECC;GDQ;CDC'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> <span class="token string">'js/module'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      inverseDependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>Set<span class="token punctuation">]</span><span class="token punctuation">,</span>
      path<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span><span class="token punctuation">,</span>
      dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>Map<span class="token punctuation">]</span><span class="token punctuation">,</span>
      getSource<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
      output<span class="token punctuation">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/app.json'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      inverseDependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>Set<span class="token punctuation">]</span><span class="token punctuation">,</span>
      path<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/app.json'</span><span class="token punctuation">,</span>
      dependencies<span class="token punctuation">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      getSource<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
      output<span class="token punctuation">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  entryPoints<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment">//入口文件</span>
    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  importBundleNames<span class="token punctuation">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">]</span>
</code></pre></div><h4 id="basejsbundle"><a href="#basejsbundle" aria-hidden="true" class="header-anchor">#</a> baseJSBundle</h4> <p>下面我们我们重点关注一下<code>baseJSBundle</code>是如何处理上述的数据结构的:</p> <ul><li><p><code>baseJSBundle</code>整体调用了三次 <code>processModules</code>分别用于解析出: <code>preCode</code> , <code>postCode</code> 和 <code>modules</code> 其对应的分别是<strong>var 和 polyfills 部分的代码</strong> , <strong>require 部分的代码</strong> , <strong>_d 部分的代码</strong></p></li> <li><p><code>processModules</code> 经过两次 <code>filter</code> 过滤出所有类型为 <code>js/</code>类型的数据，第二次过滤使用用户自定义 <code>filter</code> 函数；过滤完成之后使用 <code>wrapModule</code> 转换成<code>_d(factory,moduleId,dependencies)</code>的代码</p></li> <li><p><strong>baseJSBundle</strong></p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/DeltaBundler/Serializers/baseJSBundle.js</span>
<span class="token keyword">function</span> <span class="token function">baseJSBundle</span><span class="token punctuation">(</span><span class="token parameter">entryPoint<span class="token punctuation">,</span> preModules<span class="token punctuation">,</span> graph<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> graph<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> processModulesOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    filter<span class="token punctuation">:</span> options<span class="token punctuation">.</span>processModuleFilter<span class="token punctuation">,</span>
    createModuleId<span class="token punctuation">:</span> options<span class="token punctuation">.</span>createModuleId<span class="token punctuation">,</span>
    dev<span class="token punctuation">:</span> options<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
    projectRoot<span class="token punctuation">:</span> options<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// Do not prepend polyfills or the require runtime when only modules are requested</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>modulesOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    preModules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 通过processModules将metro解析后的prepend依赖关系图谱和代码，filter+join成对应的bundle出的代码</span>
  <span class="token keyword">const</span> preCode <span class="token operator">=</span> <span class="token function">processModules</span><span class="token punctuation">(</span>preModules<span class="token punctuation">,</span> processModulesOptions<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_ref</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> _ref2 <span class="token operator">=</span> <span class="token function">_slicedToArray</span><span class="token punctuation">(</span>_ref<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=</span> _ref2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        code <span class="token operator">=</span> _ref2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>graph<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">-</span> options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 使用getAppendScripts获取入口文件及所有的runBeforeMainModule文件的依赖图谱和 使用 getRunModuleStatement 方法生成_r(moduleId)的代码，调用processModules生成最终代码</span>
  <span class="token keyword">const</span> postCode <span class="token operator">=</span> <span class="token function">processModules</span><span class="token punctuation">(</span>
    <span class="token function">getAppendScripts</span><span class="token punctuation">(</span>
      entryPoint<span class="token punctuation">,</span>
      <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>preModules<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      graph<span class="token punctuation">.</span>importBundleNames<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        asyncRequireModulePath<span class="token punctuation">:</span> options<span class="token punctuation">.</span>asyncRequireModulePath<span class="token punctuation">,</span>
        createModuleId<span class="token punctuation">:</span> options<span class="token punctuation">.</span>createModuleId<span class="token punctuation">,</span>
        getRunModuleStatement<span class="token punctuation">:</span> options<span class="token punctuation">.</span>getRunModuleStatement<span class="token punctuation">,</span>
        inlineSourceMap<span class="token punctuation">:</span> options<span class="token punctuation">.</span>inlineSourceMap<span class="token punctuation">,</span>
        projectRoot<span class="token punctuation">:</span> options<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span>
        runBeforeMainModule<span class="token punctuation">:</span> options<span class="token punctuation">.</span>runBeforeMainModule<span class="token punctuation">,</span>
        runModule<span class="token punctuation">:</span> options<span class="token punctuation">.</span>runModule<span class="token punctuation">,</span>
        sourceMapUrl<span class="token punctuation">:</span> options<span class="token punctuation">.</span>sourceMapUrl<span class="token punctuation">,</span>
        sourceUrl<span class="token punctuation">:</span> options<span class="token punctuation">.</span>sourceUrl<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    processModulesOptions
  <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_ref3</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> _ref4 <span class="token operator">=</span> <span class="token function">_slicedToArray</span><span class="token punctuation">(</span>_ref3<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=</span> _ref4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        code <span class="token operator">=</span> _ref4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    pre<span class="token punctuation">:</span> preCode<span class="token punctuation">,</span>
    post<span class="token punctuation">:</span> postCode<span class="token punctuation">,</span>
    modules<span class="token punctuation">:</span> <span class="token function">processModules</span><span class="token punctuation">(</span>
      <span class="token comment">// 使用processModules获取所有`_d`部分的代码数组</span>
      <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>graph<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      processModulesOptions
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_ref5</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> _ref6 <span class="token operator">=</span> <span class="token function">_slicedToArray</span><span class="token punctuation">(</span>_ref5<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        module <span class="token operator">=</span> _ref6<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        code <span class="token operator">=</span> _ref6<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">[</span>options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>processModules</strong></li></ul> <p><code>processModules</code> 经过两次 <code>filter</code> 过滤出所有类型为 <code>js/</code>类型的数据，第二次过滤使用用户自定义 <code>filter</code> 函数；过滤完成之后使用 wrapModule 转换成<code>_d(factory,moduleId,dependencies)</code>的代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/DeltaBundler/Serializers/helpers/processModules.js</span>

<span class="token keyword">function</span> <span class="token function">processModules</span><span class="token punctuation">(</span><span class="token parameter">modules<span class="token punctuation">,</span> _ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> _ref$filter <span class="token operator">=</span> _ref<span class="token punctuation">.</span>filter<span class="token punctuation">,</span>
    filter <span class="token operator">=</span> _ref$filter <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span> <span class="token punctuation">:</span> _ref$filter<span class="token punctuation">,</span>
    createModuleId <span class="token operator">=</span> _ref<span class="token punctuation">.</span>createModuleId<span class="token punctuation">,</span>
    dev <span class="token operator">=</span> _ref<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
    projectRoot <span class="token operator">=</span> _ref<span class="token punctuation">.</span>projectRoot<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isJsModule<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
      module<span class="token punctuation">,</span>
      <span class="token function">wrapModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        createModuleId<span class="token punctuation">,</span>
        dev<span class="token punctuation">,</span>
        projectRoot<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// node_modules/metro/src/DeltaBundler/Serializers/helpers/js.js</span>
<span class="token keyword">function</span> <span class="token function">wrapModule</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token function">getJsOutput</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果类型为js/script则直接返回其代码</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>output<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;js/script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> output<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> moduleId <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// d(factory,moduleId,dependencies)后面两个参数生成</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">[</span>
    moduleId<span class="token punctuation">,</span>
    Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dependency</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>dependency<span class="token punctuation">.</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Add the module relative path as the last parameter (to make it easier to do</span>
  <span class="token comment">// requires by name when debugging).</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    params<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span> module<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 进行代码转换，因为在获取到的依赖图谱中只有_d(factory)，需要加上用moduleId和依赖关系</span>
  <span class="token keyword">return</span> <span class="token function">addParamsToDefineCall</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>output<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getJsOutput</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> jsModules <span class="token operator">=</span> module<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_ref</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> type <span class="token operator">=</span> _ref<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token keyword">return</span> type<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;js/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    jsModules<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Modules must have exactly one JS output, but </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> has </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      jsModules<span class="token punctuation">.</span>length
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> JS outputs.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> jsOutput <span class="token operator">=</span> jsModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    Number<span class="token punctuation">.</span><span class="token function">isFinite</span><span class="token punctuation">(</span>jsOutput<span class="token punctuation">.</span>data<span class="token punctuation">.</span>lineCount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">JS output must populate lineCount, but </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> has </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      jsOutput<span class="token punctuation">.</span>type
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> output with lineCount '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>jsOutput<span class="token punctuation">.</span>data<span class="token punctuation">.</span>lineCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> jsOutput<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isJsModule</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isJsOutput<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isJsOutput</span><span class="token punctuation">(</span><span class="token parameter">output</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> output<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;js/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// node_modules/metro/src/lib/addParamsToDefineCall.js</span>
<span class="token keyword">function</span> <span class="token function">addParamsToDefineCall</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> index <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>
    <span class="token keyword">var</span> _len <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      paramsToAdd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>_len <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> _len <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      _key <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    _key <span class="token operator">&lt;</span> _len<span class="token punctuation">;</span>
    _key<span class="token operator">++</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    paramsToAdd<span class="token punctuation">[</span>_key <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> arguments<span class="token punctuation">[</span>_key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> params <span class="token operator">=</span> paramsToAdd<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    param <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">&quot;undefined&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> code<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> code<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>getAppendScripts</strong></li></ul> <p>上面讲到 <code>getAppendScripts</code> 主要作用是: <strong>获取入口文件及所有的 runBeforeMainModule 文件的依赖图谱和 使用 getRunModuleStatement 方法生成<code>_r(moduleId)</code>的代码</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getAppendScripts</span><span class="token punctuation">(</span><span class="token parameter">entryPoint<span class="token punctuation">,</span> modules<span class="token punctuation">,</span> importBundleNames<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果有importBundleNames插入对应代码</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>importBundleNames<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> importBundleNamesObject <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    importBundleNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">absolutePath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> bundlePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span> absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      importBundleNamesObject<span class="token punctuation">[</span>options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span>
        bundlePath<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>bundlePath<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.bundle&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(function(){var $$=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span><span class="token function">getRunModuleStatement</span><span class="token punctuation">(</span>
      options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>asyncRequireModulePath<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">$$.addImportBundleNames(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>
      <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>importBundleNamesObject<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)})();</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    output<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      path<span class="token punctuation">:</span> <span class="token string">&quot;$$importBundleNames&quot;</span><span class="token punctuation">,</span>
      dependencies<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">getSource</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      inverseDependencies<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      output<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          type<span class="token punctuation">:</span> <span class="token string">&quot;js/script/virtual&quot;</span><span class="token punctuation">,</span>
          data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            code<span class="token punctuation">,</span>
            lineCount<span class="token punctuation">:</span> <span class="token function">countLines</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span>
            map<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>runModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 聚合runBeforeMainModule和入口文件，前讲过runBeforeMainModule的默认值为: /node_modules/metro/src/lib/polyfills/require.js</span>
    <span class="token keyword">const</span> paths <span class="token operator">=</span> <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>runBeforeMainModule<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      entryPoint<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> path <span class="token keyword">of</span> paths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>modules<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> module<span class="token punctuation">.</span>path <span class="token operator">===</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过getRunModuleStatement函数生成 _r(moduleId)的代码</span>
        <span class="token comment">//   getRunModuleStatement默认值详情请见: node_modules/metro-config/src/defaults/index.js</span>
        <span class="token keyword">const</span> code <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">getRunModuleStatement</span><span class="token punctuation">(</span>
          options<span class="token punctuation">.</span><span class="token function">createModuleId</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        output<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          path<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">require-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          dependencies<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function-variable function">getSource</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          inverseDependencies<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          output<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              type<span class="token punctuation">:</span> <span class="token string">&quot;js/script/virtual&quot;</span><span class="token punctuation">,</span>
              data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                code<span class="token punctuation">,</span>
                lineCount<span class="token punctuation">:</span> <span class="token function">countLines</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span>
                map<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">return</span> output<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此 <code>baseJSBundle</code>我们已经分析完成。</p> <h4 id="bundletostring"><a href="#bundletostring" aria-hidden="true" class="header-anchor">#</a> bundleToString</h4> <p>经过前面一个步骤<code>bundleToBundle</code>我们分别获取到了: <code>preCode</code> , <code>postCode</code> 和 <code>modules</code> 其对应的分别是<strong>var 和 polyfills 部分的代码</strong> , <strong>require 部分的代码</strong> , <strong>_d 部分的代码</strong>
而<code>bundleToString</code>的作用如下:</p> <ul><li>先将 var 及 polyfill 部分的代码使用\n 进行字符串拼接；</li> <li>然后将<code>_d</code> 部分的代码使用 <code>moduleId</code> 进行<strong>升序排列</strong>并使用字符串拼接的方式构造<code>_d</code> 部分的代码;</li> <li>最后合如<code>_r</code>部分的代码</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">bundleToString</span><span class="token punctuation">(</span><span class="token parameter">bundle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> code <span class="token operator">=</span> bundle<span class="token punctuation">.</span>pre<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> bundle<span class="token punctuation">.</span>pre <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sortedModules <span class="token operator">=</span> bundle<span class="token punctuation">.</span>modules
    <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// The order of the modules needs to be deterministic in order for source</span>
    <span class="token comment">// maps to work properly.</span>
    <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> _ref <span class="token keyword">of</span> sortedModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _ref2 <span class="token operator">=</span> <span class="token function">_slicedToArray</span><span class="token punctuation">(</span>_ref<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> id <span class="token operator">=</span> _ref2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> moduleCode <span class="token operator">=</span> _ref2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>moduleCode<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      code <span class="token operator">+=</span> moduleCode <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>id<span class="token punctuation">,</span> moduleCode<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>bundle<span class="token punctuation">.</span>post<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    code <span class="token operator">+=</span> bundle<span class="token punctuation">.</span>post<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    code <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">,</span>
    metadata<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      pre<span class="token punctuation">:</span> bundle<span class="token punctuation">.</span>pre<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      post<span class="token punctuation">:</span> bundle<span class="token punctuation">.</span>post<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      modules<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <ol><li><strong>react-native 使用 metro 打包之后的 bundle 大致分为四层</strong></li></ol> <p>bundle 包大致分为四层:</p> <ul><li><strong>var 声明层</strong>: 对当前运行环境, bundle 启动时间，以及进程相关信息;</li> <li><strong>poyfill 层</strong>: <code>!(function(r){})</code> , 定义了对 <code>define（__d）</code>、 <code>require（__r）</code>、<code>clear（__c）</code> 的支持，以及 module（react-native 及第三方 dependences 依赖的 module） 的加载逻辑;</li> <li><strong>模块定义层</strong>: <code>__d</code> 定义的代码块，包括 RN 框架源码 js 部分、自定义 js 代码部分、图片资源信息，供 require 引入使用</li> <li><strong>require 层</strong>: r 定义的代码块，找到 d 定义的代码块 并执行</li></ul> <ol start="2"><li><p><strong><code>react-native</code>使用 <code>metro</code> 进行打包主要分为三个步骤: 解析，转化和生成</strong>;
<img src="/assets/img/metro.7cd688e4.png" alt=""></p></li> <li><p><strong>解析和转化部分: Metro Server 使用<code>IncrementalBundler</code>进行 js 代码的解析和转换</strong></p></li></ol> <p>在 Metro 使用<code>IncrementalBundler</code>进行解析转换的主要作用是：</p> <ul><li>返回了<strong>以入口文件为入口的所有相关依赖文件的依赖图谱和 babel 转换后的代码</strong>；</li> <li>返回了<strong>var 定义部分及 polyfill 部分所有相关依赖文件的依赖图谱和 babel 转换后的代码</strong>；</li></ul> <p>整体流程如图所示:</p> <p><img src="/assets/img/metro-build.a44983e0.png" alt=""></p> <p>通过上述的流程我们总结如下几点:</p> <ol><li>整个 metro 进行依赖分析和 babel 转换主要通过了<a href="https://github.com/facebook/jest/tree/master/packages/jest-haste-map/src" target="_blank" rel="noopener noreferrer">JestHasteMap<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>去做依赖分析；</li> <li>在做依赖分析的通过，metro 会监听当前目录的文件变化，然后以最小变化生成最终依赖关系图谱；</li> <li>不管是入口文件解析还是 polyfill 文件的依赖解析都是使用了<a href="https://github.com/facebook/jest/tree/master/packages/jest-haste-map/src" target="_blank" rel="noopener noreferrer">JestHasteMap<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>;</li></ol> <p>生成的对应依赖关系图谱格式如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// graph</span>
<span class="token punctuation">[</span>
<span class="token punctuation">{</span>
  dependencies<span class="token punctuation">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">404</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 入口文件下每个文件所依赖其他文件的关系图谱</span>
    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token punctuation">{</span>
    inverseDependencies<span class="token punctuation">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span><span class="token punctuation">,</span>
    dependencies<span class="token punctuation">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">8</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token string">'@babel/runtime/helpers/createClass'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        absolutePath<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/node_modules/@babel/runtime/helpers/createClass.js'</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          name<span class="token punctuation">:</span> <span class="token string">'@babel/runtime/helpers/createClass'</span><span class="token punctuation">,</span>
          data<span class="token punctuation">:</span> <span class="token punctuation">{</span> isAsync<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// ....</span>
      <span class="token string">'react'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        absolutePath<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/node_modules/react/index.js'</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'react'</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">{</span> isAsync<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'react-native'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        absolutePath<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/node_modules/react-native/index.js'</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'react-native'</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">{</span> isAsync<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    getSource<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
    output<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token comment">// 对应文件转换后的代码</span>
          code<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__d(function(g,r,i,a,m,e,d){var t=r(d[0]);Object.defineProperty(e,&quot;__esModule&quot;,{value:!0}),e.default=void 0;var n=t(r(d[1])),u=t(r(d[2])),l=t(r(d[3])),c=t(r(d[4])),f=t(r(d[5])),o=t(r(d[6])),s=r(d[7]);function y(){if(&quot;undefined&quot;==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if(&quot;function&quot;==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}var p=(function(t){(0,l.default)(R,t);var p,h,x=(p=R,h=y(),function(){var t,n=(0,f.default)(p);if(h){var u=(0,f.default)(this).constructor;t=Reflect.construct(n,arguments,u)}else t=n.apply(this,arguments);return(0,c.default)(this,t)});function R(){return(0,n.default)(this,R),x.apply(this,arguments)}return(0,u.default)(R,[{key:&quot;render&quot;,value:function(){return o.default.createElement(o.default.Fragment,null,o.default.createElement(s.View,{style:v.body},o.default.createElement(s.Text,{style:v.text},&quot;\\u4f60\\u597d\\uff0c\\u4e16\\u754c&quot;)))}}]),R})(o.default.Component);e.default=p;var v=s.StyleSheet.create({body:{backgroundColor:'white',flex:1,justifyContent:'center',alignItems:'center'},text:{textAlign:'center',color:'red'}})});</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          lineCount<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          map<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">177</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'_react'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">179</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'_interopRequireDefault'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">181</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'r'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">183</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'d'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">185</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'_reactNative'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment">// .....</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          functionMap<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            names<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'&lt;global&gt;'</span><span class="token punctuation">,</span> <span class="token string">'App'</span><span class="token punctuation">,</span> <span class="token string">'render'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
            mappings<span class="token punctuation">:</span> <span class="token string">'AAA;eCW;ECC;GDQ;CDC'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> <span class="token string">'js/module'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      inverseDependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>Set<span class="token punctuation">]</span><span class="token punctuation">,</span>
      path<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/App.js'</span><span class="token punctuation">,</span>
      dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>Map<span class="token punctuation">]</span><span class="token punctuation">,</span>
      getSource<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
      output<span class="token punctuation">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/app.json'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      inverseDependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>Set<span class="token punctuation">]</span><span class="token punctuation">,</span>
      path<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/app.json'</span><span class="token punctuation">,</span>
      dependencies<span class="token punctuation">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      getSource<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
      output<span class="token punctuation">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  entryPoints<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment">//入口文件</span>
    <span class="token string">'/Users/alexganggao/Desktop/react-native-ssr/ReactNativeSSR/index.js'</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  importBundleNames<span class="token punctuation">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">]</span>
</code></pre></div><ol start="4"><li><strong>metro 代码生成部分使用 <code>baseJSBundle</code> 得到代码，并使用 <code>baseToString</code> 拼接最终 <code>Bundle</code> 代码</strong></li></ol> <p>在 <code>baseJSBundle</code> 中:</p> <ul><li><p><code>baseJSBundle</code>整体调用了三次 <code>processModules</code>分别用于解析出: <code>preCode</code> , <code>postCode</code> 和 <code>modules</code> 其对应的分别是<strong>var 和 polyfills 部分的代码</strong> , <strong>require 部分的代码</strong> , <strong><code>_d</code> 部分的代码</strong></p></li> <li><p><code>processModules</code> 经过两次 <code>filter</code> 过滤出所有类型为 <code>js/</code>类型的数据，第二次过滤使用用户自定义 <code>filter</code> 函数；过滤完成之后使用 <code>wrapModule</code> 转换成<code>_d(factory,moduleId,dependencies)</code>的代码</p></li></ul> <p>在<code>baseToString</code>中:</p> <ul><li>先将 var 及 polyfill 部分的代码使用\n 进行字符串拼接；</li> <li>然后将<code>_d</code> 部分的代码使用 <code>moduleId</code> 进行<strong>升序排列</strong>并使用字符串拼接的方式构造<code>_d</code> 部分的代码;</li> <li>最后合如<code>_r</code>部分的代码</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">1/28/2021, 8:50:54 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.41067249.js" defer></script><script src="/assets/js/5.49ac7986.js" defer></script><script src="/assets/js/3.c83a9e42.js" defer></script><script src="/assets/js/30.7f6582fd.js" defer></script>
  </body>
</html>
