<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>高先生的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/icons/icon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://readmore.openwrite.cn/js/readmore.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9cfd884fe46fc31072811d47a486a552";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <meta name="description" content="旨在分享对技术的了解">
    <meta name="google-site-verification" content="RJkR9vl-0Q7dBd4j9zhefSDyhvFl7eU3oyIiwWe9haE">
    <meta name="baidu-site-verification" content="code-lFm5tSYbyN">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.5e9947c8.css" as="style"><link rel="preload" href="/assets/js/app.b8d4ddc5.js" as="script"><link rel="preload" href="/assets/js/5.0218c759.js" as="script"><link rel="preload" href="/assets/js/3.4a4bc1cf.js" as="script"><link rel="preload" href="/assets/js/45.34927120.js" as="script"><link rel="prefetch" href="/assets/js/1.67325ebf.js"><link rel="prefetch" href="/assets/js/10.51bc7661.js"><link rel="prefetch" href="/assets/js/100.02f37eee.js"><link rel="prefetch" href="/assets/js/101.402ef1fc.js"><link rel="prefetch" href="/assets/js/102.e604f70a.js"><link rel="prefetch" href="/assets/js/103.9dcb5eac.js"><link rel="prefetch" href="/assets/js/104.4c12ed83.js"><link rel="prefetch" href="/assets/js/105.004b3851.js"><link rel="prefetch" href="/assets/js/106.40144298.js"><link rel="prefetch" href="/assets/js/107.e4fc97b6.js"><link rel="prefetch" href="/assets/js/108.f10c9531.js"><link rel="prefetch" href="/assets/js/109.ff7761e4.js"><link rel="prefetch" href="/assets/js/11.13f67482.js"><link rel="prefetch" href="/assets/js/110.c758a452.js"><link rel="prefetch" href="/assets/js/111.67091195.js"><link rel="prefetch" href="/assets/js/112.16135945.js"><link rel="prefetch" href="/assets/js/113.cd3b23c8.js"><link rel="prefetch" href="/assets/js/114.c548a7a9.js"><link rel="prefetch" href="/assets/js/115.dbfdeb50.js"><link rel="prefetch" href="/assets/js/116.17b8133a.js"><link rel="prefetch" href="/assets/js/117.baeef553.js"><link rel="prefetch" href="/assets/js/118.6a65dfee.js"><link rel="prefetch" href="/assets/js/119.c27dc549.js"><link rel="prefetch" href="/assets/js/12.b00d93bd.js"><link rel="prefetch" href="/assets/js/120.6cddb593.js"><link rel="prefetch" href="/assets/js/121.336232a3.js"><link rel="prefetch" href="/assets/js/122.3f81eb61.js"><link rel="prefetch" href="/assets/js/123.437940bc.js"><link rel="prefetch" href="/assets/js/124.c53a731a.js"><link rel="prefetch" href="/assets/js/125.afc5847e.js"><link rel="prefetch" href="/assets/js/126.be254411.js"><link rel="prefetch" href="/assets/js/127.5044aef8.js"><link rel="prefetch" href="/assets/js/128.a42ae9bd.js"><link rel="prefetch" href="/assets/js/129.1c7e1da0.js"><link rel="prefetch" href="/assets/js/13.f8cb8f29.js"><link rel="prefetch" href="/assets/js/130.c7da9154.js"><link rel="prefetch" href="/assets/js/131.0a2d7b6b.js"><link rel="prefetch" href="/assets/js/132.8029facb.js"><link rel="prefetch" href="/assets/js/133.0a163833.js"><link rel="prefetch" href="/assets/js/134.e5433211.js"><link rel="prefetch" href="/assets/js/135.83bb90b1.js"><link rel="prefetch" href="/assets/js/136.0590a012.js"><link rel="prefetch" href="/assets/js/137.e0c5b0b7.js"><link rel="prefetch" href="/assets/js/138.09ef2099.js"><link rel="prefetch" href="/assets/js/139.faba1e4c.js"><link rel="prefetch" href="/assets/js/14.5adaf0c2.js"><link rel="prefetch" href="/assets/js/140.a26ad290.js"><link rel="prefetch" href="/assets/js/141.c6366162.js"><link rel="prefetch" href="/assets/js/142.f2354db2.js"><link rel="prefetch" href="/assets/js/143.0dec18dd.js"><link rel="prefetch" href="/assets/js/144.02c0d3d8.js"><link rel="prefetch" href="/assets/js/145.8968f0ab.js"><link rel="prefetch" href="/assets/js/146.af7e27c2.js"><link rel="prefetch" href="/assets/js/147.a1fffe54.js"><link rel="prefetch" href="/assets/js/148.c113c816.js"><link rel="prefetch" href="/assets/js/149.b6f968ed.js"><link rel="prefetch" href="/assets/js/15.c25294ec.js"><link rel="prefetch" href="/assets/js/150.1a1ecdf6.js"><link rel="prefetch" href="/assets/js/151.28ea6acf.js"><link rel="prefetch" href="/assets/js/152.006d7727.js"><link rel="prefetch" href="/assets/js/153.b2957da4.js"><link rel="prefetch" href="/assets/js/154.258f6786.js"><link rel="prefetch" href="/assets/js/155.ba6dcd30.js"><link rel="prefetch" href="/assets/js/156.14763870.js"><link rel="prefetch" href="/assets/js/157.0b99db11.js"><link rel="prefetch" href="/assets/js/158.231ce954.js"><link rel="prefetch" href="/assets/js/159.7f605b22.js"><link rel="prefetch" href="/assets/js/16.8584611d.js"><link rel="prefetch" href="/assets/js/160.fd50ba84.js"><link rel="prefetch" href="/assets/js/161.5d9e6884.js"><link rel="prefetch" href="/assets/js/162.ef303f4c.js"><link rel="prefetch" href="/assets/js/163.0c1b7762.js"><link rel="prefetch" href="/assets/js/164.1a24f502.js"><link rel="prefetch" href="/assets/js/165.33e793f4.js"><link rel="prefetch" href="/assets/js/166.77caa680.js"><link rel="prefetch" href="/assets/js/167.3c8c87ec.js"><link rel="prefetch" href="/assets/js/168.be28e865.js"><link rel="prefetch" href="/assets/js/169.b8b47a6b.js"><link rel="prefetch" href="/assets/js/17.779f07f1.js"><link rel="prefetch" href="/assets/js/170.715d32f2.js"><link rel="prefetch" href="/assets/js/171.58b9538c.js"><link rel="prefetch" href="/assets/js/172.abc66197.js"><link rel="prefetch" href="/assets/js/173.33ca70e3.js"><link rel="prefetch" href="/assets/js/174.6bedd6a8.js"><link rel="prefetch" href="/assets/js/175.6731d24e.js"><link rel="prefetch" href="/assets/js/176.5b9d8097.js"><link rel="prefetch" href="/assets/js/177.9584cea0.js"><link rel="prefetch" href="/assets/js/178.eb2b1be2.js"><link rel="prefetch" href="/assets/js/179.ac31d3cd.js"><link rel="prefetch" href="/assets/js/18.9f57b49d.js"><link rel="prefetch" href="/assets/js/180.dd91fbc0.js"><link rel="prefetch" href="/assets/js/181.fc795001.js"><link rel="prefetch" href="/assets/js/182.0118e9d5.js"><link rel="prefetch" href="/assets/js/183.17bd7c77.js"><link rel="prefetch" href="/assets/js/184.6474e763.js"><link rel="prefetch" href="/assets/js/185.86131122.js"><link rel="prefetch" href="/assets/js/186.96517d4d.js"><link rel="prefetch" href="/assets/js/187.9d4dcacc.js"><link rel="prefetch" href="/assets/js/188.b39773a2.js"><link rel="prefetch" href="/assets/js/189.106df3b0.js"><link rel="prefetch" href="/assets/js/19.03d0bf50.js"><link rel="prefetch" href="/assets/js/190.4e47b260.js"><link rel="prefetch" href="/assets/js/191.19e18a46.js"><link rel="prefetch" href="/assets/js/192.cc28d760.js"><link rel="prefetch" href="/assets/js/193.5f7317e8.js"><link rel="prefetch" href="/assets/js/194.2bf81f21.js"><link rel="prefetch" href="/assets/js/2.07e4d427.js"><link rel="prefetch" href="/assets/js/20.8359e986.js"><link rel="prefetch" href="/assets/js/21.cffb95bf.js"><link rel="prefetch" href="/assets/js/22.1c48e6d5.js"><link rel="prefetch" href="/assets/js/23.fb673ea8.js"><link rel="prefetch" href="/assets/js/24.26a59b4c.js"><link rel="prefetch" href="/assets/js/25.abd20c79.js"><link rel="prefetch" href="/assets/js/26.09bda40a.js"><link rel="prefetch" href="/assets/js/27.4346f175.js"><link rel="prefetch" href="/assets/js/28.59868cb1.js"><link rel="prefetch" href="/assets/js/29.728850ed.js"><link rel="prefetch" href="/assets/js/30.a2b02fd9.js"><link rel="prefetch" href="/assets/js/31.fb670d0a.js"><link rel="prefetch" href="/assets/js/32.f3c2f7bd.js"><link rel="prefetch" href="/assets/js/33.c68b7ee6.js"><link rel="prefetch" href="/assets/js/34.f6e1347e.js"><link rel="prefetch" href="/assets/js/35.fbba58c6.js"><link rel="prefetch" href="/assets/js/36.b4298c93.js"><link rel="prefetch" href="/assets/js/37.3c234d2f.js"><link rel="prefetch" href="/assets/js/38.efcf0fed.js"><link rel="prefetch" href="/assets/js/39.28ffb30d.js"><link rel="prefetch" href="/assets/js/40.505d3a9c.js"><link rel="prefetch" href="/assets/js/41.51882ef2.js"><link rel="prefetch" href="/assets/js/42.59ab9fd9.js"><link rel="prefetch" href="/assets/js/43.20318b33.js"><link rel="prefetch" href="/assets/js/44.de9076da.js"><link rel="prefetch" href="/assets/js/46.04f8f7de.js"><link rel="prefetch" href="/assets/js/47.53230662.js"><link rel="prefetch" href="/assets/js/48.e4d3ef60.js"><link rel="prefetch" href="/assets/js/49.a272029b.js"><link rel="prefetch" href="/assets/js/50.0d0f3112.js"><link rel="prefetch" href="/assets/js/51.17d9d6b8.js"><link rel="prefetch" href="/assets/js/52.f269a33c.js"><link rel="prefetch" href="/assets/js/53.363686e9.js"><link rel="prefetch" href="/assets/js/54.2da6e581.js"><link rel="prefetch" href="/assets/js/55.64eac200.js"><link rel="prefetch" href="/assets/js/56.26829e0b.js"><link rel="prefetch" href="/assets/js/57.1e20b6f0.js"><link rel="prefetch" href="/assets/js/58.f12b23f8.js"><link rel="prefetch" href="/assets/js/59.a34ddbcc.js"><link rel="prefetch" href="/assets/js/6.2278d93a.js"><link rel="prefetch" href="/assets/js/60.d36e9beb.js"><link rel="prefetch" href="/assets/js/61.1eee8443.js"><link rel="prefetch" href="/assets/js/62.0d7d79ff.js"><link rel="prefetch" href="/assets/js/63.d97cf390.js"><link rel="prefetch" href="/assets/js/64.9c21306d.js"><link rel="prefetch" href="/assets/js/65.978cfe6c.js"><link rel="prefetch" href="/assets/js/66.2656e195.js"><link rel="prefetch" href="/assets/js/67.c5d1c8ed.js"><link rel="prefetch" href="/assets/js/68.6b84ced0.js"><link rel="prefetch" href="/assets/js/69.6eea391f.js"><link rel="prefetch" href="/assets/js/7.129781b4.js"><link rel="prefetch" href="/assets/js/70.4643a519.js"><link rel="prefetch" href="/assets/js/71.d9ec36fe.js"><link rel="prefetch" href="/assets/js/72.2d24bf2f.js"><link rel="prefetch" href="/assets/js/73.2b411b67.js"><link rel="prefetch" href="/assets/js/74.1a7503b6.js"><link rel="prefetch" href="/assets/js/75.84280653.js"><link rel="prefetch" href="/assets/js/76.5b255b69.js"><link rel="prefetch" href="/assets/js/77.cba38028.js"><link rel="prefetch" href="/assets/js/78.f7850355.js"><link rel="prefetch" href="/assets/js/79.b136ee3a.js"><link rel="prefetch" href="/assets/js/8.28bd26e1.js"><link rel="prefetch" href="/assets/js/80.a65f06b2.js"><link rel="prefetch" href="/assets/js/81.8ab9fda6.js"><link rel="prefetch" href="/assets/js/82.27bc6978.js"><link rel="prefetch" href="/assets/js/83.de669e69.js"><link rel="prefetch" href="/assets/js/84.c9256636.js"><link rel="prefetch" href="/assets/js/85.397ac6ae.js"><link rel="prefetch" href="/assets/js/86.227a58b2.js"><link rel="prefetch" href="/assets/js/87.32a499b3.js"><link rel="prefetch" href="/assets/js/88.b6d30c02.js"><link rel="prefetch" href="/assets/js/89.542193a7.js"><link rel="prefetch" href="/assets/js/9.8cccdd25.js"><link rel="prefetch" href="/assets/js/90.a0041787.js"><link rel="prefetch" href="/assets/js/91.a9508077.js"><link rel="prefetch" href="/assets/js/92.0ed23b9d.js"><link rel="prefetch" href="/assets/js/93.6bd7bdc7.js"><link rel="prefetch" href="/assets/js/94.5117193a.js"><link rel="prefetch" href="/assets/js/95.c5afe684.js"><link rel="prefetch" href="/assets/js/96.32ee1205.js"><link rel="prefetch" href="/assets/js/97.77a1820a.js"><link rel="prefetch" href="/assets/js/98.c147f0da.js"><link rel="prefetch" href="/assets/js/99.95e5d0e9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5e9947c8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/header.png" alt="高先生的博客" class="logo"> <span class="site-name can-hide">高先生的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://mrgaogang.github.io/parse-jsx-to-css-plugins/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue/React to CSS/Less/Sass
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gaogangsever.cn/ui-builder-root/index.html#" target="_blank" rel="noopener noreferrer" class="nav-link external">
  页面构建器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/javascript/index.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/vue/index.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/react/index.html" class="nav-link">
  React/RN
</a></div><div class="nav-item"><a href="/ai/index.html" class="nav-link">
  AI/Node
</a></div><div class="nav-item"><a href="/android/index.html" class="nav-link">
  Android
</a></div><div class="nav-item"><a href="/ios/index.html" class="nav-link">
  iOS
</a></div><div class="nav-item"><a href="/other/index.html" class="nav-link">
  趣聊
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="低代码Mendix" class="dropdown-title"><span class="title">低代码Mendix</span> <span class="arrow down"></span></button> <button type="button" aria-label="低代码Mendix" class="mobile-dropdown-title"><span class="title">低代码Mendix</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mendix/index.html" class="nav-link">
  1. Mendix介绍
</a></li><li class="dropdown-item"><!----> <a href="/mendix/widgets/index.html" class="nav-link">
  2. 组件开发
</a></li><li class="dropdown-item"><!----> <a href="/mendix/study.html" class="nav-link">
  3. Mendix学习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源" class="dropdown-title"><span class="title">开源</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源" class="mobile-dropdown-title"><span class="title">开源</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/article/oview/index.html" class="nav-link">
  图表库oView
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_recyclerview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_recyclerview
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_popup_window" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_popup_window
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/lucky_tools/blob/master/packages/mendix-cli/README.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue开发Mendix组件脚手架
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/cocos-webpack-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cocos web端开发
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/ui-designer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ui 构建器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/KotlinGank" target="_blank" rel="noopener noreferrer" class="nav-link external">
  kotlin App
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/tensorflow_object_detection" target="_blank" rel="noopener noreferrer" class="nav-link external">
  tensorflow object detection
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/react-native-file-hash-plugin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  react-native-file-hash-plugin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/parse-jsx-to-css" target="_blank" rel="noopener noreferrer" class="nav-link external">
  parse-jsx-to-css
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  issues
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://mrgaogang.github.io/parse-jsx-to-css-plugins/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue/React to CSS/Less/Sass
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gaogangsever.cn/ui-builder-root/index.html#" target="_blank" rel="noopener noreferrer" class="nav-link external">
  页面构建器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/javascript/index.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/vue/index.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/react/index.html" class="nav-link">
  React/RN
</a></div><div class="nav-item"><a href="/ai/index.html" class="nav-link">
  AI/Node
</a></div><div class="nav-item"><a href="/android/index.html" class="nav-link">
  Android
</a></div><div class="nav-item"><a href="/ios/index.html" class="nav-link">
  iOS
</a></div><div class="nav-item"><a href="/other/index.html" class="nav-link">
  趣聊
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="低代码Mendix" class="dropdown-title"><span class="title">低代码Mendix</span> <span class="arrow down"></span></button> <button type="button" aria-label="低代码Mendix" class="mobile-dropdown-title"><span class="title">低代码Mendix</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mendix/index.html" class="nav-link">
  1. Mendix介绍
</a></li><li class="dropdown-item"><!----> <a href="/mendix/widgets/index.html" class="nav-link">
  2. 组件开发
</a></li><li class="dropdown-item"><!----> <a href="/mendix/study.html" class="nav-link">
  3. Mendix学习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源" class="dropdown-title"><span class="title">开源</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源" class="mobile-dropdown-title"><span class="title">开源</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/article/oview/index.html" class="nav-link">
  图表库oView
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_recyclerview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_recyclerview
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_popup_window" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_popup_window
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/lucky_tools/blob/master/packages/mendix-cli/README.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue开发Mendix组件脚手架
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/cocos-webpack-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cocos web端开发
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/ui-designer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ui 构建器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/KotlinGank" target="_blank" rel="noopener noreferrer" class="nav-link external">
  kotlin App
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/tensorflow_object_detection" target="_blank" rel="noopener noreferrer" class="nav-link external">
  tensorflow object detection
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/react-native-file-hash-plugin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  react-native-file-hash-plugin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/parse-jsx-to-css" target="_blank" rel="noopener noreferrer" class="nav-link external">
  parse-jsx-to-css
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  issues
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/ReactNative%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.html#一、前言" class="sidebar-link">一、前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/react/ReactNative%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.html#二、metro-依赖时序图" class="sidebar-link">二、metro 依赖时序图</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/ReactNative%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.html#_1-源码阅读" class="sidebar-link">1. 源码阅读</a></li><li class="sidebar-sub-header"><a href="/react/ReactNative%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.html#_2-collectdependencies-依赖收集" class="sidebar-link">2. collectDependencies 依赖收集</a></li></ul></li><li><a href="/react/ReactNative%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="ads-main"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAG4UlEQVR4Xu2Zf4xdRRXHv+eu7f5hEyD6h9qVBFMSgrEJIkINAilogymRSHe3QcAU/aub3Tv3vUgDhF+iRIXunHvrGtPYajTR2IJSm1J+tAFaS0GpQLCGKiENKRBCCIEQ2mjuHHLIfbp9fXfu3PcewrpvkmaT3jPnx2fOnDkzjzDPB83z+DEAMMiAeU5gsAXmeQIMiuBgCwy2wDwnMNgCdRMgjuNRIvoIM/+27twPo3ytDCiC31IE8m1m3hwS1OTk5HAURZdHUXSOiHwKwCcBtP6qilcAvKx/iejlPM+fzPP8oZmZmddD9PciEwygLfiWzTXM/MtODkxMTHxswYIFlxHRShG5DMDCuo6KyP1E9DCAXcz817rzQ+SDAJQE/55+EVmVpuk9LWPr1q076dixYxNEtBbA4hAnAmRyAD9xzs1kWfbPAPlgkSAASZJsEZHRMq1EtOLIkSO7R0ZGGiJyPYBTgj2oJ/iGiMwcPXr0ro0bN75Zb2pn6SAAOjWO47uJ6AqPUV2loQCndK8/KiIHiOiA1oOiLiyJomipiCwFsKhCj867iZl3BtjzigQDUC3GGE31b3Rp9DYAjzDzI775k5OTI0NDQzERTYmIt24Q0fettTd16c9702oBKCD8AcDlNYxqwLdVBd6uzxjzeSKaEZHzKmxtY+Y6/hynrjaAAsK9AL5eBYGItlprx6rkfN+NMZsAXFuhYw8zX9iNna4AFBD+CECPt46jH8G3FBtjbgVwS0WAe5n5groQugaghpIk2S4iK8uMishYmqZb6zrVSd4Y8ysAV/t0iYhN07RRx15PANRQHMc7iOhrdSBoXxFF0WhxtGpFfwbAfmb+eZkeY8xFALQpqhpabzRjgkbPAIrtcB+AS6sgxHG8lIjuBPDVTrJEtNtae4kHggJQEFUjuE0PAtBsNs/M8/xMZr7b49z9AFb4IBDRDwF8psL7w8x8Wsk2MABsVfQAXhKRi9M0PVQlGwTAGKMp+jkAq5j59x4ID5StbpUjbd/XMfOP2+cUC3EwUNcWZh6vkq0EYIy5DsCPCkW5doPW2m0eCA8C+EqV4arvzrlLsizb3S5njPkbgM9WzdfvIhKnaZr5ZL0A1q5du2jhwoXPzb7UENG/NBOstdvLFCdJsktTMMTJMhki+qa19jcdAITWAZ36PDOf3jWAsspLRMf0FsjMOzyZoKu3vAcICTNzjwB0+lnM/HQpaJ+DzWbz43mev1Yi805RE0ovJMaYOqvVbqYMwGMAloWCJaLTrbXPdwVAJyVJ8gMRuaFEwdvFe4AWv47DGKN3gW7a1I4rF8fxC0TU8ZRod0BEHk7T1JuFlUVQ68Dw8PAeETmrJMa3CggPeSDsAfDl0FUDcIiZz+gkb4x5G8BHA3T92zm3PMuyP3VdA1oTfS9Chcwb2tlNT0+fULVbOowxewGcH+C4Vu+OLbQxRlthbYkrBxFdb63VvsM7KjNgFoTNRLTGo+31AkJpuxrH8T4i+pLPI9/9wRgT2mfsYObSO8ps+8EAkiRZ4pzbS0Sf8ASgBXPMd/c3xlQVsSs7Pbk3Go0rnHOlnegsn/SpbHnoI2owADVgjJkE4G0sALxarKLu+7LC+DiAcz0gT+jljTGhdeQaZv51Veq3vtcCUEDQ6+b6CgOvOOfGfAXIGPMEgC969Ewx84bCZsh7AIioYa0NuSv8x2xtADozSZI1IlL1o8gR59x4lmWa8mWZ8BcAX/BA0ON3OOAxRIO/w1p7Y+jKd50BrYnGGH0c1YrsO5JejKJofHp6WlO+DMKTAM6u6/hxhYxok7X2O93o6CoDWoampqYujqJIfxka8Rg/TETj1to/eyDot3O6CUBE7kjTtPbK95wBLQXNZvPsPM9/VpHK2r0pBF3tjiNJkv0BL8D/3btEW/M8/16WZXo77Hr0lAGzrcZxfBURfQtA2YuO9uPjvuMpSZJ9IuLtEwBoJ6hHbc8/iqj/fQPQghHH8coCxKoOy/KPPM9Xb9iw4SnPdvB2jCKyOk3T33W95G0T+w5gVn04P4oizQh9/zu19f8i8pxzTiHoK1NZYXwUQOkTt3Pu2izLftEPCO8bgNnO6VOWc26Z/iOi84hI7a621j7rgeC9ShPRhLX2p71C+J8A6ORkAYWstaVvfAHvCd9l5rt6gfCBAQh1OgDCzcx8e6i+drkPPQB12APh4NDQ0Nj69ev//n8NYHR0dGjx4sW72n4U6Tn49+UY7HYlquYZY04mop1Fs9SX4OcUAHW20Wh82jm3s9e0nw17TtSA9iO1lz0/J4tg1fbo5fucy4Begu00dwCg30Tnmr5BBsy1Feu3v4MM6DfRuaZvkAFzbcX67e+8z4B3AU7+oV/ZJX7ZAAAAAElFTkSuQmCC" class="btn-control"> <img src="https://camo.githubusercontent.com/01448f33e0bc34a83317f39bb3a1df723e109d4194e0259b7345775fe99968d5/68747470733a2f2f70312d6a75656a696e2e62797465696d672e636f6d2f746f732d636e2d692d6b3375316662706663702f33306666633738643332313434323632623536633633653230323261656163307e74706c762d6b3375316662706663702d7a6f6f6d2d312e696d616765" class="my-wechat-m" style="display:;"> <div class="item-ads" style="display:;"><div class="ads-name">耗时4天写的日程小程序</div> <img src="/assets/img/mini-app.9d4e9bb7.png" class="item-ads-url item-ads-url-full"></div></div> <div class="theme-default-content content__default"><blockquote><p>导语: 回到上一章节<a href="https://mrgaogang.github.io/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html" target="_blank" rel="noopener noreferrer">react-native bundle 到 bundle 生成到底发生了什么(metro 打包流程简析)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，我们知道 RN 构建过程大致分为 <code>解析</code>,<code>转换</code>和<code>生成</code>三个步骤，其中有一个比较关键的点在于，我们需要利用每个 <code>module</code> 的依赖关系，进行性能优化，剔除不必要的 <code>module</code></p></blockquote> <p>那么<code>react native</code>是如何获取到每个文件的的依赖 <code>module</code> 呢? 下面我们具体分析一波。</p> <h2 id="一、前言"><a href="#一、前言" class="header-anchor">#</a> 一、前言</h2> <p>还记得之前我们讲过 <code>metro</code> 是利用<code>jest-haste-map</code>去做文件解析，每一个 module 经过 <code>jest-haste-map</code> 之后的数据结构如下:</p> <div class="language-json extra-class"><pre class="language-json"><code> <span class="token punctuation">[</span>
    <span class="token string">&quot;App.js&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 文件路径，相对于根目录</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// id</span>
      <span class="token number">1606548079450</span><span class="token punctuation">,</span> <span class="token comment">// mtime,时间戳</span>
      <span class="token number">2794</span><span class="token punctuation">,</span> <span class="token comment">// 文件大小size</span>
      <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// visited 0 | 1,</span>
      <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token comment">// dependencies, 其实返回的并没有文件对应的依赖。</span>
      <span class="token string">&quot;552e453f03517dc010656369ea82f6a9b6b0383b&quot;</span> <span class="token comment">// sha1</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><p>然而真实转换后可以得到文件的依赖关系如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 以index.js文件为例</span>
Map <span class="token punctuation">{</span>
  <span class="token string">'/Users/alexganggao/Desktop/rn-jest/MyRN/index.js'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> inverseDependencies<span class="token operator">:</span> Set <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/rn-jest/MyRN/index.js'</span><span class="token punctuation">,</span>
    dependencies<span class="token operator">:</span>
     Map <span class="token punctuation">{</span>
       <span class="token string">'@babel/runtime/helpers/interopRequireDefault'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token string">'react-native'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token string">'./App'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token string">'./app.json'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    getSource<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么再真实的情况下，<code>metro</code> 是如何知道每个 <code>module</code> 有哪些依赖文件呢？</p> <p>答案其实很简单: <strong>利用 <code>AST</code> 分析得到每个 <code>module</code> 使用了哪些 <code>import</code> 和 <code>require</code></strong></p> <h2 id="二、metro-依赖时序图"><a href="#二、metro-依赖时序图" class="header-anchor">#</a> 二、metro 依赖时序图</h2> <p>为了验证此设想，笔者分析源码得知，整个 rn 依赖解析时序图下图所示:</p> <p><img src="/assets/img/bundle_dependencies.ad664064.png" alt=""></p> <p>对源码有兴趣的笔者，可以查阅下面一部分源码阅读，您也可以直接跳转到<a href="#collectDependencies">这里</a>查看具体依赖分析部分。</p> <h3 id="_1-源码阅读"><a href="#_1-源码阅读" class="header-anchor">#</a> 1. 源码阅读</h3> <p>在进行图谱生成完成之后，利用 <code>/node_modules/metro/src/DeltaBundler/DeltaCalculator.js</code> 初始化了 dependencies 并使用<code>getDelta</code>进行依赖解析:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>_graph <span class="token operator">=</span> <span class="token punctuation">{</span>
  dependencies<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  entryPoints<span class="token punctuation">,</span>
  importBundleNames<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>getDelta -&gt; _getChangedDependencies -&gt; initialTraverseDependencies -&gt; _traverseDependenciesForSingleFile -&gt; processModule -&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">const</span> internalOptions <span class="token operator">=</span> <span class="token function">getInternalOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
      graph<span class="token punctuation">.</span>entryPoints<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">traverseDependenciesForSingleFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> graph<span class="token punctuation">,</span> delta<span class="token punctuation">,</span> internalOptions<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用options.transform进行转换 options从哪里？其实就是上面的internalOptions，而internalOptions又使用的options</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">yield</span> options<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Get the absolute path of all sub-dependencies (some of them could have been</span>


</code></pre></div><p>现在我们将目光聚焦在 options 从哪里得来，利用反向查找 options:</p> <p>initialTraverseDependencies -&gt; <code>DeltaBundler.buildGraph(entryPoints, options)</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/DeltaBundler.js</span>
<span class="token function">buildGraph</span><span class="token punctuation">(</span><span class="token parameter">entryPoints<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> depGraph <span class="token operator">=</span> <span class="token keyword">yield</span> _this<span class="token punctuation">.</span>_bundler<span class="token punctuation">.</span><span class="token function">getDependencyGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> deltaCalculator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeltaCalculator</span><span class="token punctuation">(</span>
        entryPoints<span class="token punctuation">,</span>
        depGraph<span class="token punctuation">,</span>
        options
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">yield</span> deltaCalculator<span class="token punctuation">.</span><span class="token function">getDelta</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        reset<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        shallow<span class="token operator">:</span> options<span class="token punctuation">.</span>shallow
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> graph <span class="token operator">=</span> deltaCalculator<span class="token punctuation">.</span><span class="token function">getGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _this<span class="token punctuation">.</span>_deltaCalculators<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> deltaCalculator<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> graph<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">//node_modules/metro/src/IncrementalBundler.js</span>
<span class="token comment">// buildGraphForEntries</span>
<span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token keyword">yield</span> _this<span class="token punctuation">.</span>_deltaBundler<span class="token punctuation">.</span><span class="token function">buildGraph</span><span class="token punctuation">(</span>absoluteEntryFiles<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        resolve<span class="token operator">:</span> <span class="token keyword">yield</span> transformHelpers<span class="token punctuation">.</span><span class="token function">getResolveDependencyFn</span><span class="token punctuation">(</span>
          _this<span class="token punctuation">.</span>_bundler<span class="token punctuation">,</span>
          transformOptions<span class="token punctuation">.</span>platform
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        transform<span class="token operator">:</span> <span class="token keyword">yield</span> transformHelpers<span class="token punctuation">.</span><span class="token function">getTransformFn</span><span class="token punctuation">(</span>
          absoluteEntryFiles<span class="token punctuation">,</span>
          _this<span class="token punctuation">.</span>_bundler<span class="token punctuation">,</span>
          _this<span class="token punctuation">.</span>_deltaBundler<span class="token punctuation">,</span>
          _this<span class="token punctuation">.</span>_config<span class="token punctuation">,</span>
          transformOptions
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        onProgress<span class="token operator">:</span> otherOptions<span class="token punctuation">.</span>onProgress<span class="token punctuation">,</span>
        experimentalImportBundleSupport<span class="token operator">:</span>
          _this<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>transformer<span class="token punctuation">.</span>experimentalImportBundleSupport<span class="token punctuation">,</span>
        shallow<span class="token operator">:</span> otherOptions<span class="token punctuation">.</span>shallow
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// node_modules/metro/src/lib/transformHelpers.js 转换来源于Bundler</span>
<span class="token comment">// _getTransformFn</span>
<span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> bundler<span class="token punctuation">.</span><span class="token function">transformFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>transformOptions<span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token function">getType</span><span class="token punctuation">(</span>transformOptions<span class="token punctuation">.</span>type<span class="token punctuation">,</span> path<span class="token punctuation">,</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>assetExts<span class="token punctuation">)</span><span class="token punctuation">,</span>
      inlineRequires<span class="token operator">:</span> <span class="token function">removeInlineRequiresBlacklistFromOptions</span><span class="token punctuation">(</span>
        path<span class="token punctuation">,</span>
        inlineRequires<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// node_modules/metro/src/Bundler.js</span>
<span class="token keyword">class</span> <span class="token class-name">Bundler</span> <span class="token punctuation">{</span>
  _depGraphPromise<span class="token operator">:</span> Promise<span class="token operator">&lt;</span>DependencyGraph<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  _transformer<span class="token operator">:</span> Transformer<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token operator">:</span> ConfigT<span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> BundlerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_depGraphPromise <span class="token operator">=</span> DependencyGraph<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_depGraphPromise
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dependencyGraph<span class="token operator">:</span> DependencyGraph</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_transformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">(</span>
          config<span class="token punctuation">,</span>
          dependencyGraph<span class="token punctuation">.</span><span class="token function">getSha1</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>dependencyGraph<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Failed to construct transformer: '</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">transformFile</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> string<span class="token punctuation">,</span>
    transformOptions<span class="token operator">:</span> TransformOptions<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>TransformResultWithSource<span class="token operator">&lt;</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// We need to be sure that the DependencyGraph has been initialized.</span>
    <span class="token comment">// TODO: Remove this ugly hack!</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_depGraphPromise<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_transformer<span class="token punctuation">.</span><span class="token function">transformFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> transformOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 转换 node_modules/metro/src/DeltaBundler/Transformer.js</span>

  <span class="token keyword">async</span> <span class="token function">transformFile</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> string<span class="token punctuation">,</span>
    transformerOptions<span class="token operator">:</span> TransformOptions<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>TransformResultWithSource<span class="token operator">&lt;</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      customTransformOptions<span class="token punctuation">,</span>
      dev<span class="token punctuation">,</span>
      experimentalImportSupport<span class="token punctuation">,</span>
      hot<span class="token punctuation">,</span>
      inlinePlatform<span class="token punctuation">,</span>
      inlineRequires<span class="token punctuation">,</span>
      minify<span class="token punctuation">,</span>
      unstable_disableES6Transforms<span class="token punctuation">,</span>
      platform<span class="token punctuation">,</span>
      type<span class="token punctuation">,</span>
      <span class="token operator">...</span>extra
    <span class="token punctuation">}</span> <span class="token operator">=</span> transformerOptions<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> extra<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>extra<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token string">'Extra keys detected: '</span> <span class="token operator">+</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>extra<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> localPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> partialKey <span class="token operator">=</span> <span class="token function">stableHash</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token comment">// This is the hash related to the global Bundler config.</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_baseHash<span class="token punctuation">,</span>

      <span class="token comment">// Path.</span>
      localPath<span class="token punctuation">,</span>

      customTransformOptions<span class="token punctuation">,</span>
      dev<span class="token punctuation">,</span>
      experimentalImportSupport<span class="token punctuation">,</span>
      hot<span class="token punctuation">,</span>
      inlinePlatform<span class="token punctuation">,</span>
      inlineRequires<span class="token punctuation">,</span>
      minify<span class="token punctuation">,</span>
      unstable_disableES6Transforms<span class="token punctuation">,</span>
      platform<span class="token punctuation">,</span>
      type<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getSha1</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fullKey <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>partialKey<span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>sha1<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fullKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// A valid result from the cache is used directly; otherwise we call into</span>
    <span class="token comment">// the transformer to computed the corresponding result.</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> result
      <span class="token operator">?</span> <span class="token punctuation">{</span>result<span class="token punctuation">,</span> sha1<span class="token punctuation">}</span>
      <span class="token operator">:</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_workerFarm<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>localPath<span class="token punctuation">,</span> transformerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Only re-compute the full key if the SHA-1 changed. This is because</span>
    <span class="token comment">// references are used by the cache implementation in a weak map to keep</span>
    <span class="token comment">// track of the cache that returned the result.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1 <span class="token operator">!==</span> data<span class="token punctuation">.</span>sha1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fullKey <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>partialKey<span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>sha1<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>fullKey<span class="token punctuation">,</span> data<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>data<span class="token punctuation">.</span>result<span class="token punctuation">,</span>
      <span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Buffer <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre></div><p>打印 data.result 得知对于每个文件生成如下数据结构:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
dependencies<span class="token operator">:</span>
   <span class="token punctuation">[</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'@babel/runtime/helpers/interopRequireDefault'</span><span class="token punctuation">,</span>
       data<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'react-native'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'./App'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'./app.json'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
output<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">'js/module'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着看，文件转换：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/DeltaBundler/WorkerFarm.js</span>

  <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>
    filename<span class="token operator">:</span> string<span class="token punctuation">,</span>
    options<span class="token operator">:</span> TransformOptions<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>TransformerResult<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_worker<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>
        filename<span class="token punctuation">,</span>
        options<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_transformerConfig<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        result<span class="token operator">:</span> data<span class="token punctuation">.</span>result<span class="token punctuation">,</span>
        sha1<span class="token operator">:</span> data<span class="token punctuation">.</span>sha1<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>loc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_formatBabelError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_formatGenericError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token comment">// worker 其实是一个JestWorker，利用JestWorker执行自定义方法</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_makeFarm</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>transformer<span class="token punctuation">.</span>workerPath<span class="token punctuation">,</span> <span class="token comment">// workerPath: 'metro/src/DeltaBundler/Worker',</span>
        <span class="token punctuation">[</span><span class="token string">&quot;transform&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>maxWorkers
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>转换相关配置信息如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
transformer<span class="token operator">:</span>
   <span class="token punctuation">{</span> assetPlugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
     asyncRequireModulePath<span class="token operator">:</span> <span class="token string">'metro/src/lib/bundle-modules/asyncRequire'</span><span class="token punctuation">,</span>
     assetRegistryPath<span class="token operator">:</span> <span class="token string">'react-native/Libraries/Image/AssetRegistry'</span><span class="token punctuation">,</span>
     babelTransformerPath<span class="token operator">:</span>
      <span class="token string">'/Users/alexganggao/Desktop/rn-jest/MyRN/node_modules/@react-native-community/cli/node_modules/metro-react-native-babel-transformer/src/index.js'</span><span class="token punctuation">,</span>
     dynamicDepsInPackages<span class="token operator">:</span> <span class="token string">'throwAtRuntime'</span><span class="token punctuation">,</span>
     enableBabelRCLookup<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
     enableBabelRuntime<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
     experimentalImportBundleSupport<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
     getTransformOptions<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> getTransformOptions<span class="token punctuation">]</span><span class="token punctuation">,</span>
     minifierConfig<span class="token operator">:</span>
      <span class="token punctuation">{</span> mangle<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
        output<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
        sourceMap<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
        toplevel<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        compress<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     minifierPath<span class="token operator">:</span> <span class="token string">'metro-minify-uglify'</span><span class="token punctuation">,</span>
     optimizationSizeLimit<span class="token operator">:</span> <span class="token number">153600</span><span class="token punctuation">,</span>
     postMinifyProcess<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> postMinifyProcess<span class="token punctuation">]</span><span class="token punctuation">,</span>
     transformVariants<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     workerPath<span class="token operator">:</span> <span class="token string">'metro/src/DeltaBundler/Worker'</span><span class="token punctuation">,</span>
     publicPath<span class="token operator">:</span> <span class="token string">'/assets'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  cacheStores<span class="token operator">:</span>
   <span class="token punctuation">[</span> FileStore <span class="token punctuation">{</span>
       _root<span class="token operator">:</span>
        <span class="token string">'/var/folders/q_/vy78r8wn5n1cdftb86yqtz280000gn/T/metro-cache'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  cacheVersion<span class="token operator">:</span> <span class="token string">'1.0'</span><span class="token punctuation">,</span>
  projectRoot<span class="token operator">:</span> <span class="token string">'/Users/alexganggao/Desktop/rn-jest/MyRN'</span><span class="token punctuation">,</span>
  stickyWorkers<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  watchFolders<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'/Users/alexganggao/Desktop/rn-jest/MyRN'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  transformerPath<span class="token operator">:</span>
   <span class="token string">'/Users/alexganggao/Desktop/rn-jest/MyRN/node_modules/metro/src/JSTransformer/worker.js'</span><span class="token punctuation">,</span>
  maxWorkers<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
  resetCache<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  reporter<span class="token operator">:</span>
   TerminalReporter <span class="token punctuation">{</span>
     _activeBundles<span class="token operator">:</span> Map <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
     _scheduleUpdateBundleProgress<span class="token operator">:</span>
      <span class="token punctuation">{</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> debounced<span class="token punctuation">]</span> cancel<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> cancel<span class="token punctuation">]</span><span class="token punctuation">,</span> flush<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> flush<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     terminal<span class="token operator">:</span>
      Terminal <span class="token punctuation">{</span>
        _logLines<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        _nextStatusStr<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        _scheduleUpdate<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">]</span><span class="token punctuation">,</span>
        _statusStr<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        _stream<span class="token operator">:</span> <span class="token punctuation">[</span>WriteStream<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token string">'00000000'</span>
calcTransformerOptions<span class="token operator">:</span>  <span class="token punctuation">{</span> customTransformOptions<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token operator">:</span> <span class="token keyword">null</span> prototype<span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  dev<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  hot<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  inlineRequires<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  inlinePlatform<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  minify<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  platform<span class="token operator">:</span> <span class="token string">'ios'</span><span class="token punctuation">,</span>
  experimentalImportSupport<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  unstable_disableES6Transforms<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'module'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>继续查看 Worker.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/DeltaBundler/Worker.js</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">transform</span><span class="token punctuation">(</span>
  <span class="token parameter">filename<span class="token operator">:</span> string<span class="token punctuation">,</span>
  transformOptions<span class="token operator">:</span> JsTransformOptions<span class="token punctuation">,</span>
  projectRoot<span class="token operator">:</span> string<span class="token punctuation">,</span>
  transformerConfig<span class="token operator">:</span> TransformerConfig</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>Data<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> transformer <span class="token operator">=</span> <span class="token function">getTransformer</span><span class="token punctuation">(</span>projectRoot<span class="token punctuation">,</span> transformerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> transformFileStartLogEntry <span class="token operator">=</span> <span class="token punctuation">{</span>
    action_name<span class="token operator">:</span> <span class="token string">&quot;Transforming file&quot;</span><span class="token punctuation">,</span>
    action_phase<span class="token operator">:</span> <span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span>
    file_name<span class="token operator">:</span> filename<span class="token punctuation">,</span>
    log_entry_label<span class="token operator">:</span> <span class="token string">&quot;Transforming file&quot;</span><span class="token punctuation">,</span>
    start_timestamp<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">hrtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>projectRoot<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sha1 <span class="token operator">=</span> crypto
    <span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">&quot;sha1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">&quot;hex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> transformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> data<span class="token punctuation">,</span> transformOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">,</span>
    sha1<span class="token punctuation">,</span>
    transformFileStartLogEntry<span class="token punctuation">,</span>
    transformFileEndLogEntry<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查看 getTransformer得知转换使用的是transformerPath</span>

<span class="token keyword">const</span> Transformer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>transformerPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

transformers<span class="token punctuation">[</span>transformerKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">(</span>projectRoot<span class="token punctuation">,</span> transformerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> transformers<span class="token punctuation">[</span>transformerKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>而我们在上面的转换配置信息中可以得知:<code>transformerPath为'node_modules/metro/src/JSTransformer/worker.js'</code></p> <p>至此我们得知 react-native 使用的是<code>JSTransformer</code>进行代码转换</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/JSTransformer/worker.js</span>
 <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>
    filename<span class="token operator">:</span> string<span class="token punctuation">,</span>
    data<span class="token operator">:</span> Buffer<span class="token punctuation">,</span>
    options<span class="token operator">:</span> JsTransformOptions<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>Result<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sourceCode <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token string">'js/module'</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'asset'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> <span class="token string">'js/module/asset'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'script'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> <span class="token string">'js/script'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// json返回依赖为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> code <span class="token operator">=</span> JsFileWrapping<span class="token punctuation">.</span><span class="token function">wrapJson</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>minify<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>map<span class="token punctuation">,</span> code<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_minifyCode</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> code<span class="token punctuation">,</span> sourceCode<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        dependencies<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        output<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            data<span class="token operator">:</span> <span class="token punctuation">{</span>code<span class="token punctuation">,</span> lineCount<span class="token operator">:</span> <span class="token function">countLines</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token punctuation">,</span> functionMap<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            type<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// $FlowFixMe TODO t26372934 Plugin system</span>
    <span class="token comment">//  '/node_modules/@react-native-community/cli/node_modules/metro-react-native-babel-transformer/src/index.js'</span>
    <span class="token keyword">const</span> transformer<span class="token operator">:</span> Transformer<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_config
      <span class="token punctuation">.</span>babelTransformerPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> transformerArgs <span class="token operator">=</span> <span class="token punctuation">{</span>
      filename<span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>options<span class="token punctuation">,</span>
        enableBabelRCLookup<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>enableBabelRCLookup<span class="token punctuation">,</span>
        enableBabelRuntime<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>enableBabelRuntime<span class="token punctuation">,</span>
        <span class="token comment">// Inline requires are now performed at a secondary step. We cannot</span>
        <span class="token comment">// unfortunately remove it from the internal transformer, since this one</span>
        <span class="token comment">// is used by other tooling, and this would affect it.</span>
        inlineRequires<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        projectRoot<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_projectRoot<span class="token punctuation">,</span>
        publicPath<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>publicPath<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      src<span class="token operator">:</span> sourceCode<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> transformResult <span class="token operator">=</span>
      type <span class="token operator">===</span> <span class="token string">'js/module/asset'</span>
        <span class="token operator">?</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span><span class="token punctuation">(</span><span class="token keyword">await</span> assetTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>
              transformerArgs<span class="token punctuation">,</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>assetRegistryPath<span class="token punctuation">,</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>assetPlugins<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            functionMap<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token operator">:</span> <span class="token keyword">await</span> transformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>transformerArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Transformers can ouptut null ASTs (if they ignore the file). In that case</span>
    <span class="token comment">// we need to parse the module source code to get their AST.</span>
    <span class="token keyword">let</span> ast <span class="token operator">=</span>
      transformResult<span class="token punctuation">.</span>ast <span class="token operator">||</span>
      babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span>sourceType<span class="token operator">:</span> <span class="token string">'unambiguous'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>importDefault<span class="token punctuation">,</span> importAll<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generateImportNames</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add &quot;use strict&quot; if the file was parsed as a module, and the directive did</span>
    <span class="token comment">// not exist yet.</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>directives<span class="token punctuation">}</span> <span class="token operator">=</span> ast<span class="token punctuation">.</span>program<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>sourceType <span class="token operator">===</span> <span class="token string">'module'</span> <span class="token operator">&amp;&amp;</span>
      directives<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">d</span> <span class="token operator">=&gt;</span> d<span class="token punctuation">.</span>value<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">'use strict'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      directives<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">directiveLiteral</span><span class="token punctuation">(</span><span class="token string">'use strict'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Perform the import-export transform (in case it's still needed), then</span>
    <span class="token comment">// fold requires and perform constant folding (if in dev).</span>
    <span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>options<span class="token punctuation">,</span>
      inlineableCalls<span class="token operator">:</span> <span class="token punctuation">[</span>importDefault<span class="token punctuation">,</span> importAll<span class="token punctuation">]</span><span class="token punctuation">,</span>
      importDefault<span class="token punctuation">,</span>
      importAll<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>experimentalImportSupport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>importExportPlugin<span class="token punctuation">,</span> opts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>inlineRequires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>inlineRequiresPlugin<span class="token punctuation">,</span> opts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>constantFoldingPlugin<span class="token punctuation">,</span> opts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>inlinePlugin<span class="token punctuation">,</span> opts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token punctuation">{</span>ast<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">transformFromAstSync</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      ast<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      babelrc<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      code<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      configFile<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      comments<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      compact<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      filename<span class="token punctuation">,</span>
      plugins<span class="token punctuation">,</span>
      sourceMaps<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> dependencyMapName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> dependencies<span class="token punctuation">;</span>
    <span class="token keyword">let</span> wrappedAst<span class="token punctuation">;</span>

    <span class="token comment">// If the module to transform is a script (meaning that is not part of the</span>
    <span class="token comment">// dependency graph and it code will just be prepended to the bundle modules),</span>
    <span class="token comment">// we need to wrap it differently than a commonJS module (also, scripts do</span>
    <span class="token comment">// not have dependencies).</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'js/script'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dependencies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      wrappedAst <span class="token operator">=</span> JsFileWrapping<span class="token punctuation">.</span><span class="token function">wrapPolyfill</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span>
          asyncRequireModulePath<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>asyncRequireModulePath<span class="token punctuation">,</span>
          dynamicRequires<span class="token operator">:</span> <span class="token function">getDynamicDepsBehavior</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>dynamicDepsInPackages<span class="token punctuation">,</span>
            filename<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          inlineableCalls<span class="token operator">:</span> <span class="token punctuation">[</span>importDefault<span class="token punctuation">,</span> importAll<span class="token punctuation">]</span><span class="token punctuation">,</span>
          keepRequireNames<span class="token operator">:</span> options<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>ast<span class="token punctuation">,</span> dependencies<span class="token punctuation">,</span> dependencyMapName<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">collectDependencies</span><span class="token punctuation">(</span>
          ast<span class="token punctuation">,</span>
          opts<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 依赖收集</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">collectDependencies<span class="token punctuation">.</span>InvalidRequireCallError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidRequireCallError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 处理,globalThis,_d,polyfill,替换require部分</span>
      <span class="token punctuation">(</span><span class="token punctuation">{</span>ast<span class="token operator">:</span> wrappedAst<span class="token punctuation">}</span> <span class="token operator">=</span> JsFileWrapping<span class="token punctuation">.</span><span class="token function">wrapModule</span><span class="token punctuation">(</span>
        ast<span class="token punctuation">,</span>
        importDefault<span class="token punctuation">,</span>
        importAll<span class="token punctuation">,</span>
        dependencyMapName<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> reserved <span class="token operator">=</span>
      options<span class="token punctuation">.</span>minify <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>optimizationSizeLimit
        <span class="token operator">?</span> <span class="token function">normalizePseudoglobals</span><span class="token punctuation">(</span>wrappedAst<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 代码生成</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>
      wrappedAst<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        comments<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        compact<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        filename<span class="token punctuation">,</span>
        retainLines<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        sourceFileName<span class="token operator">:</span> filename<span class="token punctuation">,</span>
        sourceMaps<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      sourceCode<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> map <span class="token operator">=</span> result<span class="token punctuation">.</span>rawMappings <span class="token operator">?</span> result<span class="token punctuation">.</span>rawMappings<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>toSegmentTuple<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> code <span class="token operator">=</span> result<span class="token punctuation">.</span>code<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>minify<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 压缩代码</span>
      <span class="token punctuation">(</span><span class="token punctuation">{</span>map<span class="token punctuation">,</span> code<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_minifyCode</span><span class="token punctuation">(</span>
        filename<span class="token punctuation">,</span>
        result<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
        sourceCode<span class="token punctuation">,</span>
        map<span class="token punctuation">,</span>
        reserved<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>functionMap<span class="token punctuation">}</span> <span class="token operator">=</span> transformResult<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      dependencies<span class="token punctuation">,</span>
      output<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token punctuation">{</span>code<span class="token punctuation">,</span> lineCount<span class="token operator">:</span> <span class="token function">countLines</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token punctuation">,</span> functionMap<span class="token punctuation">}</span><span class="token punctuation">,</span> type<span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>查阅如上代码，我们得知:</p> <ul><li>js 转换使用的是<code>metro-react-native-babel-transformer</code>对 js 代码进行转换</li> <li>针对 dependencies，主要使用了<code>collectDependencies</code>方法:</li></ul> <h3 id="_2-collectdependencies-依赖收集"><a href="#_2-collectdependencies-依赖收集" class="header-anchor">#</a> 2. collectDependencies 依赖收集<a name="collectDependencies"></a></h3> <p>下面我们具体来看一下是如何进行依赖收集的:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/ModuleGraph/worker/collectDependencies.js</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/traverse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> type <span class="token punctuation">{</span> Ast <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@babel/core&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> type DynamicRequiresBehavior <span class="token operator">=</span> <span class="token string">&quot;throwAtRuntime&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;reject&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Produces a Babel template that will throw at runtime when the require call
 * is reached. This makes dynamic require errors catchable by libraries that
 * want to use them.
 */</span>
<span class="token keyword">const</span> dynamicRequireErrorTemplate <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  (function(line) {
    throw new Error(
      'Dynamic require defined at line ' + line + '; not supported by Metro',
    );
  })(LINE)
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Produces a Babel template that transforms an &quot;import(...)&quot; call into a
 * &quot;require(...)&quot; call to the asyncRequire specified.
 */</span>
<span class="token keyword">const</span> makeAsyncRequireTemplate <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  require(ASYNC_REQUIRE_MODULE_PATH)(MODULE_ID, MODULE_NAME)
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> makeAsyncPrefetchTemplate <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  require(ASYNC_REQUIRE_MODULE_PATH).prefetch(MODULE_ID, MODULE_NAME)
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> makeJSResourceTemplate <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  require(ASYNC_REQUIRE_MODULE_PATH).resource(MODULE_ID, MODULE_NAME)
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">collectDependencies</span><span class="token punctuation">(</span>
  <span class="token parameter">ast<span class="token operator">:</span> Ast<span class="token punctuation">,</span>
  options<span class="token operator">:</span> Options</span>
<span class="token punctuation">)</span><span class="token operator">:</span> CollectedDependencies <span class="token punctuation">{</span>
  <span class="token keyword">const</span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> state<span class="token operator">:</span> State <span class="token operator">=</span> <span class="token punctuation">{</span>
    asyncRequireModulePathStringLiteral<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    dependency<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    dependencyCalls<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dependencyData<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dependencyIndexes<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dependencyMapIdentifier<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    dynamicRequires<span class="token operator">:</span> options<span class="token punctuation">.</span>dynamicRequires<span class="token punctuation">,</span>
    keepRequireNames<span class="token operator">:</span> options<span class="token punctuation">.</span>keepRequireNames<span class="token punctuation">,</span>
    disableRequiresTransform<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>disableRequiresTransform<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理所有AST中的表达式，如果call是import类型的，其arguments一定是Expression</span>
    <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token operator">:</span> Path<span class="token punctuation">,</span> state<span class="token operator">:</span> State</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>visited<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> callee <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;callee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> name <span class="token operator">=</span> callee<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token comment">// 如果是import语句，执行依赖手机</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callee<span class="token punctuation">.</span><span class="token function">isImport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processImportCall</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          prefetchOnly<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果是import语句，执行依赖收集</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;__prefetchImport&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processImportCall</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          prefetchOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果为js资源或者分包资源同样处理import，但是生成的requore将会不同， tips: 似乎__jsResource并没有被使用过</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;__jsResource&quot;</span> <span class="token operator">||</span>
          name <span class="token operator">===</span> <span class="token string">&quot;__conditionallySplitJSResource&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processImportCall</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          prefetchOnly<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          jsResource<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>dependencyCalls<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">processRequireCall</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token operator">:</span> Path<span class="token punctuation">,</span> state<span class="token operator">:</span> State</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 针对import语句，记录import的module到一个map中，如果module被记录过那么不会重复记录</span>
      <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token function">getDependency</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        prefetchOnly<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      dep<span class="token punctuation">.</span>data<span class="token punctuation">.</span>isAsync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">Program</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token operator">:</span> Path<span class="token punctuation">,</span> state<span class="token operator">:</span> State</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>asyncRequireModulePathStringLiteral <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>
        options<span class="token punctuation">.</span>asyncRequireModulePath
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      state<span class="token punctuation">.</span>dependencyMapIdentifier <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">generateUidIdentifier</span><span class="token punctuation">(</span>
        <span class="token string">&quot;dependencyMap&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      state<span class="token punctuation">.</span>dependencyCalls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;require&quot;</span><span class="token punctuation">,</span> <span class="token operator">...</span>options<span class="token punctuation">.</span>inlineableCalls<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> visitor<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Compute the list of dependencies.</span>
  <span class="token keyword">const</span> dependencies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>dependency<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> data<span class="token punctuation">]</span> <span class="token keyword">of</span> state<span class="token punctuation">.</span>dependencyData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dependencies<span class="token punctuation">[</span><span class="token function">nullthrows</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>dependencyIndexes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">,</span>
      data<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    ast<span class="token punctuation">,</span>
    dependencies<span class="token punctuation">,</span>
    dependencyMapName<span class="token operator">:</span> <span class="token function">nullthrows</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>dependencyMapIdentifier<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 处理import语句及js资源</span>
<span class="token keyword">function</span> <span class="token function">processImportCall</span><span class="token punctuation">(</span>
  <span class="token parameter">path<span class="token operator">:</span> Path<span class="token punctuation">,</span>
  state<span class="token operator">:</span> State<span class="token punctuation">,</span>
  options<span class="token operator">:</span> DepOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Path <span class="token punctuation">{</span>
  <span class="token comment">// 获取module 名称</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">getModuleNameFromCallArgs</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidRequireCallError</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 记录module依赖，如果当前module已经存在map中则返回，否则先记录</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token function">getDependency</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> name<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>prefetchOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> dep<span class="token punctuation">.</span>data<span class="token punctuation">.</span>isPrefetchOnly<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>disableRequiresTransform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> path<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token constant">ASYNC_REQUIRE_MODULE_PATH</span> <span class="token operator">=</span> state<span class="token punctuation">.</span>asyncRequireModulePathStringLiteral<span class="token punctuation">;</span>
  <span class="token comment">// 生成零时的moduleId，用于在将代码中的import/require进行替换，</span>
  <span class="token keyword">const</span> <span class="token constant">MODULE_ID</span> <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>
    state<span class="token punctuation">.</span>dependencyMapIdentifier<span class="token punctuation">,</span>
    types<span class="token punctuation">.</span><span class="token function">numericLiteral</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// module名称</span>
  <span class="token keyword">const</span> <span class="token constant">MODULE_NAME</span> <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果是js资源，那么就替换对应的加载路径为指定的module</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>jsResource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
      <span class="token function">makeJSResourceTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token constant">ASYNC_REQUIRE_MODULE_PATH</span><span class="token punctuation">,</span>
        <span class="token constant">MODULE_ID</span><span class="token punctuation">,</span>
        <span class="token constant">MODULE_NAME</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>prefetchOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果为不是预加载则直接将import()转换成require()()语句进行加载</span>
    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
      <span class="token function">makeAsyncRequireTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token constant">ASYNC_REQUIRE_MODULE_PATH</span><span class="token punctuation">,</span>
        <span class="token constant">MODULE_ID</span><span class="token punctuation">,</span>
        <span class="token constant">MODULE_NAME</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 否则将import转换成require.prefetch的方式加载</span>
    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
      <span class="token function">makeAsyncPrefetchTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token constant">ASYNC_REQUIRE_MODULE_PATH</span><span class="token punctuation">,</span>
        <span class="token constant">MODULE_ID</span><span class="token punctuation">,</span>
        <span class="token constant">MODULE_NAME</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> path<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 处理require语句</span>
<span class="token keyword">function</span> <span class="token function">processRequireCall</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token operator">:</span> Path<span class="token punctuation">,</span> state<span class="token operator">:</span> State</span><span class="token punctuation">)</span><span class="token operator">:</span> Path <span class="token punctuation">{</span>
  <span class="token comment">// 获取module 名称</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">getModuleNameFromCallArgs</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>dynamicRequires <span class="token operator">===</span> <span class="token string">&quot;reject&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidRequireCallError</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
      <span class="token function">dynamicRequireErrorTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token constant">LINE</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">.</span>line<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> path<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 记录module依赖，如果当前module已经存在map中则返回，否则先记录</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token function">getDependency</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">{</span> prefetchOnly<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dep<span class="token punctuation">.</span>data<span class="token punctuation">.</span>isAsync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> dep<span class="token punctuation">.</span>data<span class="token punctuation">.</span>isPrefetchOnly<span class="token punctuation">;</span>
  <span class="token comment">// 如果不使用require 转换逻辑则直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>disableRequiresTransform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> path<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 生成零时的moduleId，用于在将代码中的import/require进行替换，</span>
  <span class="token keyword">const</span> moduleIDExpression <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>
    state<span class="token punctuation">.</span>dependencyMapIdentifier<span class="token punctuation">,</span>
    types<span class="token punctuation">.</span><span class="token function">numericLiteral</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 替换require内容为对应的id</span>
  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>arguments <span class="token operator">=</span> state<span class="token punctuation">.</span>keepRequireNames
    <span class="token operator">?</span> <span class="token punctuation">[</span>moduleIDExpression<span class="token punctuation">,</span> types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token operator">:</span> <span class="token punctuation">[</span>moduleIDExpression<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> path<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 记录依赖，当前module路径是否被记录过，如果没有则记录否则直接返回对呀信息</span>
<span class="token keyword">function</span> <span class="token function">getDependency</span><span class="token punctuation">(</span>
  <span class="token parameter">state<span class="token operator">:</span> State<span class="token punctuation">,</span>
  name<span class="token operator">:</span> string<span class="token punctuation">,</span>
  options<span class="token operator">:</span> DepOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> InternalDependencyInfo <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> state<span class="token punctuation">.</span>dependencyIndexes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> data<span class="token operator">:</span> <span class="token operator">?</span>InternalDependencyData <span class="token operator">=</span> state<span class="token punctuation">.</span>dependencyData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    index <span class="token operator">=</span> state<span class="token punctuation">.</span>dependency<span class="token operator">++</span><span class="token punctuation">;</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span> isAsync<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>prefetchOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">.</span>isPrefetchOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    state<span class="token punctuation">.</span>dependencyIndexes<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>dependencyData<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> index<span class="token operator">:</span> <span class="token function">nullthrows</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token function">nullthrows</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取require或者import部分具体的内容</span>
<span class="token keyword">function</span> <span class="token function">getModuleNameFromCallArgs</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token operator">:</span> Path</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>string <span class="token punctuation">{</span>
  <span class="token keyword">const</span> expectedCount <span class="token operator">=</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;__conditionallySplitJSResource&quot;</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;arguments&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">!==</span> expectedCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidRequireCallError</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> result <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;arguments.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>confident <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> result<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
collectDependencies<span class="token punctuation">.</span>getModuleNameFromCallArgs <span class="token operator">=</span> getModuleNameFromCallArgs<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">InvalidRequireCallError</span> <span class="token keyword">extends</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> node <span class="token punctuation">}</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> line <span class="token operator">=</span> node<span class="token punctuation">.</span>loc <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">.</span>line<span class="token punctuation">;</span>

    <span class="token keyword">super</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid call at line </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>line <span class="token operator">||</span> <span class="token string">&quot;&lt;unknown&gt;&quot;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">generate</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

collectDependencies<span class="token punctuation">.</span>InvalidRequireCallError <span class="token operator">=</span> InvalidRequireCallError<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> collectDependencies<span class="token punctuation">;</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ol><li><p><strong><code>collectDependencies</code> 主要利用 babel 去解析所有的 import 和 require 得到每个文件的依赖 module。</strong></p></li> <li><p><strong>处理 import 语句时，会将所有的 import 语句转换为 require 进行加载</strong></p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 转换前</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Image <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-native&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 转换后</span>
<span class="token keyword">var</span> _reactNative <span class="token operator">=</span> <span class="token function">r</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>其他情况:(tips: 暂未找到具体的实现方式，有发现的同学可以一起交流)</p> <ul><li>对于对于预加载的情况，会转换成 <code>require().prefetch</code> 的方式进行加载;</li> <li>如果为资源文件则会转换成 <code>require().resource</code> 的方式加载.</li></ul> <ol start="3"><li><strong>在处理 require 语句时, 会将 require 的内容替换成对应的 moduleId</strong></li></ol> <blockquote><p>举个例子： 类似于<code>require('Foo')</code> 将会被转换成 <code>require(_depMap[3], 'Foo')</code>，这个<code>_depMap</code> 是所有的依赖集合，其实在这个时候，我们并不需要准确的知道真实的 <code>moduleId</code>，只需要知道文件的依赖即可。</p></blockquote> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 转换前</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Image</span></span> <span class="token attr-name">source</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./demo.png'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Image</span></span><span class="token punctuation">&gt;</span></span>
<span class="token comment">// 转换后</span>
_react<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>_reactNative<span class="token punctuation">.</span>Image<span class="token punctuation">,</span><span class="token punctuation">{</span>source<span class="token operator">:</span> <span class="token function">r</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>经过 <code>babel</code> 解析之后的 <code>module</code> 依赖如下:</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 经过 collectDependencies得到的依赖</span>
dependencies<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;@babel/runtime/helpers/interopRequireDefault&quot;</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;react-native&quot;</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;./App&quot;</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;./app.json&quot;</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><ol start="5"><li>js 转换使用的是<code>metro-react-native-babel-transformer</code>对 js 代码进行转换</li></ol> <p>其他:</p> <ol><li>至于如何生成 <code>polyfills</code> 部分，以及<code>\_d</code>，<code>globalThis</code> 等，有兴趣的同学可以看一下<code>node_modules/metro/src/ModuleGraph/worker/JsFileWrapping.js</code></li></ol></div> <div class="post-copyright-container"><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>
      mrgaogang.github.io
    </li> <li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://mrgaogang.github.io/react/ReactNative%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.html" title="声明博客的许可协议">https://mrgaogang.github.io/react/ReactNative%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.html</a></li> <li class="post-copyright-license"><strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用
      <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="external nofollow" target="_blank">CC BY-SA 4.0</a>
      许可协议。转载请注明出处！
    </li></ul></div> <div class="divider-comment"></div> <div class="comments-wrapper"><!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">【未经作者允许禁止转载】 Last Updated: </span> <span class="time">5/12/2021, 11:57:50 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b8d4ddc5.js" defer></script><script src="/assets/js/5.0218c759.js" defer></script><script src="/assets/js/3.4a4bc1cf.js" defer></script><script src="/assets/js/45.34927120.js" defer></script>
  </body>
</html>
