<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>高先生的博客</title>
    <meta name="description" content="旨在分享对技术的了解">
    <link rel="icon" href="/icons/icon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9cfd884fe46fc31072811d47a486a552";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    
    <link rel="preload" href="/assets/css/0.styles.6341e0c8.css" as="style"><link rel="preload" href="/assets/js/app.18401fe5.js" as="script"><link rel="preload" href="/assets/js/6.31f36374.js" as="script"><link rel="preload" href="/assets/js/3.5ac3ae2c.js" as="script"><link rel="preload" href="/assets/js/39.73076b63.js" as="script"><link rel="prefetch" href="/assets/js/1.5ed799af.js"><link rel="prefetch" href="/assets/js/10.0307468a.js"><link rel="prefetch" href="/assets/js/100.4f6bab76.js"><link rel="prefetch" href="/assets/js/101.ec912ab3.js"><link rel="prefetch" href="/assets/js/102.411a7409.js"><link rel="prefetch" href="/assets/js/103.2663729f.js"><link rel="prefetch" href="/assets/js/104.971440e4.js"><link rel="prefetch" href="/assets/js/105.aa6d81b5.js"><link rel="prefetch" href="/assets/js/106.4fc16f3e.js"><link rel="prefetch" href="/assets/js/107.63f99cbc.js"><link rel="prefetch" href="/assets/js/108.5a58f6ad.js"><link rel="prefetch" href="/assets/js/109.2bdd2138.js"><link rel="prefetch" href="/assets/js/11.4f69e934.js"><link rel="prefetch" href="/assets/js/110.a62d1b63.js"><link rel="prefetch" href="/assets/js/111.9302f4f8.js"><link rel="prefetch" href="/assets/js/112.f643c546.js"><link rel="prefetch" href="/assets/js/113.189e5cfd.js"><link rel="prefetch" href="/assets/js/114.efb8d1e4.js"><link rel="prefetch" href="/assets/js/115.e3e9daa8.js"><link rel="prefetch" href="/assets/js/116.b658c9f1.js"><link rel="prefetch" href="/assets/js/117.e8fdc3c8.js"><link rel="prefetch" href="/assets/js/118.82086a7b.js"><link rel="prefetch" href="/assets/js/119.2181bffa.js"><link rel="prefetch" href="/assets/js/12.5e09b540.js"><link rel="prefetch" href="/assets/js/120.335a54e4.js"><link rel="prefetch" href="/assets/js/121.7f6a5296.js"><link rel="prefetch" href="/assets/js/122.8fde05aa.js"><link rel="prefetch" href="/assets/js/123.398414db.js"><link rel="prefetch" href="/assets/js/124.9dfd9c88.js"><link rel="prefetch" href="/assets/js/125.451d89d5.js"><link rel="prefetch" href="/assets/js/126.b5e2342c.js"><link rel="prefetch" href="/assets/js/127.5be00c20.js"><link rel="prefetch" href="/assets/js/128.d353c075.js"><link rel="prefetch" href="/assets/js/129.b8760228.js"><link rel="prefetch" href="/assets/js/13.96baf798.js"><link rel="prefetch" href="/assets/js/130.4aaa1e04.js"><link rel="prefetch" href="/assets/js/131.43695abe.js"><link rel="prefetch" href="/assets/js/132.7b49bea6.js"><link rel="prefetch" href="/assets/js/133.4023f82a.js"><link rel="prefetch" href="/assets/js/134.2a0a0ceb.js"><link rel="prefetch" href="/assets/js/135.5625de1e.js"><link rel="prefetch" href="/assets/js/136.1301f507.js"><link rel="prefetch" href="/assets/js/137.1a4f186b.js"><link rel="prefetch" href="/assets/js/138.209ab7d9.js"><link rel="prefetch" href="/assets/js/139.a607b251.js"><link rel="prefetch" href="/assets/js/14.23dc42d5.js"><link rel="prefetch" href="/assets/js/140.8421d485.js"><link rel="prefetch" href="/assets/js/141.95a4988b.js"><link rel="prefetch" href="/assets/js/142.531d3a7e.js"><link rel="prefetch" href="/assets/js/143.55bb56b8.js"><link rel="prefetch" href="/assets/js/144.8aed2b2c.js"><link rel="prefetch" href="/assets/js/145.a6881528.js"><link rel="prefetch" href="/assets/js/146.1e703220.js"><link rel="prefetch" href="/assets/js/147.a8e8cdd3.js"><link rel="prefetch" href="/assets/js/148.36e21b84.js"><link rel="prefetch" href="/assets/js/149.cf43e621.js"><link rel="prefetch" href="/assets/js/15.348ef904.js"><link rel="prefetch" href="/assets/js/150.d692ff34.js"><link rel="prefetch" href="/assets/js/151.2be8415d.js"><link rel="prefetch" href="/assets/js/152.b99f38c9.js"><link rel="prefetch" href="/assets/js/153.26fca8db.js"><link rel="prefetch" href="/assets/js/154.a1fce896.js"><link rel="prefetch" href="/assets/js/155.5ecb58a5.js"><link rel="prefetch" href="/assets/js/156.ff936be6.js"><link rel="prefetch" href="/assets/js/157.400320af.js"><link rel="prefetch" href="/assets/js/158.044d564d.js"><link rel="prefetch" href="/assets/js/159.930b3c70.js"><link rel="prefetch" href="/assets/js/16.a78aa32b.js"><link rel="prefetch" href="/assets/js/160.f321e117.js"><link rel="prefetch" href="/assets/js/161.8464bc1b.js"><link rel="prefetch" href="/assets/js/162.82bd156c.js"><link rel="prefetch" href="/assets/js/163.5270fe7e.js"><link rel="prefetch" href="/assets/js/164.28758c47.js"><link rel="prefetch" href="/assets/js/165.94b72ccc.js"><link rel="prefetch" href="/assets/js/166.0e27af76.js"><link rel="prefetch" href="/assets/js/167.dbe05127.js"><link rel="prefetch" href="/assets/js/168.b2dff0be.js"><link rel="prefetch" href="/assets/js/169.984b842c.js"><link rel="prefetch" href="/assets/js/17.084dee8e.js"><link rel="prefetch" href="/assets/js/170.fa971c94.js"><link rel="prefetch" href="/assets/js/171.13a6db57.js"><link rel="prefetch" href="/assets/js/172.b591135d.js"><link rel="prefetch" href="/assets/js/173.5a99e3a8.js"><link rel="prefetch" href="/assets/js/174.136faa40.js"><link rel="prefetch" href="/assets/js/175.9fcffb83.js"><link rel="prefetch" href="/assets/js/176.1aeb27ed.js"><link rel="prefetch" href="/assets/js/177.a1fe37e1.js"><link rel="prefetch" href="/assets/js/178.cf90494e.js"><link rel="prefetch" href="/assets/js/179.258360c4.js"><link rel="prefetch" href="/assets/js/18.46f50c74.js"><link rel="prefetch" href="/assets/js/180.ab3f00c4.js"><link rel="prefetch" href="/assets/js/181.97e9e90b.js"><link rel="prefetch" href="/assets/js/182.3eb6270d.js"><link rel="prefetch" href="/assets/js/183.477c3d54.js"><link rel="prefetch" href="/assets/js/184.a59c1c2a.js"><link rel="prefetch" href="/assets/js/185.12802f46.js"><link rel="prefetch" href="/assets/js/186.2a62c638.js"><link rel="prefetch" href="/assets/js/187.4c83ca80.js"><link rel="prefetch" href="/assets/js/19.010b1aa5.js"><link rel="prefetch" href="/assets/js/2.329724ac.js"><link rel="prefetch" href="/assets/js/20.5775424f.js"><link rel="prefetch" href="/assets/js/21.076ea3ed.js"><link rel="prefetch" href="/assets/js/22.fa26aa19.js"><link rel="prefetch" href="/assets/js/23.caa98753.js"><link rel="prefetch" href="/assets/js/24.0e3ee75f.js"><link rel="prefetch" href="/assets/js/25.617c92f3.js"><link rel="prefetch" href="/assets/js/26.5289e9bd.js"><link rel="prefetch" href="/assets/js/27.931fdb36.js"><link rel="prefetch" href="/assets/js/28.6223c962.js"><link rel="prefetch" href="/assets/js/29.48c2b02a.js"><link rel="prefetch" href="/assets/js/30.5932a650.js"><link rel="prefetch" href="/assets/js/31.4461cf19.js"><link rel="prefetch" href="/assets/js/32.af0b3c2f.js"><link rel="prefetch" href="/assets/js/33.8986b517.js"><link rel="prefetch" href="/assets/js/34.e159e80f.js"><link rel="prefetch" href="/assets/js/35.843452b5.js"><link rel="prefetch" href="/assets/js/36.576e4431.js"><link rel="prefetch" href="/assets/js/37.46d3f88f.js"><link rel="prefetch" href="/assets/js/38.0aecbd88.js"><link rel="prefetch" href="/assets/js/40.45d973c1.js"><link rel="prefetch" href="/assets/js/41.00d151ce.js"><link rel="prefetch" href="/assets/js/42.528e54d2.js"><link rel="prefetch" href="/assets/js/43.f29f424f.js"><link rel="prefetch" href="/assets/js/44.0385fe54.js"><link rel="prefetch" href="/assets/js/45.651b0b2e.js"><link rel="prefetch" href="/assets/js/46.a474780a.js"><link rel="prefetch" href="/assets/js/47.031b5523.js"><link rel="prefetch" href="/assets/js/48.071785bd.js"><link rel="prefetch" href="/assets/js/49.bb7a6e0d.js"><link rel="prefetch" href="/assets/js/5.a10fe74d.js"><link rel="prefetch" href="/assets/js/50.ba30009e.js"><link rel="prefetch" href="/assets/js/51.093306b9.js"><link rel="prefetch" href="/assets/js/52.4259369d.js"><link rel="prefetch" href="/assets/js/53.f9399b46.js"><link rel="prefetch" href="/assets/js/54.eec49a90.js"><link rel="prefetch" href="/assets/js/55.939edc1d.js"><link rel="prefetch" href="/assets/js/56.d25ca2d6.js"><link rel="prefetch" href="/assets/js/57.e95ca187.js"><link rel="prefetch" href="/assets/js/58.815d1f86.js"><link rel="prefetch" href="/assets/js/59.64c21a8b.js"><link rel="prefetch" href="/assets/js/60.e0bfd8ed.js"><link rel="prefetch" href="/assets/js/61.9ba4cf8a.js"><link rel="prefetch" href="/assets/js/62.2ffb72c7.js"><link rel="prefetch" href="/assets/js/63.f4a0d652.js"><link rel="prefetch" href="/assets/js/64.42ffe80a.js"><link rel="prefetch" href="/assets/js/65.82acff3e.js"><link rel="prefetch" href="/assets/js/66.0a9c9df5.js"><link rel="prefetch" href="/assets/js/67.194886de.js"><link rel="prefetch" href="/assets/js/68.f31491b6.js"><link rel="prefetch" href="/assets/js/69.e27dcac3.js"><link rel="prefetch" href="/assets/js/7.ce99ff09.js"><link rel="prefetch" href="/assets/js/70.5864d3ad.js"><link rel="prefetch" href="/assets/js/71.47b62fbd.js"><link rel="prefetch" href="/assets/js/72.ef58928e.js"><link rel="prefetch" href="/assets/js/73.427e03a4.js"><link rel="prefetch" href="/assets/js/74.40f7f540.js"><link rel="prefetch" href="/assets/js/75.26bd8461.js"><link rel="prefetch" href="/assets/js/76.a87b619b.js"><link rel="prefetch" href="/assets/js/77.489e5bdd.js"><link rel="prefetch" href="/assets/js/78.2eab8bc9.js"><link rel="prefetch" href="/assets/js/79.782b5864.js"><link rel="prefetch" href="/assets/js/8.7e712860.js"><link rel="prefetch" href="/assets/js/80.f358c4ca.js"><link rel="prefetch" href="/assets/js/81.4ed2aa93.js"><link rel="prefetch" href="/assets/js/82.f1f8462a.js"><link rel="prefetch" href="/assets/js/83.ab02ba16.js"><link rel="prefetch" href="/assets/js/84.fc42fc1c.js"><link rel="prefetch" href="/assets/js/85.6502bd79.js"><link rel="prefetch" href="/assets/js/86.8cb9b0a9.js"><link rel="prefetch" href="/assets/js/87.4ae4c914.js"><link rel="prefetch" href="/assets/js/88.60d329c2.js"><link rel="prefetch" href="/assets/js/89.90501555.js"><link rel="prefetch" href="/assets/js/9.5f869ead.js"><link rel="prefetch" href="/assets/js/90.cc4045db.js"><link rel="prefetch" href="/assets/js/91.637a9eda.js"><link rel="prefetch" href="/assets/js/92.8ad6a8c9.js"><link rel="prefetch" href="/assets/js/93.7843967e.js"><link rel="prefetch" href="/assets/js/94.ffd1464a.js"><link rel="prefetch" href="/assets/js/95.6800e255.js"><link rel="prefetch" href="/assets/js/96.3c75e345.js"><link rel="prefetch" href="/assets/js/97.43350732.js"><link rel="prefetch" href="/assets/js/98.d741fab2.js"><link rel="prefetch" href="/assets/js/99.cc11458d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6341e0c8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/header.png" alt="高先生的博客" class="logo"> <span class="site-name can-hide">高先生的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://mrgaogang.github.io/parse-jsx-to-css-plugins/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue/React to CSS/Less/Sass
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gaogangsever.cn/ui-builder-root/index.html#" target="_blank" rel="noopener noreferrer" class="nav-link external">
  页面构建器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/javascript/index.html" class="nav-link">前端</a></div><div class="nav-item"><a href="/vue/index.html" class="nav-link">Vue</a></div><div class="nav-item"><a href="/react/index.html" class="nav-link">React/RN</a></div><div class="nav-item"><a href="/ai/index.html" class="nav-link">AI/Node</a></div><div class="nav-item"><a href="/android/index.html" class="nav-link">Android</a></div><div class="nav-item"><a href="/ios/index.html" class="nav-link">iOS</a></div><div class="nav-item"><a href="/other/index.html" class="nav-link">杂谈</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">低代码Mendix</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mendix/index.html" class="nav-link">1. Mendix介绍</a></li><li class="dropdown-item"><!----> <a href="/mendix/widgets/index.html" class="nav-link">2. 组件开发</a></li><li class="dropdown-item"><!----> <a href="/mendix/study.html" class="nav-link">3. Mendix学习</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开源</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/article/oview/index.html" class="nav-link">图表库oView</a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_recyclerview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_recyclerview
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_popup_window" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_popup_window
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/lucky_tools/blob/master/packages/mendix-cli/README.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue开发Mendix组件脚手架
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/cocos-webpack-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cocos web端开发
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/ui-designer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ui 构建器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/KotlinGank" target="_blank" rel="noopener noreferrer" class="nav-link external">
  kotlin App
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/tensorflow_object_detection" target="_blank" rel="noopener noreferrer" class="nav-link external">
  tensorflow object detection
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/react-native-file-hash-plugin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  react-native-file-hash-plugin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/parse-jsx-to-css" target="_blank" rel="noopener noreferrer" class="nav-link external">
  parse-jsx-to-css
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://mrgaogang.github.io/parse-jsx-to-css-plugins/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue/React to CSS/Less/Sass
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gaogangsever.cn/ui-builder-root/index.html#" target="_blank" rel="noopener noreferrer" class="nav-link external">
  页面构建器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/javascript/index.html" class="nav-link">前端</a></div><div class="nav-item"><a href="/vue/index.html" class="nav-link">Vue</a></div><div class="nav-item"><a href="/react/index.html" class="nav-link">React/RN</a></div><div class="nav-item"><a href="/ai/index.html" class="nav-link">AI/Node</a></div><div class="nav-item"><a href="/android/index.html" class="nav-link">Android</a></div><div class="nav-item"><a href="/ios/index.html" class="nav-link">iOS</a></div><div class="nav-item"><a href="/other/index.html" class="nav-link">杂谈</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">低代码Mendix</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mendix/index.html" class="nav-link">1. Mendix介绍</a></li><li class="dropdown-item"><!----> <a href="/mendix/widgets/index.html" class="nav-link">2. 组件开发</a></li><li class="dropdown-item"><!----> <a href="/mendix/study.html" class="nav-link">3. Mendix学习</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开源</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/article/oview/index.html" class="nav-link">图表库oView</a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_recyclerview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_recyclerview
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/luckly_popup_window" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucky_popup_window
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/lucky_tools/blob/master/packages/mendix-cli/README.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue开发Mendix组件脚手架
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/cocos-webpack-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cocos web端开发
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/ui-designer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ui 构建器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/KotlinGank" target="_blank" rel="noopener noreferrer" class="nav-link external">
  kotlin App
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/tensorflow_object_detection" target="_blank" rel="noopener noreferrer" class="nav-link external">
  tensorflow object detection
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/react-native-file-hash-plugin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  react-native-file-hash-plugin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/MrGaoGang/parse-jsx-to-css" target="_blank" rel="noopener noreferrer" class="nav-link external">
  parse-jsx-to-css
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/MrGaoGang/mrgaogang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/ReactNative%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.html#一、前言" class="sidebar-link">一、前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/react/ReactNative%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.html#二、metro-依赖时序图" class="sidebar-link">二、metro 依赖时序图</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/ReactNative%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.html#_1-源码阅读" class="sidebar-link">1. 源码阅读</a></li><li class="sidebar-sub-header"><a href="/react/ReactNative%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.html#_2-collectdependencies-依赖收集" class="sidebar-link">2. collectDependencies 依赖收集</a></li></ul></li><li><a href="/react/ReactNative%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="ads-main"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAG4UlEQVR4Xu2Zf4xdRRXHv+eu7f5hEyD6h9qVBFMSgrEJIkINAilogymRSHe3QcAU/aub3Tv3vUgDhF+iRIXunHvrGtPYajTR2IJSm1J+tAFaS0GpQLCGKiENKRBCCIEQ2mjuHHLIfbp9fXfu3PcewrpvkmaT3jPnx2fOnDkzjzDPB83z+DEAMMiAeU5gsAXmeQIMiuBgCwy2wDwnMNgCdRMgjuNRIvoIM/+27twPo3ytDCiC31IE8m1m3hwS1OTk5HAURZdHUXSOiHwKwCcBtP6qilcAvKx/iejlPM+fzPP8oZmZmddD9PciEwygLfiWzTXM/MtODkxMTHxswYIFlxHRShG5DMDCuo6KyP1E9DCAXcz817rzQ+SDAJQE/55+EVmVpuk9LWPr1q076dixYxNEtBbA4hAnAmRyAD9xzs1kWfbPAPlgkSAASZJsEZHRMq1EtOLIkSO7R0ZGGiJyPYBTgj2oJ/iGiMwcPXr0ro0bN75Zb2pn6SAAOjWO47uJ6AqPUV2loQCndK8/KiIHiOiA1oOiLiyJomipiCwFsKhCj867iZl3BtjzigQDUC3GGE31b3Rp9DYAjzDzI775k5OTI0NDQzERTYmIt24Q0fettTd16c9702oBKCD8AcDlNYxqwLdVBd6uzxjzeSKaEZHzKmxtY+Y6/hynrjaAAsK9AL5eBYGItlprx6rkfN+NMZsAXFuhYw8zX9iNna4AFBD+CECPt46jH8G3FBtjbgVwS0WAe5n5groQugaghpIk2S4iK8uMishYmqZb6zrVSd4Y8ysAV/t0iYhN07RRx15PANRQHMc7iOhrdSBoXxFF0WhxtGpFfwbAfmb+eZkeY8xFALQpqhpabzRjgkbPAIrtcB+AS6sgxHG8lIjuBPDVTrJEtNtae4kHggJQEFUjuE0PAtBsNs/M8/xMZr7b49z9AFb4IBDRDwF8psL7w8x8Wsk2MABsVfQAXhKRi9M0PVQlGwTAGKMp+jkAq5j59x4ID5StbpUjbd/XMfOP2+cUC3EwUNcWZh6vkq0EYIy5DsCPCkW5doPW2m0eCA8C+EqV4arvzrlLsizb3S5njPkbgM9WzdfvIhKnaZr5ZL0A1q5du2jhwoXPzb7UENG/NBOstdvLFCdJsktTMMTJMhki+qa19jcdAITWAZ36PDOf3jWAsspLRMf0FsjMOzyZoKu3vAcICTNzjwB0+lnM/HQpaJ+DzWbz43mev1Yi805RE0ovJMaYOqvVbqYMwGMAloWCJaLTrbXPdwVAJyVJ8gMRuaFEwdvFe4AWv47DGKN3gW7a1I4rF8fxC0TU8ZRod0BEHk7T1JuFlUVQ68Dw8PAeETmrJMa3CggPeSDsAfDl0FUDcIiZz+gkb4x5G8BHA3T92zm3PMuyP3VdA1oTfS9Chcwb2tlNT0+fULVbOowxewGcH+C4Vu+OLbQxRlthbYkrBxFdb63VvsM7KjNgFoTNRLTGo+31AkJpuxrH8T4i+pLPI9/9wRgT2mfsYObSO8ps+8EAkiRZ4pzbS0Sf8ASgBXPMd/c3xlQVsSs7Pbk3Go0rnHOlnegsn/SpbHnoI2owADVgjJkE4G0sALxarKLu+7LC+DiAcz0gT+jljTGhdeQaZv51Veq3vtcCUEDQ6+b6CgOvOOfGfAXIGPMEgC969Ewx84bCZsh7AIioYa0NuSv8x2xtADozSZI1IlL1o8gR59x4lmWa8mWZ8BcAX/BA0ON3OOAxRIO/w1p7Y+jKd50BrYnGGH0c1YrsO5JejKJofHp6WlO+DMKTAM6u6/hxhYxok7X2O93o6CoDWoampqYujqJIfxka8Rg/TETj1to/eyDot3O6CUBE7kjTtPbK95wBLQXNZvPsPM9/VpHK2r0pBF3tjiNJkv0BL8D/3btEW/M8/16WZXo77Hr0lAGzrcZxfBURfQtA2YuO9uPjvuMpSZJ9IuLtEwBoJ6hHbc8/iqj/fQPQghHH8coCxKoOy/KPPM9Xb9iw4SnPdvB2jCKyOk3T33W95G0T+w5gVn04P4oizQh9/zu19f8i8pxzTiHoK1NZYXwUQOkTt3Pu2izLftEPCO8bgNnO6VOWc26Z/iOi84hI7a621j7rgeC9ShPRhLX2p71C+J8A6ORkAYWstaVvfAHvCd9l5rt6gfCBAQh1OgDCzcx8e6i+drkPPQB12APh4NDQ0Nj69ev//n8NYHR0dGjx4sW72n4U6Tn49+UY7HYlquYZY04mop1Fs9SX4OcUAHW20Wh82jm3s9e0nw17TtSA9iO1lz0/J4tg1fbo5fucy4Begu00dwCg30Tnmr5BBsy1Feu3v4MM6DfRuaZvkAFzbcX67e+8z4B3AU7+oV/ZJX7ZAAAAAElFTkSuQmCC" class="btn-control"> <img src="https://camo.githubusercontent.com/01448f33e0bc34a83317f39bb3a1df723e109d4194e0259b7345775fe99968d5/68747470733a2f2f70312d6a75656a696e2e62797465696d672e636f6d2f746f732d636e2d692d6b3375316662706663702f33306666633738643332313434323632623536633633653230323261656163307e74706c762d6b3375316662706663702d7a6f6f6d2d312e696d616765" class="my-wechat-m" style="display:;"> <div class="item-ads" style="display:;"><div class="ads-name">耗时4天写的日程小程序</div> <img src="/assets/img/mini-app.9d4e9bb7.png" class="item-ads-url item-ads-url-full"></div><div class="item-ads" style="display:;"><div class="ads-name">华为云各类服务内部优惠</div> <img src="/assets/img/huawei.1ebdc4d9.png" class="item-ads-url"></div></div> <div class="theme-default-content content__default"><blockquote><p>导语: 回到上一章节<a href="https://mrgaogang.github.io/react/react-native_bundle%E5%88%B0bundle%E7%94%9F%E6%88%90%E5%88%B0%E5%BA%95%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html" target="_blank" rel="noopener noreferrer">react-native bundle 到 bundle 生成到底发生了什么(metro 打包流程简析)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，我们知道 RN 构建过程大致分为 <code>解析</code>,<code>转换</code>和<code>生成</code>三个步骤，其中有一个比较关键的点在于，我们需要利用每个 <code>module</code> 的依赖关系，进行性能优化，剔除不必要的 <code>module</code></p></blockquote> <p>那么<code>react native</code>是如何获取到每个文件的的依赖 <code>module</code> 呢? 下面我们具体分析一波。</p> <h2 id="一、前言"><a href="#一、前言" aria-hidden="true" class="header-anchor">#</a> 一、前言</h2> <p>还记得之前我们讲过 <code>metro</code> 是利用<code>jest-haste-map</code>去做文件解析，每一个 module 经过 <code>jest-haste-map</code> 之后的数据结构如下:</p> <div class="language-json extra-class"><pre class="language-json"><code> <span class="token punctuation">[</span>
    <span class="token string">&quot;App.js&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 文件路径，相对于根目录</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// id</span>
      <span class="token number">1606548079450</span><span class="token punctuation">,</span> <span class="token comment">// mtime,时间戳</span>
      <span class="token number">2794</span><span class="token punctuation">,</span> <span class="token comment">// 文件大小size</span>
      <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// visited 0 | 1,</span>
      <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token comment">// dependencies, 其实返回的并没有文件对应的依赖。</span>
      <span class="token string">&quot;552e453f03517dc010656369ea82f6a9b6b0383b&quot;</span> <span class="token comment">// sha1</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><p>然而真实转换后可以得到文件的依赖关系如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 以index.js文件为例</span>
Map <span class="token punctuation">{</span>
  <span class="token string">'/Users/alexganggao/Desktop/rn-jest/MyRN/index.js'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> inverseDependencies<span class="token punctuation">:</span> Set <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/rn-jest/MyRN/index.js'</span><span class="token punctuation">,</span>
    dependencies<span class="token punctuation">:</span>
     Map <span class="token punctuation">{</span>
       <span class="token string">'@babel/runtime/helpers/interopRequireDefault'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token string">'react-native'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token string">'./App'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token string">'./app.json'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    getSource<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">:</span> getSource<span class="token punctuation">]</span><span class="token punctuation">,</span>
    output<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么再真实的情况下，<code>metro</code> 是如何知道每个 <code>module</code> 有哪些依赖文件呢？</p> <p>答案其实很简单: <strong>利用 <code>AST</code> 分析得到每个 <code>module</code> 使用了哪些 <code>import</code> 和 <code>require</code></strong></p> <h2 id="二、metro-依赖时序图"><a href="#二、metro-依赖时序图" aria-hidden="true" class="header-anchor">#</a> 二、metro 依赖时序图</h2> <p>为了验证此设想，笔者分析源码得知，整个 rn 依赖解析时序图下图所示:</p> <p><img src="/assets/img/bundle_dependencies.ad664064.png" alt=""></p> <p>对源码有兴趣的笔者，可以查阅下面一部分源码阅读，您也可以直接跳转到<a href="#collectDependencies">这里</a>查看具体依赖分析部分。</p> <h3 id="_1-源码阅读"><a href="#_1-源码阅读" aria-hidden="true" class="header-anchor">#</a> 1. 源码阅读</h3> <p>在进行图谱生成完成之后，利用 <code>/node_modules/metro/src/DeltaBundler/DeltaCalculator.js</code> 初始化了 dependencies 并使用<code>getDelta</code>进行依赖解析:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>_graph <span class="token operator">=</span> <span class="token punctuation">{</span>
  dependencies<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  entryPoints<span class="token punctuation">,</span>
  importBundleNames<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>getDelta -&gt; _getChangedDependencies -&gt; initialTraverseDependencies -&gt; _traverseDependenciesForSingleFile -&gt; processModule -&gt;</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">const</span> internalOptions <span class="token operator">=</span> <span class="token function">getInternalOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
      graph<span class="token punctuation">.</span>entryPoints<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">traverseDependenciesForSingleFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> graph<span class="token punctuation">,</span> delta<span class="token punctuation">,</span> internalOptions<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用options.transform进行转换 options从哪里？其实就是上面的internalOptions，而internalOptions又使用的options</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">yield</span> options<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Get the absolute path of all sub-dependencies (some of them could have been</span>


</code></pre></div><p>现在我们将目光聚焦在 options 从哪里得来，利用反向查找 options:</p> <p>initialTraverseDependencies -&gt; <code>DeltaBundler.buildGraph(entryPoints, options)</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/DeltaBundler.js</span>
<span class="token function">buildGraph</span><span class="token punctuation">(</span><span class="token parameter">entryPoints<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> depGraph <span class="token operator">=</span> <span class="token keyword">yield</span> _this<span class="token punctuation">.</span>_bundler<span class="token punctuation">.</span><span class="token function">getDependencyGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> deltaCalculator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeltaCalculator</span><span class="token punctuation">(</span>
        entryPoints<span class="token punctuation">,</span>
        depGraph<span class="token punctuation">,</span>
        options
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">yield</span> deltaCalculator<span class="token punctuation">.</span><span class="token function">getDelta</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        reset<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        shallow<span class="token punctuation">:</span> options<span class="token punctuation">.</span>shallow
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> graph <span class="token operator">=</span> deltaCalculator<span class="token punctuation">.</span><span class="token function">getGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _this<span class="token punctuation">.</span>_deltaCalculators<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> deltaCalculator<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> graph<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">//node_modules/metro/src/IncrementalBundler.js</span>
<span class="token comment">// buildGraphForEntries</span>
<span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token keyword">yield</span> _this<span class="token punctuation">.</span>_deltaBundler<span class="token punctuation">.</span><span class="token function">buildGraph</span><span class="token punctuation">(</span>absoluteEntryFiles<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        resolve<span class="token punctuation">:</span> <span class="token keyword">yield</span> transformHelpers<span class="token punctuation">.</span><span class="token function">getResolveDependencyFn</span><span class="token punctuation">(</span>
          _this<span class="token punctuation">.</span>_bundler<span class="token punctuation">,</span>
          transformOptions<span class="token punctuation">.</span>platform
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        transform<span class="token punctuation">:</span> <span class="token keyword">yield</span> transformHelpers<span class="token punctuation">.</span><span class="token function">getTransformFn</span><span class="token punctuation">(</span>
          absoluteEntryFiles<span class="token punctuation">,</span>
          _this<span class="token punctuation">.</span>_bundler<span class="token punctuation">,</span>
          _this<span class="token punctuation">.</span>_deltaBundler<span class="token punctuation">,</span>
          _this<span class="token punctuation">.</span>_config<span class="token punctuation">,</span>
          transformOptions
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        onProgress<span class="token punctuation">:</span> otherOptions<span class="token punctuation">.</span>onProgress<span class="token punctuation">,</span>
        experimentalImportBundleSupport<span class="token punctuation">:</span>
          _this<span class="token punctuation">.</span>_config<span class="token punctuation">.</span>transformer<span class="token punctuation">.</span>experimentalImportBundleSupport<span class="token punctuation">,</span>
        shallow<span class="token punctuation">:</span> otherOptions<span class="token punctuation">.</span>shallow
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// node_modules/metro/src/lib/transformHelpers.js 转换来源于Bundler</span>
<span class="token comment">// _getTransformFn</span>
<span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> bundler<span class="token punctuation">.</span><span class="token function">transformFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>transformOptions<span class="token punctuation">,</span>
      type<span class="token punctuation">:</span> <span class="token function">getType</span><span class="token punctuation">(</span>transformOptions<span class="token punctuation">.</span>type<span class="token punctuation">,</span> path<span class="token punctuation">,</span> config<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>assetExts<span class="token punctuation">)</span><span class="token punctuation">,</span>
      inlineRequires<span class="token punctuation">:</span> <span class="token function">removeInlineRequiresBlacklistFromOptions</span><span class="token punctuation">(</span>
        path<span class="token punctuation">,</span>
        inlineRequires<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// node_modules/metro/src/Bundler.js</span>
<span class="token keyword">class</span> <span class="token class-name">Bundler</span> <span class="token punctuation">{</span>
  _depGraphPromise<span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>DependencyGraph<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  _transformer<span class="token punctuation">:</span> Transformer<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">:</span> ConfigT<span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token punctuation">:</span> BundlerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_depGraphPromise <span class="token operator">=</span> DependencyGraph<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_depGraphPromise
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dependencyGraph<span class="token punctuation">:</span> DependencyGraph</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_transformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">(</span>
          config<span class="token punctuation">,</span>
          dependencyGraph<span class="token punctuation">.</span><span class="token function">getSha1</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>dependencyGraph<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Failed to construct transformer: '</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">transformFile</span><span class="token punctuation">(</span>
    filePath<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
    transformOptions<span class="token punctuation">:</span> TransformOptions<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>TransformResultWithSource<span class="token operator">&lt;</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// We need to be sure that the DependencyGraph has been initialized.</span>
    <span class="token comment">// TODO: Remove this ugly hack!</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_depGraphPromise<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_transformer<span class="token punctuation">.</span><span class="token function">transformFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> transformOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 转换 node_modules/metro/src/DeltaBundler/Transformer.js</span>

  <span class="token keyword">async</span> <span class="token function">transformFile</span><span class="token punctuation">(</span>
    filePath<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
    transformerOptions<span class="token punctuation">:</span> TransformOptions<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>TransformResultWithSource<span class="token operator">&lt;</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      customTransformOptions<span class="token punctuation">,</span>
      dev<span class="token punctuation">,</span>
      experimentalImportSupport<span class="token punctuation">,</span>
      hot<span class="token punctuation">,</span>
      inlinePlatform<span class="token punctuation">,</span>
      inlineRequires<span class="token punctuation">,</span>
      minify<span class="token punctuation">,</span>
      unstable_disableES6Transforms<span class="token punctuation">,</span>
      platform<span class="token punctuation">,</span>
      type<span class="token punctuation">,</span>
      <span class="token operator">...</span>extra
    <span class="token punctuation">}</span> <span class="token operator">=</span> transformerOptions<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> extra<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>extra<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token string">'Extra keys detected: '</span> <span class="token operator">+</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>extra<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> localPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> partialKey <span class="token operator">=</span> <span class="token function">stableHash</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token comment">// This is the hash related to the global Bundler config.</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_baseHash<span class="token punctuation">,</span>

      <span class="token comment">// Path.</span>
      localPath<span class="token punctuation">,</span>

      customTransformOptions<span class="token punctuation">,</span>
      dev<span class="token punctuation">,</span>
      experimentalImportSupport<span class="token punctuation">,</span>
      hot<span class="token punctuation">,</span>
      inlinePlatform<span class="token punctuation">,</span>
      inlineRequires<span class="token punctuation">,</span>
      minify<span class="token punctuation">,</span>
      unstable_disableES6Transforms<span class="token punctuation">,</span>
      platform<span class="token punctuation">,</span>
      type<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getSha1</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fullKey <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>partialKey<span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>sha1<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fullKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// A valid result from the cache is used directly; otherwise we call into</span>
    <span class="token comment">// the transformer to computed the corresponding result.</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> result
      <span class="token operator">?</span> <span class="token punctuation">{</span>result<span class="token punctuation">,</span> sha1<span class="token punctuation">}</span>
      <span class="token punctuation">:</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_workerFarm<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>localPath<span class="token punctuation">,</span> transformerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Only re-compute the full key if the SHA-1 changed. This is because</span>
    <span class="token comment">// references are used by the cache implementation in a weak map to keep</span>
    <span class="token comment">// track of the cache that returned the result.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1 <span class="token operator">!==</span> data<span class="token punctuation">.</span>sha1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fullKey <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>partialKey<span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>sha1<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>fullKey<span class="token punctuation">,</span> data<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>data<span class="token punctuation">.</span>result<span class="token punctuation">,</span>
      <span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Buffer <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre></div><p>打印 data.result 得知对于每个文件生成如下数据结构:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
dependencies<span class="token punctuation">:</span>
   <span class="token punctuation">[</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'@babel/runtime/helpers/interopRequireDefault'</span><span class="token punctuation">,</span>
       data<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'react-native'</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'./App'</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'./app.json'</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
output<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token string">'js/module'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着看，文件转换：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/DeltaBundler/WorkerFarm.js</span>

  <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>
    filename<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
    options<span class="token punctuation">:</span> TransformOptions<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>TransformerResult<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_worker<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>
        filename<span class="token punctuation">,</span>
        options<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_transformerConfig<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">:</span> data<span class="token punctuation">.</span>result<span class="token punctuation">,</span>
        sha1<span class="token punctuation">:</span> data<span class="token punctuation">.</span>sha1<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>loc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_formatBabelError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_formatGenericError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token comment">// worker 其实是一个JestWorker，利用JestWorker执行自定义方法</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_makeFarm</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>transformer<span class="token punctuation">.</span>workerPath<span class="token punctuation">,</span> <span class="token comment">// workerPath: 'metro/src/DeltaBundler/Worker',</span>
        <span class="token punctuation">[</span><span class="token string">&quot;transform&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>maxWorkers
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>转换相关配置信息如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
transformer<span class="token punctuation">:</span>
   <span class="token punctuation">{</span> assetPlugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
     asyncRequireModulePath<span class="token punctuation">:</span> <span class="token string">'metro/src/lib/bundle-modules/asyncRequire'</span><span class="token punctuation">,</span>
     assetRegistryPath<span class="token punctuation">:</span> <span class="token string">'react-native/Libraries/Image/AssetRegistry'</span><span class="token punctuation">,</span>
     babelTransformerPath<span class="token punctuation">:</span>
      <span class="token string">'/Users/alexganggao/Desktop/rn-jest/MyRN/node_modules/@react-native-community/cli/node_modules/metro-react-native-babel-transformer/src/index.js'</span><span class="token punctuation">,</span>
     dynamicDepsInPackages<span class="token punctuation">:</span> <span class="token string">'throwAtRuntime'</span><span class="token punctuation">,</span>
     enableBabelRCLookup<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
     enableBabelRuntime<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
     experimentalImportBundleSupport<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
     getTransformOptions<span class="token punctuation">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token punctuation">:</span> getTransformOptions<span class="token punctuation">]</span><span class="token punctuation">,</span>
     minifierConfig<span class="token punctuation">:</span>
      <span class="token punctuation">{</span> mangle<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
        output<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
        sourceMap<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
        toplevel<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        compress<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     minifierPath<span class="token punctuation">:</span> <span class="token string">'metro-minify-uglify'</span><span class="token punctuation">,</span>
     optimizationSizeLimit<span class="token punctuation">:</span> <span class="token number">153600</span><span class="token punctuation">,</span>
     postMinifyProcess<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">:</span> postMinifyProcess<span class="token punctuation">]</span><span class="token punctuation">,</span>
     transformVariants<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     workerPath<span class="token punctuation">:</span> <span class="token string">'metro/src/DeltaBundler/Worker'</span><span class="token punctuation">,</span>
     publicPath<span class="token punctuation">:</span> <span class="token string">'/assets'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  cacheStores<span class="token punctuation">:</span>
   <span class="token punctuation">[</span> FileStore <span class="token punctuation">{</span>
       _root<span class="token punctuation">:</span>
        <span class="token string">'/var/folders/q_/vy78r8wn5n1cdftb86yqtz280000gn/T/metro-cache'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  cacheVersion<span class="token punctuation">:</span> <span class="token string">'1.0'</span><span class="token punctuation">,</span>
  projectRoot<span class="token punctuation">:</span> <span class="token string">'/Users/alexganggao/Desktop/rn-jest/MyRN'</span><span class="token punctuation">,</span>
  stickyWorkers<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  watchFolders<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'/Users/alexganggao/Desktop/rn-jest/MyRN'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  transformerPath<span class="token punctuation">:</span>
   <span class="token string">'/Users/alexganggao/Desktop/rn-jest/MyRN/node_modules/metro/src/JSTransformer/worker.js'</span><span class="token punctuation">,</span>
  maxWorkers<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
  resetCache<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  reporter<span class="token punctuation">:</span>
   TerminalReporter <span class="token punctuation">{</span>
     _activeBundles<span class="token punctuation">:</span> Map <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
     _scheduleUpdateBundleProgress<span class="token punctuation">:</span>
      <span class="token punctuation">{</span> <span class="token punctuation">[</span>Function<span class="token punctuation">:</span> debounced<span class="token punctuation">]</span> cancel<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">:</span> cancel<span class="token punctuation">]</span><span class="token punctuation">,</span> flush<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">:</span> flush<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     terminal<span class="token punctuation">:</span>
      Terminal <span class="token punctuation">{</span>
        _logLines<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        _nextStatusStr<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        _scheduleUpdate<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">]</span><span class="token punctuation">,</span>
        _statusStr<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        _stream<span class="token punctuation">:</span> <span class="token punctuation">[</span>WriteStream<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token string">'00000000'</span>
calcTransformerOptions<span class="token punctuation">:</span>  <span class="token punctuation">{</span> customTransformOptions<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">:</span> <span class="token keyword">null</span> prototype<span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  dev<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  hot<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  inlineRequires<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  inlinePlatform<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  minify<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  platform<span class="token punctuation">:</span> <span class="token string">'ios'</span><span class="token punctuation">,</span>
  experimentalImportSupport<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  unstable_disableES6Transforms<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  type<span class="token punctuation">:</span> <span class="token string">'module'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>继续查看 Worker.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/DeltaBundler/Worker.js</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">transform</span><span class="token punctuation">(</span>
  <span class="token parameter">filename<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  transformOptions<span class="token punctuation">:</span> JsTransformOptions<span class="token punctuation">,</span>
  projectRoot<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  transformerConfig<span class="token punctuation">:</span> TransformerConfig</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Data<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> transformer <span class="token operator">=</span> <span class="token function">getTransformer</span><span class="token punctuation">(</span>projectRoot<span class="token punctuation">,</span> transformerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> transformFileStartLogEntry <span class="token operator">=</span> <span class="token punctuation">{</span>
    action_name<span class="token punctuation">:</span> <span class="token string">&quot;Transforming file&quot;</span><span class="token punctuation">,</span>
    action_phase<span class="token punctuation">:</span> <span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span>
    file_name<span class="token punctuation">:</span> filename<span class="token punctuation">,</span>
    log_entry_label<span class="token punctuation">:</span> <span class="token string">&quot;Transforming file&quot;</span><span class="token punctuation">,</span>
    start_timestamp<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">hrtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>projectRoot<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sha1 <span class="token operator">=</span> crypto
    <span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">&quot;sha1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">&quot;hex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> transformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> data<span class="token punctuation">,</span> transformOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">,</span>
    sha1<span class="token punctuation">,</span>
    transformFileStartLogEntry<span class="token punctuation">,</span>
    transformFileEndLogEntry<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查看 getTransformer得知转换使用的是transformerPath</span>

<span class="token keyword">const</span> Transformer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>transformerPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

transformers<span class="token punctuation">[</span>transformerKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">(</span>projectRoot<span class="token punctuation">,</span> transformerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> transformers<span class="token punctuation">[</span>transformerKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>而我们在上面的转换配置信息中可以得知:<code>transformerPath为'node_modules/metro/src/JSTransformer/worker.js'</code></p> <p>至此我们得知 react-native 使用的是<code>JSTransformer</code>进行代码转换</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/JSTransformer/worker.js</span>
 <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>
    filename<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> Buffer<span class="token punctuation">,</span>
    options<span class="token punctuation">:</span> JsTransformOptions<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Result<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sourceCode <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token string">'js/module'</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'asset'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> <span class="token string">'js/module/asset'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'script'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> <span class="token string">'js/script'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// json返回依赖为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> code <span class="token operator">=</span> JsFileWrapping<span class="token punctuation">.</span><span class="token function">wrapJson</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>minify<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>map<span class="token punctuation">,</span> code<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_minifyCode</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> code<span class="token punctuation">,</span> sourceCode<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        output<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            data<span class="token punctuation">:</span> <span class="token punctuation">{</span>code<span class="token punctuation">,</span> lineCount<span class="token punctuation">:</span> <span class="token function">countLines</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token punctuation">,</span> functionMap<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            type<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// $FlowFixMe TODO t26372934 Plugin system</span>
    <span class="token comment">//  '/node_modules/@react-native-community/cli/node_modules/metro-react-native-babel-transformer/src/index.js'</span>
    <span class="token keyword">const</span> transformer<span class="token punctuation">:</span> Transformer<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_config
      <span class="token punctuation">.</span>babelTransformerPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> transformerArgs <span class="token operator">=</span> <span class="token punctuation">{</span>
      filename<span class="token punctuation">,</span>
      options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>options<span class="token punctuation">,</span>
        enableBabelRCLookup<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>enableBabelRCLookup<span class="token punctuation">,</span>
        enableBabelRuntime<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>enableBabelRuntime<span class="token punctuation">,</span>
        <span class="token comment">// Inline requires are now performed at a secondary step. We cannot</span>
        <span class="token comment">// unfortunately remove it from the internal transformer, since this one</span>
        <span class="token comment">// is used by other tooling, and this would affect it.</span>
        inlineRequires<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        projectRoot<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_projectRoot<span class="token punctuation">,</span>
        publicPath<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>publicPath<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      src<span class="token punctuation">:</span> sourceCode<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> transformResult <span class="token operator">=</span>
      type <span class="token operator">===</span> <span class="token string">'js/module/asset'</span>
        <span class="token operator">?</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span><span class="token punctuation">(</span><span class="token keyword">await</span> assetTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>
              transformerArgs<span class="token punctuation">,</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>assetRegistryPath<span class="token punctuation">,</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>assetPlugins<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            functionMap<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">:</span> <span class="token keyword">await</span> transformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>transformerArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Transformers can ouptut null ASTs (if they ignore the file). In that case</span>
    <span class="token comment">// we need to parse the module source code to get their AST.</span>
    <span class="token keyword">let</span> ast <span class="token operator">=</span>
      transformResult<span class="token punctuation">.</span>ast <span class="token operator">||</span>
      babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span>sourceType<span class="token punctuation">:</span> <span class="token string">'unambiguous'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>importDefault<span class="token punctuation">,</span> importAll<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generateImportNames</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add &quot;use strict&quot; if the file was parsed as a module, and the directive did</span>
    <span class="token comment">// not exist yet.</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>directives<span class="token punctuation">}</span> <span class="token operator">=</span> ast<span class="token punctuation">.</span>program<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>sourceType <span class="token operator">===</span> <span class="token string">'module'</span> <span class="token operator">&amp;&amp;</span>
      directives<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">d</span> <span class="token operator">=&gt;</span> d<span class="token punctuation">.</span>value<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">'use strict'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      directives<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">directiveLiteral</span><span class="token punctuation">(</span><span class="token string">'use strict'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Perform the import-export transform (in case it's still needed), then</span>
    <span class="token comment">// fold requires and perform constant folding (if in dev).</span>
    <span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>options<span class="token punctuation">,</span>
      inlineableCalls<span class="token punctuation">:</span> <span class="token punctuation">[</span>importDefault<span class="token punctuation">,</span> importAll<span class="token punctuation">]</span><span class="token punctuation">,</span>
      importDefault<span class="token punctuation">,</span>
      importAll<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>experimentalImportSupport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>importExportPlugin<span class="token punctuation">,</span> opts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>inlineRequires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>inlineRequiresPlugin<span class="token punctuation">,</span> opts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>constantFoldingPlugin<span class="token punctuation">,</span> opts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>inlinePlugin<span class="token punctuation">,</span> opts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token punctuation">{</span>ast<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">transformFromAstSync</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      ast<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      babelrc<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      code<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      configFile<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      comments<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      compact<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      filename<span class="token punctuation">,</span>
      plugins<span class="token punctuation">,</span>
      sourceMaps<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> dependencyMapName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> dependencies<span class="token punctuation">;</span>
    <span class="token keyword">let</span> wrappedAst<span class="token punctuation">;</span>

    <span class="token comment">// If the module to transform is a script (meaning that is not part of the</span>
    <span class="token comment">// dependency graph and it code will just be prepended to the bundle modules),</span>
    <span class="token comment">// we need to wrap it differently than a commonJS module (also, scripts do</span>
    <span class="token comment">// not have dependencies).</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'js/script'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dependencies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      wrappedAst <span class="token operator">=</span> JsFileWrapping<span class="token punctuation">.</span><span class="token function">wrapPolyfill</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span>
          asyncRequireModulePath<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>asyncRequireModulePath<span class="token punctuation">,</span>
          dynamicRequires<span class="token punctuation">:</span> <span class="token function">getDynamicDepsBehavior</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>dynamicDepsInPackages<span class="token punctuation">,</span>
            filename<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          inlineableCalls<span class="token punctuation">:</span> <span class="token punctuation">[</span>importDefault<span class="token punctuation">,</span> importAll<span class="token punctuation">]</span><span class="token punctuation">,</span>
          keepRequireNames<span class="token punctuation">:</span> options<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>ast<span class="token punctuation">,</span> dependencies<span class="token punctuation">,</span> dependencyMapName<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">collectDependencies</span><span class="token punctuation">(</span>
          ast<span class="token punctuation">,</span>
          opts<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 依赖收集</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">collectDependencies<span class="token punctuation">.</span>InvalidRequireCallError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidRequireCallError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 处理,globalThis,_d,polyfill,替换require部分</span>
      <span class="token punctuation">(</span><span class="token punctuation">{</span>ast<span class="token punctuation">:</span> wrappedAst<span class="token punctuation">}</span> <span class="token operator">=</span> JsFileWrapping<span class="token punctuation">.</span><span class="token function">wrapModule</span><span class="token punctuation">(</span>
        ast<span class="token punctuation">,</span>
        importDefault<span class="token punctuation">,</span>
        importAll<span class="token punctuation">,</span>
        dependencyMapName<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> reserved <span class="token operator">=</span>
      options<span class="token punctuation">.</span>minify <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_config<span class="token punctuation">.</span>optimizationSizeLimit
        <span class="token operator">?</span> <span class="token function">normalizePseudoglobals</span><span class="token punctuation">(</span>wrappedAst<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 代码生成</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>
      wrappedAst<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        comments<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        compact<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        filename<span class="token punctuation">,</span>
        retainLines<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        sourceFileName<span class="token punctuation">:</span> filename<span class="token punctuation">,</span>
        sourceMaps<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      sourceCode<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> map <span class="token operator">=</span> result<span class="token punctuation">.</span>rawMappings <span class="token operator">?</span> result<span class="token punctuation">.</span>rawMappings<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>toSegmentTuple<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> code <span class="token operator">=</span> result<span class="token punctuation">.</span>code<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>minify<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 压缩代码</span>
      <span class="token punctuation">(</span><span class="token punctuation">{</span>map<span class="token punctuation">,</span> code<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_minifyCode</span><span class="token punctuation">(</span>
        filename<span class="token punctuation">,</span>
        result<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
        sourceCode<span class="token punctuation">,</span>
        map<span class="token punctuation">,</span>
        reserved<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>functionMap<span class="token punctuation">}</span> <span class="token operator">=</span> transformResult<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      dependencies<span class="token punctuation">,</span>
      output<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>data<span class="token punctuation">:</span> <span class="token punctuation">{</span>code<span class="token punctuation">,</span> lineCount<span class="token punctuation">:</span> <span class="token function">countLines</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token punctuation">,</span> functionMap<span class="token punctuation">}</span><span class="token punctuation">,</span> type<span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>查阅如上代码，我们得知:</p> <ul><li>js 转换使用的是<code>metro-react-native-babel-transformer</code>对 js 代码进行转换</li> <li>针对 dependencies，主要使用了<code>collectDependencies</code>方法:</li></ul> <h3 id="_2-collectdependencies-依赖收集"><a href="#_2-collectdependencies-依赖收集" aria-hidden="true" class="header-anchor">#</a> 2. collectDependencies 依赖收集<a name="collectDependencies"></a></h3> <p>下面我们具体来看一下是如何进行依赖收集的:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_modules/metro/src/ModuleGraph/worker/collectDependencies.js</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/traverse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> type <span class="token punctuation">{</span> Ast <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@babel/core&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> type DynamicRequiresBehavior <span class="token operator">=</span> <span class="token string">&quot;throwAtRuntime&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;reject&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Produces a Babel template that will throw at runtime when the require call
 * is reached. This makes dynamic require errors catchable by libraries that
 * want to use them.
 */</span>
<span class="token keyword">const</span> dynamicRequireErrorTemplate <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  (function(line) {
    throw new Error(
      'Dynamic require defined at line ' + line + '; not supported by Metro',
    );
  })(LINE)
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Produces a Babel template that transforms an &quot;import(...)&quot; call into a
 * &quot;require(...)&quot; call to the asyncRequire specified.
 */</span>
<span class="token keyword">const</span> makeAsyncRequireTemplate <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  require(ASYNC_REQUIRE_MODULE_PATH)(MODULE_ID, MODULE_NAME)
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> makeAsyncPrefetchTemplate <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  require(ASYNC_REQUIRE_MODULE_PATH).prefetch(MODULE_ID, MODULE_NAME)
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> makeJSResourceTemplate <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  require(ASYNC_REQUIRE_MODULE_PATH).resource(MODULE_ID, MODULE_NAME)
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">collectDependencies</span><span class="token punctuation">(</span>
  <span class="token parameter">ast<span class="token punctuation">:</span> Ast<span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> Options</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> CollectedDependencies <span class="token punctuation">{</span>
  <span class="token keyword">const</span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> state<span class="token punctuation">:</span> State <span class="token operator">=</span> <span class="token punctuation">{</span>
    asyncRequireModulePathStringLiteral<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    dependency<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    dependencyCalls<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dependencyData<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dependencyIndexes<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dependencyMapIdentifier<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    dynamicRequires<span class="token punctuation">:</span> options<span class="token punctuation">.</span>dynamicRequires<span class="token punctuation">,</span>
    keepRequireNames<span class="token punctuation">:</span> options<span class="token punctuation">.</span>keepRequireNames<span class="token punctuation">,</span>
    disableRequiresTransform<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>disableRequiresTransform<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理所有AST中的表达式，如果call是import类型的，其arguments一定是Expression</span>
    <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">:</span> Path<span class="token punctuation">,</span> state<span class="token punctuation">:</span> State</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>visited<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> callee <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;callee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> name <span class="token operator">=</span> callee<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token comment">// 如果是import语句，执行依赖手机</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callee<span class="token punctuation">.</span><span class="token function">isImport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processImportCall</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          prefetchOnly<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果是import语句，执行依赖收集</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;__prefetchImport&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processImportCall</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          prefetchOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果为js资源或者分包资源同样处理import，但是生成的requore将会不同， tips: 似乎__jsResource并没有被使用过</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;__jsResource&quot;</span> <span class="token operator">||</span>
          name <span class="token operator">===</span> <span class="token string">&quot;__conditionallySplitJSResource&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processImportCall</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          prefetchOnly<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          jsResource<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>dependencyCalls<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">processRequireCall</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">:</span> Path<span class="token punctuation">,</span> state<span class="token punctuation">:</span> State</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 针对import语句，记录import的module到一个map中，如果module被记录过那么不会重复记录</span>
      <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token function">getDependency</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        prefetchOnly<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      dep<span class="token punctuation">.</span>data<span class="token punctuation">.</span>isAsync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">Program</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">:</span> Path<span class="token punctuation">,</span> state<span class="token punctuation">:</span> State</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>asyncRequireModulePathStringLiteral <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>
        options<span class="token punctuation">.</span>asyncRequireModulePath
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      state<span class="token punctuation">.</span>dependencyMapIdentifier <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">generateUidIdentifier</span><span class="token punctuation">(</span>
        <span class="token string">&quot;dependencyMap&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      state<span class="token punctuation">.</span>dependencyCalls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;require&quot;</span><span class="token punctuation">,</span> <span class="token operator">...</span>options<span class="token punctuation">.</span>inlineableCalls<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> visitor<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Compute the list of dependencies.</span>
  <span class="token keyword">const</span> dependencies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>dependency<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> data<span class="token punctuation">]</span> <span class="token keyword">of</span> state<span class="token punctuation">.</span>dependencyData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dependencies<span class="token punctuation">[</span><span class="token function">nullthrows</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>dependencyIndexes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">,</span>
      data<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    ast<span class="token punctuation">,</span>
    dependencies<span class="token punctuation">,</span>
    dependencyMapName<span class="token punctuation">:</span> <span class="token function">nullthrows</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>dependencyMapIdentifier<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 处理import语句及js资源</span>
<span class="token keyword">function</span> <span class="token function">processImportCall</span><span class="token punctuation">(</span>
  <span class="token parameter">path<span class="token punctuation">:</span> Path<span class="token punctuation">,</span>
  state<span class="token punctuation">:</span> State<span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> DepOptions</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Path <span class="token punctuation">{</span>
  <span class="token comment">// 获取module 名称</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">getModuleNameFromCallArgs</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidRequireCallError</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 记录module依赖，如果当前module已经存在map中则返回，否则先记录</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token function">getDependency</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> name<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>prefetchOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> dep<span class="token punctuation">.</span>data<span class="token punctuation">.</span>isPrefetchOnly<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>disableRequiresTransform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> path<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token constant">ASYNC_REQUIRE_MODULE_PATH</span> <span class="token operator">=</span> state<span class="token punctuation">.</span>asyncRequireModulePathStringLiteral<span class="token punctuation">;</span>
  <span class="token comment">// 生成零时的moduleId，用于在将代码中的import/require进行替换，</span>
  <span class="token keyword">const</span> <span class="token constant">MODULE_ID</span> <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>
    state<span class="token punctuation">.</span>dependencyMapIdentifier<span class="token punctuation">,</span>
    types<span class="token punctuation">.</span><span class="token function">numericLiteral</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// module名称</span>
  <span class="token keyword">const</span> <span class="token constant">MODULE_NAME</span> <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果是js资源，那么就替换对应的加载路径为指定的module</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>jsResource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
      <span class="token function">makeJSResourceTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token constant">ASYNC_REQUIRE_MODULE_PATH</span><span class="token punctuation">,</span>
        <span class="token constant">MODULE_ID</span><span class="token punctuation">,</span>
        <span class="token constant">MODULE_NAME</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>prefetchOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果为不是预加载则直接将import()转换成require()()语句进行加载</span>
    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
      <span class="token function">makeAsyncRequireTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token constant">ASYNC_REQUIRE_MODULE_PATH</span><span class="token punctuation">,</span>
        <span class="token constant">MODULE_ID</span><span class="token punctuation">,</span>
        <span class="token constant">MODULE_NAME</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 否则将import转换成require.prefetch的方式加载</span>
    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
      <span class="token function">makeAsyncPrefetchTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token constant">ASYNC_REQUIRE_MODULE_PATH</span><span class="token punctuation">,</span>
        <span class="token constant">MODULE_ID</span><span class="token punctuation">,</span>
        <span class="token constant">MODULE_NAME</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> path<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 处理require语句</span>
<span class="token keyword">function</span> <span class="token function">processRequireCall</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">:</span> Path<span class="token punctuation">,</span> state<span class="token punctuation">:</span> State</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Path <span class="token punctuation">{</span>
  <span class="token comment">// 获取module 名称</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">getModuleNameFromCallArgs</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>dynamicRequires <span class="token operator">===</span> <span class="token string">&quot;reject&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidRequireCallError</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
      <span class="token function">dynamicRequireErrorTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token constant">LINE</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">.</span>line<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> path<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 记录module依赖，如果当前module已经存在map中则返回，否则先记录</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token function">getDependency</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">{</span> prefetchOnly<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dep<span class="token punctuation">.</span>data<span class="token punctuation">.</span>isAsync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> dep<span class="token punctuation">.</span>data<span class="token punctuation">.</span>isPrefetchOnly<span class="token punctuation">;</span>
  <span class="token comment">// 如果不使用require 转换逻辑则直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>disableRequiresTransform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> path<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 生成零时的moduleId，用于在将代码中的import/require进行替换，</span>
  <span class="token keyword">const</span> moduleIDExpression <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>
    state<span class="token punctuation">.</span>dependencyMapIdentifier<span class="token punctuation">,</span>
    types<span class="token punctuation">.</span><span class="token function">numericLiteral</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 替换require内容为对应的id</span>
  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>arguments <span class="token operator">=</span> state<span class="token punctuation">.</span>keepRequireNames
    <span class="token operator">?</span> <span class="token punctuation">[</span>moduleIDExpression<span class="token punctuation">,</span> types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">:</span> <span class="token punctuation">[</span>moduleIDExpression<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> path<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 记录依赖，当前module路径是否被记录过，如果没有则记录否则直接返回对呀信息</span>
<span class="token keyword">function</span> <span class="token function">getDependency</span><span class="token punctuation">(</span>
  <span class="token parameter">state<span class="token punctuation">:</span> State<span class="token punctuation">,</span>
  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> DepOptions</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> InternalDependencyInfo <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> state<span class="token punctuation">.</span>dependencyIndexes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> data<span class="token punctuation">:</span> <span class="token operator">?</span>InternalDependencyData <span class="token operator">=</span> state<span class="token punctuation">.</span>dependencyData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    index <span class="token operator">=</span> state<span class="token punctuation">.</span>dependency<span class="token operator">++</span><span class="token punctuation">;</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span> isAsync<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>prefetchOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">.</span>isPrefetchOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    state<span class="token punctuation">.</span>dependencyIndexes<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>dependencyData<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> index<span class="token punctuation">:</span> <span class="token function">nullthrows</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token function">nullthrows</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取require或者import部分具体的内容</span>
<span class="token keyword">function</span> <span class="token function">getModuleNameFromCallArgs</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">:</span> Path</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span>string <span class="token punctuation">{</span>
  <span class="token keyword">const</span> expectedCount <span class="token operator">=</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;__conditionallySplitJSResource&quot;</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;arguments&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">!==</span> expectedCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidRequireCallError</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> result <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;arguments.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>confident <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> result<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
collectDependencies<span class="token punctuation">.</span>getModuleNameFromCallArgs <span class="token operator">=</span> getModuleNameFromCallArgs<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">InvalidRequireCallError</span> <span class="token keyword">extends</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> node <span class="token punctuation">}</span><span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> line <span class="token operator">=</span> node<span class="token punctuation">.</span>loc <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">.</span>line<span class="token punctuation">;</span>

    <span class="token keyword">super</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid call at line </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>line <span class="token operator">||</span> <span class="token string">&quot;&lt;unknown&gt;&quot;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">generate</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

collectDependencies<span class="token punctuation">.</span>InvalidRequireCallError <span class="token operator">=</span> InvalidRequireCallError<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> collectDependencies<span class="token punctuation">;</span>
</code></pre></div><h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <ol><li><p><strong><code>collectDependencies</code> 主要利用 babel 去解析所有的 import 和 require 得到每个文件的依赖 module。</strong></p></li> <li><p><strong>处理 import 语句时，会将所有的 import 语句转换为 require 进行加载</strong></p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 转换前</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Image <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-native&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 转换后</span>
<span class="token keyword">var</span> _reactNative <span class="token operator">=</span> <span class="token function">r</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>其他情况:(tips: 暂未找到具体的实现方式，有发现的同学可以一起交流)</p> <ul><li>对于对于预加载的情况，会转换成 <code>require().prefetch</code> 的方式进行加载;</li> <li>如果为资源文件则会转换成 <code>require().resource</code> 的方式加载.</li></ul> <ol start="3"><li><strong>在处理 require 语句时, 会将 require 的内容替换成对应的 moduleId</strong></li></ol> <blockquote><p>举个例子： 类似于<code>require('Foo')</code> 将会被转换成 <code>require(_depMap[3], 'Foo')</code>，这个<code>_depMap</code> 是所有的依赖集合，其实在这个时候，我们并不需要准确的知道真实的 <code>moduleId</code>，只需要知道文件的依赖即可。</p></blockquote> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 转换前</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Image</span></span> <span class="token attr-name">source</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./demo.png'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Image</span></span><span class="token punctuation">&gt;</span></span>
<span class="token comment">// 转换后</span>
_react<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>_reactNative<span class="token punctuation">.</span>Image<span class="token punctuation">,</span><span class="token punctuation">{</span>source<span class="token punctuation">:</span> <span class="token function">r</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>经过 <code>babel</code> 解析之后的 <code>module</code> 依赖如下:</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 经过 collectDependencies得到的依赖</span>
dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;@babel/runtime/helpers/interopRequireDefault&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;react-native&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;./App&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;./app.json&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><ol start="5"><li>js 转换使用的是<code>metro-react-native-babel-transformer</code>对 js 代码进行转换</li></ol> <p>其他:</p> <ol><li>至于如何生成 <code>polyfills</code> 部分，以及<code>\_d</code>，<code>globalThis</code> 等，有兴趣的同学可以看一下<code>node_modules/metro/src/ModuleGraph/worker/JsFileWrapping.js</code></li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">【未经作者允许禁止转载】 Last Updated: </span> <span class="time">4/15/2021, 2:49:19 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.18401fe5.js" defer></script><script src="/assets/js/6.31f36374.js" defer></script><script src="/assets/js/3.5ac3ae2c.js" defer></script><script src="/assets/js/39.73076b63.js" defer></script>
  </body>
</html>
